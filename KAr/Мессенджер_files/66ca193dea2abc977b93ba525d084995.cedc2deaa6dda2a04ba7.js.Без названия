(self.webpackChunkvk=self.webpackChunkvk||[]).push([[26001],{53996:(e,t,i)=>{"use strict";i.r(t),i.d(t,{Api:()=>$n,BaseApi:()=>ot,BaseLogger:()=>ct,BaseSignaling:()=>lt,CallDirection:()=>pt,CallType:()=>_t,ChatRoomEventType:()=>mt,ConversationOption:()=>Et,DebugMessageType:()=>xr,ExternalIdType:()=>Gr,FacingMode:()=>ir,FatalError:()=>At,HangupReason:()=>Ai,HangupType:()=>bt,MediaOption:()=>Dt,MediaTrackKind:()=>bi,MediaType:()=>$r,MuteState:()=>Nt,ParticipantState:()=>Lt,ParticipantStatus:()=>Dr,RecordRole:()=>ra,Signaling:()=>Zn,SignalingCommandType:()=>qn,SignalingConnectionType:()=>Ut,SignalingNotification:()=>Ft,TransportTopology:()=>bn,UserRole:()=>zt,UserType:()=>Xt,Utils:()=>Ui,acceptCall:()=>ma,addMovie:()=>ns,addParticipant:()=>Ta,addParticipantInternal:()=>Ca,authorize:()=>fa,browser:()=>aa,callInternal:()=>pa,callTo:()=>ua,captureScreen:()=>Pa,changeConversationOptions:()=>Ha,changeDevice:()=>Aa,changeParticipantState:()=>ka,changePriorities:()=>Na,changeVideoEffect:()=>ls,chatHistory:()=>$a,chatMessage:()=>ja,chatMessageInternal:()=>Wa,createJoinLink:()=>Ya,customData:()=>Ka,customDataInternal:()=>qa,debug:()=>cs,debugMessage:()=>ds,declineCall:()=>ga,forceRelayPolicy:()=>Za,getAnonymTokenByLink:()=>Xa,getParticipantListChunk:()=>_s,getParticipants:()=>fs,getStreamInfo:()=>rs,getWaitingHall:()=>ps,grantRoles:()=>Ma,grantRolesInternal:()=>Ua,hangup:()=>ya,init:()=>la,joinCall:()=>va,joinCallByLink:()=>Ea,joinCallInternal:()=>Sa,muteParticipant:()=>xa,muteParticipantInternal:()=>Ba,pinParticipant:()=>Va,pinParticipantInternal:()=>Fa,processPush:()=>ha,processPushInternal:()=>_a,promoteParticipant:()=>hs,recordSetRole:()=>is,removeHistoryRecords:()=>gs,removeJoinLink:()=>Ja,removeMovie:()=>ss,removeParticipant:()=>Ra,removeParticipantInternal:()=>Ia,setApi:()=>sa,setAudioStream:()=>us,setLocalResolution:()=>wa,setLogger:()=>ca,setMediaModifiers:()=>Ga,setSignalingFactory:()=>oa,setStatisticsInterval:()=>os,setVideoEffects:()=>da,setVideoStream:()=>ba,setVolume:()=>Qa,startConversation:()=>za,startStream:()=>es,stopStream:()=>ts,toggleLocalAudio:()=>Da,toggleLocalVideo:()=>Oa,updateDisplayLayout:()=>La,updateMovie:()=>as,version:()=>vs});var r={};i.r(r),i.d(r,{fixNegotiationNeeded:()=>N,shimAddTrackRemoveTrack:()=>D,shimAddTrackRemoveTrackWithNative:()=>O,shimGetDisplayMedia:()=>C,shimGetSendersWithDtmf:()=>A,shimGetStats:()=>P,shimGetUserMedia:()=>T,shimMediaStream:()=>R,shimOnTrack:()=>I,shimPeerConnection:()=>w,shimSenderReceiverGetStats:()=>b});var n={};i.r(n),i.d(n,{shimGetDisplayMedia:()=>U,shimGetUserMedia:()=>M,shimPeerConnection:()=>x,shimReplaceTrack:()=>B});var a={};i.r(a),i.d(a,{shimAddTransceiver:()=>q,shimCreateAnswer:()=>J,shimCreateOffer:()=>Y,shimGetDisplayMedia:()=>F,shimGetParameters:()=>z,shimGetUserMedia:()=>V,shimOnTrack:()=>G,shimPeerConnection:()=>H,shimRTCDataChannel:()=>K,shimReceiverGetStats:()=>W,shimRemoveStream:()=>$,shimSenderGetStats:()=>j});var s={};i.r(s),i.d(s,{shimAudioContext:()=>ae,shimCallbacksAPI:()=>Z,shimConstraints:()=>te,shimCreateOfferLegacy:()=>ne,shimGetUserMedia:()=>ee,shimLocalStreamsAPI:()=>X,shimRTCIceServerUrls:()=>ie,shimRemoteStreamsAPI:()=>Q,shimTrackEventTransceiver:()=>re});var o={};i.r(o),i.d(o,{removeAllowExtmapMixed:()=>pe,shimConnectionState:()=>ue,shimMaxMessageSize:()=>de,shimRTCIceCandidate:()=>ce,shimSendThrowTypeError:()=>le});let c=!0,d=!0;function l(e,t,i){const r=e.match(t);return r&&r.length>=i&&parseInt(r[i],10)}function u(e,t,i){if(!e.RTCPeerConnection)return;const r=e.RTCPeerConnection.prototype,n=r.addEventListener;r.addEventListener=function(e,r){if(e!==t)return n.apply(this,arguments);const a=e=>{const t=i(e);t&&(r.handleEvent?r.handleEvent(t):r(t))};return this._eventMap=this._eventMap||{},this._eventMap[t]||(this._eventMap[t]=new Map),this._eventMap[t].set(r,a),n.apply(this,[e,a])};const a=r.removeEventListener;r.removeEventListener=function(e,i){if(e!==t||!this._eventMap||!this._eventMap[t])return a.apply(this,arguments);if(!this._eventMap[t].has(i))return a.apply(this,arguments);const r=this._eventMap[t].get(i);return this._eventMap[t].delete(i),0===this._eventMap[t].size&&delete this._eventMap[t],0===Object.keys(this._eventMap).length&&delete this._eventMap,a.apply(this,[e,r])},Object.defineProperty(r,"on"+t,{get(){return this["_on"+t]},set(e){this["_on"+t]&&(this.removeEventListener(t,this["_on"+t]),delete this["_on"+t]),e&&this.addEventListener(t,this["_on"+t]=e)},enumerable:!0,configurable:!0})}function p(e){return"boolean"!=typeof e?new Error("Argument type: "+typeof e+". Please use a boolean."):(c=e,e?"adapter.js logging disabled":"adapter.js logging enabled")}function h(e){return"boolean"!=typeof e?new Error("Argument type: "+typeof e+". Please use a boolean."):(d=!e,"adapter.js deprecation warnings "+(e?"disabled":"enabled"))}function _(){if("object"==typeof window){if(c)return;"undefined"!=typeof console&&"function"==typeof console.log&&console.log.apply(console,arguments)}}function f(e,t){d&&console.warn(e+" is deprecated, please use "+t+" instead.")}function m(e){const t={browser:null,version:null};if(void 0===e||!e.navigator)return t.browser="Not a browser.",t;const{navigator:i}=e;if(i.mozGetUserMedia)t.browser="firefox",t.version=l(i.userAgent,/Firefox\/(\d+)\./,1);else if(i.webkitGetUserMedia||!1===e.isSecureContext&&e.webkitRTCPeerConnection&&!e.RTCIceGatherer)t.browser="chrome",t.version=l(i.userAgent,/Chrom(e|ium)\/(\d+)\./,2);else if(i.mediaDevices&&i.userAgent.match(/Edge\/(\d+).(\d+)$/))t.browser="edge",t.version=l(i.userAgent,/Edge\/(\d+).(\d+)$/,2);else{if(!e.RTCPeerConnection||!i.userAgent.match(/AppleWebKit\/(\d+)\./))return t.browser="Not a supported browser.",t;t.browser="safari",t.version=l(i.userAgent,/AppleWebKit\/(\d+)\./,1),t.supportsUnifiedPlan=e.RTCRtpTransceiver&&"currentDirection"in e.RTCRtpTransceiver.prototype}return t}function g(e){return"[object Object]"===Object.prototype.toString.call(e)}function v(e){return g(e)?Object.keys(e).reduce((function(t,i){const r=g(e[i]),n=r?v(e[i]):e[i],a=r&&!Object.keys(n).length;return void 0===n||a?t:Object.assign(t,{[i]:n})}),{}):e}function S(e,t,i){t&&!i.has(t.id)&&(i.set(t.id,t),Object.keys(t).forEach((r=>{r.endsWith("Id")?S(e,e.get(t[r]),i):r.endsWith("Ids")&&t[r].forEach((t=>{S(e,e.get(t),i)}))})))}function E(e,t,i){const r=i?"outbound-rtp":"inbound-rtp",n=new Map;if(null===t)return n;const a=[];return e.forEach((e=>{"track"===e.type&&e.trackIdentifier===t.id&&a.push(e)})),a.forEach((t=>{e.forEach((i=>{i.type===r&&i.trackId===t.id&&S(e,i,n)}))})),n}const y=_;function T(e){const t=e&&e.navigator;if(!t.mediaDevices)return;const i=m(e),r=function(e){if("object"!=typeof e||e.mandatory||e.optional)return e;const t={};return Object.keys(e).forEach((i=>{if("require"===i||"advanced"===i||"mediaSource"===i)return;const r="object"==typeof e[i]?e[i]:{ideal:e[i]};void 0!==r.exact&&"number"==typeof r.exact&&(r.min=r.max=r.exact);const n=function(e,t){return e?e+t.charAt(0).toUpperCase()+t.slice(1):"deviceId"===t?"sourceId":t};if(void 0!==r.ideal){t.optional=t.optional||[];let e={};"number"==typeof r.ideal?(e[n("min",i)]=r.ideal,t.optional.push(e),e={},e[n("max",i)]=r.ideal,t.optional.push(e)):(e[n("",i)]=r.ideal,t.optional.push(e))}void 0!==r.exact&&"number"!=typeof r.exact?(t.mandatory=t.mandatory||{},t.mandatory[n("",i)]=r.exact):["min","max"].forEach((e=>{void 0!==r[e]&&(t.mandatory=t.mandatory||{},t.mandatory[n(e,i)]=r[e])}))})),e.advanced&&(t.optional=(t.optional||[]).concat(e.advanced)),t},n=function(e,n){if(i.version>=61)return n(e);if((e=JSON.parse(JSON.stringify(e)))&&"object"==typeof e.audio){const t=function(e,t,i){t in e&&!(i in e)&&(e[i]=e[t],delete e[t])};t((e=JSON.parse(JSON.stringify(e))).audio,"autoGainControl","googAutoGainControl"),t(e.audio,"noiseSuppression","googNoiseSuppression"),e.audio=r(e.audio)}if(e&&"object"==typeof e.video){let a=e.video.facingMode;a=a&&("object"==typeof a?a:{ideal:a});const s=i.version<66;if(a&&("user"===a.exact||"environment"===a.exact||"user"===a.ideal||"environment"===a.ideal)&&(!t.mediaDevices.getSupportedConstraints||!t.mediaDevices.getSupportedConstraints().facingMode||s)){let i;if(delete e.video.facingMode,"environment"===a.exact||"environment"===a.ideal?i=["back","rear"]:"user"!==a.exact&&"user"!==a.ideal||(i=["front"]),i)return t.mediaDevices.enumerateDevices().then((t=>{let s=(t=t.filter((e=>"videoinput"===e.kind))).find((e=>i.some((t=>e.label.toLowerCase().includes(t)))));return!s&&t.length&&i.includes("back")&&(s=t[t.length-1]),s&&(e.video.deviceId=a.exact?{exact:s.deviceId}:{ideal:s.deviceId}),e.video=r(e.video),y("chrome: "+JSON.stringify(e)),n(e)}))}e.video=r(e.video)}return y("chrome: "+JSON.stringify(e)),n(e)},a=function(e){return i.version>=64?e:{name:{PermissionDeniedError:"NotAllowedError",PermissionDismissedError:"NotAllowedError",InvalidStateError:"NotAllowedError",DevicesNotFoundError:"NotFoundError",ConstraintNotSatisfiedError:"OverconstrainedError",TrackStartError:"NotReadableError",MediaDeviceFailedDueToShutdown:"NotAllowedError",MediaDeviceKillSwitchOn:"NotAllowedError",TabCaptureError:"AbortError",ScreenCaptureError:"AbortError",DeviceCaptureError:"AbortError"}[e.name]||e.name,message:e.message,constraint:e.constraint||e.constraintName,toString(){return this.name+(this.message&&": ")+this.message}}};if(t.getUserMedia=function(e,i,r){n(e,(e=>{t.webkitGetUserMedia(e,i,(e=>{r&&r(a(e))}))}))}.bind(t),t.mediaDevices.getUserMedia){const e=t.mediaDevices.getUserMedia.bind(t.mediaDevices);t.mediaDevices.getUserMedia=function(t){return n(t,(t=>e(t).then((e=>{if(t.audio&&!e.getAudioTracks().length||t.video&&!e.getVideoTracks().length)throw e.getTracks().forEach((e=>{e.stop()})),new DOMException("","NotFoundError");return e}),(e=>Promise.reject(a(e))))))}}}function C(e,t){e.navigator.mediaDevices&&"getDisplayMedia"in e.navigator.mediaDevices||e.navigator.mediaDevices&&("function"==typeof t?e.navigator.mediaDevices.getDisplayMedia=function(i){return t(i).then((t=>{const r=i.video&&i.video.width,n=i.video&&i.video.height,a=i.video&&i.video.frameRate;return i.video={mandatory:{chromeMediaSource:"desktop",chromeMediaSourceId:t,maxFrameRate:a||3}},r&&(i.video.mandatory.maxWidth=r),n&&(i.video.mandatory.maxHeight=n),e.navigator.mediaDevices.getUserMedia(i)}))}:console.error("shimGetDisplayMedia: getSourceId argument is not a function"))}function R(e){e.MediaStream=e.MediaStream||e.webkitMediaStream}function I(e){if("object"==typeof e&&e.RTCPeerConnection&&!("ontrack"in e.RTCPeerConnection.prototype)){Object.defineProperty(e.RTCPeerConnection.prototype,"ontrack",{get(){return this._ontrack},set(e){this._ontrack&&this.removeEventListener("track",this._ontrack),this.addEventListener("track",this._ontrack=e)},enumerable:!0,configurable:!0});const t=e.RTCPeerConnection.prototype.setRemoteDescription;e.RTCPeerConnection.prototype.setRemoteDescription=function(){return this._ontrackpoly||(this._ontrackpoly=t=>{t.stream.addEventListener("addtrack",(i=>{let r;r=e.RTCPeerConnection.prototype.getReceivers?this.getReceivers().find((e=>e.track&&e.track.id===i.track.id)):{track:i.track};const n=new Event("track");n.track=i.track,n.receiver=r,n.transceiver={receiver:r},n.streams=[t.stream],this.dispatchEvent(n)})),t.stream.getTracks().forEach((i=>{let r;r=e.RTCPeerConnection.prototype.getReceivers?this.getReceivers().find((e=>e.track&&e.track.id===i.id)):{track:i};const n=new Event("track");n.track=i,n.receiver=r,n.transceiver={receiver:r},n.streams=[t.stream],this.dispatchEvent(n)}))},this.addEventListener("addstream",this._ontrackpoly)),t.apply(this,arguments)}}else u(e,"track",(e=>(e.transceiver||Object.defineProperty(e,"transceiver",{value:{receiver:e.receiver}}),e)))}function A(e){if("object"==typeof e&&e.RTCPeerConnection&&!("getSenders"in e.RTCPeerConnection.prototype)&&"createDTMFSender"in e.RTCPeerConnection.prototype){const t=function(e,t){return{track:t,get dtmf(){return void 0===this._dtmf&&("audio"===t.kind?this._dtmf=e.createDTMFSender(t):this._dtmf=null),this._dtmf},_pc:e}};if(!e.RTCPeerConnection.prototype.getSenders){e.RTCPeerConnection.prototype.getSenders=function(){return this._senders=this._senders||[],this._senders.slice()};const i=e.RTCPeerConnection.prototype.addTrack;e.RTCPeerConnection.prototype.addTrack=function(e,r){let n=i.apply(this,arguments);return n||(n=t(this,e),this._senders.push(n)),n};const r=e.RTCPeerConnection.prototype.removeTrack;e.RTCPeerConnection.prototype.removeTrack=function(e){r.apply(this,arguments);const t=this._senders.indexOf(e);-1!==t&&this._senders.splice(t,1)}}const i=e.RTCPeerConnection.prototype.addStream;e.RTCPeerConnection.prototype.addStream=function(e){this._senders=this._senders||[],i.apply(this,[e]),e.getTracks().forEach((e=>{this._senders.push(t(this,e))}))};const r=e.RTCPeerConnection.prototype.removeStream;e.RTCPeerConnection.prototype.removeStream=function(e){this._senders=this._senders||[],r.apply(this,[e]),e.getTracks().forEach((e=>{const t=this._senders.find((t=>t.track===e));t&&this._senders.splice(this._senders.indexOf(t),1)}))}}else if("object"==typeof e&&e.RTCPeerConnection&&"getSenders"in e.RTCPeerConnection.prototype&&"createDTMFSender"in e.RTCPeerConnection.prototype&&e.RTCRtpSender&&!("dtmf"in e.RTCRtpSender.prototype)){const t=e.RTCPeerConnection.prototype.getSenders;e.RTCPeerConnection.prototype.getSenders=function(){const e=t.apply(this,[]);return e.forEach((e=>e._pc=this)),e},Object.defineProperty(e.RTCRtpSender.prototype,"dtmf",{get(){return void 0===this._dtmf&&("audio"===this.track.kind?this._dtmf=this._pc.createDTMFSender(this.track):this._dtmf=null),this._dtmf}})}}function P(e){if(!e.RTCPeerConnection)return;const t=e.RTCPeerConnection.prototype.getStats;e.RTCPeerConnection.prototype.getStats=function(){const[e,i,r]=arguments;if(arguments.length>0&&"function"==typeof e)return t.apply(this,arguments);if(0===t.length&&(0===arguments.length||"function"!=typeof e))return t.apply(this,[]);const n=function(e){const t={};return e.result().forEach((e=>{const i={id:e.id,timestamp:e.timestamp,type:{localcandidate:"local-candidate",remotecandidate:"remote-candidate"}[e.type]||e.type};e.names().forEach((t=>{i[t]=e.stat(t)})),t[i.id]=i})),t},a=function(e){return new Map(Object.keys(e).map((t=>[t,e[t]])))};if(arguments.length>=2){const r=function(e){i(a(n(e)))};return t.apply(this,[r,e])}return new Promise(((e,i)=>{t.apply(this,[function(t){e(a(n(t)))},i])})).then(i,r)}}function b(e){if(!("object"==typeof e&&e.RTCPeerConnection&&e.RTCRtpSender&&e.RTCRtpReceiver))return;if(!("getStats"in e.RTCRtpSender.prototype)){const t=e.RTCPeerConnection.prototype.getSenders;t&&(e.RTCPeerConnection.prototype.getSenders=function(){const e=t.apply(this,[]);return e.forEach((e=>e._pc=this)),e});const i=e.RTCPeerConnection.prototype.addTrack;i&&(e.RTCPeerConnection.prototype.addTrack=function(){const e=i.apply(this,arguments);return e._pc=this,e}),e.RTCRtpSender.prototype.getStats=function(){const e=this;return this._pc.getStats().then((t=>E(t,e.track,!0)))}}if(!("getStats"in e.RTCRtpReceiver.prototype)){const t=e.RTCPeerConnection.prototype.getReceivers;t&&(e.RTCPeerConnection.prototype.getReceivers=function(){const e=t.apply(this,[]);return e.forEach((e=>e._pc=this)),e}),u(e,"track",(e=>(e.receiver._pc=e.srcElement,e))),e.RTCRtpReceiver.prototype.getStats=function(){const e=this;return this._pc.getStats().then((t=>E(t,e.track,!1)))}}if(!("getStats"in e.RTCRtpSender.prototype)||!("getStats"in e.RTCRtpReceiver.prototype))return;const t=e.RTCPeerConnection.prototype.getStats;e.RTCPeerConnection.prototype.getStats=function(){if(arguments.length>0&&arguments[0]instanceof e.MediaStreamTrack){const e=arguments[0];let t,i,r;return this.getSenders().forEach((i=>{i.track===e&&(t?r=!0:t=i)})),this.getReceivers().forEach((t=>(t.track===e&&(i?r=!0:i=t),t.track===e))),r||t&&i?Promise.reject(new DOMException("There are more than one sender or receiver for the track.","InvalidAccessError")):t?t.getStats():i?i.getStats():Promise.reject(new DOMException("There is no sender or receiver for the track.","InvalidAccessError"))}return t.apply(this,arguments)}}function O(e){e.RTCPeerConnection.prototype.getLocalStreams=function(){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},Object.keys(this._shimmedLocalStreams).map((e=>this._shimmedLocalStreams[e][0]))};const t=e.RTCPeerConnection.prototype.addTrack;e.RTCPeerConnection.prototype.addTrack=function(e,i){if(!i)return t.apply(this,arguments);this._shimmedLocalStreams=this._shimmedLocalStreams||{};const r=t.apply(this,arguments);return this._shimmedLocalStreams[i.id]?-1===this._shimmedLocalStreams[i.id].indexOf(r)&&this._shimmedLocalStreams[i.id].push(r):this._shimmedLocalStreams[i.id]=[i,r],r};const i=e.RTCPeerConnection.prototype.addStream;e.RTCPeerConnection.prototype.addStream=function(e){this._shimmedLocalStreams=this._shimmedLocalStreams||{},e.getTracks().forEach((e=>{if(this.getSenders().find((t=>t.track===e)))throw new DOMException("Track already exists.","InvalidAccessError")}));const t=this.getSenders();i.apply(this,arguments);const r=this.getSenders().filter((e=>-1===t.indexOf(e)));this._shimmedLocalStreams[e.id]=[e].concat(r)};const r=e.RTCPeerConnection.prototype.removeStream;e.RTCPeerConnection.prototype.removeStream=function(e){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},delete this._shimmedLocalStreams[e.id],r.apply(this,arguments)};const n=e.RTCPeerConnection.prototype.removeTrack;e.RTCPeerConnection.prototype.removeTrack=function(e){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},e&&Object.keys(this._shimmedLocalStreams).forEach((t=>{const i=this._shimmedLocalStreams[t].indexOf(e);-1!==i&&this._shimmedLocalStreams[t].splice(i,1),1===this._shimmedLocalStreams[t].length&&delete this._shimmedLocalStreams[t]})),n.apply(this,arguments)}}function D(e){if(!e.RTCPeerConnection)return;const t=m(e);if(e.RTCPeerConnection.prototype.addTrack&&t.version>=65)return O(e);const i=e.RTCPeerConnection.prototype.getLocalStreams;e.RTCPeerConnection.prototype.getLocalStreams=function(){const e=i.apply(this);return this._reverseStreams=this._reverseStreams||{},e.map((e=>this._reverseStreams[e.id]))};const r=e.RTCPeerConnection.prototype.addStream;e.RTCPeerConnection.prototype.addStream=function(t){if(this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{},t.getTracks().forEach((e=>{if(this.getSenders().find((t=>t.track===e)))throw new DOMException("Track already exists.","InvalidAccessError")})),!this._reverseStreams[t.id]){const i=new e.MediaStream(t.getTracks());this._streams[t.id]=i,this._reverseStreams[i.id]=t,t=i}r.apply(this,[t])};const n=e.RTCPeerConnection.prototype.removeStream;function a(e,t){let i=t.sdp;return Object.keys(e._reverseStreams||[]).forEach((t=>{const r=e._reverseStreams[t],n=e._streams[r.id];i=i.replace(new RegExp(n.id,"g"),r.id)})),new RTCSessionDescription({type:t.type,sdp:i})}function s(e,t){let i=t.sdp;return Object.keys(e._reverseStreams||[]).forEach((t=>{const r=e._reverseStreams[t],n=e._streams[r.id];i=i.replace(new RegExp(r.id,"g"),n.id)})),new RTCSessionDescription({type:t.type,sdp:i})}e.RTCPeerConnection.prototype.removeStream=function(e){this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{},n.apply(this,[this._streams[e.id]||e]),delete this._reverseStreams[this._streams[e.id]?this._streams[e.id].id:e.id],delete this._streams[e.id]},e.RTCPeerConnection.prototype.addTrack=function(t,i){if("closed"===this.signalingState)throw new DOMException("The RTCPeerConnection's signalingState is 'closed'.","InvalidStateError");const r=[].slice.call(arguments,1);if(1!==r.length||!r[0].getTracks().find((e=>e===t)))throw new DOMException("The adapter.js addTrack polyfill only supports a single  stream which is associated with the specified track.","NotSupportedError");const n=this.getSenders().find((e=>e.track===t));if(n)throw new DOMException("Track already exists.","InvalidAccessError");this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{};const a=this._streams[i.id];if(a)a.addTrack(t),Promise.resolve().then((()=>{this.dispatchEvent(new Event("negotiationneeded"))}));else{const r=new e.MediaStream([t]);this._streams[i.id]=r,this._reverseStreams[r.id]=i,this.addStream(r)}return this.getSenders().find((e=>e.track===t))},["createOffer","createAnswer"].forEach((function(t){const i=e.RTCPeerConnection.prototype[t],r={[t](){const e=arguments;return arguments.length&&"function"==typeof arguments[0]?i.apply(this,[t=>{const i=a(this,t);e[0].apply(null,[i])},t=>{e[1]&&e[1].apply(null,t)},arguments[2]]):i.apply(this,arguments).then((e=>a(this,e)))}};e.RTCPeerConnection.prototype[t]=r[t]}));const o=e.RTCPeerConnection.prototype.setLocalDescription;e.RTCPeerConnection.prototype.setLocalDescription=function(){return arguments.length&&arguments[0].type?(arguments[0]=s(this,arguments[0]),o.apply(this,arguments)):o.apply(this,arguments)};const c=Object.getOwnPropertyDescriptor(e.RTCPeerConnection.prototype,"localDescription");Object.defineProperty(e.RTCPeerConnection.prototype,"localDescription",{get(){const e=c.get.apply(this);return""===e.type?e:a(this,e)}}),e.RTCPeerConnection.prototype.removeTrack=function(e){if("closed"===this.signalingState)throw new DOMException("The RTCPeerConnection's signalingState is 'closed'.","InvalidStateError");if(!e._pc)throw new DOMException("Argument 1 of RTCPeerConnection.removeTrack does not implement interface RTCRtpSender.","TypeError");if(!(e._pc===this))throw new DOMException("Sender was not created by this connection.","InvalidAccessError");let t;this._streams=this._streams||{},Object.keys(this._streams).forEach((i=>{this._streams[i].getTracks().find((t=>e.track===t))&&(t=this._streams[i])})),t&&(1===t.getTracks().length?this.removeStream(this._reverseStreams[t.id]):t.removeTrack(e.track),this.dispatchEvent(new Event("negotiationneeded")))}}function w(e){const t=m(e);if(!e.RTCPeerConnection&&e.webkitRTCPeerConnection&&(e.RTCPeerConnection=e.webkitRTCPeerConnection),!e.RTCPeerConnection)return;const i=0===e.RTCPeerConnection.prototype.addIceCandidate.length;t.version<53&&["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach((function(t){const i=e.RTCPeerConnection.prototype[t],r={[t](){return arguments[0]=new("addIceCandidate"===t?e.RTCIceCandidate:e.RTCSessionDescription)(arguments[0]),i.apply(this,arguments)}};e.RTCPeerConnection.prototype[t]=r[t]}));const r=e.RTCPeerConnection.prototype.addIceCandidate;e.RTCPeerConnection.prototype.addIceCandidate=function(){return i||arguments[0]?t.version<78&&arguments[0]&&""===arguments[0].candidate?Promise.resolve():r.apply(this,arguments):(arguments[1]&&arguments[1].apply(null),Promise.resolve())}}function N(e){const t=m(e);u(e,"negotiationneeded",(e=>{const i=e.target;if(!(t.version<72||i.getConfiguration&&"plan-b"===i.getConfiguration().sdpSemantics)||"stable"===i.signalingState)return e}))}var k=i(62539),L=i.n(k);function M(e){const t=e&&e.navigator,i=t.mediaDevices.getUserMedia.bind(t.mediaDevices);t.mediaDevices.getUserMedia=function(e){return i(e).catch((e=>Promise.reject(function(e){return{name:{PermissionDeniedError:"NotAllowedError"}[e.name]||e.name,message:e.message,constraint:e.constraint,toString(){return this.name}}}(e))))}}function U(e){"getDisplayMedia"in e.navigator&&e.navigator.mediaDevices&&(e.navigator.mediaDevices&&"getDisplayMedia"in e.navigator.mediaDevices||(e.navigator.mediaDevices.getDisplayMedia=e.navigator.getDisplayMedia.bind(e.navigator)))}function x(e){const t=m(e);if(e.RTCIceGatherer&&(e.RTCIceCandidate||(e.RTCIceCandidate=function(e){return e}),e.RTCSessionDescription||(e.RTCSessionDescription=function(e){return e}),t.version<15025)){const t=Object.getOwnPropertyDescriptor(e.MediaStreamTrack.prototype,"enabled");Object.defineProperty(e.MediaStreamTrack.prototype,"enabled",{set(e){t.set.call(this,e);const i=new Event("enabled");i.enabled=e,this.dispatchEvent(i)}})}e.RTCRtpSender&&!("dtmf"in e.RTCRtpSender.prototype)&&Object.defineProperty(e.RTCRtpSender.prototype,"dtmf",{get(){return void 0===this._dtmf&&("audio"===this.track.kind?this._dtmf=new e.RTCDtmfSender(this):"video"===this.track.kind&&(this._dtmf=null)),this._dtmf}}),e.RTCDtmfSender&&!e.RTCDTMFSender&&(e.RTCDTMFSender=e.RTCDtmfSender);const i=L()(e,t.version);e.RTCPeerConnection=function(e){return e&&e.iceServers&&(e.iceServers=function(e,t){let i=!1;return(e=JSON.parse(JSON.stringify(e))).filter((e=>{if(e&&(e.urls||e.url)){let t=e.urls||e.url;e.url&&!e.urls&&f("RTCIceServer.url","RTCIceServer.urls");const r="string"==typeof t;return r&&(t=[t]),t=t.filter((e=>{if(0===e.indexOf("stun:"))return!1;const t=e.startsWith("turn")&&!e.startsWith("turn:[")&&e.includes("transport=udp");return t&&!i?(i=!0,!0):t&&!i})),delete e.url,e.urls=r?t[0]:t,!!t.length}}))}(e.iceServers,t.version),_("ICE servers after filtering:",e.iceServers)),new i(e)},e.RTCPeerConnection.prototype=i.prototype}function B(e){e.RTCRtpSender&&!("replaceTrack"in e.RTCRtpSender.prototype)&&(e.RTCRtpSender.prototype.replaceTrack=e.RTCRtpSender.prototype.setTrack)}function V(e){const t=m(e),i=e&&e.navigator,r=e&&e.MediaStreamTrack;if(i.getUserMedia=function(e,t,r){f("navigator.getUserMedia","navigator.mediaDevices.getUserMedia"),i.mediaDevices.getUserMedia(e).then(t,r)},!(t.version>55&&"autoGainControl"in i.mediaDevices.getSupportedConstraints())){const e=function(e,t,i){t in e&&!(i in e)&&(e[i]=e[t],delete e[t])},t=i.mediaDevices.getUserMedia.bind(i.mediaDevices);if(i.mediaDevices.getUserMedia=function(i){return"object"==typeof i&&"object"==typeof i.audio&&(i=JSON.parse(JSON.stringify(i)),e(i.audio,"autoGainControl","mozAutoGainControl"),e(i.audio,"noiseSuppression","mozNoiseSuppression")),t(i)},r&&r.prototype.getSettings){const t=r.prototype.getSettings;r.prototype.getSettings=function(){const i=t.apply(this,arguments);return e(i,"mozAutoGainControl","autoGainControl"),e(i,"mozNoiseSuppression","noiseSuppression"),i}}if(r&&r.prototype.applyConstraints){const t=r.prototype.applyConstraints;r.prototype.applyConstraints=function(i){return"audio"===this.kind&&"object"==typeof i&&(i=JSON.parse(JSON.stringify(i)),e(i,"autoGainControl","mozAutoGainControl"),e(i,"noiseSuppression","mozNoiseSuppression")),t.apply(this,[i])}}}}function F(e,t){e.navigator.mediaDevices&&"getDisplayMedia"in e.navigator.mediaDevices||e.navigator.mediaDevices&&(e.navigator.mediaDevices.getDisplayMedia=function(i){if(!i||!i.video){const e=new DOMException("getDisplayMedia without video constraints is undefined");return e.name="NotFoundError",e.code=8,Promise.reject(e)}return!0===i.video?i.video={mediaSource:t}:i.video.mediaSource=t,e.navigator.mediaDevices.getUserMedia(i)})}function G(e){"object"==typeof e&&e.RTCTrackEvent&&"receiver"in e.RTCTrackEvent.prototype&&!("transceiver"in e.RTCTrackEvent.prototype)&&Object.defineProperty(e.RTCTrackEvent.prototype,"transceiver",{get(){return{receiver:this.receiver}}})}function H(e){const t=m(e);if("object"!=typeof e||!e.RTCPeerConnection&&!e.mozRTCPeerConnection)return;if(!e.RTCPeerConnection&&e.mozRTCPeerConnection&&(e.RTCPeerConnection=e.mozRTCPeerConnection),t.version<53&&["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach((function(t){const i=e.RTCPeerConnection.prototype[t],r={[t](){return arguments[0]=new("addIceCandidate"===t?e.RTCIceCandidate:e.RTCSessionDescription)(arguments[0]),i.apply(this,arguments)}};e.RTCPeerConnection.prototype[t]=r[t]})),t.version<68){const t=e.RTCPeerConnection.prototype.addIceCandidate;e.RTCPeerConnection.prototype.addIceCandidate=function(){return arguments[0]?arguments[0]&&""===arguments[0].candidate?Promise.resolve():t.apply(this,arguments):(arguments[1]&&arguments[1].apply(null),Promise.resolve())}}const i={inboundrtp:"inbound-rtp",outboundrtp:"outbound-rtp",candidatepair:"candidate-pair",localcandidate:"local-candidate",remotecandidate:"remote-candidate"},r=e.RTCPeerConnection.prototype.getStats;e.RTCPeerConnection.prototype.getStats=function(){const[e,n,a]=arguments;return r.apply(this,[e||null]).then((e=>{if(t.version<53&&!n)try{e.forEach((e=>{e.type=i[e.type]||e.type}))}catch(t){if("TypeError"!==t.name)throw t;e.forEach(((t,r)=>{e.set(r,Object.assign({},t,{type:i[t.type]||t.type}))}))}return e})).then(n,a)}}function j(e){if("object"!=typeof e||!e.RTCPeerConnection||!e.RTCRtpSender)return;if(e.RTCRtpSender&&"getStats"in e.RTCRtpSender.prototype)return;const t=e.RTCPeerConnection.prototype.getSenders;t&&(e.RTCPeerConnection.prototype.getSenders=function(){const e=t.apply(this,[]);return e.forEach((e=>e._pc=this)),e});const i=e.RTCPeerConnection.prototype.addTrack;i&&(e.RTCPeerConnection.prototype.addTrack=function(){const e=i.apply(this,arguments);return e._pc=this,e}),e.RTCRtpSender.prototype.getStats=function(){return this.track?this._pc.getStats(this.track):Promise.resolve(new Map)}}function W(e){if("object"!=typeof e||!e.RTCPeerConnection||!e.RTCRtpSender)return;if(e.RTCRtpSender&&"getStats"in e.RTCRtpReceiver.prototype)return;const t=e.RTCPeerConnection.prototype.getReceivers;t&&(e.RTCPeerConnection.prototype.getReceivers=function(){const e=t.apply(this,[]);return e.forEach((e=>e._pc=this)),e}),u(e,"track",(e=>(e.receiver._pc=e.srcElement,e))),e.RTCRtpReceiver.prototype.getStats=function(){return this._pc.getStats(this.track)}}function $(e){e.RTCPeerConnection&&!("removeStream"in e.RTCPeerConnection.prototype)&&(e.RTCPeerConnection.prototype.removeStream=function(e){f("removeStream","removeTrack"),this.getSenders().forEach((t=>{t.track&&e.getTracks().includes(t.track)&&this.removeTrack(t)}))})}function K(e){e.DataChannel&&!e.RTCDataChannel&&(e.RTCDataChannel=e.DataChannel)}function q(e){if("object"!=typeof e||!e.RTCPeerConnection)return;const t=e.RTCPeerConnection.prototype.addTransceiver;t&&(e.RTCPeerConnection.prototype.addTransceiver=function(){this.setParametersPromises=[];const e=arguments[1],i=e&&"sendEncodings"in e;i&&e.sendEncodings.forEach((e=>{if("rid"in e){if(!/^[a-z0-9]{0,16}$/i.test(e.rid))throw new TypeError("Invalid RID value provided.")}if("scaleResolutionDownBy"in e&&!(parseFloat(e.scaleResolutionDownBy)>=1))throw new RangeError("scale_resolution_down_by must be >= 1.0");if("maxFramerate"in e&&!(parseFloat(e.maxFramerate)>=0))throw new RangeError("max_framerate must be >= 0.0")}));const r=t.apply(this,arguments);if(i){const{sender:t}=r,i=t.getParameters();(!("encodings"in i)||1===i.encodings.length&&0===Object.keys(i.encodings[0]).length)&&(i.encodings=e.sendEncodings,t.sendEncodings=e.sendEncodings,this.setParametersPromises.push(t.setParameters(i).then((()=>{delete t.sendEncodings})).catch((()=>{delete t.sendEncodings}))))}return r})}function z(e){if("object"!=typeof e||!e.RTCRtpSender)return;const t=e.RTCRtpSender.prototype.getParameters;t&&(e.RTCRtpSender.prototype.getParameters=function(){const e=t.apply(this,arguments);return"encodings"in e||(e.encodings=[].concat(this.sendEncodings||[{}])),e})}function Y(e){if("object"!=typeof e||!e.RTCPeerConnection)return;const t=e.RTCPeerConnection.prototype.createOffer;e.RTCPeerConnection.prototype.createOffer=function(){return this.setParametersPromises&&this.setParametersPromises.length?Promise.all(this.setParametersPromises).then((()=>t.apply(this,arguments))).finally((()=>{this.setParametersPromises=[]})):t.apply(this,arguments)}}function J(e){if("object"!=typeof e||!e.RTCPeerConnection)return;const t=e.RTCPeerConnection.prototype.createAnswer;e.RTCPeerConnection.prototype.createAnswer=function(){return this.setParametersPromises&&this.setParametersPromises.length?Promise.all(this.setParametersPromises).then((()=>t.apply(this,arguments))).finally((()=>{this.setParametersPromises=[]})):t.apply(this,arguments)}}function X(e){if("object"==typeof e&&e.RTCPeerConnection){if("getLocalStreams"in e.RTCPeerConnection.prototype||(e.RTCPeerConnection.prototype.getLocalStreams=function(){return this._localStreams||(this._localStreams=[]),this._localStreams}),!("addStream"in e.RTCPeerConnection.prototype)){const t=e.RTCPeerConnection.prototype.addTrack;e.RTCPeerConnection.prototype.addStream=function(e){this._localStreams||(this._localStreams=[]),this._localStreams.includes(e)||this._localStreams.push(e),e.getAudioTracks().forEach((i=>t.call(this,i,e))),e.getVideoTracks().forEach((i=>t.call(this,i,e)))},e.RTCPeerConnection.prototype.addTrack=function(e,...i){return i&&i.forEach((e=>{this._localStreams?this._localStreams.includes(e)||this._localStreams.push(e):this._localStreams=[e]})),t.apply(this,arguments)}}"removeStream"in e.RTCPeerConnection.prototype||(e.RTCPeerConnection.prototype.removeStream=function(e){this._localStreams||(this._localStreams=[]);const t=this._localStreams.indexOf(e);if(-1===t)return;this._localStreams.splice(t,1);const i=e.getTracks();this.getSenders().forEach((e=>{i.includes(e.track)&&this.removeTrack(e)}))})}}function Q(e){if("object"==typeof e&&e.RTCPeerConnection&&("getRemoteStreams"in e.RTCPeerConnection.prototype||(e.RTCPeerConnection.prototype.getRemoteStreams=function(){return this._remoteStreams?this._remoteStreams:[]}),!("onaddstream"in e.RTCPeerConnection.prototype))){Object.defineProperty(e.RTCPeerConnection.prototype,"onaddstream",{get(){return this._onaddstream},set(e){this._onaddstream&&(this.removeEventListener("addstream",this._onaddstream),this.removeEventListener("track",this._onaddstreampoly)),this.addEventListener("addstream",this._onaddstream=e),this.addEventListener("track",this._onaddstreampoly=e=>{e.streams.forEach((e=>{if(this._remoteStreams||(this._remoteStreams=[]),this._remoteStreams.includes(e))return;this._remoteStreams.push(e);const t=new Event("addstream");t.stream=e,this.dispatchEvent(t)}))})}});const t=e.RTCPeerConnection.prototype.setRemoteDescription;e.RTCPeerConnection.prototype.setRemoteDescription=function(){const e=this;return this._onaddstreampoly||this.addEventListener("track",this._onaddstreampoly=function(t){t.streams.forEach((t=>{if(e._remoteStreams||(e._remoteStreams=[]),e._remoteStreams.indexOf(t)>=0)return;e._remoteStreams.push(t);const i=new Event("addstream");i.stream=t,e.dispatchEvent(i)}))}),t.apply(e,arguments)}}}function Z(e){if("object"!=typeof e||!e.RTCPeerConnection)return;const t=e.RTCPeerConnection.prototype,i=t.createOffer,r=t.createAnswer,n=t.setLocalDescription,a=t.setRemoteDescription,s=t.addIceCandidate;t.createOffer=function(e,t){const r=arguments.length>=2?arguments[2]:arguments[0],n=i.apply(this,[r]);return t?(n.then(e,t),Promise.resolve()):n},t.createAnswer=function(e,t){const i=arguments.length>=2?arguments[2]:arguments[0],n=r.apply(this,[i]);return t?(n.then(e,t),Promise.resolve()):n};let o=function(e,t,i){const r=n.apply(this,[e]);return i?(r.then(t,i),Promise.resolve()):r};t.setLocalDescription=o,o=function(e,t,i){const r=a.apply(this,[e]);return i?(r.then(t,i),Promise.resolve()):r},t.setRemoteDescription=o,o=function(e,t,i){const r=s.apply(this,[e]);return i?(r.then(t,i),Promise.resolve()):r},t.addIceCandidate=o}function ee(e){const t=e&&e.navigator;if(t.mediaDevices&&t.mediaDevices.getUserMedia){const e=t.mediaDevices,i=e.getUserMedia.bind(e);t.mediaDevices.getUserMedia=e=>i(te(e))}!t.getUserMedia&&t.mediaDevices&&t.mediaDevices.getUserMedia&&(t.getUserMedia=function(e,i,r){t.mediaDevices.getUserMedia(e).then(i,r)}.bind(t))}function te(e){return e&&void 0!==e.video?Object.assign({},e,{video:v(e.video)}):e}function ie(e){if(!e.RTCPeerConnection)return;const t=e.RTCPeerConnection;e.RTCPeerConnection=function(e,i){if(e&&e.iceServers){const t=[];for(let i=0;i<e.iceServers.length;i++){let r=e.iceServers[i];!r.hasOwnProperty("urls")&&r.hasOwnProperty("url")?(f("RTCIceServer.url","RTCIceServer.urls"),r=JSON.parse(JSON.stringify(r)),r.urls=r.url,delete r.url,t.push(r)):t.push(e.iceServers[i])}e.iceServers=t}return new t(e,i)},e.RTCPeerConnection.prototype=t.prototype,"generateCertificate"in t&&Object.defineProperty(e.RTCPeerConnection,"generateCertificate",{get:()=>t.generateCertificate})}function re(e){"object"==typeof e&&e.RTCTrackEvent&&"receiver"in e.RTCTrackEvent.prototype&&!("transceiver"in e.RTCTrackEvent.prototype)&&Object.defineProperty(e.RTCTrackEvent.prototype,"transceiver",{get(){return{receiver:this.receiver}}})}function ne(e){const t=e.RTCPeerConnection.prototype.createOffer;e.RTCPeerConnection.prototype.createOffer=function(e){if(e){void 0!==e.offerToReceiveAudio&&(e.offerToReceiveAudio=!!e.offerToReceiveAudio);const t=this.getTransceivers().find((e=>"audio"===e.receiver.track.kind));!1===e.offerToReceiveAudio&&t?"sendrecv"===t.direction?t.setDirection?t.setDirection("sendonly"):t.direction="sendonly":"recvonly"===t.direction&&(t.setDirection?t.setDirection("inactive"):t.direction="inactive"):!0!==e.offerToReceiveAudio||t||this.addTransceiver("audio"),void 0!==e.offerToReceiveVideo&&(e.offerToReceiveVideo=!!e.offerToReceiveVideo);const i=this.getTransceivers().find((e=>"video"===e.receiver.track.kind));!1===e.offerToReceiveVideo&&i?"sendrecv"===i.direction?i.setDirection?i.setDirection("sendonly"):i.direction="sendonly":"recvonly"===i.direction&&(i.setDirection?i.setDirection("inactive"):i.direction="inactive"):!0!==e.offerToReceiveVideo||i||this.addTransceiver("video")}return t.apply(this,arguments)}}function ae(e){"object"!=typeof e||e.AudioContext||(e.AudioContext=e.webkitAudioContext)}var se=i(57539),oe=i.n(se);function ce(e){if(!e.RTCIceCandidate||e.RTCIceCandidate&&"foundation"in e.RTCIceCandidate.prototype)return;const t=e.RTCIceCandidate;e.RTCIceCandidate=function(e){if("object"==typeof e&&e.candidate&&0===e.candidate.indexOf("a=")&&((e=JSON.parse(JSON.stringify(e))).candidate=e.candidate.substr(2)),e.candidate&&e.candidate.length){const i=new t(e),r=oe().parseCandidate(e.candidate),n=Object.assign(i,r);return n.toJSON=function(){return{candidate:n.candidate,sdpMid:n.sdpMid,sdpMLineIndex:n.sdpMLineIndex,usernameFragment:n.usernameFragment}},n}return new t(e)},e.RTCIceCandidate.prototype=t.prototype,u(e,"icecandidate",(t=>(t.candidate&&Object.defineProperty(t,"candidate",{value:new e.RTCIceCandidate(t.candidate),writable:"false"}),t)))}function de(e){if(!e.RTCPeerConnection)return;const t=m(e);"sctp"in e.RTCPeerConnection.prototype||Object.defineProperty(e.RTCPeerConnection.prototype,"sctp",{get(){return void 0===this._sctp?null:this._sctp}});const i=function(e){if(!e||!e.sdp)return!1;const t=oe().splitSections(e.sdp);return t.shift(),t.some((e=>{const t=oe().parseMLine(e);return t&&"application"===t.kind&&-1!==t.protocol.indexOf("SCTP")}))},r=function(e){const t=e.sdp.match(/mozilla...THIS_IS_SDPARTA-(\d+)/);if(null===t||t.length<2)return-1;const i=parseInt(t[1],10);return i!=i?-1:i},n=function(e){let i=65536;return"firefox"===t.browser&&(i=t.version<57?-1===e?16384:2147483637:t.version<60?57===t.version?65535:65536:2147483637),i},a=function(e,i){let r=65536;"firefox"===t.browser&&57===t.version&&(r=65535);const n=oe().matchPrefix(e.sdp,"a=max-message-size:");return n.length>0?r=parseInt(n[0].substr(19),10):"firefox"===t.browser&&-1!==i&&(r=2147483637),r},s=e.RTCPeerConnection.prototype.setRemoteDescription;e.RTCPeerConnection.prototype.setRemoteDescription=function(){if(this._sctp=null,"chrome"===t.browser&&t.version>=76){const{sdpSemantics:e}=this.getConfiguration();"plan-b"===e&&Object.defineProperty(this,"sctp",{get(){return void 0===this._sctp?null:this._sctp},enumerable:!0,configurable:!0})}if(i(arguments[0])){const e=r(arguments[0]),t=n(e),i=a(arguments[0],e);let s;s=0===t&&0===i?Number.POSITIVE_INFINITY:0===t||0===i?Math.max(t,i):Math.min(t,i);const o={};Object.defineProperty(o,"maxMessageSize",{get:()=>s}),this._sctp=o}return s.apply(this,arguments)}}function le(e){if(!e.RTCPeerConnection||!("createDataChannel"in e.RTCPeerConnection.prototype))return;function t(e,t){const i=e.send;e.send=function(){const r=arguments[0],n=r.length||r.size||r.byteLength;if("open"===e.readyState&&t.sctp&&n>t.sctp.maxMessageSize)throw new TypeError("Message too large (can send a maximum of "+t.sctp.maxMessageSize+" bytes)");return i.apply(e,arguments)}}const i=e.RTCPeerConnection.prototype.createDataChannel;e.RTCPeerConnection.prototype.createDataChannel=function(){const e=i.apply(this,arguments);return t(e,this),e},u(e,"datachannel",(e=>(t(e.channel,e.target),e)))}function ue(e){if(!e.RTCPeerConnection||"connectionState"in e.RTCPeerConnection.prototype)return;const t=e.RTCPeerConnection.prototype;Object.defineProperty(t,"connectionState",{get(){return{completed:"connected",checking:"connecting"}[this.iceConnectionState]||this.iceConnectionState},enumerable:!0,configurable:!0}),Object.defineProperty(t,"onconnectionstatechange",{get(){return this._onconnectionstatechange||null},set(e){this._onconnectionstatechange&&(this.removeEventListener("connectionstatechange",this._onconnectionstatechange),delete this._onconnectionstatechange),e&&this.addEventListener("connectionstatechange",this._onconnectionstatechange=e)},enumerable:!0,configurable:!0}),["setLocalDescription","setRemoteDescription"].forEach((e=>{const i=t[e];t[e]=function(){return this._connectionstatechangepoly||(this._connectionstatechangepoly=e=>{const t=e.target;if(t._lastConnectionState!==t.connectionState){t._lastConnectionState=t.connectionState;const i=new Event("connectionstatechange",e);t.dispatchEvent(i)}return e},this.addEventListener("iceconnectionstatechange",this._connectionstatechangepoly)),i.apply(this,arguments)}}))}function pe(e){if(!e.RTCPeerConnection)return;const t=m(e);if("chrome"===t.browser&&t.version>=71)return;if("safari"===t.browser&&t.version>=605)return;const i=e.RTCPeerConnection.prototype.setRemoteDescription;e.RTCPeerConnection.prototype.setRemoteDescription=function(e){return e&&e.sdp&&-1!==e.sdp.indexOf("\na=extmap-allow-mixed")&&(e.sdp=e.sdp.split("\n").filter((e=>"a=extmap-allow-mixed"!==e.trim())).join("\n")),i.apply(this,arguments)}}const he=function({window:e}={},t={shimChrome:!0,shimFirefox:!0,shimEdge:!0,shimSafari:!0}){const i=_,c=m(e),d={browserDetails:c,commonShim:o,extractVersion:l,disableLog:p,disableWarnings:h};switch(c.browser){case"chrome":if(!r||!w||!t.shimChrome)return i("Chrome shim is not included in this adapter release."),d;if(null===c.version)return i("Chrome shim can not determine version, not shimming."),d;i("adapter.js shimming chrome."),d.browserShim=r,T(e),R(e),w(e),I(e),D(e),A(e),P(e),b(e),N(e),ce(e),ue(e),de(e),le(e),pe(e);break;case"firefox":if(!a||!H||!t.shimFirefox)return i("Firefox shim is not included in this adapter release."),d;i("adapter.js shimming firefox."),d.browserShim=a,V(e),H(e),G(e),$(e),j(e),W(e),K(e),q(e),z(e),Y(e),J(e),ce(e),ue(e),de(e),le(e);break;case"edge":if(!n||!x||!t.shimEdge)return i("MS edge shim is not included in this adapter release."),d;i("adapter.js shimming edge."),d.browserShim=n,M(e),U(e),x(e),B(e),de(e),le(e);break;case"safari":if(!s||!t.shimSafari)return i("Safari shim is not included in this adapter release."),d;i("adapter.js shimming safari."),d.browserShim=s,ie(e),ne(e),Z(e),X(e),Q(e),re(e),ee(e),ae(e),ce(e),de(e),le(e),pe(e);break;default:i("Unsupported browser!")}return d}({window:"undefined"==typeof window?void 0:window}),_e=he;var fe=i(6257),me=i.n(fe),ge=i(38797),ve=i(36090);function Se(e,t){throw new TypeError(`unexpected tag 0x${e.toString(16)} (${t} expected)`)}function Ee(e){return 127&e}function ye(e){return 0==(128&e)}function Te(e){return 224==(224&e)}function Ce(e){return 160==(224&e)}function Re(e){return 144==(240&e)}function Ie(e){return 128==(240&e)}function Ae(e,t,i){const r=t.byteLength;if(r<=255)e.putUi8(i),e.putUi8(r);else if(r<=65535)e.putUi8(i+1),e.putUi16(r);else{if(!(r<=4294967295))throw new RangeError("length limit exceeded");e.putUi8(i+2),e.putUi32(r)}e.put(t)}function Pe(e){const t=e.getUi8();let i;switch(t){case 192:i=0;break;case 196:case 217:i=e.getUi8();break;case 197:case 218:i=e.getUi16();break;case 198:case 219:i=e.getUi32();break;default:Ce(t)||Se(t,"bytes or string"),i=function(e){return 31&e}(t)}return e.get(i)}function be(e,t){t<16?e.putUi8(144|15&t):Ne(e,220,t)}function Oe(e,t){const i=e.getUi8(),r=Re(i)?function(e){return 15&e}(i):ke(e,i,220,"array");if(null!=t&&r!==t)throw new Error(`invalid array header size ${r}`);return r}function De(e,t){t<16?e.putUi8(128|15&t):Ne(e,222,t)}function we(e,t){const i=e.getUi8(),r=Ie(i)?function(e){return 15&e}(i):ke(e,i,222,"map");if(null!=t&&r!==t)throw new Error(`invalid map header size ${r}`);return r}function Ne(e,t,i){if(i<=65535)e.putUi8(t),e.putUi16(i);else{if(!(i<=4294967295))throw new RangeError("length limit exceeded");e.putUi8(t+1),e.putUi32(i)}}function ke(e,t,i,r){switch(t){case 192:return 0;case i:return e.getUi16();case i+1:return e.getUi32();default:Se(t,r)}}const Le={enc(e,t){(function(e){switch(typeof e){case"undefined":return Me;case"boolean":return Ue;case"number":return isFinite(e)&&Math.floor(e)===e?e<0?xe:Be:Ve;case"string":return Ge;case"object":return null===e?Me:Array.isArray(e)?je:e instanceof Uint8Array||e instanceof ArrayBuffer?Fe:e instanceof Date?He:$e;default:throw new TypeError("unsupported type "+typeof e)}})(t).enc(e,t)},dec:e=>function(e){switch(e){case 192:return Me;case 194:case 195:return Ue;case 208:case 209:case 210:case 211:return xe;case 204:case 205:case 206:case 207:return Be;case 202:case 203:return Ve;case 196:case 197:case 198:return Fe;case 217:case 218:case 219:return Ge;case 220:case 221:return je;case 222:case 223:return $e;case 214:case 215:case 199:return He;default:if(ye(e)||Te(e))return xe;if(Ce(e))return Ge;if(Re(e))return je;if(Ie(e))return $e;throw new TypeError(`unsupported tag ${e}`)}}(e.peek()).dec(e)},Me={enc(e,t){e.putUi8(192)},dec(e){const t=e.getUi8();return 192!==t&&Se(t,"nil"),null}},Ue={enc(e,t){e.putUi8(t?195:194)},dec(e){const t=e.getUi8();switch(t){case 192:case 194:return!1;case 195:return!0;default:Se(t,"bool")}}},xe={enc(e,t){-128<=t&&t<=127?t>=0?e.putUi8(Ee(t)):t>-32?e.putUi8(224|31&t):(e.putUi8(208),e.putUi8(t)):-32768<=t&&t<=32767?(e.putI8(209),e.putI16(t)):-2147483648<=t&&t<=2147483647?(e.putI8(210),e.putI32(t)):(e.putI8(211),e.putI64(t))},dec(e){const t=e.getUi8();if(ye(t))return function(e){return 127&e}(t);if(Te(t))return function(e){return e-256}(t);switch(t){case 192:return 0;case 208:return e.getI8();case 209:return e.getI16();case 210:return e.getI32();case 211:return e.getI64();case 204:return e.getUi8();case 205:return e.getUi16();case 206:return e.getUi32();case 207:return e.getUi64();default:Se(t,"int")}}},Be={enc(e,t){if(t<0)throw new Error(`not an uint: ${t}`);t<=127?e.putUi8(Ee(t)):t<=255?(e.putUi8(204),e.putUi8(t)):t<=65535?(e.putUi8(205),e.putUi16(t)):t<=4294967295?(e.putUi8(206),e.putUi32(t)):(e.putUi8(207),e.putUi64(t))},dec(e){const t=xe.dec(e);if(t<0)throw new RangeError("uint underflow");return t}},Ve={enc(e,t){e.putUi8(203),e.putF(t)},dec(e){const t=e.getUi8();switch(t){case 192:return 0;case 202:return e.getF32();case 203:return e.getF64();default:Se(t,"float")}}},Fe={enc(e,t){Ae(e,t,196)},dec:Pe},Ge={enc(e,t){const i=function(e){const t=e.length,i=new Uint8Array(4*t);let r,n=0,a=0;for(;a<t;)r=e.charCodeAt(a++),55296==(64512&r)&&(r=(r<<10)+e.charCodeAt(a++)-56613888),r<128?i[n++]=r:r<2048?(i[n++]=192+(r>>6),i[n++]=128+(63&r)):r<65536?(i[n++]=224+(r>>12),i[n++]=128+(r>>6&63),i[n++]=128+(63&r)):(i[n++]=240+(r>>18),i[n++]=128+(r>>12&63),i[n++]=128+(r>>6&63),i[n++]=128+(63&r));return i.buffer.slice(0,n)}(t);i.byteLength<32?(e.putUi8(160|31&i.byteLength),e.put(i)):Ae(e,i,217)},dec:e=>function(e){return new TextDecoder("utf-8").decode(e)}(Pe(e))},He={enc(e,t){const i=t.getTime();e.putUi8(199),e.putUi8(12),e.putI8(-1),e.putUi32(i%1e3*1e6),e.putI64(i/1e3)},dec(e){const t=e.getUi8();switch(t){case 214:if(-1===e.getI8())return new Date(1e3*e.getUi32());break;case 215:if(-1===e.getI8()){const t=e.getUi32(),i=e.getUi32();return new Date(1e3*(i+4294967296*(3&t))+t/4e6)}break;case 199:if(12===e.getUi8()&&-1===e.getI8()){const t=e.getUi32(),i=e.getI64();return new Date(1e3*i+t/1e6)}}Se(t,"time")}},je=(We=Le,{encHeader:be,decHeader:Oe,enc(e,t){be(e,t.length),t.forEach((t=>We.enc(e,t)))},dec(e){const t=[];for(let i=Oe(e);i>0;--i)t.push(We.dec(e));return t}});var We;const $e=function(e,t){return{encHeader:De,decHeader:we,enc(i,r){const n=Object.keys(r);De(i,n.length),n.forEach((n=>{e.enc(i,n),t.enc(i,r[n])}))},dec(i){const r={};for(let n=we(i);n>0;--n){r[e.dec(i)]=t.dec(i)}return r}}}(Le,Le);function Ke(e,t){return(t||Le).dec(function(e){let t=ArrayBuffer.isView(e)?new DataView(e.buffer,e.byteOffset,e.byteLength):new DataView(e),i=0;return{peek:()=>t.getUint8(i),get(e){i+=e;const r=t.byteOffset;return t.buffer.slice(r+i-e,r+i)},getI8:()=>t.getInt8(i++),getI16:()=>(i+=2,t.getInt16(i-2)),getI32:()=>(i+=4,t.getInt32(i-4)),getI64:()=>(i+=8,4294967296*t.getInt32(i-8)+t.getUint32(i-4)),getUi8:()=>t.getUint8(i++),getUi16:()=>(i+=2,t.getUint16(i-2)),getUi32:()=>(i+=4,t.getUint32(i-4)),getUi64:()=>(i+=8,4294967296*t.getUint32(i-8)+t.getUint32(i-4)),getF32:()=>(i+=4,t.getFloat32(i-4)),getF64:()=>(i+=8,t.getFloat64(i-8))}}(e))}var qe,ze,Ye,Je=Object.defineProperty,Xe=Object.defineProperties,Qe=Object.getOwnPropertyDescriptors,Ze=Object.getOwnPropertySymbols,et=Object.prototype.hasOwnProperty,tt=Object.prototype.propertyIsEnumerable,it=Math.pow,rt=(e,t,i)=>t in e?Je(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i,nt=(e,t)=>{for(var i in t||(t={}))et.call(t,i)&&rt(e,i,t[i]);if(Ze)for(var i of Ze(t))tt.call(t,i)&&rt(e,i,t[i]);return e},at=(e,t)=>Xe(e,Qe(t)),st=(e,t,i)=>new Promise(((r,n)=>{var a=e=>{try{o(i.next(e))}catch(e){n(e)}},s=e=>{try{o(i.throw(e))}catch(e){n(e)}},o=e=>e.done?r(e.value):Promise.resolve(e.value).then(a,s);o((i=i.apply(e,t)).next())})),ot=class{createJoinLink(e){return st(this,null,(function*(){return{join_link:"nop"}}))}removeJoinLink(e){return st(this,null,(function*(){return{success:!0}}))}getAnonymTokenByLink(e,t){return st(this,null,(function*(){return""}))}log(e){}prepareUserIds(e){return st(this,null,(function*(){}))}getCachedOkIdByExternalId(e){return null}cacheExternalId(e,t){}hangupConversation(e){}removeHistoryRecords(e){return st(this,null,(function*(){}))}cleanup(){}},ct=class{log(e,t,i=!1){}destroy(){}},dt=class{constructor(){this._handlers={},this._listeners=[]}_triggerEvent(e,...t){if(this._handlers.hasOwnProperty(e))for(let i of this._handlers[e])i.apply(this,t)}addEventListener(e,t){if("function"!=typeof t)throw new Error("Listener should be a function");return this._handlers.hasOwnProperty(e)||(this._handlers[e]=[]),this._handlers[e].push(t),{dispose:this.removeEventListener.bind(this,e,t)}}removeEventListener(e,t){if(!this._handlers.hasOwnProperty(e))return;t||delete this._handlers[e];let i=this._handlers[e].indexOf(t);i>=0&&this._handlers[e].splice(i,1)}subscribe(e,t,i){let r=e.addEventListener(t,i);this._listeners.push(r)}unsubscribe(){this._listeners.forEach((e=>{e.dispose()}))}},lt=class extends dt{get ready(){return!0}setParticipantIdRegistry(e){}requestRealloc(){}setEndpoint(e){}setConversationId(e){}readyToSend(){}cleanup(){}requestTestMode(e,t){}getNextCommandSequenceNumber(){return 0}},ut=((qe=ut||{}).INCOMING="INCOMING",qe.OUTGOING="OUTGOING",qe.JOINING="JOINING",qe),pt=ut,ht=(e=>(e.USER="USER",e.GROUP="GROUP",e.CHAT="CHAT",e))(ht||{}),_t=ht,ft=((ze=ft||{}).ATTENDEE="ATTENDEE",ze.HAND_UP="HAND_UP",ze),mt=ft,gt=(e=>(e.ADD_PARTICIPANT="ADD_PARTICIPANT",e.RECORD="RECORD",e))(gt||{}),vt=gt,St=((Ye=St||{}).REQUIRE_AUTH_TO_JOIN="REQUIRE_AUTH_TO_JOIN",Ye.AUDIENCE_MODE="AUDIENCE_MODE",Ye.WAITING_HALL="WAITING_HALL",Ye.ASR="ASR",Ye),Et=St;var yt,Tt,Ct,Rt,It=((yt=It||{}).CAMERA_PERMISSION="camera",yt.MIC_PERMISSION="mic",yt.CAMERA_ACCESS="cameralock",yt.MIC_ACCESS="miclock",yt.MIC_NOT_FOUND="nomic",yt.SCREEN_PERMISSION="screenpermission",yt.SCREEN_ACCESS="screenlock",yt.CONNECTION="connection",yt.NETWORK="network",yt.UNKNOWN="unknown",yt.UNSUPPORTED="unsupported",yt.SIGNALING_FAILED="signalingfailed",yt.API="api",yt.AUTH="auth",yt),At=It,Pt=((Tt=Pt||{}).CANCELED="CANCELED",Tt.REJECTED="REJECTED",Tt.REMOVED="REMOVED",Tt.HUNGUP="HUNGUP",Tt.MISSED="MISSED",Tt.BUSY="BUSY",Tt.FAILED="FAILED",Tt.NETWORK_ERROR="NETWORK_ERROR",Tt.KILLED="KILLED",Tt.BANNED="BANNED",Tt.HAS_ACTIVE_CALL="HAS_ACTIVE_CALL",Tt.CALLER_IS_BLOCKED="CALLER_IS_BLOCKED",Tt.NOT_FRIENDS="NOT_FRIENDS",Tt.CALLEE_IS_OFFLINE="CALLEE_IS_OFFLINE",Tt.CALLER_IS_REJECTED="CALLER_IS_REJECTED",Tt.UNKNOWN_ERROR="UNKNOWN_ERROR",Tt.UNSUPPORTED="UNSUPPORTED",Tt.OLD_VERSION="OLD_VERSION",Tt.SERVICE_DISABLED="SERVICE_DISABLED",Tt.EXTERNAL_API_ERROR="EXTERNAL_API_ERROR",Tt.SOCKET_CLOSED="SOCKET_CLOSED",Tt.ENDED="ENDED",Tt.KILLED_WITHOUT_DELETE="KILLED_WITHOUT_DELETE",Tt.ANOTHER_DEVICE="ANOTHER_DEVICE",Tt),bt=Pt,Ot=(e=>(e.AUDIO="AUDIO",e.VIDEO="VIDEO",e.SCREEN_SHARING="SCREEN_SHARING",e))(Ot||{}),Dt=Ot,wt=(e=>(e.UNMUTE="UNMUTE",e.MUTE="MUTE",e.MUTE_PERMANENT="MUTE_PERMANENT",e))(wt||{}),Nt=wt,kt=(e=>(e.CALLED="CALLED",e.ACCEPTED="ACCEPTED",e.REJECTED="REJECTED",e.HUNGUP="HUNGUP",e))(kt||{}),Lt=kt,Mt=(e=>(e.START="start",e.ACCEPT="accept",e.JOIN="join",e.RETRY="retry",e))(Mt||{}),Ut=Mt,xt=(e=>(e.NOTIFICATION="NOTIFICATION",e.FAILED="FAILED",e.RECONNECT="RECONNECT",e))(xt||{}),Bt=xt,Vt=((Ct=Vt||{}).TRANSMITTED_DATA="transmitted-data",Ct.ACCEPTED_CALL="accepted-call",Ct.HUNGUP="hungup",Ct.PARTICIPANT_ADDED="participant-added",Ct.PARTICIPANT_JOINED="participant-joined",Ct.CLOSED_CONVERSATION="closed-conversation",Ct.MEDIA_SETTINGS_CHANGED="media-settings-changed",Ct.PARTICIPANT_STATE_CHANGED="participant-state-changed",Ct.RATE_CALL_DATA="rate-call-data",Ct.FEATURE_SET_CHANGED="feature-set-changed",Ct.TOPOLOGY_CHANGED="topology-changed",Ct.PRODUCER_UPDATED="producer-updated",Ct.CONSUMER_ANSWERED="consumer-answered",Ct.MULTIPARTY_CHAT_CREATED="multiparty-chat-created",Ct.FORCE_MEDIA_SETTINGS_CHANGE="force-media-settings-change",Ct.SETTINGS_UPDATE="settings-update",Ct.VIDEO_QUALITY_UPDATE="video-quality-update",Ct.REGISTERED_PEER="registered-peer",Ct.SWITCH_MICRO="switch-micro",Ct.RECORD_STARTED="record-started",Ct.RECORD_STOPPED="record-stopped",Ct.REALLOC_CON="realloc-con",Ct.AUDIO_ACTIVITY="audio-activity",Ct.SPEAKER_CHANGED="speaker-changed",Ct.STALLED_ACTIVITY="stalled-activity",Ct.CHAT_MESSAGE="chat-message",Ct.CUSTOM_DATA="custom-data",Ct.ROLES_CHANGED="roles-changed",Ct.MUTE_PARTICIPANT="mute-participant",Ct.PIN_PARTICIPANT="pin-participant",Ct.OPTIONS_CHANGED="options-changed",Ct.NETWORK_STATUS="network-status",Ct.PARTICIPANT_SOURCES_UPDATE="participant-sources-update",Ct.PROMOTE_PARTICIPANT="promote-participant",Ct.CHAT_ROOM_UPDATED="chat-room-updated",Ct.PROMOTION_APPROVED="promotion-approved",Ct.JOIN_LINK_CHANGED="join-link-changed",Ct.MOVIE_UPDATE_NOTIFICATION="movie-update-notification",Ct.MOVIE_SHARE_INFO="movie-share-info",Ct.MOVIE_SHARE_STARTED="movie-share-started",Ct.MOVIE_SHARE_STOPPED="movie-share-stopped",Ct),Ft=Vt,Gt=((Rt=Gt||{}).ERROR="callError",Rt.DEVICES="callDevices",Rt.CALL_SPEC_ERROR="callSpecError",Rt.ICE_CONNECTION_STATE="callIceConnectionState",Rt.ICE_CONNECTION_TYPE="callIceConnectionType",Rt.ICE_RESTART="callIceRestart",Rt.PUSH="callPush",Rt.OUTGOING_CALL="callStart",Rt.OUTGOING_MULTIPARTY_CALL="callStartMultiparty",Rt.JOIN_CONVERSATION="callJoinConversation",Rt.ACCEPTED_OUTGOING="callAcceptedOutgoing",Rt.ACCEPT_INCOMING="callAcceptIncoming",Rt.DECLINE_INCOMING="callDeclineIncoming",Rt.ACCEPT_CONCURRENT="callAcceptConcurrent",Rt.HANGUP="callHangup",Rt.MEDIA_STATUS="callMediaStatus",Rt.DEVICE_CHANGED="callDeviceChanged",Rt.SOCKET_ACTION="callSocketAction",Rt.ADD_PARTICIPANT="callAddParticipant",Rt.REMOVE_PARTICIPANT="callRemoveParticipant",Rt.POOR_CONNECTION="callPoorConnection",Rt.TOPOLOGY_CHANGE_REQUESTED="callTopologyChangeRequested",Rt.RELAY_POLICY="callForceRelay",Rt.PAT_ALLOCATED="patAllocate",Rt.PAT_DEALLOCATED="patDeallocate",Rt.PAT_ERROR="patError",Rt.PAT_WAITING_TIME_ERROR="patWaitingTimeError",Rt.PAT_OUTDATED_RESPONSE="patOutdatedResponse",Rt),Ht=Gt,jt=(e=>(e.AUDIO_MIX="audio-mix",e.PARTICIPANT_AGNOSTIC_TRACK_PREFIX="pat",e))(jt||{}),Wt=jt,$t=(e=>(e.NO_AVAILABLE_TRACKS="no-available-tracks",e.UNKNOWN_ERROR="unknown-error",e))($t||{}),Kt=$t;var qt=(e=>(e.CREATOR="CREATOR",e.ADMIN="ADMIN",e))(qt||{}),zt=qt;function Yt(e,t){if(e.length!==t.length)return!1;for(let i of e)if(!t.includes(i))return!1;return!0}var Jt=(e=>(e.USER="USER",e.GROUP="GROUP",e))(Jt||{}),Xt=Jt,Qt=2097152,Zt=102400,ei="_okcls_logs_session_";function ti(){return`${ei}${Date.now()}`}function ii(e){return new Blob([e]).size}function ri(e){try{window.localStorage.removeItem(e)}catch(e){console.error("Failed to remove log from storage",e)}}function ni(){let e=di.toString();if(!ci.available||!e)return;let t=ii(e);ci.cleanup(t);try{window.localStorage.setItem(li,e)}catch(e){return console.warn("Failed to write log to storage",e),ci.storageSize=ci.size+t,ci.cleanup(Zt+t),ci.available>=Zt+t?void ni():t>Zt?(di.bisect(),void ni()):void(ci.storageSize=0)}t>524288&&(ci.add(li,t),li=ti(),di.clear(),ci.cleanup(Zt))}function ai(){!ci.available||!di.length||ni()}function si(e=!1){let t=[];try{let e=window.localStorage;for(let i of ci.items){let r=e.getItem(i.key);t.push(r)}let i=di.toString();i&&t.push(i)}catch(e){console.error("Storage is blocked",e)}let i=`[${t.join(",")}]`;if(e)return i;let r=`logs_${Date.now()}.json`;return function(e,t){let i=document.createElement("a"),r=new Blob([e],{type:"text/json"});i.href=URL.createObjectURL(r),i.download=t,i.click()}(i,r),r}function oi(){ci||(ci=new class{constructor(){this._items=[],this._itemsSize=0,this._storageSize=Qt;try{let e=window.localStorage;for(let t of Object.keys(e)){if(0!==t.indexOf(ei))continue;let i=e.getItem(t);if(!i){ri(t);continue}let r=ii(i);this.add(t,r)}}catch(e){console.error("Storage is blocked",e),this._storageSize=0}this._items.sort(((e,t)=>e.date-t.date)),this.cleanup(Zt)}get size(){return this._itemsSize}get length(){return this._items.length}get available(){return Math.max(this._storageSize-this._itemsSize,0)}get items(){return this._items}set storageSize(e){this._storageSize=e}add(e,t){let i=parseInt(e.replace(ei,""),10);this._itemsSize+=t,this._items.push({key:e,size:t,date:i})}deleteOldestItem(){let e=this._items.shift();e&&(ri(e.key),this._itemsSize-=e.size)}cleanup(e){for(;this.length&&(this.size>Qt||this.length>4||this.size+e>this.available);)this.deleteOldestItem()}},di=new class{constructor(){this._items=[]}get length(){return this._items.length}push(e){this._items.push(e)}shift(){return this._items.shift()||null}bisect(){let e=this.length>1?Math.floor(this.length/2):1;this._items=this._items.slice(e)}clear(){this._items=[]}toString(){return this._items.length?JSON.stringify(this._items,((e,t)=>t instanceof Error?String(t):t)):""}},li=ti(),window.addEventListener("beforeunload",ai))}var ci,di,li,ui=null;window.__VKCallsSDKLogs__=(e=!1)=>(ci||oi(),ai(),si(e));var pi,hi,_i=((pi=_i||{}).INIT="init",pi.READY="ready",pi.FRAME="frame",pi.ERROR="error",pi.DEBUG="debug",pi.LOG_ERROR="log_error",pi),fi=class extends ct{constructor(e,t){super(),this._batchInterval=3e3,this._batch=[],this._batchTimeout=null,this._api=e,this._externalLogger=t}_send(e){this._api.log(e)}_sendBatch(){this._stopTimeout(),this._batch.length>0&&(this._send(this._batch),this._batch=[],this._startTimeout())}_startTimeout(){this._batchTimeout=window.setTimeout((()=>this._sendBatch()),this._batchInterval)}_stopTimeout(){this._batchTimeout&&(clearTimeout(this._batchTimeout),this._batchTimeout=null)}_onUnload(){this._sendBatch(),this._stopTimeout()}log(e,t,i=!1){let r={};void 0!==t&&(r.param=t),this._logInternal(e,r,i),this._externalLogger&&this._externalLogger.log(e,t,i)}logCustom(e,t,i=!1){this._logInternal(e,t,i)}_logInternal(e,t,i){let r={type:1,time:0,operation:e,timestamp:Date.now(),custom:t,uid:this._api.getUserId()};this._batch.push(r),(i||!this._batchTimeout)&&this._sendBatch()}destroy(){this._sendBatch(),this._stopTimeout(),this._externalLogger&&this._externalLogger.destroy()}static create(e,t){fi._instance||(fi._instance=new fi(e,t))}static log(e,t,i=!1){fi._instance&&fi._instance.log(e,t,i)}static logCustom(e,t,i=!1){fi._instance&&fi._instance.logCustom(e,t,i)}static destroy(){fi._instance&&fi._instance.destroy(),fi._instance=null}},mi=class{constructor(){this._worker=null}_createWorker(e,t){return st(this,arguments,(function*(e,t,i=[],r={},n=[]){return new Promise(((a,s)=>{let o=i.join(","),c=new Blob([e,`exports.default(${o});`],{type:"application/javascript; charset=utf-8"}),d=window.URL.createObjectURL(c);this._worker=new Worker(d),this._worker.onmessage=e=>{switch(e.data.type){case _i.READY:a();break;case _i.ERROR:s(e.data.error);break;case _i.FRAME:t(e.data);break;case _i.DEBUG:Fr.debug(e.data.message);break;case _i.LOG_ERROR:fi.log(Ht.ERROR,e.data.message)}},this._sendToWorker(_i.INIT,r,n)}))}))}_removeWorker(){var e;null==(e=this._worker)||e.terminate(),this._worker=null}_sendToWorker(e,t={},i=[]){var r;null==(r=this._worker)||r.postMessage(Object.assign({type:e},t),i)}static isBrowserSupported(){throw new Error("Not implemented")}},gi=class extends mi{init(e){return st(this,null,(function*(){Fr.debug("LibVPxDecoder started"),yield this._createWorker('var exports=(()=>{var b=Object.defineProperty;var E=a=>b(a,"__esModule",{value:!0});var M=(a,p)=>{E(a);for(var e in p)b(a,e,{get:p[e],enumerable:!0})};var V={};M(V,{default:()=>D});var t=(s=>(s.INIT="init",s.READY="ready",s.FRAME="frame",s.ERROR="error",s.DEBUG="debug",s.LOG_ERROR="log_error",s))(t||{});var D=(a,p)=>{let e=null,n=null,g=!0;function y(){return a({locateFile:p}).then(r=>n=r)}function s(r,m,l,R,x){if(!n){self.postMessage({type:t.LOG_ERROR,message:"decoder-init-fail-libvpx"}),self.postMessage({type:t.FRAME,error:"Fatal initialization error"});return}if(g!==l&&(g=l,e&&(e=null,self.postMessage({type:t.DEBUG,message:`LibVPxDecoder codec changed to ${l?"VP9":"VP8"} - reinitialize`}))),!e&&(self.postMessage({type:t.DEBUG,message:`LibVPxDecoder codec ${l?"VP9":"VP8"}`}),e=new n.VpxDecoder,e.debug(x),!e.init(l?n.VpxType.VP9:n.VpxType.VP8))){e=null,self.postMessage({type:t.FRAME,error:"Decoder failed to create"});return}try{e.allocateBuffer(m.byteLength).set(new Uint8Array(m))}catch(o){self.postMessage({type:t.DEBUG,message:o}),e=null,self.postMessage({type:t.FRAME,error:String(o)});return}if(!(e.decode()&&e.nextImage())){self.postMessage({type:t.FRAME,error:"Decode failed"});return}let d=e.getImageBuffer();if(!d){self.postMessage({type:t.FRAME,error:"No decoded data"});return}let c=e.getImageWidth(),f=e.getImageHeight();e.nextImage()&&(self.postMessage({type:t.DEBUG,message:"LibVPxDecoder dropped frame"}),self.postMessage({type:t.LOG_ERROR,message:"LibVPxDecoder-drop"}));let i=new Uint8ClampedArray(d.byteLength);if(i.set(d),R){let o=new ImageData(i,c,f);createImageBitmap(o,0,0,c,f).then(u=>{self.postMessage({type:t.FRAME,data:u},[u]),u.close()})}else self.postMessage({type:t.FRAME,data:i.buffer,width:c,height:f},[i.buffer])}y().then(()=>{self.onmessage=r=>{switch(r.data.type){case t.FRAME:s(r.data.timestamp,r.data.data,r.data.isVP9,r.data.useImageBitmap,r.data.debug);break}},self.postMessage({type:t.READY})}).catch(r=>{self.postMessage({type:t.ERROR,error:String(r)})})};return V;})();\n',(t=>{if(t.error)Fr.warn("LibVPxDecoder",t.error);else if(t.data instanceof ArrayBuffer){let i=new ImageData(new Uint8ClampedArray(t.data),t.width,t.height);e(i)}else e(t.data)}),[me(),me().getUrl])}))}decodeFrame(e,t,i,r){let n="ImageBitmap"in window;this._sendToWorker(_i.FRAME,{timestamp:e,data:t.buffer,isVP9:i,keyFrame:r,useImageBitmap:n,debug:Fr.enabled()},[t.buffer])}destroy(){this._removeWorker(),Fr.debug("LibVPxDecoder destroyed")}static isBrowserSupported(){return"WebAssembly"in window&&"Worker"in window}},vi="_okcls_",Si=(()=>{try{let e=Date.now().toString(),t=window.localStorage,i=!1;return t.setItem(e,e),i=t.getItem(e)===e,t.removeItem(e),i?t:null}catch(e){return null}})();(e=>{e.get=function(e){return function(e){let t=Si?Si.getItem(vi+e):null;if(null===t)return null;try{return JSON.parse(t)}catch(e){return null}}(e)||null},e.set=function(e,t){!function(e,t){try{Si&&Si.setItem(vi+e,JSON.stringify(t))}catch(e){}}(e,t)},e.remove=function(e){!function(e){Si&&Si.removeItem(vi+e)}(e)}})(hi||(hi={}));var Ei=hi;function yi(e,t){if(e.isAudioEnabled!==t.isAudioEnabled||e.isVideoEnabled!==t.isVideoEnabled||e.isScreenSharingEnabled!==t.isScreenSharingEnabled||e.videoStreams.length!==t.videoStreams.length)return!1;for(let i of e.videoStreams)if(!t.videoStreams.find((e=>e.id===i.id&&e.source===i.source)))return!1;return!0}function Ti(e){return Object.assign({isAudioEnabled:!1,isVideoEnabled:!1,isScreenSharingEnabled:!1,videoStreams:[]},e||{})}var Ci,Ri=e=>e.stop(),Ii=e=>e.getVideoTracks().forEach(Ri),Ai=class extends Error{constructor(e,t){super(),this.name="HangupReason",this.code=t&&t.code||0,this.remote=t&&t.remote||!1,Object.values(bt).indexOf(e)>-1?this.hangup=e:this.error=e;let i=[];this.error&&i.push("error"),this.remote&&i.push("remote"),this.code&&i.push(`code: ${this.code}`),t&&t.message&&i.push(`message: '${t.message}'`),this.message=e+(i.length?` (${i.join(", ")})`:""),Error.captureStackTrace&&Error.captureStackTrace(this,Ai)}},Pi=(e=>(e.SOURCE_CHANGED="SOURCE_CHANGED",e.TRACK_REPLACED="TRACK_REPLACED",e.SCREEN_STATUS="SCREEN_STATUS",e))(Pi||{}),bi=(e=>(e.audio="audio",e.video="video",e.screen="screen",e))(bi||{}),Oi=class extends dt{constructor(){super(),this._stream=null,this._trackVideoStreamBackup=null,this._screenTrack=null,this._sendVideoTrack=null,this._mediaSettings=Ti(),this._videoStatusOnScreenCapturingEnabled=!1,this._effect=null,this._initDeviceChangeListener()}request(){return st(this,arguments,(function*(e=[Dt.AUDIO],t=!0){if(this._stream)return;let i=e.includes(Dt.VIDEO),r=e.includes(Dt.AUDIO);if(!dr.isBrowserSupported())throw new Ai(At.UNSUPPORTED);try{this._stream=yield dr.getUserMedia(i,r,t),this._mediaSettings.isVideoEnabled=i&&this._stream.getVideoTracks().filter((e=>e.enabled)).length>0||!1,this._mediaSettings.isAudioEnabled=r&&this._stream.getAudioTracks().filter((e=>e.enabled)).length>0||!1}catch(e){throw new Ai(e)}}))}getStream(){return this._stream}getScreenTrack(){return this._screenTrack}getSendVideoTrack(e=!1){return this._sendVideoTrack&&!e?this._sendVideoTrack:this._stream?this._stream.getVideoTracks()[0]:null}_getSendAudioTrack(){var e;return(null==(e=this._stream)?void 0:e.getAudioTracks()[0])||null}addTrackToPeerConnection(e,t,i,r){let n=this.getStream(),a=this._getSendAudioTrack(),s=this.getSendVideoTrack(i);if(!n||!a&&!s&&!t)throw new Error("No local stream found");if(a&&!t){if(r){let{codecs:t}=RTCRtpSender.getCapabilities("audio"),i="audio/red",r=48e3,n=t.findIndex((e=>e.mimeType===i&&e.clockRate===r));if(n>=0){let i=[];i.push(t[n]);for(let e=0;e<t.length;e++)e!==n&&i.push(t[e]);e.getTransceivers().forEach((e=>e.setCodecPreferences(i)))}}e.addTrack(a,n)}s&&!t&&e.addTrack(s,n)}getMediaSettings(){return this._mediaSettings}changeDevice(e){return st(this,null,(function*(){switch(e){case"videoinput":return this._changeVideoInput();case"audioinput":return this._changeAudioInput();default:return Promise.reject()}}))}setVideoStream(e,t){return st(this,null,(function*(){return t?this._changeScreen(e):this._changeVideoInput(e)}))}_initDeviceChangeListener(){if(!navigator.mediaDevices||!navigator.mediaDevices.enumerateDevices||!navigator.mediaDevices.addEventListener)return;let e=!1,t=!1,i=Ui.throttle((()=>{t&&this._changeVideoInput().catch((()=>{})),e&&this._changeAudioInput().catch((()=>{})),e=!1,t=!1}),1e3);this._onDeviceChange=()=>st(this,null,(function*(){if(!this._stream)return;let r=this._stream.getAudioTracks()[0],n=r&&r.enabled&&r.getSettings(),a=n&&n.deviceId,s=this._stream.getVideoTracks()[0],o=s&&s.enabled&&s.getSettings(),c=o&&o.deviceId;if(!a&&!c)return;let d=yield navigator.mediaDevices.enumerateDevices();!e&&a&&(e=!d.find((e=>e.deviceId===a))),!t&&c&&(t=!d.find((e=>e.deviceId===c))),i()})),navigator.mediaDevices.addEventListener("devicechange",this._onDeviceChange)}_destroyDeviceChangeListener(){this._onDeviceChange&&navigator.mediaDevices.removeEventListener("devicechange",this._onDeviceChange)}_changeVideoInput(e=null){return st(this,null,(function*(){try{let t=e?"stream":"video",i=e||(yield dr.getUserVideo(void 0,!!this._effect));if(this._stream){Ar.consumerScreenTrack||this._disableScreenCapture();let e=this._getVideoEffectTrack(i),r=yield this._videoEffect(this._effect,e);this._stopLocalTrack("video"),fi.log(Ht.DEVICE_CHANGED,t),Fr.log("Video stream changed"),yield this._replaceLocalTrack(r),this._mediaSettings.isVideoEnabled=!0,this._triggerEvent("SOURCE_CHANGED",{kind:"video",mediaSettings:this._mediaSettings})}else i.getTracks().forEach((e=>e.stop()))}catch(e){throw fi.log(Ht.ERROR,"change_video"),Fr.warn("Camera change failed",e),e}}))}_getVideoEffectTrack(e){let t;return this._effect?(this._trackVideoStreamBackup||(this._trackVideoStreamBackup=e.getVideoTracks()[0].clone()),t=this._trackVideoStreamBackup.clone(),Ii(e)):this._trackVideoStreamBackup?(t=this._trackVideoStreamBackup.clone(),this._stopAndRemoveTrackVideoStreamBackup(),Ii(e)):t=e.getVideoTracks()[0],t}setAudioStream(e){return st(this,null,(function*(){return this._changeAudioInput(e)}))}_changeAudioInput(e=null){return st(this,null,(function*(){try{if(e=e||(yield dr.getUserAudio()),this._stream){let t=e.getAudioTracks()[0];this._stopLocalTrack("audio"),fi.log(Ht.DEVICE_CHANGED,"audio"),Fr.log("Audio stream changed"),yield this._replaceLocalTrack(t),this._mediaSettings.isAudioEnabled=!0,this._triggerEvent("SOURCE_CHANGED",{kind:"audio",mediaSettings:this._mediaSettings})}else e.getTracks().forEach((e=>e.stop()))}catch(e){throw fi.log(Ht.ERROR,"change_audio"),Fr.error("Microphone change failed",e),e}}))}_changeScreen(e){return st(this,null,(function*(){try{if((e=e||(yield dr.getScreenMedia())).addEventListener("inactive",(()=>{this._mediaSettings.isScreenSharingEnabled&&this.toggleScreenCapturing(!1)}),!1),this._stream){let t=e.getVideoTracks()[0],i=Ar.consumerScreenTrack?t:yield this._videoEffect(null,t);fi.log(Ht.DEVICE_CHANGED,"screen"),Fr.log("Screen capturing started"),this._screenTrack=i,this._mediaSettings.isScreenSharingEnabled=!0,Ar.consumerScreenTrack||(this._videoStatusOnScreenCapturingEnabled=this._mediaSettings.isVideoEnabled,this._mediaSettings.isVideoEnabled=!0,this._stopLocalTrack("video"),this._sendVideoTrack=Ar.consumerScreenDataChannel?dr.getBlackMediaTrack(Ar.videoMinWidth,Ar.videoMinHeight):i,yield this._replaceLocalTrack(i,this._sendVideoTrack)),this._triggerEvent("SCREEN_STATUS",{track:i,mediaSettings:this._mediaSettings}),this._triggerEvent("SOURCE_CHANGED",{kind:"screen",mediaSettings:this._mediaSettings})}else e.getTracks().forEach((e=>e.stop()))}catch(e){throw fi.log(Ht.ERROR,"screen"),Fr.warn("Screen capturing failed",e),e}}))}_disableScreenCapture(){this._sendVideoTrack&&(this._sendVideoTrack.stop(),this._sendVideoTrack=null),this._screenTrack&&(this._screenTrack.stop(),this._screenTrack=null),this._mediaSettings.isScreenSharingEnabled&&(this._mediaSettings.isScreenSharingEnabled=!1,this._triggerEvent("SCREEN_STATUS",{mediaSettings:this._mediaSettings}),this._triggerEvent("SOURCE_CHANGED",{kind:"screen",mediaSettings:this._mediaSettings}))}_replaceLocalTrack(e,t){return st(this,null,(function*(){!this._stream||this._stream.getTracks().forEach((i=>{var r,n;i.kind===e.kind&&(null==(r=this._stream)||r.removeTrack(i),null==(n=this._stream)||n.addTrack(e),this._triggerEvent("TRACK_REPLACED",e,t))}))}))}_stopLocalTrack(e){this._stream&&this._stream.getTracks().forEach((t=>{t.kind===e&&t.stop()}))}_videoEffect(e,t){return st(this,null,(function*(){if(!Ar.videoEffects)return t;try{return fi.log(Ht.DEVICE_CHANGED,`effect_${e}`),Ar.videoEffects.setEffect(e,t)}catch(e){return Fr.warn("Video effect failed",e),t}}))}_stopAndRemoveTrackVideoStreamBackup(){this._trackVideoStreamBackup&&(this._trackVideoStreamBackup.stop(),this._trackVideoStreamBackup=null)}destroy(){this._destroyDeviceChangeListener(),Ar.videoEffects&&(this._effect=null,Ar.videoEffects.destroy()),this._stream&&(this._stream.getTracks().forEach(Ri),this._stream=null),this._stopAndRemoveTrackVideoStreamBackup(),this._disableScreenCapture()}toggleScreenCapturing(e){return st(this,null,(function*(){return e?this._changeScreen():Ar.consumerScreenTrack?this._disableScreenCapture():this._videoStatusOnScreenCapturingEnabled?this._changeVideoInput():this.toggleVideo(!1)}))}toggleVideo(e){return st(this,null,(function*(){if(!this._stream)return;let t;if(Ar.consumerScreenTrack||this._disableScreenCapture(),e){let e=yield dr.getUserVideo(void 0,!!this._effect);t=this._getVideoEffectTrack(e),t=yield this._videoEffect(this._effect,t)}else t=dr.getBlackMediaTrack(Ar.videoMinWidth,Ar.videoMinHeight),t=yield this._videoEffect(null,t),this._stopAndRemoveTrackVideoStreamBackup();this._stopLocalTrack("video"),yield this._replaceLocalTrack(t),this._mediaSettings.isVideoEnabled=e,this._triggerEvent("SOURCE_CHANGED",{kind:"video",mediaSettings:this._mediaSettings})}))}toggleAudio(e){return st(this,null,(function*(){if(!this._stream)return;let t;t=e?(yield dr.getUserAudio()).getAudioTracks()[0]:dr.getSilentMediaTrack(),this._stopLocalTrack("audio"),yield this._replaceLocalTrack(t),this._mediaSettings.isAudioEnabled=e,this._triggerEvent("SOURCE_CHANGED",{kind:"audio",mediaSettings:this._mediaSettings})}))}setResolution(e,t){return st(this,null,(function*(){if(!Ar.consumerScreenTrack&&this._mediaSettings.isScreenSharingEnabled)return;if(!this._stream)throw new Error("Local stream not found");let i=this._stream.getVideoTracks()[0];if(!i)throw new Error("Local video track not found");if(i.enabled){if(!this._effect)return i.applyConstraints({width:{ideal:e},height:{ideal:t}});yield this.toggleVideo(!1),yield this.toggleVideo(!0)}}))}updateNoiseSuppression(){return st(this,null,(function*(){if(!this._stream||!this._mediaSettings.isAudioEnabled)return;let e=this._stream.getAudioTracks()[0];if(!e)throw new Error("Local audio track not found");return e.enabled?e.applyConstraints({noiseSuppression:Ar.noiseSuppression}):void 0}))}videoEffect(e){return st(this,null,(function*(){if(!Ar.videoEffects)throw new Error("Video Effects library is not set");if(!Ar.consumerScreenTrack&&this._mediaSettings.isScreenSharingEnabled)throw new Error("Can't apply effect to screensharing");if(this._mediaSettings.isVideoEnabled)return this._stream&&e!==this._effect?(this._effect=e,this._changeVideoInput(this._stream)):void 0;this._effect=e}))}},Di=":",wi="a=fmtp:";(e=>{e.patchSDP=function(e,t,i,r,n,a=!1,s=!1){let o="\r\n";if(!(t||i||r||s||a||n))return e;function c(e,t,i){let r,n=e.split(" "),a=n.slice(0,3);for(r=3;r<n.length;r++)i.includes(n[r])&&a.push(n[r]);for(r=3;r<n.length;r++)!i.includes(n[r])&&!t.includes(n[r])&&a.push(n[r]);return a.join(" ")}function d(e,t){let i,r=new RegExp("a=rtpmap:(\\d+) ([a-zA-Z0-9-]+)\\/\\d+"),n=[];for(i=0;i<e.length;++i){let a=e[i].match(r);a&&3===a.length&&a[2]===t&&n.push(a[1])}return n}function l(e,t,i,r){let n,a="m="+t;for(n=0;n<e.length;++n)if(e[n].startsWith(a)){e[n]=c(e[n],i,r);break}}let u=e.split(/[\r\n]+/);return(i||t||n)&&function(e){let r=d(e,"H264");if(i){let t,i=r.slice(0),n=new RegExp(wi+"(\\d+) apt=(\\d+)");for(t=0;t<e.length;++t){let r=e[t].match(n);r&&3===r.length&&i.includes(r[2])&&i.push(r[1])}let a=new RegExp("a=(rtpmap|rtcp-fb|fmtp):(\\d+) .*");for(t=e.length;t--;){let r=e[t].match(a);r&&3===r.length&&i.includes(r[2])&&e.splice(t,1)}l(e,"video",i,[])}else t&&l(e,"video",[],r),n&&function(e,t){let i=new RegExp(wi+"(\\d+)");for(let r=0;r<e.length;++r){let n=e[r].match(i);if(n&&2===n.length&&t.includes(n[1])){let t=e[r].trim()===wi+n[1]?" ":";";e[r]+=t+"sps-pps-idr-in-keyframe=1"}}}(e,r)}(u),r&&function(e){let t=d(e,"VP9");r&&l(e,"video",[],t)}(u),s&&function(e){let t=d(e,"red");t.length>0&&l(e,"audio",[],t)}(u),a&&function(e){let t=e.findIndex((e=>e.startsWith("a=rtcp-fb:111")));~t&&(e[t]=e[t]+o+["a=rtcp-fb:111 nack","a=rtcp-fb:111 nack pli"].join(o))}(u),u.join(o)},e.getPeerIdString=function(e){return e?`${e.type||"WEB_SOCKET"}_${e.id}`:"_"},e.comparePeerId=function(e,t){return e&&e.id===t.id&&(e.type||"WEB_SOCKET")===(t.type||"WEB_SOCKET")},e.getPeerConnectionHostInfo=function(e){return st(this,null,(function*(){return e&&e.getStats?e.getStats(null).then((e=>{let t=null,i=null;if(e.forEach((t=>{"transport"===t.type&&t.selectedCandidatePairId?i=e.get(t.selectedCandidatePairId):"candidate-pair"===t.type&&"succeeded"===t.state&&!i&&(!t.hasOwnProperty("selected")||t.selected)&&(i=t)})),i&&i.localCandidateId){let r=e.get(i.localCandidateId);r&&(t={type:r.candidateType,ip:r.ip||r.ipAddress,port:r.port||r.portNumber})}return t})).catch((()=>null)):Promise.resolve(null)}))};let t=/^[0-9]+$/,i=/^([gu])([0-9]+)$/;function r(e,r){let n=String(e);return i.test(n)?(Fr.warn(`Already composite id [${e}] type supplied [${r}]`),n):r===Xt.GROUP?"g"+n:r===Xt.USER?"u"+n:(Fr.warn(`Unknown type [${r}] for id [${e}]`),n.match(t)?"u"+n:n)}function n(e,t,i){return a(r(e,t),i)}function a(e,t){return t?e+Di+"d"+t:e}function s(e){return n(e.id,e.idType||Xt.USER,e.deviceIdx||0)}function o(e){let t=String(e),r=t.match(i);return r?{id:Number(r[2]),type:"g"===r[1]?Xt.GROUP:Xt.USER}:(Fr.warn(`Unsupported compositeId [${e}]`),{id:Number(t),type:Xt.USER})}function c(e){let t=e.split(":d");return{compositeUserId:t[0],deviceIdx:t.length>1?parseInt(t[1],10):0}}function d(e,t,i,r,n){var a;if(e&&i&&i.kind===bi.video){let s=i.getSettings();if(s){let o=e.maxBitrateK?1024*e.maxBitrateK:null,c=s.width,d=s.height,l=c&&d&&e.maxDimension?Math.max(1,Math.max(c,d)/e.maxDimension):null,u=e.maxFramerate?e.maxFramerate:null;if(c&&d&&e.maxDimension&&e.maxDimension>Math.max(c,d)){let e=Math.round(c*d/256),t=1e4*(Math.round(533*e/1e4)+1);o=null===o?t:Math.min(t,o)}let p=e.degradationPreference?e.degradationPreference:"balanced",h=r[i.id];if(h&&h.bitrate===o&&h.scaleResolutionDownBy===l&&h.maxFramerate===u&&h.degradationPreference===p)return void(n[i.id]=h);n[i.id]={bitrate:o,scaleResolutionDownBy:l,maxFramerate:u,degradationPreference:p};let _=t.getParameters();_.encodings||(_.encodings=[{}]),_.encodings.forEach((e=>{o?e.maxBitrate=o:delete e.maxBitrate,l?e.scaleResolutionDownBy=l:delete e.scaleResolutionDownBy,u?e.maxFramerate=u:delete e.maxFramerate})),_.degradationPreference=p,null==(a=t.setParameters)||a.call(t,_)}}}e.composeUserId=r,e.composeParticipantId=n,e.compose=a,e.composeId=s,e.composeMessageId=function(e){return e.participant?s(e.participant):n(e.participantId,e.participantType||Xt.USER,e.deviceIdx||0)},e.decomposeId=o,e.decomposeParticipantId=c,e.uuid=function(){var e,t;let i=null==(t=null==(e=window.crypto)?void 0:e.randomUUID)?void 0:t.call(e);if(i)return i;let r,n,a="0123456789abcdefghijklmnopqrstuvwxyz".split(""),s=new Array(36),o=0;for(n=0;n<36;n++)8===n||13===n||18===n||23===n?s[n]="-":14===n?s[n]="4":(o<=2&&(o=33554432+16777216*Math.random()|0),r=15&o,o>>=4,s[n]=a[19===n?3&r|8:r]);return s.join("")},e.throttle=function(e,t){let i;return function(){let r=this,n=arguments;i&&window.clearTimeout(i),i=window.setTimeout((()=>{e.apply(r,n)}),t)}},e.sdpFingerprint=function(e){if(!window.BigInt)return null;let t="",i=e.split("\n");for(let e of i)if(e.startsWith("a=fingerprint")){let i=e.split(" ");if(2===i.length){t=i[1];break}}if(!t)return BigInt(-1);let r=t.split(":"),n=BigInt(0);for(let e=Math.min(7,r.length-1);e>=0;e--){let t=BigInt(parseInt(r[e],16));n<<=BigInt(8),n|=t}return BigInt.asIntN(64,n)},e.delay=function(e){return st(this,null,(function*(){return new Promise((t=>window.setTimeout(t,e)))}))},e.applySettings=function(e,t,i){let r=[];return e.getSenders().forEach((e=>d(t,e,e.track,i,r))),r},e.applyVideoTrackSettings=d,e.includesOneOf=function(e,t){Array.isArray(t)||(t=[t]);for(let i of t)if(e.includes(i))return!0;return!1},e.mapParticipantState=function(e){var t;return Object.entries((null==(t=e.participantState)?void 0:t.state)||{}).reduce(((t,[i,r])=>(e.participantState&&(t[i]={ts:e.participantState.stateUpdateTs[i],state:r}),t)),{})},e.mapSharedParticipants=function(e){let t=e.map((e=>({uid:e.externalId,mediaSettings:e.mediaSettings,status:e.status,muteStates:e.muteStates,unmuteOptions:e.unmuteOptions,participantState:e.participantState,markers:e.markers,movieShareInfos:e.movieShareInfos})));return Ar.filterObservers?t.filter((e=>!e.uid.observer)):t},e.isEqualParticipantState=function(e,t){let i=Object.keys(e),r=Object.keys(t);if(i.length!==r.length)return!1;for(let n of i)if(!r.hasOwnProperty(n)||e[n].state!==t[n].state||e[n].ts!==t[n].ts)return!1;return!0},e.isObjectsEquals=function(e,t){let i=Object.keys(e),r=Object.keys(t);if(i.length!==r.length)return!1;for(let r of i)if(!t.hasOwnProperty(r)||e[r]!==t[r])return!1;return!0},e.isArraysEquals=function(e,t){if(e.length!==t.length)return!1;for(let i of e)if(t.indexOf(i)<0)return!1;return!0},e.isEmptyObject=function(e){return!Object.keys(e).length},e.participantMarkerCompare=function(e,t){return e||t?e&&t?i(t.rank,e.rank)||i(e.ts,t.ts)||function(e,t){let r={[Xt.USER]:0,[Xt.GROUP]:1},{compositeUserId:n,deviceIdx:a}=c(e.id),{compositeUserId:s,deviceIdx:d}=c(t.id),{id:l,type:u}=o(n),{id:p,type:h}=o(s);return i(r[u],r[h])||i(l,p)||i(a,d)}(e,t):e?-1:1:0;function i(e,t){return e<t?-1:e===t?0:1}},e.objectFilterOutValues=function(e,t){let i=Object.entries(e).filter((([,e])=>Array.isArray(t)?!t.includes(e):e!==t));return Object.fromEntries(i)},e.objectReduce=function(e,t,i){let r=i;for(let i in e)!e.hasOwnProperty(i)||(r=t(r,e[i],i));return r},e.setImmediate=(()=>{let e=1,t={},i=null;return"undefined"!=typeof MessageChannel&&(i=new MessageChannel,i.port1.onmessage=e=>{let i=e.data;t[i]&&(t[i](),delete t[i])}),function(r){if(i&&"hidden"===document.visibilityState){let n=e;return e=e>=Number.MAX_SAFE_INTEGER?1:e+1,t[n]=r,i.port2.postMessage(n),()=>{t[n]&&delete t[n]}}let n=setTimeout(r,0);return()=>clearTimeout(n)}})()})(Ci||(Ci={}));var Ni,ki,Li,Mi,Ui=Ci,xi=null,Bi=null,Vi=[],Fi=[],Gi=[],Hi=null,ji=null,Wi=null,$i=!1,Ki=!1,qi=!1,zi=!1,Yi=null,Ji="",Xi=[],Qi=null,Zi=navigator.appVersion,er=navigator.appName,tr=navigator.userAgent,ir=(e=>(e.USER="user",e.ENVIRONMENT="environment",e.LEFT="left",e.RIGHT="right",e))(ir||{}),rr=class{constructor(e,t=!1,i=Ar.videoMaxWidth,r=Ar.videoMaxHeight){let n=!1;if(e){let t;n={noiseSuppression:Ar.noiseSuppression,echoCancellation:!0,autoGainControl:!0},ji&&(t=ji.deviceId),"string"==typeof e&&(t=e),t&&(n.deviceId={ideal:t})}let a=!1;if(t){let e;a={width:{min:Ar.videoMinWidth,max:i,ideal:i},height:{min:Ar.videoMinHeight,max:r,ideal:r},aspectRatio:{ideal:Ar.videoAspectRatio},frameRate:{ideal:Ar.videoFrameRate}},Hi&&(e=Hi.deviceId),"string"==typeof t&&(e=t),e&&(a.deviceId={ideal:e}),Ar.videoFacingMode&&(a.facingMode={ideal:Ar.videoFacingMode})}this.audio=n,this.video=a,this.needVideo=!!a}getNative(){return Object.assign({},{audio:this.audio,video:this.video})}simplify(){return"object"==typeof this.video&&(this.video.width||this.video.height?(delete this.video.width,delete this.video.height):this.video.aspectRatio?delete this.video.aspectRatio:this.video.frameRate?delete this.video.frameRate:(this.video.deviceId||this.video.facingMode)&&(delete this.video.deviceId,delete this.video.facingMode)),"object"==typeof this.audio&&(this.audio.echoCancellation||this.audio.autoGainControl||this.audio.noiseSuppression?(delete this.audio.echoCancellation,delete this.audio.autoGainControl,delete this.audio.noiseSuppression):this.audio.deviceId&&delete this.audio.deviceId),!0===this.video&&!0===this.audio?this.video=!1:!1===this.video&&!0===this.audio?(this.audio=!1,this.video=this.needVideo):!0===this.video&&!1===this.audio&&(this.video=!1),this.video&&!Object.keys(this.video).length&&(this.video=!0),this.audio&&!Object.keys(this.audio).length&&(this.audio=!0),this}canSimplify(){let e="object"==typeof this.video&&(this.video.width||this.video.height||this.video.aspectRatio||this.video.frameRate||this.video.facingMode||this.video.deviceId)||this.video;return!!("object"==typeof this.audio&&(this.audio.deviceId||this.audio.noiseSuppression||this.audio.echoCancellation||this.audio.autoGainControl)||this.audio||e)}isVideo(){return!!this.video}isAudio(){return!!this.audio}},nr=class extends rr{constructor(e,t){super(!1,!0),"object"==typeof this.video?(delete this.video.deviceId,delete this.video.aspectRatio,delete this.video.frameRate,delete this.video.facingMode):this.video={},this.video.cursor="motion",this.video.width=e,this.video.height=t,this.video.frameRate=Ar.screenFrameRate}};function ar(){xi=null,sr().then((()=>Ur.onDeviceChange()))}function sr(){return st(this,null,(function*(){return xi||(navigator.mediaDevices&&navigator.mediaDevices.enumerateDevices?(!Bi&&navigator.mediaDevices.addEventListener&&(Bi=Ui.throttle(ar,1e3),navigator.mediaDevices.addEventListener("devicechange",Bi)),xi=navigator.mediaDevices.enumerateDevices().then((e=>{Vi=e.filter((e=>"videoinput"===e.kind&&(e.label&&($i=!0),!0))),Fi=e.filter((e=>"audioinput"===e.kind&&(e.label?Ki=!0:Mi.isMobile()&&"Firefox"===Mi.browserName()&&(Ki=$i),!0))),Gi=e.filter((e=>"audiooutput"===e.kind));let t=Ei.get("videoinput"),i=Ei.get("audioinput"),r=Ei.get("audiooutput");return Hi=Vi.find((e=>e.deviceId===t))||null,ji=Fi.find((e=>e.deviceId===i))||null,Wi=Gi.find((e=>e.deviceId===r))||null,xi=Promise.resolve(e),e})).catch((()=>(xi=null,[])))):[])}))}function or(e,t){return st(this,null,(function*(){Fr.debug("Try to get media",e.getNative());let i=Mi.hasPermissions(e.isVideo());!i&&!t&&Ur.onPermissionsRequested();try{let t=yield navigator.mediaDevices.getUserMedia(e.getNative());return i||(yield function(){return st(this,null,(function*(){xi=null,yield sr()}))}()),t}catch(i){switch(i.name){case"PermissionDeniedError":case"PermissionDismissedError":case"NotAllowedError":case"SecurityError":case"DOMException":t=e.isVideo()?At.CAMERA_PERMISSION:At.MIC_PERMISSION;break;case"OverconstrainedError":case"TypeError":case"NotFoundError":break;case"AbortError":case"NotReadableError":t=e.isVideo()?At.CAMERA_ACCESS:At.MIC_ACCESS}if(e.canSimplify())return or(e.simplify(),t);let r=t||At.UNKNOWN;throw Ur.onPermissionsError(r),r}}))}function cr(){return Xi.length||(Xi=(()=>{let e,t=!1,i=0,r="0",n=tr.match(/(opera|chrome|safari|firefox|msie|trident(?=\/))\/?\s*(\d+)/i)||[];if(/trident/i.test(n[1]))return e=/\brv[ :]+(\d+)/g.exec(tr),["IE",e&&e[1]||"Unknown",t,i,r];if("Safari"===n[1]){if(e=tr.match(/\bEdge\/(\d+)/),e)return["Edge",e[1]||"Unknown",t,i,r];if(e=tr.match(/\bCriOS\/(\d+)/),e)return["Chrome",e[1],!0,Number(e[1]),r];if(e=tr.match(/\bFxiOS\/(\d+)/),e)return["Firefox",e[1],!1,i,r];if(e=tr.match(/\bYaBrowser\/(\d+)/),e)return["Yandex",e[1],!1,i,r];if(e=tr.match(/\bOPT\/(\d+)/),e)return["Opera",e[1],!1,i,r]}if("Chrome"===n[1]){if(t=!0,i=Number(n[2]),e=tr.match(/\bOPR\/(\d+)/),e)return["Opera",e[1]||"Unknown",t,i,r];if(e=tr.match(/\bYaBrowser\/(\d+)/),e)return["Yandex",e[1]||"Unknown",t,i,r];if(e=tr.match(/\bSferum\/((\d+)(?:\.\d+)*)/),e)return["Sferum",e[1]||"Unknown",t,i,r];if(e=tr.match(/\bEdge?\/(\d+)/),e)return["Edge",e[1]||"Unknown",t,i,r];if(void 0!==window.opr&&/^(.+\.)?ok.ru$/.test(window.location.host))return["Opera","Hidden",t,i,r]}return e=tr.match(/version\/(\d+)(?:(?:\.)(\d+))?/i),e&&void 0!==e[2]&&(r=e[2]),[n[2]?n[1]:er,e&&e[1]||n[2]||Zi,t,i,r]})()),Xi}(e=>{function t(){return Vi.length>0}function i(){return Fi.length>0}function r(){return $i}function n(){return Ki}function a(){if(!Li||"ended"===Li.readyState){let e=d(),t=e.createMediaStreamDestination(),i=e.createGain();i.gain.value=1e-5,i.connect(t),i.connect(e.destination);let r=e.createOscillator();r.type="sine",r.frequency.value=0,r.connect(i),r.start(),Li=t.stream.getAudioTracks()[0]}return Object.assign(Li.clone(),{enabled:!1})}function s(e=Ar.videoMinWidth,t=Ar.videoMinHeight){return ki||(ki=document.createElement("canvas")).getContext("2d"),ki.width=e,ki.height=t,(!Ni||"ended"===Ni.readyState)&&(Ni=ki.captureStream(Ar.videoFrameRate).getVideoTracks()[0]),Object.assign(Ni.clone(),{enabled:!1})}function o(){return cr()[0]}function c(){return cr()[1]}function d(){return Qi||(Qi=new(window.AudioContext||window.webkitAudioContext)),Qi}e.init=function(){return st(this,null,(function*(){return yield function(){return st(this,null,(function*(){return Mi.isBrowserSupported()?new Promise((e=>{(new window.RTCPeerConnection).createOffer({offerToReceiveVideo:!0}).then((t=>{/^a=rtpmap:\d+ VP8\/\d+$/m.test(t.sdp)&&(qi=!0),/^a=mid:0$/m.test(t.sdp)&&(zi=!0),e()})).catch(e)})):Promise.resolve()}))}(),sr()}))},e.getCameras=function(){return Vi},e.getMicrophones=function(){return Fi},e.getOutput=function(){return Gi},e.hasCamera=t,e.hasMicrophone=i,e.getSavedCamera=function(){return Hi},e.getSavedMicrophone=function(){return ji},e.getSavedOutput=function(){return Wi},e.hasCameraPermission=r,e.hasMicrophonePermission=n,e.hasPermissions=function(e=!1){return!!n()&&(!t()||!e||r())},e.getUserMedia=function(e=!1,r=!0,n=!0){return st(this,null,(function*(){let o,c=i()&&r,d=t()&&e;if(c||d)try{o=yield or(new rr(c,d))}catch(e){o=new MediaStream}else o=new MediaStream;return!o.getVideoTracks().length&&n&&o.addTrack(s()),!o.getAudioTracks().length&&n&&o.addTrack(a()),o}))},e.getScreenMedia=function(){return st(this,null,(function*(){return function(e){return st(this,null,(function*(){Fr.debug("Try to get screen",e.getNative());try{let t=yield navigator.mediaDevices.getDisplayMedia(e.getNative()),i=null==t?void 0:t.getVideoTracks()[0];return i&&(Fr.debug("Got display media track",i.id),i.contentHint="text"),t}catch(e){switch(e.name){case"PermissionDeniedError":case"NotAllowedError":case"SecurityError":throw At.SCREEN_PERMISSION;default:throw At.SCREEN_ACCESS}}}))}(new nr(window.screen.width,window.screen.height))}))},e.getUserVideo=function(e,t=!1){return st(this,null,(function*(){let i=t?Ar.videoEffectMaxWidth:Ar.videoMaxWidth,r=t?Ar.videoEffectMaxHeight:Ar.videoMaxHeight;return or(new rr(!1,e||!0,i,r))}))},e.getUserAudio=function(e){return st(this,null,(function*(){return or(new rr(e||!0,!1))}))},e.saveDeviceId=function(e,t){return st(this,null,(function*(){let i=(yield sr()).find((i=>i.kind===e&&i.deviceId===t));return i?("videoinput"===e?Hi=i:"audioinput"===e?ji=i:"audiooutput"===e&&(Wi=i),Ei.set(e,t),i):null}))},e.getSilentMediaTrack=a,e.getBlackMediaTrack=s,e.isBrowserSupported=function(){if("Edge"===o()&&Number(c())<70)return!1;try{let e=window;return!!(navigator.mediaDevices&&navigator.mediaDevices.getUserMedia&&e.RTCPeerConnection&&e.RTCIceCandidate&&e.RTCSessionDescription&&e.HTMLCanvasElement&&e.HTMLCanvasElement.prototype.captureStream&&e.RTCRtpSender&&e.RTCRtpSender.prototype.replaceTrack&&e.RTCRtpSender.prototype.getParameters&&navigator.sendBeacon)}catch(e){return!1}},e.isScreenCapturingSupported=function(){return!!navigator.mediaDevices.getDisplayMedia},e.canVP8=function(){return qi},e.isUnifiedPlan=function(){return zi},e.isBrokenH264=function(){let t="Safari"===e.browserName()&&"15"===e.browserVersion()&&"1"===e.browserSubVersion(),i="Opera"===e.browserName()&&"Windows"===e.os();return t||i},e.canPreferH264=function(){return!(e.baseChromeVersion()&&e.isMobile())},e.canPreferRed=function(){var e;return(null==(e=window.RTCRtpTransceiver)?void 0:e.prototype)&&"setCodecPreferences"in window.RTCRtpTransceiver.prototype},e.os=function(){return Ji||(Ji=(()=>{let e={Windows:/Win/,Android:/Android/,OpenBSD:/OpenBSD/,SunOS:/SunOS/,Linux:/(Linux|X11)/,iPad:/(iPad)/,iPhone:/(iPhone)/,iPod:/(iPod)/,MacOS:/(MacPPC|MacIntel|Mac_PowerPC|Macintosh|Mac OS X)/,QNX:/QNX/,UNIX:/UNIX/,BeOS:/BeOS/,OS2:/OS\/2/,Bot:/(nuhk|Googlebot|Yammybot|Openbot|Slurp|MSNBot|Ask Jeeves\/Teoma|ia_archiver)/};for(let t in e)if(e.hasOwnProperty(t)&&e[t].test(tr))return t;return"Unknown"})()),Ji},e.isMobile=function(){return null===Yi&&(Yi=/Mobile|mini|Fennec|Android|iP(ad|od|hone)/.test(Zi)),Yi},e.browserName=o,e.browserVersion=c,e.baseChromeVersion=function(){return cr()[3]},e.getAudioContext=d,e.browserSubVersion=function(){return cr()[4]}})(Mi||(Mi={}));var dr=Mi,lr=class extends mi{init(e){return st(this,null,(function*(){Fr.debug("WebCodecsDecoder started"),yield this._createWorker('var exports=(()=>{var i=Object.defineProperty;var E=a=>i(a,"__esModule",{value:!0});var g=(a,e)=>{E(a);for(var t in e)i(a,t,{get:e[t],enumerable:!0})};var V={};g(V,{default:()=>D});var n=(t=>(t.VP9="vp09.00.50.08",t.VP8="vp8",t))(n||{}),o=(r=>(r.INIT="init",r.READY="ready",r.FRAME="frame",r.ERROR="error",r.DEBUG="debug",r.LOG_ERROR="log_error",r))(o||{});var D=a=>{let e=null,t=!0;function p(){self.postMessage({type:o.READY})}function f(d,r,s,l=!1){if(!e||t!==s){if(!l){self.postMessage({type:o.DEBUG,message:"WebCodecsDecoder dropped frame - waiting for keyframe"});return}t=s,e?self.postMessage({type:o.DEBUG,message:`WebCodecsDecoder codec changed to ${s?"VP9":"VP8"}`}):(self.postMessage({type:o.DEBUG,message:`WebCodecsDecoder codec ${s?"VP9":"VP8"}`}),e=new VideoDecoder({output:c=>{let m=a?[c]:[];self.postMessage({type:o.FRAME,data:c},m),c.close()},error:c=>{e&&e.state!=="closed"&&e.close(),e=null,self.postMessage({type:o.FRAME,error:"WebCodecsDecoder failed, reinitialize"})}})),e.configure({codec:s?n.VP9:n.VP8})}let u=new EncodedVideoChunk({type:l?"key":"delta",timestamp:d,data:r});e.decode(u)}self.onmessage=d=>{switch(d.data.type){case o.INIT:p();break;case o.FRAME:f(d.data.timestamp,d.data.data,d.data.isVP9,d.data.keyFrame);break}}};return V;})();\n',(t=>{t.error?Fr.warn("WebCodecsDecoder",t.error):e(t.data)}),[dr.baseChromeVersion()>=92])}))}decodeFrame(e,t,i,r=!1){this._sendToWorker(_i.FRAME,{timestamp:e,data:t.buffer,isVP9:i,keyFrame:r},[t.buffer])}destroy(){this._removeWorker(),Fr.debug("WebCodecsDecoder destroyed")}static isBrowserSupported(){return"VideoDecoder"in window&&"Worker"in window&&"VideoFrame"in window}},ur=class{constructor(e,t){this._chunks=[],this._participantId=e,this._onStream=t}appendChunk(e){let t=this._chunks.length;if(e.start)t&&(Fr.warn("[FrameBuilder] Cleanup buffer",Array.prototype.slice.call(this._chunks)),this._chunks=[]);else if(!t||(this._chunks[t-1].sequence+1)%65536!==e.sequence)return void Fr.warn("[FrameBuilder] Got incorrect chunk");if(this._chunks.push(e),e.end){let t=this._processFrameData(),{width:i,height:r}=ur.getFrameSize(t);this._processFrame({timestamp:e.timestamp,frameData:t,isVP9:e.isVP9,keyframe:e.keyframe,width:i,height:r})}}destroy(){this._chunks=[]}_processFrameData(){let e=this._chunks;this._chunks=[];let t=e.reduce(((e,t)=>e+t.data.byteLength),0),i=new Uint8Array(t),r=0;for(let t of e)i.set(new Uint8Array(t.data),r),r+=t.data.byteLength;return i}static getFrameSize(e){let t={width:0,height:0},i=new ge.BitStream(e.buffer);i.bigEndian=!0,i.index+=2;let r=i.readBits(1),n=i.readBits(1)<<1|r;return 3===n&&i.index++,1===i.readBits(1)||0!==i.readBits(1)||(i.index++,i.index++,i.index+=24,n>=2&&i.index++,7!==i.readBits(3)?(i.index++,(1===n||3===n)&&(i.index+=3)):(1===n||3===n)&&i.index++,t.width=i.readBits(16)+1,t.height=i.readBits(16)+1),t}static isBrowserSupported(){throw new Error("Method `isBrowserSupported` is not implemented")}},pr=class{constructor(e){this._onStream=e}drawFrame(e){return st(this,null,(function*(){throw new Error("Method `drawFrame` is not supported by this implementation")}))}drawImage(e){throw new Error("Method `drawImage` is not supported by this implementation")}static isBrowserSupported(){throw new Error("Method `isBrowserSupported` is not implemented")}},hr=class extends pr{constructor(e){super(e),this._canvas=null,this._canvasContext=null,this._stream=null,this._track=null,Fr.debug("CanvasRenderer started"),this._useImageBitmap="ImageBitmap"in window}_createStream(e,t){this._canvas||(this._canvas=document.createElement("canvas"),this._canvas.width=e,this._canvas.height=t,this._canvas.style.pointerEvents="none",this._canvas.style.visibility="hidden",this._canvas.style.position="absolute",this._canvas.style.width="160px",this._canvas.style.height="90px",this._canvas.style.bottom="0",this._canvas.style.right="0",this._canvas.style.zIndex="5000",document.body.appendChild(this._canvas),this._useImageBitmap?this._canvasContext=this._canvas.getContext("bitmaprenderer"):this._canvasContext=this._canvas.getContext("2d"),this._stream=this._canvas.captureStream(0),this._track=this._stream.getVideoTracks()[0],this._track.contentHint="text")}_removeStream(){this._stream&&(this._stream.getTracks().forEach((e=>e.stop())),this._stream=null,this._track=null),this._canvasContext=null;try{this._canvas&&document.body.removeChild(this._canvas)}catch(e){}this._canvas=null}_requestCanvasFrame(){this._track&&this._track.requestFrame?this._track.requestFrame():this._stream&&this._stream.requestFrame&&this._stream.requestFrame()}drawFrame(e){return st(this,null,(function*(){let t="createImageBitmap"in e?yield e.createImageBitmap():yield createImageBitmap(e);this.drawImage(t),t.close()}))}drawImage(e){this._track||(this._createStream(e.width,e.height),this._onStream(this._stream));let t=this._canvas;if(t.width=e.width,t.height=e.height,e instanceof ImageData){let i=this._canvasContext;i.clearRect(0,0,t.width,t.height),i.putImageData(e,0,0)}else this._canvasContext.transferFromImageBitmap(e);this._requestCanvasFrame()}destroy(){this._removeStream(),Fr.debug("CanvasRenderer destroyed")}static isBrowserSupported(){return("CanvasCaptureMediaStream"in window||"CanvasCaptureMediaStreamTrack"in window)&&!("Safari"===dr.browserName()&&15===Number(dr.browserVersion()))}},_r=class extends pr{constructor(e){super(e),Fr.debug("TrackGeneratorRenderer started"),this._generator=new MediaStreamTrackGenerator({kind:bi.video}),this._writer=this._generator.writable.getWriter(),this._stream=new MediaStream([this._generator]),this._onStream(this._stream)}drawFrame(e){return st(this,null,(function*(){yield this._writer.write(e)}))}destroy(){this._writer.releaseLock(),this._generator.writable.close().then((()=>this._generator.stop())),Fr.debug("TrackGeneratorRenderer destroyed")}static isBrowserSupported(){return"VideoFrame"in window&&"MediaStreamTrackGenerator"in window&&lr.isBrowserSupported()}},fr=class extends ur{constructor(e,t){super(e,t),this._decoderReady=!1,this._decoderQueue=[],Fr.debug(`StreamBuilder started for participant [${e}]`),_r.isBrowserSupported()?this._renderer=new _r(t):this._renderer=new hr(t),lr.isBrowserSupported()?this._decoder=new lr:this._decoder=new gi;this._decoder.init((e=>st(this,null,(function*(){"VideoFrame"in window&&e instanceof VideoFrame?yield this._renderer.drawFrame(e):this._renderer.drawImage(e)})))).then((()=>{this._decoderReady=!0,this._decodeQueue()}))}_processFrame(e){!this._decoderReady||this._decoderQueue.length?(this._decoderQueue.push(e),this._decodeQueue()):this._decoder.decodeFrame(e.timestamp,e.frameData,e.isVP9,e.keyframe)}_decodeQueue(){if(!this._decoderReady)return;let e=this._decoderQueue;this._decoderQueue=[],e.forEach((e=>{this._decoder.decodeFrame(e.timestamp,e.frameData,e.isVP9,e.keyframe)}))}destroy(){super.destroy(),this._decoder.destroy(),this._renderer.destroy(),Fr.debug(`StreamBuilder destroyed for participant ${this._participantId}`)}static isBrowserSupported(){return hr.isBrowserSupported()||_r.isBrowserSupported()}};var mr=it(2,15)-1,gr=class{constructor(e){this._queue=[],this._clearBufferTill=0,this._mediaSource=new MediaSource,this._codec=e;let t=()=>{this._mediaSource.removeEventListener("sourceopen",t),this._initBuffer(),this._handleQueue()};this._mediaSource.addEventListener("sourceopen",t,!1)}_handleQueue(){if(!this._sourceBuffer||this._sourceBuffer.updating||!this._queue.length)return;if(this._clearBufferTill&&this._sourceBuffer.buffered.length){let e=this._sourceBuffer.buffered.start(0);return e<this._clearBufferTill&&(this._sourceBuffer.remove(e,this._clearBufferTill),Fr.debug(`[WebmBuilder] SourceBuffer cleanup from ${e} to ${this._clearBufferTill}`)),void(this._clearBufferTill=0)}let e=this._queue;this._queue=[];let t=gr._buildQueue(e);this._sourceBuffer.appendBuffer(t)}static _buildQueue(e){if(!e.length)return new Uint8Array;if(1===e.length)return ve.build(e[0]);let t=e.reduce(((e,t)=>e+t.countSize()),0),i=new Uint8Array(t),r=0;for(let t of e){let e=ve.build(t);i.set(e,r),r+=e.byteLength}return i}_initBuffer(){this._sourceBuffer=this._mediaSource.addSourceBuffer(`video/webm; codecs="${this._codec}"`),this._sourceBuffer.mode="sequence",this._sourceBuffer.addEventListener("updateend",(()=>this._handleQueue()))}changeType(e){var t;return this._codec=e,null==(t=this._sourceBuffer)?void 0:t.changeType(e)}append(e,t=!1){this._queue.push(e),t&&this._handleQueue()}cleanup(){var e,t,i;"open"===(null==(e=this._mediaSource)?void 0:e.readyState)&&(null==(t=this._sourceBuffer)||t.abort());let r=null==(i=this._sourceBuffer)?void 0:i.buffered,n=null==r?void 0:r.length;if(!n)return;let a=r.start(0),s=Math.max(0,r.end(n-1)-5);s-a>5&&(this._clearBufferTill=s)}destroy(){this._queue=[],"open"===this._mediaSource.readyState&&(this._sourceBuffer.abort(),this._mediaSource.endOfStream()),this._sourceBuffer=null,this._clearBufferTill=0}get codec(){return this._codec}get mediaSource(){return this._mediaSource}get buffered(){var e;return null==(e=this._sourceBuffer)?void 0:e.buffered}},vr=class extends ur{constructor(e,t){super(e,t),this._video=null,this._stream=null,this._earliestTimestamp=0,this._clusterStartTime=0,this._lastFrameTimestamp=0,Fr.debug(`[WebmBuilder] started for participant [${e}]`)}static _intToU16BE(e){return new Uint8Array([e>>8,e])}static _genWebmHeader(){return ve.element(ve.ID.EBML,[ve.element(ve.ID.EBMLVersion,ve.number(1)),ve.element(ve.ID.EBMLReadVersion,ve.number(1)),ve.element(ve.ID.EBMLMaxIDLength,ve.number(4)),ve.element(ve.ID.EBMLMaxSizeLength,ve.number(8)),ve.element(ve.ID.DocType,ve.string("webm")),ve.element(ve.ID.DocTypeVersion,ve.number(2)),ve.element(ve.ID.DocTypeReadVersion,ve.number(2))])}static _genSegmentHeader(e,t,i){let r=ve.element(ve.ID.Info,[ve.element(ve.ID.TimecodeScale,ve.number(1e6)),ve.element(ve.ID.MuxingApp,ve.string("vk-webm-builder")),ve.element(ve.ID.WritingApp,ve.string("vk-webm-builder"))]),n=[ve.element(ve.ID.PixelWidth,ve.number(e)),ve.element(ve.ID.PixelHeight,ve.number(t))],a=ve.element(ve.ID.Tracks,ve.element(ve.ID.TrackEntry,[ve.element(ve.ID.TrackNumber,ve.number(1)),ve.element(ve.ID.TrackUID,ve.number(1)),ve.element(ve.ID.TrackType,ve.number(1)),ve.element(ve.ID.FlagLacing,ve.number(0)),ve.element(ve.ID.DefaultDuration,ve.number(1e9)),ve.element(ve.ID.CodecID,ve.string(`V_${i.toUpperCase()}`)),ve.element(ve.ID.Video,n)]));return ve.unknownSizeElement(ve.ID.Segment,[r,a])}static _genClusterHeader(e){return ve.unknownSizeElement(ve.ID.Cluster,[ve.element(ve.ID.Timecode,ve.number(Math.round(e)))])}_createVideo(e){this._mediaBuffer=new gr(e),this._video=document.createElement("video"),this._video.autoplay=!0,this._video.controls=!1,this._video.muted=!0,this._video.style.pointerEvents="none",this._video.style.visibility="hidden",this._video.style.position="absolute",this._video.style.width="160px",this._video.style.height="90px",this._video.style.bottom="0",this._video.style.right="0",this._video.style.zIndex="5000",this._video.src=URL.createObjectURL(this._mediaBuffer.mediaSource),document.body.appendChild(this._video);let t=()=>{if(this._video.src){Fr.warn(`[WebmBuilder] Video paused for participant [${this._participantId}], try to play again`);let e=this._video.seekable;e.length&&(this._video.currentTime=e.end(e.length-1)-.1),this._video.play().catch((()=>{}))}};this._video.onpause=t,this._video.onwaiting=t,this._video.onstalled=t,this._video.onerror=()=>Fr.warn(`[WebmBuilder] Video Error for participant [${this._participantId}]`,this._video.error),this._stream=this._video.captureStream(),this._onStream(this._stream)}_processFrame(e){let t=e.isVP9?"vp9":"vp8";this._mediaBuffer?this._mediaBuffer.codec!==t&&this._mediaBuffer.changeType(t):this._createVideo(t);let i=e.timestamp;if(i<=this._lastFrameTimestamp&&(i=this._lastFrameTimestamp+10,Fr.debug(`[WebmBuilder] Fixup timestamp for participant [${this._participantId}]`)),this._lastFrameTimestamp=i,this._earliestTimestamp)i-=this._earliestTimestamp;else{if(!e.keyframe)return;this._earliestTimestamp=i,i=0}if(e.keyframe){this._clusterStartTime=i,this._mediaBuffer.cleanup(),Fr.debug(`[WebmBuilder] Segment header for participant [${this._participantId}]`);let r=vr._genWebmHeader();this._mediaBuffer.append(r);let n=vr._genSegmentHeader(e.width,e.height,t);this._mediaBuffer.append(n)}let r=Math.round(i-this._clusterStartTime);if(r>mr&&(this._clusterStartTime=i,r=0),0===r){Fr.debug(`[WebmBuilder] Cluster header for participant [${this._participantId}]`);let e=vr._genClusterHeader(this._clusterStartTime);this._mediaBuffer.append(e)}let n=ve.element(ve.ID.SimpleBlock,[ve.vintEncodedNumber(1),ve.bytes(vr._intToU16BE(r)),ve.number((e.keyframe?1:0)<<7),ve.bytes(e.frameData)]);this._mediaBuffer.append(n,!0)}destroy(){super.destroy(),this._video&&(this._video.onpause=null,this._video.onwaiting=null,this._video.onstalled=null,this._video.onerror=null,this._video.pause(),this._video.src="",document.body.removeChild(this._video)),this._mediaBuffer&&(this._mediaBuffer.destroy(),this._mediaBuffer=null),this._stream&&(this._stream.getTracks().forEach((e=>e.stop())),this._stream=null),Fr.debug(`[WebmBuilder] destroyed for participant [${this._participantId}]`)}static isBrowserSupported(){var e,t,i;return"captureStream"in(null==(e=window.HTMLVideoElement)?void 0:e.prototype)&&(null==(t=window.MediaSource)?void 0:t.isTypeSupported('video/webm; codecs="vp8"'))&&(null==(i=window.MediaSource)?void 0:i.isTypeSupported('video/webm; codecs="vp9"'))}},Sr=class{constructor(e,t,i,r){this._participantIdRegistry=null,this._streamBuilders={},this._onStream=()=>{},this._onEos=()=>{},Fr.debug("ScreenCaptureReceiver started"),this._datachannel=e,this._participantIdRegistry=t,this._onStream=i,this._onEos=r,this._datachannel.onmessage=e=>this._onDataChannelMessage(e.data)}_onDataChannelMessage(e){var t,i;let r=function(e){let t=new DataView(e),i=t.getUint8(0),r=t.getUint16(1),n=t.getUint32(3),a=1===t.getUint8(7),s=t.getUint16(8),o=t.getUint8(10),c=!!(1&o),d=!!(2&o),l=!!(4&o),u=!!(8&o);if(1!==i)throw new Error(`Unexpected protocol version. Got ${i}, expected 1`);return{timestamp:n,start:c,end:d,keyframe:l,sequence:r,isVP9:a,ssrc:s,eos:u,data:e.slice(11)}}(e),n=null==(i=null==(t=this._participantIdRegistry)?void 0:t.getStreamDescription(r.ssrc))?void 0:i.participantId;if(!n)return void Fr.warn(`Participant id for ssrc ${r.ssrc} not found in registry`);if(r.eos)return this.close(n),void this._onEos(n);let a=this._streamBuilders[n];if(!a){let e=e=>this._onStream(n,e);a=Ar.screenShareWebmBuilder&&vr.isBrowserSupported()?new vr(n,e):new fr(n,e),this._streamBuilders[n]=a}a.appendChunk(r)}close(e){let t=this._streamBuilders[e];t&&(t.destroy(),delete this._streamBuilders[e])}destroy(){this._datachannel.onbufferedamountlow=null,this._datachannel.onmessage=null,this._onStream=()=>{},Object.values(this._streamBuilders).forEach((e=>e.destroy())),this._streamBuilders={},this._participantIdRegistry=null,Fr.debug("ScreenCaptureReceiver destroyed")}static isBrowserSupported(){return(lr.isBrowserSupported()||gi.isBrowserSupported())&&(fr.isBrowserSupported()||vr.isBrowserSupported())}},Er=class extends mi{constructor(e,t){super(),this._video=null,this._imageCapture=null,this._canvas=null,this._canvasCtx=null,this._stream=null,this._track=null,this._frameReadTimeout=0,this._lastFrame=null,this._sourceTrack=e,this._onFrame=t,this._useImageCapture="ImageCapture"in window&&"ImageBitmap"in window,("live"!==e.readyState||!e.enabled||e.muted)&&(this._useImageCapture=!1)}_createDom(){this._canvas||(this._canvas=document.createElement("canvas"),this._canvas.style.pointerEvents="none",this._canvas.style.visibility="hidden",this._canvas.style.position="absolute",this._canvas.style.width="160px",this._canvas.style.height="90px",this._canvas.style.bottom="0",this._canvas.style.right="160px",this._canvas.style.zIndex="5000",this._canvasCtx=this._canvas.getContext("2d"),document.body.appendChild(this._canvas)),!this._video&&!this._useImageCapture&&(this._video=document.createElement("video"),this._video.controls=!1,this._video.autoplay=!1,this._video.preload="auto",this._video.muted=!0,this._video.style.pointerEvents="none",this._video.style.visibility="hidden",this._video.style.position="absolute",this._video.style.width="160px",this._video.style.height="90px",this._video.style.bottom="0",this._video.style.right="0",this._video.style.zIndex="5000",document.body.appendChild(this._video))}_removeDom(){try{this._canvas&&document.body.removeChild(this._canvas),this._video&&document.body.removeChild(this._video)}catch(e){}this._canvasCtx=null,this._canvas=null,this._video=null}_createStream(e){return st(this,null,(function*(){if(!this._canvas)throw new Error("Canvas not found");if(!this._video&&!this._useImageCapture)throw new Error("Video element not found");return this._stream=this._canvas.captureStream(0),this._track=this._stream.getVideoTracks()[0],new Promise(((t,i)=>{if(this._useImageCapture)this._imageCapture=new ImageCapture(e),t();else{let r=this._video;r.srcObject=new MediaStream([e]),r.onloadeddata=e=>t(),r.onerror=()=>i(new Error("Video element error"));let n=r.play(),a=()=>i(new Error("Autoplay is disabled"));n?n.catch(a):a()}}))}))}_removeStream(){var e;window.clearTimeout(this._frameReadTimeout),null==(e=this._lastFrame)||e.close(),this._stream&&(this._stream.getTracks().forEach((e=>e.stop())),this._stream=null,this._track=null),this._video&&(this._video.pause(),this._video.srcObject=null),this._imageCapture&&(this._imageCapture=null)}_drawFrameVideo(){if(!(this._canvas&&this._canvasCtx&&this._video&&this._track))throw new Error("Fatal error");this._video.paused&&this._video.play();let e=this._video.videoWidth,t=this._video.videoHeight;return this._canvas.width=this._video.width=e,this._canvas.height=this._video.height=t,this._canvasCtx.clearRect(0,0,e,t),this._canvasCtx.drawImage(this._video,0,0,e,t),this._requestCanvasFrame(),this._canvasCtx.getImageData(0,0,e,t)}_getFrameBitmap(){return st(this,null,(function*(){if(!this._imageCapture)throw new Error("Destroyed");return this._imageCapture.grabFrame()}))}_drawFrameData(e){var t;if(!this._canvas||!this._canvasCtx||!this._track)throw new Error("Destroyed");let i=e.width,r=e.height;return this._canvas.width=i,this._canvas.height=r,this._canvasCtx.clearRect(0,0,i,r),this._canvasCtx.drawImage(e,0,0,i,r),this._requestCanvasFrame(),null==(t=this._canvasCtx)?void 0:t.getImageData(0,0,i,r)}_requestCanvasFrame(){this._track&&this._track.requestFrame?this._track.requestFrame():this._stream&&this._stream.requestFrame&&this._stream.requestFrame()}init(){return st(this,null,(function*(){this._createDom();let e=this._sourceTrack.getSettings().width,t=this._sourceTrack.getSettings().height;Fr.debug(`LibVPxEncoder started ${e}x${t}, codec ${this.isVP9()?"VP9":"VP8"}`),yield this._createStream(this._sourceTrack),yield this._createWorker('var exports=(()=>{var u=Object.defineProperty;var b=o=>u(o,"__esModule",{value:!0});var g=(o,n)=>{b(o);for(var t in n)u(o,t,{get:n[t],enumerable:!0})};var y={};g(y,{default:()=>R});var e=(r=>(r.INIT="init",r.READY="ready",r.FRAME="frame",r.ERROR="error",r.DEBUG="debug",r.LOG_ERROR="log_error",r))(e||{});var R=(o,n)=>{let t;function m(a,r){return o({locateFile:n}).then(s=>{if(t=new s.VpxEncoder,t.debug(r),!t.init(a?s.VpxType.VP9:s.VpxType.VP8))throw self.postMessage({type:e.LOG_ERROR,message:"encoder-init-fail-libvpx"}),new Error("LibVPxEncoder failed to create");t.setMaxQuantizer(10),t.setTargetBitrate(1024)})}function E(a,r,s,i){let c=t.allocateImage(a,r);if(!c){self.postMessage({type:e.FRAME,error:"No buffer data"});return}c.set(new Uint8Array(s));let f=Math.round(performance.now()),l=150;if(!t.encode(f,l,i)){self.postMessage({type:e.FRAME,error:"Encode failed"});return}let p=t.readFrame();if(!p){self.postMessage({type:e.FRAME,error:"No encoded data"});return}t.readFrame()&&(self.postMessage({type:e.DEBUG,message:"LibVPxEncoder dropped frame"}),self.postMessage({type:e.LOG_ERROR,message:"LibVPxEncoder-drop"}));let d=new Uint8Array(p.byteLength);d.set(p),self.postMessage({type:e.FRAME,frameType:i?"key":"delta",timestamp:f,duration:l,data:d.buffer},[d.buffer])}self.onmessage=a=>{switch(a.data.type){case e.INIT:m(a.data.isVP9,a.data.debug).then(()=>self.postMessage({type:e.READY})).catch(r=>self.postMessage({type:e.ERROR,error:String(r)}));break;case e.FRAME:E(a.data.width,a.data.height,a.data.imageData,a.data.keyFrame);break}}};return y;})();\n',(e=>{var t;e.error?this._onFrame(null,e.error):this._onFrame({type:e.frameType,timestamp:e.timestamp,duration:e.duration,data:e.data,byteLength:null==(t=e.data)?void 0:t.byteLength})}),[me(),me().getUrl],{isVP9:this.isVP9(),debug:Fr.enabled()})}))}_encode(e,t){let i=e.data.buffer;this._sendToWorker(_i.FRAME,{width:e.width,height:e.height,imageData:i,keyFrame:t},[i])}_requestFrameVideo(e){let t=this._drawFrameVideo();this._encode(t,e)}_requestFrameBitmap(e){this._frameReadTimeout=window.setTimeout((()=>{if(this._lastFrame){let t=this._drawFrameData(this._lastFrame);this._encode(t,e)}else this._onFrame(null)}),1e3),this._getFrameBitmap().then((t=>{var i;window.clearTimeout(this._frameReadTimeout),null==(i=this._lastFrame)||i.close(),this._lastFrame=t;let r=this._drawFrameData(t);this._encode(r,e)})).catch((()=>{}))}requestFrame(e=!1){this._useImageCapture?this._requestFrameBitmap(e):this._requestFrameVideo(e)}isVP9(){return!1}destroy(){this._removeWorker(),this._removeStream(),this._removeDom(),Fr.debug("LibVPxEncoder destroyed")}static isBrowserSupported(){return"WebAssembly"in window&&"Worker"in window&&("CanvasCaptureMediaStream"in window||"CanvasCaptureMediaStreamTrack"in window)}},yr=class extends mi{constructor(e,t){super(),this._sourceTrack=e,this._onFrame=t,this._trackProcessor=new MediaStreamTrackProcessor(e)}init(){return st(this,null,(function*(){let e=this._sourceTrack.getSettings().width,t=this._sourceTrack.getSettings().height,i=this._trackProcessor.readable;Fr.debug(`WebCodecsEncoder started ${e}x${t}, codec ${this.isVP9()?"VP9":"VP8"}`),yield this._createWorker('var exports=(()=>{var E=Object.defineProperty;var g=i=>E(i,"__esModule",{value:!0});var F=(i,l)=>{g(i);for(var r in l)E(i,r,{get:l[r],enumerable:!0})};var A={};F(A,{default:()=>h});var n=(r=>(r.VP9="vp09.00.50.08",r.VP8="vp8",r))(n||{}),d=(t=>(t.INIT="init",t.READY="ready",t.FRAME="frame",t.ERROR="error",t.DEBUG="debug",t.LOG_ERROR="log_error",t))(d||{});var h=()=>{let i=1e3,l,r,c,s,f,t,a=null,p=0,u=!1;function V(e){l=e.readable,r=l.getReader(),c=e.width,s=e.height,f=e.isVP9,t=e.framerate,m.configure({framerate:t,codec:f?n.VP9:n.VP8,width:c,height:s,latencyMode:"realtime"}),self.postMessage({type:d.READY})}function y(e){p=self.setTimeout(()=>{a&&b(a,e)},i),!u&&(u=!0,r.read().finally(()=>{u=!1,self.clearTimeout(p)}).then(({done:o,value:R})=>{if(a==null||a.close(),a=null,!(o||!R)){if(!m){r.releaseLock(),l.cancel();return}a=R,b(R,e)}}))}function b(e,o){(e.codedWidth!==c||e.codedHeight!==s)&&(c=e.codedWidth,s=e.codedHeight,m.configure({framerate:t,codec:f?n.VP9:n.VP8,width:c,height:s,latencyMode:"realtime"})),m.encode(e,{keyFrame:o})}let m=new VideoEncoder({output:e=>{let o;e.data?o=e.data:(o=new ArrayBuffer(e.byteLength),e.copyTo(o)),self.postMessage({type:d.FRAME,frameType:e.type,timestamp:e.timestamp,duration:e.duration,data:o},[o])},error:e=>{self.postMessage({type:d.FRAME,error:String(e)})}});self.onmessage=e=>{switch(e.data.type){case d.INIT:V(e.data);break;case d.FRAME:y(e.data.keyFrame);break}}};return A;})();\n',(e=>{var t;e.error?this._onFrame(null,e.error):this._onFrame({type:e.frameType,timestamp:e.timestamp,duration:e.duration,data:e.data,byteLength:null==(t=e.data)?void 0:t.byteLength})}),[],{readable:i,width:e,height:t,isVP9:this.isVP9(),framerate:Ar.screenFrameRate},[i])}))}requestFrame(e=!1){this._sendToWorker(_i.FRAME,{keyFrame:e})}isVP9(){return!0}destroy(){this._removeWorker(),Fr.debug("WebCodecsEncoder destroyed")}static isBrowserSupported(){return"VideoEncoder"in window&&"Worker"in window&&"EncodedVideoChunk"in window&&"MediaStreamTrackProcessor"in window}},Tr=0,Cr=class{constructor(e,t){this._destroyed=!1,this._needKeyframe=!0,Fr.debug("ScreenCaptureSender started"),this.DATA_SIZE=Ar.consumerScreenDataChannelPacketSize-11,this._datachannel=t;let i=(e,t)=>{if(!this._destroyed){if(!e)return Fr.warn("requestFrame failed, keyFrame: "+this._needKeyframe,t),this._needKeyframe=!0,void this._requestFrame();this._send(e).catch((e=>{Fr.warn("sendFrame failed",e),this._needKeyframe=!0})).finally((()=>this._requestFrame()))}};yr.isBrowserSupported()?this._encoder=new yr(e,i):this._encoder=new Er(e,i),this._datachannel.onmessage=e=>{(function(e){if(!e||!e.byteLength||4!==e.byteLength)return!1;let t=new DataView(e);return!(1!==t.getUint8(0)||1!==t.getUint8(1)||0!==t.getUint16(2))})(e.data)&&(Fr.debug(`[${this._datachannel.label}] Requested keyframe`),this._needKeyframe=!0)},this._encoder.init().then((()=>this._requestFrame())).catch((e=>Fr.warn("ScreenCaptureSender init failed",e)))}_requestFrame(){this._destroyed||(this._encoder.requestFrame(this._needKeyframe),this._needKeyframe=!1)}_wrapHeader(e,t,i,r,n){let a=function(e,t,i,r,n,a,s){let o=0;t&&(o|=1),i&&(o|=2),r&&(o|=4),s||(o|=8);let c=new ArrayBuffer(11),d=new DataView(c);if(d.setUint8(0,1),d.setUint16(1,n),d.setUint32(3,e),d.setUint8(7,a?1:0),d.setUint16(8,0),d.setUint8(10,o),!s)return c;let l=new Uint8Array(c.byteLength+s.byteLength);return l.set(new Uint8Array(c),0),l.set(new Uint8Array(s),c.byteLength),l.buffer}(e,t,i,r,Tr,this._encoder.isVP9(),n);return Tr=(Tr+1)%65536,a}_stopPacket(){return this._wrapHeader(Date.now(),!1,!1,!1,null)}_send(e){return st(this,null,(function*(){return new Promise(((t,i)=>{this._sendChunk(e,0,t,i)}))}))}_sendChunk(e,t,i,r){if(!this._datachannel||"open"!==this._datachannel.readyState)return void r();let n=e.data.slice(t,t+this.DATA_SIZE),a=e.data.byteLength<=t+n.byteLength,s=this._wrapHeader(e.timestamp,!t,a,"key"===e.type,n);this._datachannel.onbufferedamountlow=a?()=>{this._datachannel.bufferedAmount<=this._datachannel.bufferedAmountLowThreshold&&i()}:null;try{this._datachannel.send(s)}catch(e){return Fr.warn("Error send data to DataChannel",e),void r()}a||Ui.setImmediate((()=>this._sendChunk(e,t+this.DATA_SIZE,i,r)))}destroy(){this._datachannel.onbufferedamountlow=null,this._datachannel.onmessage=null,"open"===this._datachannel.readyState&&this._datachannel.send(this._stopPacket()),this._destroyed=!0,this._encoder.destroy(),Fr.debug("ScreenCaptureSender destroyed")}static isBrowserSupported(){return yr.isBrowserSupported()||Er.isBrowserSupported()}},Rr=class{static get sessionKey(){return Rr._sessionKey}static set sessionKey(e){Rr._sessionKey=e}static get sessionSecretKey(){return Rr._sessionSecretKey}static set sessionSecretKey(e){Rr._sessionSecretKey=e}static get accessToken(){return Rr._accessToken}static set accessToken(e){Rr._accessToken=e}static isEmpty(){return!Rr._sessionKey||!Rr._sessionSecretKey}},Ir=class{static set(e){e.hasOwnProperty("voiceParams")&&(Object.assign(Ir._params.voiceParams,e.voiceParams),delete e.voiceParams),e.hasOwnProperty("specListenerParams")&&(Object.assign(Ir._params.specListenerParams,e.specListenerParams),delete e.specListenerParams),e.hasOwnProperty("unifiedPlanBrowsers")&&(Object.assign(Ir._params.unifiedPlanBrowsers,e.unifiedPlanBrowsers),delete e.unifiedPlanBrowsers),e.hasOwnProperty("apiAuth")&&(Rr.accessToken=e.apiAuth.accessToken,Rr.sessionKey=e.apiAuth.sessionKey,Rr.sessionSecretKey=e.apiAuth.sessionSecretKey),Object.assign(Ir._params,Ui.objectFilterOutValues(e,void 0))}static get(e){return Ir._params[e]}static get appName(){return"ok.calls.sdk.js"}static get appVersion(){return 1.1}static get sdkVersion(){return"2.6.2-beta.12"}static get debug(){}static get protocolVersion(){return Ir._params.joinFromMultipleDevices?6:5}static get platform(){return Ir._params.platform}static set platform(e){Ir._params.platform=e}static get clientType(){return Ir._params.clientType}static set clientType(e){Ir._params.clientType=e}static get device(){return Ir._params.device}static get apiKey(){return Ir._params.apiKey}static get apiEnv(){return Ir._params.apiEnv}static get apiEndpoint(){switch(Ir.apiEnv){case"AUTO":case"PROD":return"https://api.mycdn.me";case"PROD_OK":return"https://api.ok.ru";case"TEST":return"https://apitest.ok.ru/api";case"VIDEOTEST":return"https://videotestapi.ok.ru/api";default:return Ir._params.apiEnv}}static get authToken(){return Ir._params.authToken}static set authToken(e){Ir._params.authToken=e}static get anonymToken(){return Ir._params.anonymToken}static set anonymToken(e){Ir._params.anonymToken=e}static get domain(){return Ir._params.domain}static get externalDomain(){return Ir._params.externalDomain}static get iceServers(){return Ir._params.iceServers}static set iceServers(e){Ir._params.iceServers=e}static get wssBase(){return Ir._params.wssBase}static set wssBase(e){Ir._params.wssBase=e}static get wssToken(){return Ir._params.wssToken}static set wssToken(e){Ir._params.wssToken=e}static get signalingReconnectDelay(){return Ir._params.signalingReconnectDelay}static get signalingReconnectMaxDelay(){return Ir._params.signalingReconnectMaxDelay}static get signalingReconnectMaxCount(){return Ir._params.signalingReconnectMaxCount}static get waitConnectionDelay(){return Ir._params.waitConnectionDelay}static get waitResponseDelay(){return Ir._params.waitResponseDelay}static get waitMessageDelay(){return Ir._params.waitMessageDelay}static get waitAnotherTabDelay(){return Ir._params.waitAnotherTabDelay}static get debugLog(){return Ir._params.debugLog}static get forceRelayPolicy(){return Ir._params.forceRelayPolicy}static set forceRelayPolicy(e){Ir._params.forceRelayPolicy=e}static get videoMinWidth(){return Ir._params.videoMinWidth}static get videoMaxWidth(){return Ir._params.videoMaxWidth}static set videoMaxWidth(e){Ir._params.videoMaxWidth=e}static get videoMinHeight(){return Ir._params.videoMinHeight}static get videoMaxHeight(){return Ir._params.videoMaxHeight}static set videoMaxHeight(e){Ir._params.videoMaxHeight=e}static get videoAspectRatio(){return Ir._params.videoAspectRatio}static get videoFrameRate(){return Ir._params.videoFrameRate}static get videoFacingMode(){return Ir._params.videoFacingMode}static get screenFrameRate(){return Ir._params.screenFrameRate}static get videoEffects(){return Ir._params.videoEffects}static set videoEffects(e){Ir._params.videoEffects=e}static get videoEffectMaxWidth(){return Ir._params.videoEffectMaxWidth}static set videoEffectMaxWidth(e){Ir._params.videoEffectMaxWidth=e}static get videoEffectMaxHeight(){return Ir._params.videoEffectMaxHeight}static set videoEffectMaxHeight(e){Ir._params.videoEffectMaxHeight=e}static get voiceParams(){return Ir._params.voiceParams}static get specListenerParams(){return Ir._params.specListenerParams}static get iceRestartWaitTime(){return Ir._params.iceRestartWaitTime}static get transportConnectionWaitTime(){return Ir._params.transportConnectionWaitTime}static get statisticsInterval(){return Ir._params.statisticsInterval}static set statisticsInterval(e){Ir._params.statisticsInterval=e}static get networkStatisticsInterval(){return Ir._params.networkStatisticsInterval}static get perfStatReportEnabled(){return Ir._params.perfStatReportEnabled}static get callStatReportEnabled(){return Ir._params.callStatReportEnabled}static get producerNotificationDataChannel(){return Ir._params.producerNotificationDataChannel}static get producerCommandDataChannel(){return Ir._params.producerCommandDataChannel}static get consumerScreenDataChannel(){return Ir._params.consumerScreenDataChannel&&Cr.isBrowserSupported()}static get producerScreenDataChannel(){return Ir._params.producerScreenDataChannel&&Ir.producerNotificationDataChannel&&Sr.isBrowserSupported()}static get consumerScreenDataChannelPacketSize(){return Ir._params.consumerScreenDataChannelPacketSize}static get screenShareWebmBuilder(){return Ir._params.screenShareWebmBuilder}static get noiseSuppression(){return Ir._params.noiseSuppression}static set noiseSuppression(e){Ir._params.noiseSuppression=e}static get preferH264(){return Ir._params.preferH264}static get preferVP9(){return Ir._params.preferVP9}static get audioNack(){return Ir._params.audioNack}static get consumerScreenTrack(){return Ir._params.consumerScreenTrack&&Ir.consumerScreenDataChannel}static get producerScreenTrack(){return Ir._params.producerScreenTrack}static isUnifiedPlanSupported(e,t){let i=Ir._params.unifiedPlanBrowsers;return!!i.hasOwnProperty(e)&&t>=i[e]}static get movieShare(){return Ir._params.movieShare&&Ir.videoTracksCount>0}static get videoTracksCount(){return Ir.producerNotificationDataChannel?Ir._params.videoTracksCount:0}static get breakVideoPayloadTypes(){return Ir._params.breakVideoPayloadTypes}static get filteredMessages(){return Ir._params.filteredMessages}static get useParticipantListChunk(){return Ir._params.useParticipantListChunk&&Ir._params.videoTracksCount>0}static get participantListChunkInitIndex(){var e;return null!=(e=Ir._params.participantListChunkInitIndex)?e:0}static get participantListChunkInitCount(){var e;return null!=(e=Ir._params.participantListChunkInitCount)?e:null}static get serverAudioRed(){return Ir._params.serverAudioRed&&dr.canPreferRed()}static get p2pAudioRed(){return Ir._params.p2pAudioRed&&dr.canPreferRed()}static get h264spsPpsIdrInKeyframe(){return Ir._params.h264spsPpsIdrInKeyframe}static get batchParticipantsOnStart(){return Ir._params.batchParticipantsOnStart}static get filterObservers(){return Ir._params.filterObservers}static get muteMode(){return Ir._params.muteMode}static get preserveAudioTracks(){return Ir._params.preserveAudioTracks}},Ar=Ir;Ar._params={platform:"WEB",clientType:"PORTAL",device:"browser",apiKey:"",authToken:"",anonymToken:"",apiEnv:"AUTO",domain:"",externalDomain:"",iceServers:[],wssBase:"",wssToken:"",signalingReconnectDelay:1e3,signalingReconnectMaxDelay:5e3,signalingReconnectMaxCount:20,waitConnectionDelay:1e4,waitResponseDelay:1e4,waitMessageDelay:15e3,waitAnotherTabDelay:200,debugLog:!1,forceRelayPolicy:!1,videoMinWidth:428,videoMinHeight:240,videoMaxWidth:1280,videoMaxHeight:720,videoAspectRatio:16/9,videoFrameRate:25,screenFrameRate:15,videoEffects:null,videoEffectMaxWidth:640,videoEffectMaxHeight:360,iceRestartWaitTime:2e4,transportConnectionWaitTime:5e3,statisticsInterval:5e3,networkStatisticsInterval:2e4,perfStatReportEnabled:!0,callStatReportEnabled:!1,voiceParams:{smoothing:.8,minFreq:200,maxFreq:5e3,interval:500,threshold:.35,speakerLevelMultiplier:1.8},specListenerParams:{connectionTimeout:1e4,volumeTimeout:1e4},unifiedPlanBrowsers:{Firefox:10,Chrome:76,Safari:12},producerNotificationDataChannel:!0,producerCommandDataChannel:!0,consumerScreenDataChannel:!0,producerScreenDataChannel:!0,consumerScreenDataChannelPacketSize:16384,screenShareWebmBuilder:!1,noiseSuppression:!0,preferH264:!1,preferVP9:!0,audioNack:!0,consumerScreenTrack:!0,producerScreenTrack:!0,videoTracksCount:0,movieShare:!1,filteredMessages:!0,useParticipantListChunk:!1,participantListChunkInitIndex:0,participantListChunkInitCount:null,serverAudioRed:!1,p2pAudioRed:!1,h264spsPpsIdrInKeyframe:!1,breakVideoPayloadTypes:!1,batchParticipantsOnStart:!0,joinFromMultipleDevices:!0,filterObservers:!1,muteMode:!1,preserveAudioTracks:!1};var Pr,br,Or,Dr=((Pr=Dr||{}).WAITING_HALL="WAITING_HALL",Pr.WAITING="WAITING",Pr.CONNECTING="CONNECTING",Pr.CONNECTED="CONNECTED",Pr.RECONNECT="RECONNECT",Pr.ERROR="ERROR",Pr.HANGUP="HANGUP",Pr.PERMISSIONS="PERMISSIONS",Pr);function wr(e,...t){let i=Ar.get(e);i&&setTimeout(i,0,...t)}function Nr(e,t,...i){if(Ar.filterObservers)if(Array.isArray(t)){if(t=t.filter((e=>!e.observer)),!t.length)return}else if(t.observer)return;wr(e,t,...i)}function kr(e){return Object.assign({},e)}function Lr(e){return e.slice()}(Or=br||(br={})).onLocalStream=function(e,t){wr("onLocalStream",e,kr(t))},Or.onScreenStream=function(e,t){wr("onScreenStream",e,kr(t))},Or.onLocalStreamUpdate=function(e,t){wr("onLocalStreamUpdate",kr(e),t)},Or.onLocalStatus=function(e){wr("onLocalStatus",e)},Or.onRemoteStream=function(e,t){Nr("onRemoteStream",e,t)},Or.onRemoteLive=function(e,t){Nr("onRemoteLive",e,t)},Or.onLocalLive=function(e,t){Nr("onLocalLive",e,t)},Or.onRemoteLiveUpdate=function(e,t){Nr("onRemoteLiveUpdate",e,t)},Or.onLocalLiveUpdate=function(e,t){Nr("onLocalLiveUpdate",e,t)},Or.onRemoteScreenStream=function(e,t){Nr("onRemoteScreenStream",e,t)},Or.onConversation=function(e,t,i,r){Nr("onConversation",e,kr(t),kr(i),r)},Or.onConversationParticipantListChunk=function(e){e&&wr("onConversationParticipantListChunk",e)},Or.onRemoteMediaSettings=function(e,t,i){Nr("onRemoteMediaSettings",e,kr(t),i)},Or.onLocalMediaSettings=function(e,t){Nr("onLocalMediaSettings",e,kr(t))},Or.onRemoteSharedMovieInfo=function(e,t){Nr("onRemoteSharedMovieInfo",e,kr(t))},Or.onRemoteSharedMovieStoppedInfo=function(e,t){Nr("onRemoteSharedMovieStoppedInfo",e,kr(t))},Or.onLocalSharedMovieInfo=function(e,t){Nr("onLocalSharedMovieInfo",e,kr(t))},Or.onLocalSharedMovieStoppedInfo=function(e,t){Nr("onLocalSharedMovieStoppedInfo",e,kr(t))},Or.onParticipantAdded=function(e,t){Nr("onParticipantAdded",e,t)},Or.onParticipantJoined=function(e,t){Nr("onParticipantJoined",e,t)},Or.onRemoteParticipantState=function(e,t,i){Nr("onRemoteParticipantState",e,kr(t),i)},Or.onRemoteStatus=function(e,t,i=null){Nr("onRemoteStatus",e,t,i)},Or.onParticipantStatus=function(e,t,i=null){Nr("onParticipantStatus",e,t,i)},Or.onPermissionsRequested=function(){wr("onPermissionsRequested")},Or.onPermissionsError=function(e){wr("onPermissionsError",e)},Or.onRemoteRemoved=function(e,t){Nr("onRemoteRemoved",e,t)},Or.onCallState=function(e,t,i){wr("onCallState",e,t,kr(i))},Or.onDeviceSwitched=function(e,t){wr("onDeviceSwitched",e,t)},Or.onMuteStates=function(e,t,i,r=!1,n=!1,a=null,s=null,o,c){let d=c?Lr(c):void 0;wr("onMuteStates",kr(e),Lr(t),Lr(i),r,n,a,s,o,d)},Or.onRolesChanged=function(e,t){Nr("onRolesChanged",e,Lr(t))},Or.onLocalRolesChanged=function(e){wr("onLocalRolesChanged",Lr(e))},Or.onPinnedParticipant=function(e,t,i){Nr("onPinnedParticipant",e,t,i)},Or.onLocalPin=function(e){wr("onLocalPin",e)},Or.onOptionsChanged=function(e){wr("onOptionsChanged",Lr(e))},Or.onCallAccepted=function(){wr("onCallAccepted")},Or.onRateNeeded=function(){wr("onRateNeeded")},Or.onSpeakerChanged=function(e){Nr("onSpeakerChanged",e)},Or.onVolumesDetected=function(e){wr("onVolumesDetected",Lr(e))},Or.onLocalVolume=function(e,t){wr("onLocalVolume",e,t)},Or.onJoinStatus=function(e,t){wr("onJoinStatus",e,t)},Or.onHangup=function(e,t){wr("onHangup",e,t)},Or.onMultipartyChatCreated=function(e){wr("onMultipartyChatCreated",kr(e))},Or.onDeviceChange=function(){wr("onDeviceChange")},Or.onFingerprintChange=function(e){wr("onFingerprintChange",e)},Or.onTokenExpired=function(){wr("onTokenExpired")},Or.onChatMessage=function(e,t,i=!1){wr("onChatMessage",e,t,i)},Or.onCustomData=function(e,t,i=!1){wr("onCustomData",e,t,i)},Or.onRecordStarted=function(e,t,i,r,n,a){wr("onRecordStarted",e,t,i,r,n,a)},Or.onRecordStopped=function(){wr("onRecordStopped")},Or.onLocalNetworkStatusChanged=function(e){wr("onLocalNetworkStatusChanged",e)},Or.onNetworkStatusChanged=function(e){wr("onNetworkStatusChanged",e)},Or.onDebugMessage=function(e,...t){wr("onDebugMessage",e,...t)},Or.onStatistics=function(e,t){wr("onStatistics",Object.assign({},e,{memory:t}))},Or.onAutoplayError=function(){wr("onAutoplayError")},Or.onChatRoomUpdated=function(e,t,i){wr("onChatRoomUpdated",e,t,i)},Or.onRemoteMixedAudioStream=function(e){wr("onRemoteMixedAudioStream",e)},Or.onJoinLinkChanged=function(e){wr("onJoinLinkChanged",e)};var Mr,Ur=br,xr=(e=>(e.DEBUG="DEBUG",e.LOG="LOG",e.WARN="WARN",e.ERROR="ERROR",e))(xr||{});(e=>{let t="📞",i=(e,...t)=>{Ur.onDebugMessage(e,...t)},r=!1,n=(e,t)=>(...i)=>{e(...i),function(e,t){!ci.available||(di.push({t:Date.now(),l:e,d:t}),ui||(ui=window.setTimeout((()=>{ui=null,ai()}),3e4)))}(t,i)},a=console.debug.bind(console,t),s=console.log.bind(console,t),o=console.warn.bind(console,t),c=console.error.bind(console,t),d=i.bind(null,"DEBUG"),l=i.bind(null,"LOG"),u=i.bind(null,"WARN"),p=i.bind(null,"ERROR");e.debug=d,e.log=l,e.warn=u,e.error=p,e.enabled=function(){return r},e.toggle=function(t){r=t,Ar.debugLog&&oi(),t?(e.debug=Ar.debugLog?n(a,"DEBUG"):a,e.log=Ar.debugLog?n(s,"LOG"):s,e.warn=Ar.debugLog?n(o,"WARN"):o,e.error=Ar.debugLog?n(c,"ERROR"):c):(e.debug=Ar.debugLog?n(d,"DEBUG"):d,e.log=Ar.debugLog?n(l,"LOG"):l,e.warn=Ar.debugLog?n(u,"WARN"):u,e.error=Ar.debugLog?n(p,"ERROR"):p)},e.send=function(t,...i){switch(t){case"DEBUG":e.debug(...i);break;case"LOG":e.log(...i);break;case"WARN":e.warn(...i);break;case"ERROR":e.error(...i)}}})(Mr||(Mr={}));var Br,Vr,Fr=Mr,Gr=(e=>(e.USER="USER",e.ANONYM="ANONYM",e.GROUP="GROUP",e))(Gr||{});(e=>{function t(e,t="USER"){return{id:e,type:t}}function i(e){return`{"id":"${e.id}","type":"${e.type}"}`}e.fromIds=function(e){return e.length?"object"==typeof e[0]?e:e.map((e=>t(e))):[]},e.fromId=t,e.fromSignaling=function(e){return{id:e.id,type:"ANONYM"===e.type?"ANONYM":"USER"}},e.toString=i,e.fromIdToString=function(e,r="USER"){return i(t(e,r))},e.fromString=function(e){try{return JSON.parse(e)}catch(t){throw new Error(`Failed to parse ExternalId from string '${e}'`)}},e.compare=function(e,t){return e.id===t.id&&e.type===t.type}})(Br||(Br={})),(e=>{e.fromId=function(e,t="USER",i=0){return{id:e,type:t,deviceIdx:i}},e.toString=function(e){return`{"id":"${e.id}","type":"${e.type}","deviceIdx":"${e.deviceIdx}"}`},e.fromSignaling=function(e,t){return Object.assign({deviceIdx:t},Br.fromSignaling(e))},e.getDeviceIdx=function(e){return e&&"object"==typeof e?e.deviceIdx:0}})(Vr||(Vr={}));function Hr(e){return e.stopStream}function jr(e){return e.keyFrameRequested}function Wr(e){if(Hr(e))return"ss";if(jr(e))return"kf";let t="";return void 0!==e.priority&&(t+="p="+e.priority),void 0!==e.width&&void 0!==e.height&&(""!==t&&(t+=":"),t+="sz="+Math.round(e.width)+"x"+Math.round(e.height)),void 0!==e.fit&&(""!==t&&(t+=":"),t+="fit="+e.fit),t}var $r=(e=>(e.CAMERA="CAMERA",e.SCREEN="SCREEN",e.STREAM="STREAM",e.MOVIE="MOVIE",e))($r||{});function Kr(e){return e.participantId+(e.mediaType?":s"+e.mediaType:"")+(e.streamName?":m"+e.streamName:"")}function qr(e){let t=e.split(Di),i=t.shift();if(!i)throw new Error("Illegal stream description: "+e);let r,n=null,a=0;for(let i of t)switch(i.charAt(0)){case"s":n=zr(i.slice(1));break;case"m":r=i.slice(1);break;case"d":a=Number.parseInt(i.slice(1),10);break;default:throw new Error("Unexpected parameter type "+i.charAt(0)+" in stream description "+e)}return{participantId:Ui.compose(i,a),mediaType:n,streamName:r}}function zr(e){for(let t of Object.keys($r))if(t===e)return $r[t];return null}function Yr(e,t){return null===e||null===t?null===e&&null===t:!(e.maxDimension!==t.maxDimension||e.maxBitrateK!==t.maxBitrateK||e.maxFramerate!==t.maxFramerate||e.degradationPreference!==t.degradationPreference)}function Jr(e,t){return!(!Yr(e.camera,t.camera)||!Yr(e.screenSharing,t.screenSharing))}function Xr(e,t){return{camera:Object.assign({},e.camera,t.camera),screenSharing:Object.assign({},e.screenSharing,t.screenSharing)}}var Qr=(e,t)=>Ui.objectReduce(e,((e,i,r)=>(i===t&&e.push(r),e)),[]),Zr=class{constructor(e){this._fixNoPacketsApplied=!1,this._fixNoPacketsChecked=!1,this._fixTooManyPacketsApplied=!1,this._fixTooManyPacketsSucceeded=!1,this._fixTooManyPacketsFailed=!1,this._mediaSource=e}_fixAudioDeviceNoPackets(e){if(!this._fixNoPacketsApplied||!this._fixNoPacketsChecked){if(this._fixNoPacketsApplied&&!this._fixNoPacketsChecked)return this._fixNoPacketsChecked=!0,void fi.log(Ht.ERROR,"audio_device_recover_"+(e.bandwidth?"success":"fail"));!this._fixNoPacketsApplied&&!e.bandwidth&&(this._fixNoPacketsApplied=!0,fi.log(Ht.ERROR,"audio_device_recover"),this._mediaSource.toggleAudio(!0))}}_fixAudioDeviceTooManyPackets(e){if(this._fixTooManyPacketsSucceeded||this._fixTooManyPacketsFailed)return;let t=Date.now();if(this._lastPacketsSentTime){if(t-this._lastPacketsSentTime>500){let i=1e3*(e.packetsSent-this._lastPacketsSent)/(t-this._lastPacketsSentTime);this._lastPacketsSentTime=t,this._lastPacketsSent=e.packetsSent,this._fixTooManyPacketsApplied?i>75?(Fr.log("Failed to fix RV"),fi.log(Ht.ERROR,"audio_device_recover_rv_fail"),this._fixTooManyPacketsFailed=!0):t-this._fixTooManyPacketsTime>6e4&&(Fr.log("Fixed RV"),fi.log(Ht.ERROR,"audio_device_recover_rv_success"),this._fixTooManyPacketsSucceeded=!0):i>75&&(this._fixTooManyPacketsApplied=!0,Fr.log("Trying to fix RV"),this._mediaSource.toggleAudio(!0),this._fixTooManyPacketsTime=t)}}else e.packetsSent>0&&(this._lastPacketsSentTime=t,this._lastPacketsSent=e.packetsSent)}fix(e){if(!this._mediaSource)return;let t=e.find((e=>e.kind===bi.audio));!t||(this._fixAudioDeviceNoPackets(t),this._fixAudioDeviceTooManyPackets(t))}},en=class extends dt{constructor(){super(...arguments),this._lastMemoryStat={percent:0,bytes:0}}onRemoteDataStats(e,t){this._calcMemory(),e.inbound.rtps.map((e=>{let i="string"==typeof e.userId&&t[e.userId]||null;e.userId=null==i?void 0:i.externalId})),Ur.onStatistics(e,this._lastMemoryStat)}_calcMemory(){var e;let t=null==(e=null==window?void 0:window.performance)?void 0:e.memory;if(!t||!t.usedJSHeapSize||!t.jsHeapSizeLimit)return;let i=Number((100*t.usedJSHeapSize/t.jsHeapSizeLimit).toFixed(2)),r=Number((t.usedJSHeapSize/1024/1024).toFixed(1));i>90?Fr.warn(`High memory usage: ${i}% (${r} MiB)`):(!this._lastMemoryStat.percent||Math.abs(i-this._lastMemoryStat.percent)>=3)&&(Fr.debug(`Memory usage: ${i}% (${r} MiB)`),this._lastMemoryStat.percent=i,this._lastMemoryStat.bytes=t.usedJSHeapSize)}},tn=class{constructor(e,t){this._analyser=null,this._gainNode=null,this._fftBins=null,this._mediaStreamSource=null,this._lastSmoothedLevel=0,this._trackId=e,this._stream=t;try{let e=dr.getAudioContext();this._gainNode=e.createGain(),this._gainNode.gain.value=1e-5,this._gainNode.connect(e.destination),this._analyser=e.createAnalyser(),this._analyser.fftSize=1024,this._analyser.smoothingTimeConstant=0,this._analyser.connect(this._gainNode),this._fftBins=new Uint8Array(this._analyser.frequencyBinCount),this._mediaStreamSource=e.createMediaStreamSource(t),this._mediaStreamSource.connect(this._analyser)}catch(e){}}get stream(){return this._stream}get trackId(){return this._trackId}_getBins(){if(!this._fftBins||!this._analyser)return new Uint8Array;this._analyser.getByteFrequencyData(this._fftBins);let e=44100/this._fftBins.length,t=Math.ceil(Ar.voiceParams.minFreq/e),i=Math.floor(Ar.voiceParams.maxFreq/e);return this._fftBins.subarray(t,i)}getLevel(){let e=this._getBins(),t=e.reduce(((e,t)=>e+t),0)/e.length/255,i=this._lastSmoothedLevel*Ar.voiceParams.smoothing+t*(1-Ar.voiceParams.smoothing);return this._lastSmoothedLevel=i,{real:t,smoothed:i}}destroy(){this._mediaStreamSource&&(this._mediaStreamSource.disconnect(),this._mediaStreamSource=null),this._gainNode&&(this._gainNode.disconnect(),this._gainNode=null),this._analyser&&(this._analyser.disconnect(),this._analyser=null,this._fftBins=null,this._lastSmoothedLevel=0)}},rn=class extends dt{constructor(e){super(),this._detector=null,this._track=null,this._interval=null;let t=()=>{this._detector&&Ur.onLocalVolume(this._detector.getLevel().real,e.getMediaSettings().isAudioEnabled),this._interval=window.setTimeout(t,Ar.voiceParams.interval)};this._interval=window.setTimeout(t,Ar.voiceParams.interval);let i=()=>{let t=e.getStream();t&&this.init(t)};this.subscribe(e,Pi.SOURCE_CHANGED,(e=>{e.kind===bi.audio&&e.mediaSettings.isAudioEnabled&&i()})),i()}init(e){this._stopDetector();let t=e.getAudioTracks();t.length&&(this._track=t[0].clone(),this._detector=new tn("local",new MediaStream([this._track])))}_stopDetector(){this._detector&&(this._detector.destroy(),this._detector=null),this._track&&(this._track.stop(),this._track=null)}destroy(){this.unsubscribe(),this._interval&&(window.clearTimeout(this._interval),this._interval=null),this._stopDetector()}},nn="videochat-epi",an=class extends dt{constructor(e,t,i=!1){super(),this._previousTimestamp=0,this._previousCallStatReportTimestamp=0,this._previousCallStatReport={nack_sent:0,nack_received:0,pli_sent:0,pli_received:0,fir_sent:0,fir_received:0,frames_dropped:0,jitter_video:0,jitter_audio:0,interframe_delay_variance:0,total_audio_samples_received:0,concealed_audio_samples:0,inserted_audio_samples_for_deceleration:0,removed_audio_samples_for_acceleration:0,silent_concealed_audio_samples:0,audio_concealment_events:0,total_audio_energy:0},this._signaling=t,this._directTopology=i,this.subscribe(e,An.REMOTE_DATA_STATS,this._handleStats.bind(this))}destroy(){this.unsubscribe()}static getEstimatedPerformanceIndex(){try{let e=parseInt(localStorage.getItem(nn)||"",10);return isNaN(e)?0:e}catch(e){return 0}}_handleStats(e){return st(this,null,(function*(){if(!e.inbound||!e.inbound.rtps)return;let t=Date.now();!this._directTopology&&Ar.perfStatReportEnabled&&this._previousTimestamp+5e3<=t&&(yield this.reportPerfStats(e),this._previousTimestamp=t),Ar.callStatReportEnabled&&this._previousCallStatReportTimestamp+3e4<=t&&(this._reportCallStats(e),this._previousCallStatReportTimestamp=t)}))}reportPerfStats(e){return st(this,null,(function*(){let t=e.inbound.rtps.reduce(((e,t)=>("video"===t.kind&&(e.framesDecoded+=t.framesDecoded||0,e.framesReceived+=t.framesReceived||0),e)),{framesDecoded:0,framesReceived:0});if(t.framesDecoded)try{let e=yield this._signaling.reportPerfStat(t);localStorage.setItem(nn,e.estimatedPerformanceIndex)}catch(e){}}))}_reportCallStats(e){let t={nack_received:0,pli_received:0,fir_received:0,frames_dropped:0,jitter_video:0,jitter_audio:0,interframe_delay_variance:0,nack_sent:0,pli_sent:0,fir_sent:0,total_audio_samples_received:0,concealed_audio_samples:0,silent_concealed_audio_samples:0,inserted_audio_samples_for_deceleration:0,removed_audio_samples_for_acceleration:0,audio_concealment_events:0,total_audio_energy:0,inbound_video_count:0,inbound_audio_count:0};e.inbound.rtps.reduce(((e,t)=>("video"===t.kind?(t.framesReceived&&(e.jitter_video=e.jitter_video*e.inbound_video_count/(e.inbound_video_count+1)+1e3*t.jitter/(e.inbound_video_count+1),e.interframe_delay_variance=e.interframe_delay_variance*e.inbound_video_count/(e.inbound_video_count+1)+1e6*t.interframeDelayVariance/(e.inbound_video_count+1),e.inbound_video_count++),e.frames_dropped+=t.framesDropped,e.nack_sent+=t.nackCount,e.pli_sent+=t.pliCount,e.fir_sent+=t.firCount):(t.totalSamplesReceived&&(e.jitter_audio=e.jitter_audio*e.inbound_audio_count/(e.inbound_audio_count+1)+1e3*t.jitter/(e.inbound_audio_count+1),e.total_audio_energy=e.total_audio_energy*e.inbound_audio_count/(e.inbound_audio_count+1)+t.totalAudioEnergy/(e.inbound_audio_count+1),e.inbound_audio_count++),e.total_audio_samples_received+=t.totalSamplesReceived,e.inserted_audio_samples_for_deceleration+=t.insertedSamplesForDeceleration,e.removed_audio_samples_for_acceleration+=t.removedSamplesForAcceleration,e.concealed_audio_samples+=t.concealedSamples,e.silent_concealed_audio_samples+=t.silentConcealedSamples,e.audio_concealment_events+=t.concealmentEvents),e)),t),e.outbound.rtps.reduce(((e,t)=>("video"===t.kind&&(e.nack_received+=t.nackCount,e.pli_received+=t.pliCount,e.fir_received+=t.firCount),e)),t);let i={call_topology:this._directTopology?"D":"S",nack_sent:t.nack_sent-this._previousCallStatReport.nack_sent,nack_received:t.nack_received-this._previousCallStatReport.nack_received,pli_sent:t.pli_sent-this._previousCallStatReport.pli_sent,pli_received:t.pli_received-this._previousCallStatReport.pli_received,fir_sent:t.fir_sent-this._previousCallStatReport.fir_sent,fir_received:t.fir_received-this._previousCallStatReport.fir_received,frames_dropped:t.frames_dropped-this._previousCallStatReport.frames_dropped};if(t.jitter_video&&(i.jitter_video=t.jitter_video),t.jitter_audio&&(i.jitter_audio=t.jitter_audio),t.interframe_delay_variance&&(i.interframe_delay_variance=t.interframe_delay_variance),t.total_audio_samples_received){let e=t.total_audio_samples_received-this._previousCallStatReport.total_audio_samples_received,r=t.inserted_audio_samples_for_deceleration-this._previousCallStatReport.inserted_audio_samples_for_deceleration,n=t.removed_audio_samples_for_acceleration-this._previousCallStatReport.removed_audio_samples_for_acceleration,a=t.concealed_audio_samples-this._previousCallStatReport.concealed_audio_samples,s=t.silent_concealed_audio_samples-this._previousCallStatReport.silent_concealed_audio_samples,o=t.audio_concealment_events-this._previousCallStatReport.audio_concealment_events;i.inserted_audio_samples_for_deceleration=r/e*1e3,i.removed_audio_samples_for_acceleration=n/e*1e3,i.concealed_audio_samples=a/e*1e3,i.concealed_silent_audio_samples=s/e*1e3,i.concealment_audio_avg_size=a/o,i.total_audio_energy=t.total_audio_energy}fi.logCustom("callStat",i),Fr.log("Sent call stats",i),this._previousCallStatReport=t}};function sn(e,t,i=0){return t in e&&e[t]?e[t]:i}function on(...e){return t=>{for(let i of e)if(i(t))return!0;return!1}}function cn(e,t){return i=>i[e]===t}function dn(e,t){return t.reduce(((t,i)=>(t[i[e]]=i,t)),{})}function ln(e){let t={},i=[];for(let r of e)t[r.id]||(t[r.id]=!0,i.push(r));return i}function un(e){return Object.keys(e).filter((t=>void 0!==e[t])).map((t=>[t,e[t]])).reduce(((e,t)=>(e[t[0]]=function(e){return null!==e&&"object"==typeof e&&!Array.isArray(e)}(t[1])?un(t[1]):t[1],e)),{})}function pn(e){let t=[];for(let i of e)i.forEach((e=>t.push(e)));return t}function hn(e){return st(this,null,(function*(){let t=[];return RTCRtpReceiver.prototype.getStats?(t.push(...e.getReceivers().map((e=>e.getStats()))),t.push(...e.getSenders().map((e=>e.getStats())))):t.push(e.getStats()),Promise.all(t).then(pn).then(ln)}))}function _n(e){let t=e.filter(cn("type","candidate-pair")).sort(function(e){return(t,i)=>t[e]-i[e]}("priority")).find(on(cn("nominated",!0),cn("selected",!0)));if(!t)return{totalRoundTripTime:0,currentRoundTripTime:0,bytesSent:0,bytesReceived:0};let i={totalRoundTripTime:t.totalRoundTripTime||0,currentRoundTripTime:t.currentRoundTripTime||0,bytesSent:t.bytesSent,bytesReceived:t.bytesReceived},r=e.find(cn("id",t.remoteCandidateId));r&&(i=Object.assign({},i,{remote:{type:r.candidateType,address:r.ip||r.address,port:r.port,protocol:r.protocol}}));let n=e.find(cn("id",t.localCandidateId));return n&&(i=Object.assign({},i,{local:{type:n.candidateType,address:n.ip||n.address,port:n.port,protocol:n.protocol,relayProtocol:n.relayProtocol,networkType:n.networkType}})),un(i)}function fn(e,t){let i=dn("id",e),r=e.filter(on(cn("type","inbound-rtp"),cn("type","outbound-rtp")));"Firefox"===dr.browserName()&&(r=Object.values(r.reduce(((e,t)=>{if(e[t.ssrc]){let i=Object.assign({},e[t.ssrc],t),r=e[t.ssrc].isRemote?t:e[t.ssrc];i.id=r.id,i.type=r.type,delete i.isRemote,delete i.remoteId,e[i.ssrc]=i}else e[t.ssrc]=t;return e}),{})));let n={};if("Safari"===dr.browserName()){let t=e.filter(cn("type","track"));n=dn("trackIdentifier",t)}return r.map((e=>{let r=Number(e.ssrc),a=e.mediaType||e.kind,s=e.trackId,o=e.type,c=e.codecId;if("Safari"===dr.browserName()){let i=/^.+_([\d]+)$/.exec(e.id);if(i&&(r=parseInt(i[1],10)),a=e.id.indexOf("Audio")>0?"audio":"video",t[r]){let e=a+"-"+t[r];n[e]&&(s=n[e].id)}}if(!o||!r||!a)return null;let d={ssrc:r,type:o,kind:a,bytesReceived:sn(e,"bytesReceived"),bytesSent:sn(e,"bytesSent"),jitter:sn(e,"jitter"),packetsLost:sn(e,"packetsLost"),packetsReceived:sn(e,"packetsReceived"),packetsSent:sn(e,"packetsSent"),fractionLost:sn(e,"fractionLost"),pliCount:sn(e,"pliCount"),firCount:sn(e,"firCount"),nackCount:sn(e,"nackCount"),userId:t[r]};if("video"===a){let t=sn(e,"framesDecoded"),i=sn(e,"totalInterFrameDelay"),r=sn(e,"totalSquaredInterFrameDelay");d.interframeDelayVariance=(r-i*i/t)/t}if("audio"===a&&(d.totalSamplesReceived=sn(e,"totalSamplesReceived"),d.concealedSamples=sn(e,"concealedSamples"),d.insertedSamplesForDeceleration=sn(e,"insertedSamplesForDeceleration"),d.removedSamplesForAcceleration=sn(e,"removedSamplesForAcceleration"),d.silentConcealedSamples=sn(e,"silentConcealedSamples"),d.concealmentEvents=sn(e,"concealmentEvents"),d.totalAudioEnergy=sn(e,"totalAudioEnergy")),c&&i[c]){let e=i[c];d.clockRate=e.clockRate,d.mimeType=e.mimeType}if(s&&i[s]){let e=i[s];d.frameHeight=e.frameHeight,d.frameWidth=e.frameWidth,d.framesDecoded=e.framesDecoded,d.framesReceived=e.framesReceived,d.framesDropped=e.framesDropped}return un(d)})).filter((e=>!!e))}function mn(e,t){if(!t||!t.rtps||!e.rtps)return e;let i=dn("ssrc",e.rtps),r=dn("ssrc",t.rtps),n=(e.timestamp-t.timestamp)/1e3;return!i||!r||Object.keys(i).forEach((e=>{let t=i[e],a=r[e];if(t&&a){if(t.bytesReceived&&t.bytesReceived>a.bytesReceived&&(t.bandwidth=Math.round((t.bytesReceived-a.bytesReceived)/n)),t.bytesSent&&t.bytesSent>a.bytesSent&&(t.bandwidth=Math.round((t.bytesSent-a.bytesSent)/n)),t.packetsReceived)if(t.packetsReceived>a.packetsReceived||t.packetsLost>a.packetsLost){let e=t.packetsLost-a.packetsLost,i=t.packetsReceived-a.packetsReceived;t.packetLoss=parseFloat((100*e/(e+i)).toFixed(2))}else t.packetLoss=0;t.framesDropped&&a.framesDropped&&t.framesDropped>a.framesDropped&&(t.framesDroppedDelta=parseFloat(((t.framesDropped-a.framesDropped)/n).toFixed(0)))}})),e}function gn(e,t){return st(this,arguments,(function*(e,t,i={}){let r=yield hn(e),n={timestamp:Date.now(),transport:_n(r),rtps:fn(r,i)};return t?mn(n,t):(yield Ui.delay(1e3),gn(e,n,i))}))}var vn,Sn,En,yn=.8,Tn=class extends dt{constructor(e,t,i,r,n){if(super(),this._remoteSDP={},this._remoteCandidates={},this._state=Pn.IDLE,this._isOpen=!1,this._remotePeerId=null,this._statInterval=null,this._settingsInterval=null,this._failedOnCreate=null,this._remoteStream=null,this._iceRestartTimeout=null,this._reconnectionTimeout=null,this._reconnectionPrevented=!1,this._fingerprint=null,this._neverConnected=!0,this._prevConsumerSettings={},this._lastNetworkStat={rtt:0,loss:0,date:0},this._remoteNetworkStat={rtt:0,loss:0},this._networkLimits={badNet:{loss:3,rtt:1e3},goodNet:{loss:.5,rtt:600}},this._signaling=i,this._mediaSource=r,this._participantId=e,this._isMaster=t,this._serverSettings=n,this._perfStatReporter=new an(this,i,!0),this.subscribe(this._signaling,Bt.NOTIFICATION,this._onSignalingNotification.bind(this)),this.subscribe(this._mediaSource,Pi.TRACK_REPLACED,this._onReplacedTrack.bind(this)),this.subscribe(this._mediaSource,Pi.SOURCE_CHANGED,this._applySettings.bind(this)),this._pc=new RTCPeerConnection({iceServers:Ar.iceServers,iceTransportPolicy:Ar.forceRelayPolicy?"relay":"all"},{optional:[{googSuspendBelowMinBitrate:!1}]}),this._pc.onicecandidate=this._handleIceCandidate.bind(this),this._pc.ontrack=this._onAddTrack.bind(this),this._pc.oniceconnectionstatechange=this._onIceConnectionStateChange.bind(this),this._pc.onconnectionstatechange=this._onConnectionStateChange.bind(this),this._pc.onsignalingstatechange=this._onSignalingStateChange.bind(this),this._prevConsumerSettings={},this._isMaster){try{this._mediaSource.addTrackToPeerConnection(this._pc,!1,!0,Ar.p2pAudioRed),this._applySettings()}catch(e){return fi.log(Ht.ERROR,"addTrack-direct"),Fr.error("Unable to add media source tracks",e,{participantId:this._participantId}),void(this._failedOnCreate=e)}this._createOffer(!1).catch((e=>{this._state===Pn.IDLE?this._failedOnCreate=e:this.close(e)}))}this._startSettingsInterval(),this._startStatInterval()}getState(){return this._state}updateStatisticsInterval(){this._stopStatInterval();let e=this.getState();e!==Pn.IDLE&&e!==Pn.CLOSED&&e!==Pn.FAILED&&this._startStatInterval()}open(e=null){return st(this,null,(function*(){if(this._isOpen)return void Fr.warn("DirectTransport: Already opened",{participantId:this._participantId});if(this._failedOnCreate)return void this.close(this._failedOnCreate);if(Fr.debug("DirectTransport: Open transport",{participantId:this._participantId}),this._isOpen=!0,this._remotePeerId=e,!this._isMaster)try{this._mediaSource.addTrackToPeerConnection(this._pc,!1,!0,Ar.p2pAudioRed),this._applySettings()}catch(e){return fi.log(Ht.ERROR,"addTrack-direct"),Fr.error("DirectTransport: Unable to add media source tracks",e,{participantId:this._participantId}),void this.close(e)}this._setState(Pn.OPENED);let t=e;if(!e){let e=Object.keys(this._remoteSDP);t=e[e.length-1]}if(t&&this._remoteSDP[t])try{yield this._setRemoteDescription(t,this._remoteSDP[t])}catch(e){return void this.close()}this._remoteSDP={},this._remoteCandidates={}}))}updateSettings(e){Jr(e,this._serverSettings)||(this._serverSettings=e,this._applySettings())}preventRestart(){this._reconnectionPrevented=!0}allowRestart(){this._reconnectionPrevented=!1}close(e){this._isOpen=!1,this._stopReconnection(),this._remoteStream&&(this._remoteStream.getTracks().forEach((e=>{e.stop(),this._triggerEvent(An.REMOTE_TRACK_REMOVED,this._remoteStream,e)})),this._remoteStream=null),this._stopStatInterval(),this._stopSettingsInterval(),this._pc&&(this._pc.onicecandidate=null,this._pc.ontrack=null,this._pc.oniceconnectionstatechange=null,this._pc.onconnectionstatechange=null,this._pc.onsignalingstatechange=null,this._pc.close()),this.unsubscribe(),e?(Fr.error("DirectTransport: Closed",e,{participantId:this._participantId}),this._setState(Pn.FAILED)):(Fr.debug("DirectTransport: Closed",{participantId:this._participantId}),this._setState(Pn.CLOSED)),this._triggerEvent(An.PEER_CONNECTION_CLOSED)}_setState(e){this._state!==e&&(Fr.debug(`DirectTransport: State changed to ${e}`,{participantId:this._participantId}),this._state=e,this._triggerEvent(An.STATE_CHANGED,e))}_onSignalingNotification(e){var t,i,r,n;switch(e.notification){case Ft.TRANSMITTED_DATA:this._handleTransmittedData(e);break;case Ft.SETTINGS_UPDATE:Object.assign(this._networkLimits.badNet,(null==(t=e.settings)?void 0:t.badNet)||{}),Object.assign(this._networkLimits.goodNet,(null==(i=e.settings)?void 0:i.goodNet)||{});break;case Ft.CUSTOM_DATA:e.data.hasOwnProperty("sdk")&&(this._remoteNetworkStat.rtt=(null==(r=e.data.sdk)?void 0:r.rtt)||0,this._remoteNetworkStat.loss=(null==(n=e.data.sdk)?void 0:n.loss)||0)}}_handleTransmittedData(e){let t=e.data,i=Ui.getPeerIdString(e.peerId);Ui.composeMessageId(e)===this._participantId&&(t.candidate&&t.candidate.candidate?this._addIceCandidate(i,t.candidate).catch(this.close.bind(this)):t.sdp&&this._setRemoteDescription(i,t.sdp).catch(this.close.bind(this)))}_addIceCandidate(e,t){return st(this,null,(function*(){if(this._isOpen&&(!this._remotePeerId||this._remotePeerId===e)&&this._pc&&this._pc.remoteDescription){Fr.debug("Add remote ice candidate",{participantId:this._participantId,candidate:t});try{yield this._pc.addIceCandidate(new RTCIceCandidate(t))}catch(e){throw fi.log(Ht.ERROR,"addIceCandidate-direct"),Fr.error("Unable to add remote ice candidate",e,{participantId:this._participantId,candidate:t}),e}}else Fr.debug("Cache remote ice candidate",{participantId:this._participantId,candidate:t}),this._remoteCandidates[e]=this._remoteCandidates[e]||[],this._remoteCandidates[e].push(t)}))}_setRemoteCandidates(e){return st(this,null,(function*(){if(!this._remoteCandidates[e])return void Fr.log(`No cached candidates found for peer ${e}`);let t=this._remoteCandidates[e];this._remoteCandidates[e]=[];for(let i of t)try{yield this._addIceCandidate(e,i)}catch(e){}}))}_setRemoteDescription(e,t){return st(this,null,(function*(){if(!this._isOpen||this._remotePeerId&&this._remotePeerId!==e||!this._pc)this._remoteSDP[e]=t;else{Fr.debug("Add remote description",{participantId:this._participantId,sdp:t}),this._calcFingerprint(t.sdp);try{yield this._pc.setRemoteDescription(new RTCSessionDescription(t)),yield this._setRemoteCandidates(e)}catch(e){throw fi.log(Ht.ERROR,"setRemoteDescription-direct"),Fr.error("Unable to set remote description",e,{participantId:this._participantId,sdp:t}),e}}}))}_onAddTrack(e){Fr.debug("Added remote track",{participantId:this._participantId,kind:e.track.kind}),this._remoteStream?this._remoteStream.addTrack(e.track):(this._remoteStream=new MediaStream([e.track]),this._remoteStream.onremovetrack=e=>{this._triggerEvent(An.REMOTE_TRACK_REMOVED,this._remoteStream,e.track)}),this._triggerEvent(An.REMOTE_TRACK_ADDED,this._remoteStream,e.track)}_handleIceCandidate(e){return st(this,null,(function*(){e.candidate&&this._signaling.ready&&(Fr.debug("Local ice candidate",{participantId:this._participantId,candidate:e.candidate}),yield this._signaling.sendCandidate(this._participantId,e.candidate))}))}_onSignalingStateChange(){switch(Fr.debug(`DirectTransport: Signaling state changed to ${this._pc.signalingState}`,{participantId:this._participantId}),this._pc.signalingState){case"have-local-offer":let e=this._pc.localDescription;e?this._signaling.sendSdp(this._participantId,e).catch(this.close.bind(this)):this.close(new Error);break;case"have-remote-offer":this._createAnswer().catch(this.close.bind(this)).then((e=>st(this,null,(function*(){return this._signaling.sendSdp(this._participantId,e)})))).catch(this.close.bind(this))}}_onIceConnectionStateChange(){if("checking"===(Fr.debug(`DirectTransport: Ice Connection state changed to ${this._pc.iceConnectionState}`,{participantId:this._participantId}),this._pc.iceConnectionState)){let e=this.getState();e===Pn.IDLE||e===Pn.OPENED?this._setState(Pn.CONNECTING):this._setState(Pn.RECONNECTING)}}_onConnectionStateChange(){switch(Fr.debug(`DirectTransport: Connection state changed to ${this._pc.connectionState}`,{participantId:this._participantId}),fi.log(Ht.ICE_CONNECTION_STATE,this._pc.connectionState),this._pc.connectionState){case"connected":this._neverConnected=!1,this._setState(Pn.CONNECTED),this._stopReconnection(),Ui.getPeerConnectionHostInfo(this._pc).then((e=>{e&&fi.log(Ht.ICE_CONNECTION_TYPE,e.type)}));break;case"failed":case"disconnected":this._reconnectionPrevented?this.close(new Error(`Ice connection ${this._pc.connectionState}`)):(this._setState(Pn.RECONNECTING),this._startReconnection());break;case"closed":this.close(new Error("Ice connection closed"))}}_startReconnection(){this._reconnectionTimeout||this._iceRestartTimeout||(Fr.log("Waiting for reconnection...",{participantId:this._participantId}),this._reconnectionTimeout=window.setTimeout((()=>{this._reconnectionTimeout=null,this._neverConnected?this._requestTopologySwitch():this._startIceRestart()}),Ar.transportConnectionWaitTime))}_requestTopologySwitch(){this._isMaster&&this._signaling.ready&&(Fr.log("Switch topology DIRECT to SERVER",{participantId:this._participantId}),this._signaling.switchTopology(bn.SERVER))}_stopReconnection(){this._reconnectionTimeout&&(clearTimeout(this._reconnectionTimeout),this._reconnectionTimeout=null),this._iceRestartTimeout&&(clearTimeout(this._iceRestartTimeout),this._iceRestartTimeout=null)}_startIceRestart(){this._isMaster?(fi.log(Ht.ICE_RESTART),Fr.log("Ice restart",{participantId:this._participantId}),this._createOffer(!0).catch(this.close.bind(this))):Fr.debug("Waiting for ice restart...",{participantId:this._participantId}),this._iceRestartTimeout=window.setTimeout((()=>{this._iceRestartTimeout=null,Fr.error("Ice restart failed",{participantId:this._participantId}),fi.log(Ht.ERROR,"iceRestart-direct"),this._requestTopologySwitch()}),Ar.iceRestartWaitTime)}_createOffer(e){return st(this,null,(function*(){let t={iceRestart:e,offerToReceiveAudio:!0,offerToReceiveVideo:!0};return Fr.debug("Create offer",{participantId:this._participantId,options:t}),this._pc.createOffer(t).catch((e=>{throw Fr.error("Unable to create offer",e,{participantId:this._participantId}),fi.log(Ht.ERROR,"createOffer-direct"),e})).then((e=>st(this,null,(function*(){return Fr.debug("Created offer",{participantId:this._participantId,offer:e}),e=Tn._patchDescription(e),Fr.debug("Set local description",{participantId:this._participantId,offer:e}),this._calcFingerprint(e.sdp),this._pc.setLocalDescription(e).then((()=>this._pc.localDescription))})))).catch((e=>{throw Fr.error("Unable to set local description",e,{participantId:this._participantId}),fi.log(Ht.ERROR,"setLocalDescription-direct"),e}))}))}_createAnswer(){return st(this,null,(function*(){return Fr.debug("Create answer",{participantId:this._participantId}),this._pc.createAnswer().catch((e=>{throw Fr.error("Unable to create answer",e,{participantId:this._participantId}),fi.log(Ht.ERROR,"createAnswer-direct"),e})).then((e=>st(this,null,(function*(){return Fr.debug("Created answer",{participantId:this._participantId,answer:e}),e=Tn._patchDescription(e),Fr.debug("Set local description",{participantId:this._participantId,answer:e}),this._calcFingerprint(e.sdp),this._pc.setLocalDescription(e)})))).then((()=>this._pc.localDescription)).catch((e=>{throw Fr.error("Unable to set local description",e,{participantId:this._participantId}),fi.log(Ht.ERROR,"setLocalDescription-direct"),e}))}))}static _patchDescription(e){let t=!!dr.baseChromeVersion();return e.sdp=Ui.patchSDP(e.sdp,Ar.preferH264&&dr.canPreferH264(),dr.isBrokenH264(),Ar.preferVP9,Ar.h264spsPpsIdrInKeyframe,t&&Ar.audioNack,Ar.p2pAudioRed),e}_onReplacedTrack(e){this._pc&&(this._pc.getSenders().forEach((t=>{t.track&&t.track.kind===e.kind&&(t.track.enabled=e.enabled,t.replaceTrack(e).catch((e=>{Fr.error("DirectTransport: Unable to replace track",e,{participantId:this._participantId}),fi.log(Ht.ERROR,"replaceTrack-direct")})))})),this._applySettings())}_startStatInterval(){if(this._statInterval)return;let e=()=>{this._pc?gn(this._pc,this._lastStat).then((t=>{this._lastStat=t;let i={inbound:{topology:bn.DIRECT,transport:t.transport,rtps:t.rtps.filter((e=>"inbound-rtp"===e.type&&(e.userId=this._participantId,!0)))},outbound:{topology:bn.DIRECT,transport:t.transport,rtps:t.rtps.filter((e=>"outbound-rtp"===e.type))}};this._checkBadNetwork(i),this._triggerEvent(An.REMOTE_DATA_STATS,i),this._statInterval=window.setTimeout(e,Ar.statisticsInterval)})):this._stopStatInterval()};this._statInterval=window.setTimeout(e,Ar.statisticsInterval)}_stopStatInterval(){this._statInterval&&(window.clearTimeout(this._statInterval),this._statInterval=null)}_checkBadNetwork(e){if(!this._signaling.ready)return;let t=e=>e.rtt<=this._networkLimits.goodNet.rtt&&e.loss<=this._networkLimits.goodNet.loss,i=e=>e.rtt>=this._networkLimits.badNet.rtt||e.loss>=this._networkLimits.badNet.loss,r=Math.round(1e3*e.outbound.transport.currentRoundTripTime)||0,n=e.inbound.rtps.reduce(((e,t)=>Math.max(e,t.packetLoss||0)),0),a={rtt:this._lastNetworkStat.rtt*(1-yn)+r*yn,loss:this._lastNetworkStat.loss*(1-yn)+n*yn},s=i(a),o=t(a),c=i(this._remoteNetworkStat),d=t(this._remoteNetworkStat),l=i(this._lastNetworkStat),u=t(this._lastNetworkStat),p=s||c?.2:o&&d?1:0,h=Date.now();if((l!==s||u!==o||h-this._lastNetworkStat.date>Ar.networkStatisticsInterval)&&(this._lastNetworkStat.date=Date.now(),this._signaling.customData({sdk:Object.assign({type:"bad-net"},a)},null).catch((e=>{Fr.warn("Unable to send [bad-net]",e)}))),p){let e={};e[this._participantId]=e[""]=p,this._triggerEvent(An.NETWORK_STATUS,e)}this._lastNetworkStat.rtt=a.rtt,this._lastNetworkStat.loss=a.loss}_startSettingsInterval(){if(this._settingsInterval)return;let e=()=>{this._pc?(this._applySettings(),this._settingsInterval=window.setTimeout(e,2e3)):this._stopSettingsInterval()};this._settingsInterval=window.setTimeout(e,2e3)}_stopSettingsInterval(){this._settingsInterval&&(window.clearTimeout(this._settingsInterval),this._settingsInterval=null)}_calcFingerprint(e){let t=Ui.sdpFingerprint(e);null!==t?null===this._fingerprint?this._fingerprint=t:(Ur.onFingerprintChange((this._fingerprint^t).toString()),this._fingerprint=null):Fr.warn("Fingerprint calculation is unsupported")}_applySettings(){var e;let t=this._mediaSource.getMediaSettings().isScreenSharingEnabled?this._serverSettings.screenSharing:this._serverSettings.camera;t&&"connected"===(null==(e=this._pc)?void 0:e.connectionState)&&(this._prevConsumerSettings=Ui.applySettings(this._pc,t,this._prevConsumerSettings))}},Cn=(e=>(e.producerNotification="producerNotification",e.producerCommand="producerCommand",e.consumerScreenShare="consumerScreenShare",e.producerScreenShare="producerScreenShare",e))(Cn||{}),Rn=Cn,In=class extends dt{constructor(e,t,i){super(),this._pc=null,this._producerNotification=null,this._producerCommand=null,this._producerScreen=null,this._consumerScreen=null,this._isOpen=!1,this._observer=!1,this._reconnectionPrevented=!1,this._state=Pn.IDLE,this._statInterval=null,this._settingsInterval=null,this._statBytes={},this._ssrcMap={},this._producerOfferIsProcessing=!1,this._producerNextOffer=null,this._prevConsumerSettings={},this._captureSender=null,this._captureReceiver=null,this._participantIdRegistry=null,this._disabledSenders=new Set,this._rtpReceiversByStreamId={},this._producerSessionId="",this._signaling=e,this._mediaSource=t,this.subscribe(this._signaling,Bt.NOTIFICATION,this._onSignalingNotification.bind(this)),this.subscribe(this._mediaSource,Pi.TRACK_REPLACED,this._onReplacedTrack.bind(this)),this.subscribe(this._mediaSource,Pi.SOURCE_CHANGED,this._applyConsumerSettings.bind(this)),this.subscribe(this._mediaSource,Pi.SCREEN_STATUS,this._onScreenSharingStatus.bind(this)),this._perfStatReporter=new an(this,e),this._serverSettings=i,Fr.debug("ServerTransport: Created")}getState(){return this._state||Pn.IDLE}updateStatisticsInterval(){this._stopStatInterval();let e=this.getState();e!==Pn.IDLE&&e!==Pn.CLOSED&&e!==Pn.FAILED&&this._startStatInterval()}open(e=!1){this._isOpen?Fr.log("ServerTransport: Already opened connections"):(this._isOpen=!0,this._observer=e,this._openConnection())}close(e){this._isOpen=!1,this._closeConnection(),this.unsubscribe(),e?(Fr.error("ServerTransport: Closed",e),this._setState(Pn.FAILED)):(Fr.debug("ServerTransport: Closed"),this._setState(Pn.CLOSED))}removeParticipant(e){var t;null==(t=this._captureReceiver)||t.close(e)}preventRestart(){this._reconnectionPrevented=!0}allowRestart(){this._reconnectionPrevented=!1}updateSettings(e){Jr(e,this._serverSettings)||(this._serverSettings=e,this._applyConsumerSettings())}_closeConnection(){this._stopStatInterval(),this._stopSettingsInterval(),this._removeCaptureSender(),this._removeCaptureReceiver(),this._pc&&(this._rtpReceiversByStreamId={},this._disabledSenders.forEach((e=>{var t;return null==(t=e.track)?void 0:t.stop()})),this._disabledSenders.clear(),this._pc.ontrack=null,this._pc.onconnectionstatechange=null,this._pc.onsignalingstatechange=null,this._participantIdRegistry=null,In._closeDataChannel(this._producerNotification),In._closeDataChannel(this._producerCommand),In._closeDataChannel(this._producerScreen),In._closeDataChannel(this._consumerScreen),this._pc.close(),this._pc=null,this._producerOfferIsProcessing=!1,this._producerNextOffer=null),this._triggerEvent(An.PEER_CONNECTION_CLOSED)}static _closeDataChannel(e){e&&(e.onopen=null,e.onmessage=null,e.onerror=null,e.close())}_createDataChannel(e,t,i){Fr.debug(`[${t}] data channel opening`);let r=e.createDataChannel(t,{ordered:!0});r.onopen=()=>{let e=r.readyState;"open"===e?(Fr.debug(`[${t}] data channel opened`),r.onerror=e=>{Fr.error(`[${t}] data channel error`,e)},i(r)):Fr.error(`[${t}] data channel open failed, state [${e}]`)}}_openConnection(e=!1){Fr.debug("ServerTransport: Open single connection");let t={};dr.baseChromeVersion()&&(t.sdpSemantics=In._isUnifiedPlanSupported()?"unified-plan":"plan-b"),this._pc=new RTCPeerConnection(t,{optional:[{googSuspendBelowMinBitrate:!1}]}),this._pc.ontrack=this._onAddTrack.bind(this,this._pc),this._pc.onconnectionstatechange=Ui.throttle((e=>{this._pc&&this._onConnectionStateChange(this._pc,e)}),500),this._pc.onsignalingstatechange=In._onSignalingStateChange.bind(this,this._pc),Ar.producerNotificationDataChannel&&this._createDataChannel(this._pc,Rn.producerNotification,(e=>{this._producerNotification=e,this._producerNotification.binaryType="arraybuffer",this._participantIdRegistry=new class{constructor(){this.streamDescriptionByCompactId=new Map,this.compactIdByStreamDescription=new Map}getStreamDescription(e){return this.streamDescriptionByCompactId.get(e)}getCompactId(e){return this.compactIdByStreamDescription.get(e)}handleMessage(e){var t,i;let r=new Uint8Array(e),n=r[0],a=r.subarray(1);switch(n){case 1:let e=Ke(a);return Object.entries(e).forEach((([e,t])=>{let i=qr(e);this.streamDescriptionByCompactId.set(t,i),this.compactIdByStreamDescription.set(e,t)})),null;case 2:case 4:let r=Ke(a),s=[];for(let e of r){let t=this.getStreamDescription(e);t&&s.push(t.participantId)}return 2===n?{type:"notification",notification:Ft.AUDIO_ACTIVITY,activeParticipants:s}:{type:"notification",notification:Ft.STALLED_ACTIVITY,stalledParticipants:s};case 3:let o=Ke(a);return{type:"notification",notification:Ft.SPEAKER_CHANGED,speaker:null==(t=this.getStreamDescription(o))?void 0:t.participantId};case 5:let c=Ke(a);return{type:"notification",notification:Ft.VIDEO_QUALITY_UPDATE,quality:{maxBitrate:c[0],maxDimension:c[1]}};case 6:let d=Ke(a),l={};for(let[e,t]of Object.entries(d)){let r=null==(i=this.getStreamDescription(Number(e)))?void 0:i.participantId;r&&(l[r]=t/100)}return{type:"notification",notification:Ft.NETWORK_STATUS,statuses:l};case 7:return this._createParticipantSourcesUpdateNotification(a);case 8:{let e=Ke(a).map((e=>{var t;let[i,r,n,a,s]=e;return{participantId:null==(t=this.getStreamDescription(i))?void 0:t.participantId,gain:r,pause:n,offset:a,duration:s}}));return{type:"notification",notification:Ft.MOVIE_UPDATE_NOTIFICATION,data:e}}default:return Fr.debug("unsupported message type: "+n),null}}_createParticipantSourcesUpdateNotification(e){let t=Ke(e),i=[];for(let[e,r]of Object.entries(t)){let t,n=r[0],a=r[1],s=r[2];if(null!==n){if(t=this.getStreamDescription(n),!t){Fr.error(`could not uncompress participant ID ${n}`);continue}}else t=null;if(null===s){Fr.error("unexpected null sequenceNumber",e,r);continue}let o=Wt.PARTICIPANT_AGNOSTIC_TRACK_PREFIX+"-"+e,c=a?a>>>0:null;i.push({participantStreamDescription:t,streamId:o,rtpTimestamp:c,sequenceNumber:s})}return{type:"notification",notification:Ft.PARTICIPANT_SOURCES_UPDATE,participantUpdateInfos:i}}},this._signaling.setParticipantIdRegistry(this._participantIdRegistry),this._signaling.setProducerNotificationDataChannel(e)})),Ar.producerCommandDataChannel&&(this._signaling.useCommandDataChannel(!0),this._createDataChannel(this._pc,Rn.producerCommand,(e=>{this._producerCommand=e,this._signaling.setProducerCommandDataChannel(e)}))),Ar.producerScreenDataChannel&&this._createDataChannel(this._pc,Rn.producerScreenShare,(e=>{this._producerScreen=e,this._producerScreen.binaryType="arraybuffer",this._createCaptureReceiver()}));try{this._mediaSource.addTrackToPeerConnection(this._pc,this._observer,!1,Ar.serverAudioRed),this._prevConsumerSettings={},this._applyConsumerSettings()}catch(e){return Fr.error("ServerTransport: Unable to add media source tracks",e),fi.log(Ht.ERROR,"addTrack-single"),void this.close(e)}Ar.consumerScreenDataChannel&&this._createDataChannel(this._pc,Rn.consumerScreenShare,(e=>{this._consumerScreen=e,this._consumerScreen.binaryType="arraybuffer";let t=this._mediaSource.getScreenTrack();t&&this._createCaptureSender(t)})),e||this._allocateConsumer(),this._setState(Pn.OPENED),this._startStatInterval(),this._startSettingsInterval()}_reconnect(){this.getState()!==Pn.OPENED&&(this._setState(Pn.RECONNECTING),this._closeConnection(),this._openConnection(!0))}_signalActiveParticipants(e){this._triggerEvent(An.SIGNALLED_ACTIVE_PARTICIPANTS,e)}_signalStalledParticipants(e){this._triggerEvent(An.SIGNALLED_STALLED_PARTICIPANTS,e)}_signalSpeakerChanged(e){this._triggerEvent(An.SIGNALLED_SPEAKER_CHANGED,e)}_signalNetworkStatus(e){this._triggerEvent(An.NETWORK_STATUS,e)}_updateSSRCMap(e){e&&e.sdp.split("\n").forEach((e=>{let t=`a=ssrc:([0-9]+) label:(audio|video)-((?:[ug]?[\\d]+)|(?:mix)|(?:${Wt.PARTICIPANT_AGNOSTIC_TRACK_PREFIX}-[0-9]+))`,i=new RegExp(t).exec(e);i&&(this._ssrcMap[i[1]]=i[3])}))}_createCaptureSender(e){!e||!Ar.consumerScreenDataChannel||!this._consumerScreen||!this._mediaSource.getMediaSettings().isScreenSharingEnabled||(this._captureSender&&this._removeCaptureSender(),this._captureSender=new Cr(e,this._consumerScreen))}_removeCaptureSender(){var e;null==(e=this._captureSender)||e.destroy(),this._captureSender=null}_createCaptureReceiver(){!Ar.producerScreenDataChannel||!this._producerScreen||!this._participantIdRegistry||(this._captureReceiver&&this._removeCaptureReceiver(),this._captureReceiver=new Sr(this._producerScreen,this._participantIdRegistry,((e,t)=>{this._triggerEvent(An.REMOTE_STREAM_SECOND,e,t)}),(e=>{this._triggerEvent(An.REMOTE_STREAM_SECOND,e,null)})))}_removeCaptureReceiver(){var e;null==(e=this._captureReceiver)||e.destroy(),this._captureReceiver=null}_applyConsumerSettings(){let e=this._mediaSource.getMediaSettings().isScreenSharingEnabled&&!Ar.consumerScreenDataChannel?this._serverSettings.screenSharing:this._serverSettings.camera;if(e&&this._pc){let t=[];this._pc.getSenders().forEach((i=>{if(!i.track||i.track.kind!==bi.video)return;let r=!this._disabledSenders.has(i),n=0!==e.maxDimension;if(r&&!n)return Fr.log("Disabling video upload"),this._disabledSenders.add(i),void i.replaceTrack(dr.getBlackMediaTrack()).catch((e=>{Fr.error("Could not disable video upload",e)}));let a=this._mediaSource.getSendVideoTrack();if(!r&&n&&a){Fr.log("Enabling video upload"),this._disabledSenders.delete(i);let e=i.track;e.enabled=a.enabled,i.replaceTrack(a).then((()=>e.stop())).catch((e=>{Fr.error("Could not enable video upload",e)}))}Ui.applyVideoTrackSettings(e,i,null!=a?a:i.track,this._prevConsumerSettings,t)})),this._prevConsumerSettings=t}}_onScreenSharingStatus(e){e.track?this._createCaptureSender(e.track):this._removeCaptureSender()}_setState(e){this._state!==e&&(this._state=e,this._triggerEvent(An.STATE_CHANGED,e))}_startStatInterval(){if(this._statInterval)return;let e=()=>{this._pc?(this._collectStat().then((e=>{this._reportStats(e),this._detectStaleTracks(e)})).catch((()=>{})),this._statInterval=window.setTimeout(e,Ar.statisticsInterval)):this._stopStatInterval()};this._statInterval=window.setTimeout(e,Ar.statisticsInterval)}_stopStatInterval(){this._statInterval&&(window.clearTimeout(this._statInterval),this._statInterval=null),this._statBytes={}}_startSettingsInterval(){if(this._settingsInterval)return;let e=()=>{this._pc?(this._applyConsumerSettings(),this._settingsInterval=window.setTimeout(e,2e3)):this._stopSettingsInterval()};this._settingsInterval=window.setTimeout(e,2e3)}_stopSettingsInterval(){this._settingsInterval&&(window.clearTimeout(this._settingsInterval),this._settingsInterval=null)}_collectStat(){return st(this,null,(function*(){if(!this._pc)return Promise.reject();let e=yield gn(this._pc,this._lastStat,this._ssrcMap);return this._lastStat=e,e}))}_reportStats(e){this._triggerEvent(An.REMOTE_DATA_STATS,{inbound:{topology:bn.SERVER,transport:e.transport,rtps:e.rtps.filter((e=>"inbound-rtp"===e.type))},outbound:{topology:bn.SERVER,transport:e.transport,rtps:e.rtps.filter((e=>"outbound-rtp"===e.type))}})}_detectStaleTracks(e){let t=e.rtps.find((e=>"inbound-rtp"===e.type&&"audio"===e.kind&&"mix"===this._ssrcMap[e.ssrc]));if(!t)return;let i=Wt.AUDIO_MIX,r=this._statBytes[i],n=!1;if(r){let e=t.bytesReceived-r.bytesReceived;e>=0&&e<=5&&(n=!0),r.stalled!==n&&this._triggerEvent(An.REMOTE_ALL_STALL,n)}this._statBytes[i]={bytesReceived:t.bytesReceived,stalled:n}}_allocateConsumer(){if(!this._signaling.ready)return;let e={estimatedPerformanceIndex:an.getEstimatedPerformanceIndex(),audioMix:!0,consumerUpdate:!0,producerNotificationDataChannelVersion:Ar.producerNotificationDataChannel?7:0,producerCommandDataChannelVersion:Ar.producerCommandDataChannel?3:0,consumerScreenDataChannelVersion:Ar.consumerScreenDataChannel?1:0,producerScreenDataChannelVersion:Ar.producerScreenDataChannel?1:0,onDemandTracks:!0,unifiedPlan:In._isUnifiedPlanSupported(),singleSession:!0,videoTracksCount:Ar.videoTracksCount,red:Ar.serverAudioRed};this._signaling.allocateConsumer(null,e)}_acceptProducer(e){return st(this,null,(function*(){if(this._producerOfferIsProcessing)return this._producerNextOffer=e,void Fr.debug("[single] wait until other remote offer is processed");this._producerOfferIsProcessing=!0;let t=new RTCSessionDescription({type:"offer",sdp:e});if(Fr.debug("[single] set remote offer",{offer:t}),!this._pc)throw new Error("Interrupt allocation");this._pc.setRemoteDescription(t).catch((e=>{throw Fr.error("[single] unable to set remote offer",e),fi.log(Ht.ERROR,"setRemoteDescription-single"),e})).then((()=>st(this,null,(function*(){if(Fr.debug("[single] create local answer"),!this._pc)throw new Error("Interrupt allocation");return this._pc.createAnswer()})))).catch((e=>{throw Fr.error("[single] unable to create answer",e),fi.log(Ht.ERROR,"createAnswer-single"),e})).then((e=>(e.sdp=Ui.patchSDP(e.sdp,!1,dr.isBrokenH264(),!1,Ar.h264spsPpsIdrInKeyframe),e))).then((e=>st(this,null,(function*(){if(Fr.debug("[single] set local answer",{answer:e}),!this._pc)throw new Error("Interrupt allocation");return yield this._pc.setLocalDescription(e),e})))).catch((e=>{throw Fr.error("[single] unable to set local answer",e),fi.log(Ht.ERROR,"setLocalDescription-single"),e})).then((e=>st(this,null,(function*(){Fr.debug("[single] transmit local answer",{answer:e}),this._updateSSRCMap(t),yield this._signaling.acceptProducer(e,Object.keys(this._ssrcMap)),Fr.debug("[single] remote offer has been processed")})))).catch((e=>{Fr.warn("[single] unable to send local answer",e),fi.log(Ht.ERROR,"acceptProducer")})).then((()=>st(this,null,(function*(){if(this._producerOfferIsProcessing=!1,this._producerNextOffer){Fr.debug("[single] there is other unprocessed remote offer, process it");let e=this._producerNextOffer;return this._producerNextOffer=null,this._acceptProducer(e)}})))).catch((e=>this.close(e)))}))}_onSignalingNotification(e){return st(this,null,(function*(){if(this._isOpen)switch(e.notification){case Ft.PRODUCER_UPDATED:yield this._onProducerUpdated(e);break;case Ft.REALLOC_CON:this._reconnect();break;case Ft.AUDIO_ACTIVITY:this._signalActiveParticipants(e.activeParticipants);break;case Ft.SPEAKER_CHANGED:this._signalSpeakerChanged(e.speaker);break;case Ft.STALLED_ACTIVITY:this._signalStalledParticipants(e.stalledParticipants);break;case Ft.NETWORK_STATUS:this._signalNetworkStatus(e.statuses)}}))}_onProducerUpdated(e){return st(this,null,(function*(){this._producerSessionId&&this._producerSessionId!==e.sessionId&&this._reconnect(),Ar.breakVideoPayloadTypes&&(Fr.log("test mode enabled, video switched off"),this._signaling.requestTestMode("breakVideoPayloadTypes",null)),this._producerSessionId=e.sessionId,yield this._acceptProducer(e.description)}))}_onAddTrack(e,t){Fr.debug("[single] remote track (added)",{track:t.track});let i=t.streams[0];i?(i.onremovetrack||(i.onremovetrack=e=>{this._triggerEvent(An.REMOTE_TRACK_REMOVED,i.id,i,e.track)}),i.getTracks().find((e=>e.id===t.track.id))||i.addTrack(t.track),this._rtpReceiversByStreamId[i.id]=t.receiver,this._triggerEvent(An.REMOTE_TRACK_ADDED,i.id,i,t.track)):Fr.error("[single] unable to get media stream from track event")}static _onSignalingStateChange(e,t){Fr.debug("[single] signaling state changed",{state:e.signalingState},t)}_onConnectionStateChange(e,t){switch(Fr.debug("[single] connection state changed",{state:e.connectionState},t),fi.log(Ht.ICE_CONNECTION_STATE,e.connectionState),e.connectionState){case"failed":this._reconnectionPrevented?this.close(new Error("Ice connection failed")):this._reconnect();break;case"connecting":let t=this.getState();t===Pn.IDLE||t===Pn.OPENED?this._setState(Pn.CONNECTING):"checking"===e.iceConnectionState&&this._setState(Pn.RECONNECTING);break;case"disconnected":this._reconnectionPrevented?this.close(new Error("Ice connection disconnected")):this._setState(Pn.RECONNECTING);break;case"connected":this._setState(Pn.CONNECTED),Ui.getPeerConnectionHostInfo(e).then((e=>{e&&fi.log(Ht.ICE_CONNECTION_TYPE,e.type)}))}}_onReplacedTrack(e,t){this._pc&&(Ar.consumerScreenDataChannel&&t&&(e=t),this._pc.getSenders().forEach((t=>{t.track&&t.track.kind===e.kind&&!this._disabledSenders.has(t)&&(t.track.enabled=e.enabled,t.replaceTrack(e).catch((e=>{Fr.error("ServerTransport: Unable to replace track",e),fi.log(Ht.ERROR,"replaceTrack-single")})))}))),this._applyConsumerSettings()}static _isUnifiedPlanSupported(){let e=dr.baseChromeVersion();return e?Ar.isUnifiedPlanSupported("Chrome",e):Ar.isUnifiedPlanSupported(dr.browserName(),Number(dr.browserVersion()))}getStreamWaitingTimeMs(e,t){if(!this._pc)return fi.log(Ht.PAT_WAITING_TIME_ERROR,"noConnection"),Fr.error("Cannot get stream waiting time, peer connection is not initialized"),0;let i=this._rtpReceiversByStreamId[e];if(!i)return fi.log(Ht.PAT_WAITING_TIME_ERROR,"noReceiver"),Fr.error(`Cannot get stream waiting time, cannot find RTP receiver by stream ID: ${e}`),0;let r=i.getSynchronizationSources();if(!r||!r.length)return Fr.log(`Cannot get stream waiting time, ${e} receiver has no synchronization sources`),0;let n=r[0].rtpTimestamp;if(!Number.isInteger(n))return fi.log(Ht.PAT_WAITING_TIME_ERROR,"timestampNotInteger"),Fr.error(`Cannot get stream waiting time, ${e} receiver's RTP timestamp is not an integer: ${n}`),0;let a=t-n&4294967295,s=Math.ceil(a/90);return Math.min(100,Math.max(0,s))}},An=((Sn=An||{}).REMOTE_TRACK_ADDED="REMOTE_TRACK_ADDED",Sn.REMOTE_TRACK_REMOVED="REMOTE_TRACK_REMOVED",Sn.REMOTE_STREAM_SECOND="REMOTE_STREAM_SECOND",Sn.REMOTE_ALL_STALL="REMOTE_ALL_STALL",Sn.REMOTE_DATA_STATS="REMOTE_DATA_STATS",Sn.STATE_CHANGED="STATE_CHANGED",Sn.LOCAL_STATE_CHANGED="LOCAL_STATE_CHANGED",Sn.SIGNALLED_ACTIVE_PARTICIPANTS="SIGNALLED_ACTIVE_PARTICIPANTS",Sn.SIGNALLED_SPEAKER_CHANGED="SIGNALLED_SPEAKER_CHANGED",Sn.SIGNALLED_STALLED_PARTICIPANTS="SIGNALLED_STALLED_PARTICIPANTS",Sn.TOPOLOGY_CHANGED="TOPOLOGY_CHANGED",Sn.NETWORK_STATUS="NETWORK_STATUS",Sn.PEER_CONNECTION_CLOSED="PEER_CONNECTION_CLOSED",Sn),Pn=((vn=Pn||{}).IDLE="IDLE",vn.OPENED="OPENED",vn.CONNECTING="CONNECTING",vn.RECONNECTING="RECONNECTING",vn.CONNECTED="CONNECTED",vn.CLOSED="CLOSED",vn.FAILED="FAILED",vn),bn=(e=>(e.DIRECT="DIRECT",e.SERVER="SERVER",e))(bn||{}),On=class extends dt{constructor(e,t,i,r){super(),this._allocated=[],this._opened=[],this._directTransport=null,this._serverTransport=null,this._dtListeners=[],this._stListeners=[],this._states={},this._localState="IDLE",this._signaling=t,this._mediaSource=i,this._topology=e,this._serverSettings=r,this.subscribe(this._signaling,Bt.NOTIFICATION,this._onSignalingNotification.bind(this)),"SERVER"===e&&(this._serverTransport=this._createServerTransport())}updateSettings(e){Fr.log("Update transport settings",e),this._serverSettings=e,this._directTransport&&this._directTransport.updateSettings(e),this._serverTransport&&this._serverTransport.updateSettings(e)}updateStatisticsInterval(){this._directTransport&&this._directTransport.updateStatisticsInterval(),this._serverTransport&&this._serverTransport.updateStatisticsInterval()}allocate(e,t=!1){-1===this._allocated.indexOf(e)?(this._allocated.push(e),"DIRECT"===this._topology&&!this._directTransport&&(this._directTransport=this._createDirectTransport(e,t)),"SERVER"===this._topology&&!this._serverTransport&&(this._serverTransport=this._createServerTransport())):Fr.warn(`The participant [${e}] has already had allocated transport`)}open(e,t=null,i=!1,r=!1){let n=r;for(let t of e)-1===this._opened.indexOf(t)?-1!==this._allocated.indexOf(t)?(this._opened.push(t),n=!0):Fr.warn(`The participant [${t}] has no allocated transport`):Fr.warn(`The participant [${t}] has already had opened transport`);!n||("DIRECT"===this._topology&&this._directTransport&&this._directTransport.open(t),"SERVER"===this._topology&&this._serverTransport&&(this._serverTransport.open(i),this._setStates(e,this._serverTransport.getState()),this._setLocalState(this._serverTransport.getState())),Fr.debug("The transport has been opened",e))}close(e){var t;let i=this._allocated.indexOf(e),r=this._opened.indexOf(e);i<0&&Fr.warn(`The participant [${e}] transport has already deallocated`),"DIRECT"===this._topology&&this._directTransport&&(this._directTransport.close(),this._directTransport=null),"SERVER"===this._topology&&(null==(t=this._serverTransport)||t.removeParticipant(e),this._setState(e,"CLOSED")),r>=0&&this._opened.splice(r,1),i>=0&&this._allocated.splice(i,1)}destroy(){this.unsubscribe(),this._dtListeners&&this._dtListeners.forEach((e=>{e.dispose()})),this._stListeners&&this._stListeners.forEach((e=>{e.dispose()})),this._directTransport&&(this._directTransport.close(),this._directTransport=null),this._serverTransport&&(this._serverTransport.close(),this._serverTransport=null),this._allocated=[],this._opened=[]}getTopology(){return this._topology}isAllocated(e){return this._allocated.indexOf(e)>=0}allocated(){return this._allocated.slice()}opened(){return this._opened.slice()}getState(){var e,t;return"SERVER"===this._topology?null==(e=this._serverTransport)?void 0:e.getState():null==(t=this._directTransport)?void 0:t.getState()}_setStates(e,t){let i=e.filter((e=>this._states[e]!==t&&(this._states[e]=t,!0)));i.length&&this._triggerEvent("STATE_CHANGED",i,t)}_setState(e,t){this._states[e]!==t&&(this._states[e]=t,this._triggerEvent("STATE_CHANGED",[e],t))}_setLocalState(e){this._localState!==e&&(this._localState=e,this._triggerEvent("LOCAL_STATE_CHANGED",e))}_onSignalingNotification(e){if(e.notification===Ft.TOPOLOGY_CHANGED)return this._onTopologyChanged(e)}_onTopologyChanged(e){var t;if(e.topology!==this._topology){if(Fr.log(`Topology changed ${this._topology} -> ${e.topology}`),fi.log(Ht.TOPOLOGY_CHANGE_REQUESTED,e.topology),this._topology=e.topology,"SERVER"===this._topology&&(this._serverTransport?this._serverTransport.allowRestart():(this._serverTransport=this._createServerTransport(),this._opened.length>0&&(null==(t=this._directTransport)||t.preventRestart(),this._serverTransport.open()))),"DIRECT"===this._topology){let t=e.offerTo||[],i=e.offerToTypes||[],r=e.offerToDeviceIdxs||[],n=t.length&&i.length?Ui.composeParticipantId(t[0],i[0],r[0]):null;if(this._serverTransport&&this._serverTransport.preventRestart(),!this._allocated||0===this._allocated.length)return void Fr.error("Topology changed to DIRECT, but the list of allocated participants is empty");this._allocated.length>1&&Fr.warn("Topology changed to DIRECT, but the allocated participants count more then one");let a=this._allocated[0];if(this._directTransport)this._directTransport.allowRestart();else{let e=n===a;this._directTransport=this._createDirectTransport(a,e)}this._opened.indexOf(a)>=0&&this._directTransport.open()}this._triggerEvent("TOPOLOGY_CHANGED",this._topology)}}_createDirectTransport(e,t=!1){let i=new Tn(e,t,this._signaling,this._mediaSource,this._serverSettings);return this._dtListeners&&this._dtListeners.length>0&&Fr.warn(`The list of direct listeners for the participant [${e}] is not empty`),this._dtListeners=[],this._dtListeners.push(i.addEventListener("REMOTE_TRACK_ADDED",this._onDirectRemoteTrackAdded.bind(this,e)),i.addEventListener("REMOTE_TRACK_REMOVED",this._onDirectRemoteTrackRemoved.bind(this,e)),i.addEventListener("REMOTE_DATA_STATS",this._onDirectRemoteDataStats.bind(this)),i.addEventListener("STATE_CHANGED",this._onDirectTransportChanged.bind(this,e)),i.addEventListener("NETWORK_STATUS",this._onTransportNetworkStatus.bind(this)),i.addEventListener("PEER_CONNECTION_CLOSED",this._onPeerConnectionClosed.bind(this,"DIRECT"))),i}_createServerTransport(){let e=new In(this._signaling,this._mediaSource,this._serverSettings);return this._stListeners&&this._stListeners.length>0&&Fr.warn("The list of server transport listeners is not empty"),this._stListeners=[],this._stListeners.push(e.addEventListener("REMOTE_TRACK_ADDED",this._onServerRemoteTrackAdded.bind(this)),e.addEventListener("REMOTE_TRACK_REMOVED",this._onServerRemoteTrackRemoved.bind(this)),e.addEventListener("REMOTE_ALL_STALL",this._onServerRemoteAllStall.bind(this)),e.addEventListener("REMOTE_DATA_STATS",this._onServerRemoteDataStats.bind(this)),e.addEventListener("STATE_CHANGED",this._onServerTransportChanged.bind(this)),e.addEventListener("SIGNALLED_ACTIVE_PARTICIPANTS",this._onTransportActiveParticipants.bind(this)),e.addEventListener("SIGNALLED_SPEAKER_CHANGED",this._onTransportSpeakerChanged.bind(this)),e.addEventListener("SIGNALLED_STALLED_PARTICIPANTS",this._onTransportStalledParticipants.bind(this)),e.addEventListener("NETWORK_STATUS",this._onTransportNetworkStatus.bind(this)),e.addEventListener("REMOTE_STREAM_SECOND",this._onRemoteStreamSecond.bind(this)),e.addEventListener("PEER_CONNECTION_CLOSED",this._onPeerConnectionClosed.bind(this,"SERVER"))),e}_releaseDirectTransport(e){this._directTransport&&(e&&this._directTransport.close(),this._directTransport=null),this._dtListeners&&(this._dtListeners.forEach((e=>{e.dispose()})),this._dtListeners=[])}_releaseServerTransport(e){this._serverTransport&&(e&&this._serverTransport.close(),this._serverTransport=null),this._stListeners&&(this._stListeners.forEach((e=>{e.dispose()})),this._stListeners=[])}_setLocalNoiseSuppression(e){var t;Ar.noiseSuppression!==e&&(Ar.noiseSuppression=e,null==(t=this._mediaSource)||t.updateNoiseSuppression())}_onDirectTransportChanged(e,t){if("CONNECTED"===t&&"DIRECT"===this._topology&&this._releaseServerTransport(!0),("CLOSED"===t||"FAILED"===t)&&(this._releaseDirectTransport(!1),"DIRECT"===this._topology)){let t=this._opened.indexOf(e);t>=0&&this._opened.splice(t,1);let i=this._allocated.indexOf(e);i>=0&&this._allocated.splice(i,1)}"DIRECT"===this._topology&&(this._setState(e,t),this._setLocalState(t))}_onServerTransportChanged(e){let t=this._opened.slice();"CONNECTED"===e&&"SERVER"===this._topology&&this._releaseDirectTransport(!0),("CLOSED"===e||"FAILED"===e)&&(this._releaseServerTransport(!1),"SERVER"===this._topology&&(this._allocated=[],this._opened=[])),"SERVER"===this._topology&&(this._setStates(t,e),this._setLocalState(e))}_onTransportActiveParticipants(e){"SERVER"===this._topology&&this._triggerEvent("SIGNALLED_ACTIVE_PARTICIPANTS",e)}_onTransportStalledParticipants(e){"SERVER"===this._topology&&this._triggerEvent("SIGNALLED_STALLED_PARTICIPANTS",e)}_onTransportSpeakerChanged(e){"SERVER"===this._topology&&this._triggerEvent("SIGNALLED_SPEAKER_CHANGED",e)}_onTransportNetworkStatus(e){this._triggerEvent("NETWORK_STATUS",e)}_onRemoteStreamSecond(e,t){this._triggerEvent("REMOTE_STREAM_SECOND",e,t)}_onPeerConnectionClosed(e){this._triggerEvent("PEER_CONNECTION_CLOSED",e)}_onServerRemoteAllStall(e){"SERVER"===this._topology&&this._triggerEvent("REMOTE_ALL_STALL",e)}_onServerRemoteDataStats(e){this._triggerEvent("REMOTE_DATA_STATS",e)}_onDirectRemoteTrackAdded(e,t,i){this._triggerEvent("REMOTE_TRACK_ADDED",e,t,i)}_onDirectRemoteTrackRemoved(e,t,i){this._triggerEvent("REMOTE_TRACK_REMOVED",e,t,i)}_onDirectRemoteDataStats(e){this._triggerEvent("REMOTE_DATA_STATS",e)}_onServerRemoteTrackAdded(e,t,i){this._triggerEvent("REMOTE_TRACK_ADDED",e,t,i)}_onServerRemoteTrackRemoved(e,t,i){this._triggerEvent("REMOTE_TRACK_REMOVED",e,t,i)}getStreamWaitingTimeMs(e,t){return"SERVER"!==this._topology?(fi.log(Ht.PAT_WAITING_TIME_ERROR,"wrongTopology"),Fr.error(`Cannot get stream waiting time, incorrect topology: ${this._topology}`),0):this._serverTransport?this._serverTransport.getStreamWaitingTimeMs(e,t):(fi.log(Ht.PAT_WAITING_TIME_ERROR,"noTransport"),Fr.error("Cannot get stream waiting time, server transport is not initialized"),0)}},Dn=((En=Dn||{}).VOLUMES_DETECTED="VOLUMES_DETECTED",En),wn=class extends dt{constructor(e){super(),this._detector=null,this._interval=null,this.subscribe(e,An.REMOTE_TRACK_ADDED,this._onRemoteTrackAdded.bind(this)),this.subscribe(e,An.REMOTE_TRACK_REMOVED,this._onRemoteTrackRemoved.bind(this)),this.subscribe(e,An.SIGNALLED_ACTIVE_PARTICIPANTS,this._onSignalledActiveParticipants.bind(this)),this.subscribe(e,An.TOPOLOGY_CHANGED,this._onTopologyChanged.bind(this))}destroy(){var e;this._interval&&(window.clearTimeout(this._interval),this._interval=null),this.unsubscribe(),null==(e=this._detector)||e.destroy(),this._detector=null}_onRemoteTrackAdded(e,t,i){var r;if(i.kind===bi.audio&&(null==(r=this._detector)||r.destroy(),this._detector=new tn(e,t),!this._interval)){let e=()=>{this._collectVolumes(),this._interval=window.setTimeout(e,Ar.voiceParams.interval)};this._interval=window.setTimeout(e,Ar.voiceParams.interval)}}_onRemoteTrackRemoved(e,t,i){i.kind===bi.audio&&(!this._detector||this._detector.stream!==t||(this._detector.destroy(),this._detector=null))}_collectVolumes(){if(!this._detector)return;let e={},t=this._detector.trackId,i=this._detector.getLevel();if(t===Wt.AUDIO_MIX){if(this._activeParticipants)for(let t of this._activeParticipants)e[t]=i}else e[t]=i;this._triggerEvent("VOLUMES_DETECTED",e)}_onSignalledActiveParticipants(e){this._activeParticipants=e}_onTopologyChanged(e){e===bn.DIRECT&&(this._activeParticipants=null)}},Nn=(e=>(e.SPEAKER_CHANGED="SPEAKER_CHANGED",e))(Nn||{}),kn=class extends dt{constructor(e,t,i){super(),this._speakerId=null,this._serverSideSpeakerDetection=!1,this._serverSideSpeakerDetection=i===bn.SERVER,this.subscribe(e,Dn.VOLUMES_DETECTED,this._onVolumesDetected.bind(this)),this.subscribe(t,An.SIGNALLED_SPEAKER_CHANGED,this._onServerSpeakerChanged.bind(this)),this.subscribe(t,An.TOPOLOGY_CHANGED,this._onTopologyChanged.bind(this))}destroy(){this.unsubscribe()}_onVolumesDetected(e){if(this._serverSideSpeakerDetection)return;let t=0,i=null;if(Object.keys(e).forEach((r=>{let n=e[r].smoothed;n>t&&n>Ar.voiceParams.threshold&&(t=n,i=r)})),i&&i!==this._speakerId){let r=this._speakerId&&e.hasOwnProperty(this._speakerId)?e[this._speakerId].smoothed:0;t>r*Ar.voiceParams.speakerLevelMultiplier&&(this._speakerId=i,this._triggerEvent("SPEAKER_CHANGED",i))}}_onServerSpeakerChanged(e){this._serverSideSpeakerDetection&&this._triggerEvent("SPEAKER_CHANGED",e)}_onTopologyChanged(e){this._serverSideSpeakerDetection=e===bn.SERVER}},Ln=class extends dt{constructor(e,t,i){super(),this._states={},this._volumes={},this._participants={},this._connectionTimeout=0,this._volumeTimeout=0,this._transport=e,this._participants=i,this.subscribe(e,An.STATE_CHANGED,this._onTransportStateChanged.bind(this)),this.subscribe(t,Dn.VOLUMES_DETECTED,this._onVolumesDetected.bind(this))}destroy(){this.unsubscribe(),this._connectionTimeout&&window.clearTimeout(this._connectionTimeout),this._volumeTimeout&&window.clearTimeout(this._volumeTimeout)}onChangeRemoteMediaSettings(e,t){t.isAudioEnabled||(this._volumes[e]=1),t.isAudioEnabled&&(this._volumes[e]=0)}_onTransportStateChanged(e,t){e.forEach((e=>this._states[e]=t)),t===Pn.OPENED&&(this._connectionTimeout||(this._connectionTimeout=window.setTimeout(this._onConnectionTimeout.bind(this),Ar.specListenerParams.connectionTimeout)),this._volumeTimeout||(this._volumeTimeout=window.setTimeout(this._onVolumeTimeout.bind(this),Ar.specListenerParams.volumeTimeout))),t===Pn.FAILED&&this._connectionTimeout&&(Fr.warn("Transport failed, send callSpecError"),fi.log(Ht.CALL_SPEC_ERROR,`${this._transport.getTopology()}_CONNECTION_TIMEOUT`))}_onVolumesDetected(e){Object.keys(e).forEach((t=>{this._volumes[t]=Math.max(e[t].real,this._volumes[t]||0)}))}_onConnectionTimeout(){let e=e=>e!==Pn.CONNECTED;(()=>Object.values(this._states).filter(e).length>0)()&&(Fr.warn("There is not connected transport, send callSpecError"),fi.log(Ht.CALL_SPEC_ERROR,`${this._transport.getTopology()}_CONNECTION_TIMEOUT`)),this._connectionTimeout=0}_onVolumeTimeout(){let e=[];Object.keys(this._volumes).forEach((t=>{if(this._volumes[t]>0)return;let i="UNKNOWN",r=this._participants[t];r&&r.platform&&(i=r.platform),e.indexOf(i)<0&&(e.push(i),fi.log(Ht.CALL_SPEC_ERROR,`${this._transport.getTopology()}_VOLUME_TIMEOUT_${i}`))})),e.length&&Fr.warn("There is silent participant, send callSpecError"),this._volumeTimeout=0}},Mn=class extends dt{constructor(e,t,i){super(),this._mediaSource=null,this._conversation=null,this._state="IDLE",this._participantState=Lt.CALLED,this._participants={},this._transport=null,this._debugInfo=null,this._volumesDetector=null,this._speakerDetector=null,this._localVolumeDetector=null,this._specListener=null,this._activeSpeakerId=null,this._lastSignalledActiveSpeakerId=null,this._serverSettings={camera:null,screenSharing:null},this._lastStalled={},this._remoteAllStalled=!1,this._audioFix=null,this._streamByStreamId=new Map,this._streamIdByStreamDescription=new Map,this._streamWaitTimerByStreamDescription=new Map,this._sequenceNumberByStreamDescription=new Map,this._cooldownTimestampByStreamDescription=new Map,this._cooldownQueueCleanupTimer=null,fi.create(e,i),this._api=e,this._signaling=t,this._onUnload=()=>{this._conversation&&this._api&&this._api.hangupConversation(this._conversation.id),fi.destroy()},window.addEventListener("unload",this._onUnload),this._audioOutput=new class{constructor(){this._output=null,this._volume=1,this._features={setSinkId:!!Audio.prototype.setSinkId}}add(e){this.destroy(),this._output={},this._output.audioTrack=e,this._initAudioElement()}remove(e){!this._output||this._output.audioTrack!==e||this.destroy()}get volume(){return this._volume}set volume(e){this._volume=Math.max(0,Math.min(1,e)),this._output&&this._output.audioElement&&(this._output.audioElement.volume=this._volume)}_initAudioElement(){var e;if(Ar.muteMode||!(null==(e=this._output)?void 0:e.audioTrack))return;let t="Safari"!==dr.browserName()||dr.isMobile(),i=document.createElement(t?"audio":"video");i.muted=!1,i.volume=this._volume,i.preload="auto";let r=()=>{Fr.warn("Error on play audio"),Ur.onAutoplayError()},n=e=>{i.srcObject=new MediaStream([e]),i.load();let t=i.play();t?t.catch(r):r()},a=()=>{var e;Fr.debug("Recover audio playback");let t=null==(e=this._output)?void 0:e.audioTrack;t?n(t):Fr.warn("Broken audio track")};i.onpause=a,i.onstalled=a,i.onerror=a,n(this._output.audioTrack),this._output.audioElement=i}_stopAudioElement(){var e,t,i;(null==(e=this._output)?void 0:e.audioElement)&&(this._output.audioElement.pause(),this._output.audioElement.srcObject=null),null==(i=null==(t=this._output)?void 0:t.audioTrack)||i.stop()}destroy(){!this._output||(this._stopAudioElement(),this._output=null)}changeOutput(){return st(this,null,(function*(){var e,t,i;try{if(!this._features.setSinkId)throw new Error('Feature "setSinkId" is not supported');if(!(null==(e=this._output)?void 0:e.audioElement))throw new Error("Audio Element is not initialized");let r=dr.getSavedOutput();r&&(yield null==(i=(t=this._output.audioElement).setSinkId)?void 0:i.call(t,r.deviceId))}catch(e){throw fi.log(Ht.ERROR,"change_output"),Fr.error("Output change failed",e),e}}))}},Ar.videoTracksCount>0&&(this._cooldownQueueCleanupTimer=window.setInterval(this._cleanupCooldownQueue.bind(this),1e3))}static current(){return Mn._current}static hangupAfterInit(){Mn._activationMutex&&!Mn._current&&(Mn._delayedHangup=!0)}static id(){var e,t;return(null==(t=null==(e=Mn._current)?void 0:e._conversation)?void 0:t.id)||null}onStart(e,t,i,r="",n=!1,a=!1){return st(this,null,(function*(){if(Mn._activationMutex)throw fi.log(Ht.ERROR,"startCall"),Fr.warn("Conversation: there is already running activation"),new Ai(bt.FAILED);Mn._activationMutex=!0;try{this._mediaSource=this._createMediaSource(),yield this._mediaSource.request(i);let s=this._mediaSource.getMediaSettings();t===_t.CHAT||e.length>1?this._logWithMediaSettings(Ht.OUTGOING_MULTIPARTY_CALL,s):this._logWithMediaSettings(Ht.OUTGOING_CALL,s);let o=yield this._startConversation(e,t,pt.OUTGOING,i,r,n,a);if(!this._conversation)throw new Ai(bt.UNKNOWN_ERROR);if(this._participantState=Lt.ACCEPTED,this._signaling.changeMediaSettings(s),yield this._processConnection(o),this._allocateTransport(),this._createSpeakerDetector(),this._createSpecListener(),this._signaling.readyToSend(),Mn._delayedHangup)throw new Ai(bt.CANCELED);Fr.debug("Outgoing call",{opponentIds:e,opponentType:t,mediaOptions:i});let c,d=Object.values(this._participants);return Ar.batchParticipantsOnStart&&(c=Ui.mapSharedParticipants(d)),Ur.onLocalStream(this._mediaSource.getStream(),this._mediaSource.getMediaSettings()),Ur.onConversation(this._conversation.externalId,this._conversation.mediaModifiers,this._conversation.muteStates,c),this._onConversationParticipantListChunk(o),Ur.onLocalStatus(Dr.WAITING),this._toggleJoinAvailability(),this._changeFeatureSet(),this._changeNeedRate(),Mn._current=this,this._conversation.concurrent?yield this._acceptConcurrent():Ar.batchParticipantsOnStart||this._setParticipantsStatus(d,Dr.WAITING),this._conversation}catch(e){throw this._close(e,"Unable to start conversation"),e}finally{Mn._activationMutex=!1}}))}onJoin(e){return st(this,null,(function*(){var t;if(Mn._activationMutex)throw fi.log(Ht.ERROR,"joinCall"),Fr.warn("Conversation: there is already running activation"),new Ai(bt.FAILED);Mn._activationMutex=!0,this._state="PROCESSING";try{let i=!!(null==(t=e.observedIds)?void 0:t.length);this._mediaSource=this._createMediaSource(),yield this._mediaSource.request(e.mediaOptions,!i);let r=this._mediaSource.getMediaSettings();this._logWithMediaSettings(Ht.JOIN_CONVERSATION,r);let n=yield this._joinConversation(e);if(!this._conversation)throw new Ai(bt.UNKNOWN_ERROR);return this._conversation.observer=i,Ur.onLocalStream(this._mediaSource.getStream(),r),this._conversation.waitingHall?(Fr.log("In waiting hall"),Mn._current=this,Mn._activationMutex=!1,this._signaling.readyToSend(),Ur.onLocalStatus(Dr.WAITING_HALL),this._conversation):this._onJoinPart2(n)}catch(e){throw Mn._activationMutex=!1,this._close(e,"Unable to join conversation"),e}}))}_onJoinPart2(e){return st(this,null,(function*(){Fr.debug("Join conversation part 2"),Mn._activationMutex=!0;try{if(this._participantState=Lt.ACCEPTED,!this._conversation||!this._mediaSource)throw new Ai(bt.UNKNOWN_ERROR);if(this._conversation.observer||this._signaling.changeMediaSettings(this._mediaSource.getMediaSettings()),yield this._processConnection(e),this._allocateTransport(),this._createSpeakerDetector(),this._createSpecListener(),this._signaling.readyToSend(),Mn._delayedHangup)throw new Ai(bt.CANCELED);let t,i=Object.values(this._participants);return Ar.batchParticipantsOnStart&&(t=Ui.mapSharedParticipants(i)),Ur.onConversation(this._conversation.externalId,this._conversation.mediaModifiers,this._conversation.muteStates,t),this._onConversationParticipantListChunk(e),Ur.onLocalStatus(Dr.WAITING),this._toggleJoinAvailability(),this._changeNeedRate(),this._state="ACTIVE",this._changeFeatureSet(),Mn._current=this,Ar.batchParticipantsOnStart||this._setParticipantsStatus(i,Dr.WAITING),this._openTransport(i,!1),this._conversation}catch(e){throw this._close(e,"Unable to join conversation"),e}finally{Mn._activationMutex=!1}}))}onPush(e){return st(this,arguments,(function*(e,t=Xt.USER,i){if(Mn._activationMutex)throw Fr.warn("Conversation: there is already running activation"),new Ai(bt.REJECTED);Mn._activationMutex=!0;try{let r=yield this._prepareConversation(e,t,i);if(this._mediaSource=this._createMediaSource(),!this._conversation)throw new Ai(bt.UNKNOWN_ERROR);if(!r.conversation.participants.find((e=>{var t;return e.state===Lt.CALLED&&e.id===(null==(t=this._conversation)?void 0:t.userId)})))throw Fr.log("Push rejected (there is an active call)"),fi.log(Ht.PUSH,"rejected"),new Ai(bt.REJECTED);if(yield this._processConnection(r),this._allocateTransport(),this._createSpeakerDetector(),this._createSpecListener(),this._signaling.readyToSend(),fi.log(Ht.PUSH,"accepted"),Mn._current=this,Mn._delayedHangup)throw new Ai(bt.CANCELED);Mn._activationMutex=!1}catch(e){throw Mn._activationMutex=!1,this._close(e,"Unable to handle inbound call push"),e}}))}_isInWaitingHall(e){if(!e.conversation||(e.conversation.options||[]).indexOf(Et.WAITING_HALL)<0)return!1;let t=(e.conversation.participants||[]).find((t=>Ui.comparePeerId(t.peerId,e.peerId)));return t&&t.restricted||!1}_acceptConcurrent(){return st(this,null,(function*(){if(!this._mediaSource||!this._conversation)throw new Ai(bt.UNKNOWN_ERROR);this._state="PROCESSING";let e=this._mediaSource.getMediaSettings();this._logWithMediaSettings(Ht.ACCEPT_CONCURRENT,e),Fr.debug("Concurrent call",{conversationId:this._conversation.id});try{yield this._signaling.acceptCall(this._mediaSource.getMediaSettings()),Ur.onCallAccepted(),this._state="ACTIVE",this._participantState=Lt.ACCEPTED,this._changeFeatureSet(),this._openTransport(Object.values(this._participants),!0)}catch(e){this._close(e,"Unable to accept concurrent call")}}))}accept(e){return st(this,null,(function*(){if("IDLE"!==this._state)throw fi.log(Ht.ERROR,"acceptIncoming"),Fr.error("Unable to accept a call - invalid state"),new Error("Unable to accept a call - invalid state");if(!this._mediaSource||!this._conversation)throw new Ai(bt.UNKNOWN_ERROR);this._state="PROCESSING",Fr.debug("Accept incoming call",e);try{yield this._mediaSource.request(e);let t=this._mediaSource.getMediaSettings();this._logWithMediaSettings(Ht.ACCEPT_INCOMING,t),this._signaling.changeMediaSettings(t),yield this._signaling.acceptCall(t),this._participantState=Lt.ACCEPTED;let i,r=Object.values(this._participants);if(Ar.batchParticipantsOnStart&&(i=Ui.mapSharedParticipants(r)),Ur.onCallAccepted(),Ur.onLocalStream(this._mediaSource.getStream(),t),Ur.onConversation(this._conversation.externalId,this._conversation.mediaModifiers,this._conversation.muteStates,i),Ar.useParticipantListChunk){let e=yield this._getInitialParticiapntListChunk();this._onConversationParticipantListChunk({participants:e})}Ur.onLocalStatus(Dr.WAITING),this._toggleJoinAvailability(),this._changeNeedRate();let n=Qr(this._conversation.muteStates,Nt.MUTE),a=Qr(this._conversation.muteStates,Nt.MUTE_PERMANENT);for(let e of[n,a])e.length&&(yield this._processMuteState({mediaOptions:e,stateUpdated:!0}));return this._state="ACTIVE",this._changeFeatureSet(),Ar.batchParticipantsOnStart||this._setParticipantsStatus(r,Dr.WAITING),this._openTransport(r,!0),this._conversation}catch(e){throw this._close(e,"Unable to accept call"),e}}))}decline(){return st(this,null,(function*(){var e;if("IDLE"!==this._state)throw fi.log(Ht.ERROR,"declineIncoming"),Fr.error("Unable to decline a call - invalid state"),new Error("Unable to decline a call - invalid state");this._state="PROCESSING",Fr.debug("Decline incoming call"),this._logWithMediaSettings(Ht.DECLINE_INCOMING,null==(e=this._mediaSource)?void 0:e.getMediaSettings()),this._participantState=Lt.HUNGUP,this._signaling.ready&&(yield this._signaling.hangup(bt.REJECTED)),this._close(new Ai(bt.REJECTED))}))}hangup(){return st(this,null,(function*(){Fr.debug("Hangup");let e="ACTIVE"===this._state?bt.HUNGUP:bt.CANCELED;fi.log(Ht.HANGUP,e),this._signaling.ready?(yield this._signaling.hangup(e),this._close(new Ai(e))):Ur.onHangup(new Ai(bt.HUNGUP),this._conversation&&this._conversation.id)}))}addParticipant(e,t){return st(this,null,(function*(){if(!this._signaling.ready)return void this._close(new Ai(bt.UNKNOWN_ERROR),"Unable to add participant");let i=yield this._signaling.addParticipant(e,t),r=null;"error"===i.type&&(r="call-unfeasible"===i.error?i.status:bt.UNKNOWN_ERROR);let n=i.participant;yield this._onAddParticipant(Ui.composeId(n),n,r)}))}removeParticipant(e,t=!1){return st(this,null,(function*(){this._signaling.ready&&(yield this._signaling.removeParticipant(e,t),this._onRemoveParticipant(e))}))}setVolume(e){this._audioOutput.volume=e}updateStatisticsInterval(){this._transport&&this._transport.updateStatisticsInterval()}_openTransport(e,t){var i;if(!this._transport)return;let r=[];for(let i of e)(i.state===Lt.CALLED||i.state===Lt.ACCEPTED)&&(this._transport.isAllocated(i.id)||this._transport.allocate(i.id,t)),i.state===Lt.ACCEPTED&&r.push(i.id);r.length&&this._transport.open(r,null,!!(null==(i=this._conversation)?void 0:i.observer))}_close(e,t){t&&Fr.error(t,e),Fr.debug("Close conversation",e),e.error?this._signaling.ready&&this._signaling.hangup(bt.FAILED):fi.log(Ht.ERROR,e.hangup),Mn._activationMutex=!1;let i=this._conversation&&this._conversation.id;return-1!==[bt.CANCELED,bt.NOT_FRIENDS,bt.CALLEE_IS_OFFLINE,bt.CALLER_IS_BLOCKED,bt.CALLER_IS_REJECTED].indexOf(e.hangup)||e.hangup===bt.REJECTED&&!e.remote?(Ur.onHangup(e,i),void this.destroy()):(e.hangup!==bt.HUNGUP||e.remote&&this._participantState!==Lt.CALLED)&&(e.hangup!==bt.MISSED||e.remote)?e.hangup===bt.SOCKET_CLOSED&&Mn._current&&!this._conversation?(this._cleanupSignaling(),void this._cleanupMediaSource()):e.hangup!==bt.BUSY||e.remote?(this._state="CLOSE",this._participantState=Lt.HUNGUP,this._changeFeatureSet(),this._cleanupMediaSource(),this._cleanupParticipants(),this._cleanupParticipantAgnosticStreams(),this._cleanupTransport(),this._cleanupSpeakerDetector(),this._cleanupSpecListener(),this._cleanupSignaling(),this._api.cleanup(),fi.destroy(),this._conversation=null,Mn._current=null,Mn._delayedHangup=!1,Ur.onHangup(e||new Ai(bt.UNKNOWN_ERROR),i),void(null!==this._cooldownQueueCleanupTimer&&(window.clearInterval(this._cooldownQueueCleanupTimer),this._cooldownQueueCleanupTimer=null))):(this._cleanupSignaling(),void this._cleanupMediaSource()):(Ur.onHangup(e,i),void this.destroy())}destroy(){let e=this._conversation&&this._conversation.id;Fr.debug("Destroy conversation",{conversationId:e}),this._cleanupMediaSource(),this._cleanupParticipants(),this._cleanupParticipantAgnosticStreams(),this._cleanupTransport(),this._cleanupSpeakerDetector(),this._cleanupSpecListener(),this._cleanupSignaling(),this._api.cleanup(),this._cleanupListeners(),fi.destroy(),this._conversation=null,Mn._current=null,Mn._delayedHangup=!1,null!==this._cooldownQueueCleanupTimer&&(window.clearInterval(this._cooldownQueueCleanupTimer),this._cooldownQueueCleanupTimer=null)}_getConversationParams(e){return st(this,null,(function*(){let t=yield this._api.getConversationParams(e);Fr.debug("Api.getConversationParams",t);let i=[],{turn_server:r,stun_server:n}=t;if(n&&i.push(n),r){let e=r.urls.filter(((e,t,i)=>i.indexOf(e)===t));e.push(`${e[e.length-1]}?transport=tcp`),i.push({urls:e,username:r.username,credential:r.credential})}return Ar.iceServers=i,Ar.wssBase=t.endpoint,Ar.wssToken=t.token,t.client_type&&(Ar.clientType=t.client_type),t}))}_addGeoParamsToEndpoint(e,t){return t.isp_as_no&&(e+=`&ispAsNo=${t.isp_as_no}`),t.isp_as_org&&(e+=`&ispAsOrg=${t.isp_as_org}`),t.loc_cc&&(e+=`&locCc=${t.loc_cc}`),t.loc_reg&&(e+=`&locReg=${t.loc_reg}`),e}_startConversation(e,t,i,r,n="",a=!1,s=!1){return st(this,null,(function*(){let o=Ui.uuid();Fr.debug("Conversation: start",{conversationId:o,opponentIds:e,opponentType:t,direction:i});let c=r.includes(Dt.VIDEO),d=yield this._api.startConversation(o,e,t,c,n,a,s);Fr.debug("Api.startConversation",d);let l=yield this._getConversationParams(d.id);d.endpoint=this._addGeoParamsToEndpoint(d.endpoint,l);let u=yield this._connectSignaling(Ut.START,d);return yield this._setConversation(d,u,i),u}))}_joinConversation(e){return st(this,null,(function*(){let{conversationId:t,mediaOptions:i,chatId:r,joinLink:n,observedIds:a}=e;Fr.debug("Conversation: join",{conversationId:t,joinLink:n,observedIds:a});let s,o=i.includes(Dt.VIDEO);if(t)s=yield this._api.joinConversation(t,o,r);else{if(!n)throw new Ai(bt.UNKNOWN_ERROR);s=yield this._api.joinConversationByLink(n,o,a)}Fr.debug("Api.joinConversation",s),yield this._getConversationParams(s.id);let c=yield this._connectSignaling(Ut.JOIN,s);return yield this._setConversation(s,c,pt.JOINING),c}))}_prepareConversation(e){return st(this,arguments,(function*(e,t=Xt.USER,i){Fr.debug("Conversation: push",{conversationId:e,type:t,peerId:i});let r=this._api.getUserId();if(!r)throw new Ai(bt.UNKNOWN_ERROR);let n=yield this._getConversationParams(e),a=n.device_idx||0,s=`${Ar.wssBase}?userId=${r}&entityType=${t}&deviceIdx=${a}&conversationId=${e}&token=${Ar.wssToken}`;s=this._addGeoParamsToEndpoint(s,n);let o={id:e,peerId:i,endpoint:s,is_concurrent:!1,p2p_forbidden:!1,device_idx:a},c=yield this._connectSignaling(Ut.ACCEPT,o);return!Mn._current||Mn._current._participantState!==Lt.ACCEPTED&&Mn._current._participantState!==Lt.CALLED?(Mn._current&&(Mn._current.destroy(),Mn._current=null),yield this._setConversation(o,c,pt.INCOMING,t),c):(Fr.log("Push rejected (busy)"),fi.log(Ht.PUSH,"busy"),this._signaling.ready&&this._signaling.hangup(bt.BUSY),Promise.reject({hangup:bt.BUSY}))}))}_createParticipant(e){return st(this,null,(function*(){var t;let i=Object.assign({id:null,externalId:null,mediaSettings:Ti(),participantState:{},state:Lt.CALLED,status:null,remoteStream:null,mediaSource:null,platform:null,clientType:null,roles:[],networkRating:1,lastRequestedLayouts:{},muteStates:{},unmuteOptions:[],observedIds:[]},e);if(e.externalId){let t=Ui.decomposeParticipantId(i.id).compositeUserId;this._api.cacheExternalId(t,e.externalId)}else i.externalId=yield this._getParticipantId(i.id);return(null==(t=i.observedIds)?void 0:t.length)&&(i.externalId.observer=!0),this._setParticipantMarkers(i,i.markers),i}))}_getParticipantId(e){return st(this,null,(function*(){try{let t=Ui.decomposeParticipantId(e),i=yield this._api.userId(t.compositeUserId);return Object.assign({deviceIdx:t.deviceIdx},i)}catch(e){throw this._close(new Ai(bt.NETWORK_ERROR),e),e}}))}_setConversation(e,t,i){return st(this,arguments,(function*(e,t,i,r=Xt.USER){yield this._prepareParticipants(t.conversation.participants);let n=this._api.getUserId(),a=e.device_idx||0;if(!n){let e=(t.conversation.participants||[]).find((e=>Ui.comparePeerId(e.peerId,t.peerId)));if(!e)throw new Ai(bt.UNKNOWN_ERROR);n=Number(e.id),e.idType&&(r=e.idType),e.deviceIdx&&(a=e.deviceIdx),this._api.setUserId(n)}let s=Ui.composeParticipantId(n,r,a),o=yield this._getParticipantId(s);this._conversation={userId:n,compositeUserId:s,externalId:o,acceptTime:t.conversation.acceptTime,features:t.conversation.features||[],id:t.conversation.id||e.id,participantsLimit:t.conversation.participantsLimit||30,topology:t.conversation.topology||bn.DIRECT,direction:i,concurrent:t.isConcurrent||e.is_concurrent||!1,needRate:!1,chatId:t.conversation.multichatId,roles:[],recordInfo:null,joinLink:e.join_link,pinnedParticipantId:null,mediaModifiers:t.mediaModifiers,options:[],muteStates:{},unmuteOptions:[],networkRating:1,waitingHall:this._isInWaitingHall(t),observer:!1},this._signaling.setConversationId(e.id),e.p2p_forbidden&&(Ar.forceRelayPolicy=e.p2p_forbidden),fi.log(Ht.RELAY_POLICY,Ar.forceRelayPolicy?"1":"0"),this._changeFeatureSet(),this._logDevices()}))}_updateConversation(e){if(!this._conversation)throw new Ai(bt.UNKNOWN_ERROR);this._conversation.acceptTime=e.conversation.acceptTime,this._conversation.features=e.conversation.features||[],this._conversation.participantsLimit=e.conversation.participantsLimit||30,this._conversation.topology=e.conversation.topology||bn.DIRECT,this._conversation.concurrent=e.isConcurrent||!1,this._conversation.chatId=e.conversation.multichatId,this._conversation.mediaModifiers=e.mediaModifiers,this._conversation.waitingHall=!1}_createMediaSource(){let e=new Oi;return this.subscribe(e,Pi.SOURCE_CHANGED,this._onLocalMediaStreamChanged.bind(this)),this.subscribe(e,Pi.SCREEN_STATUS,this._onScreenSharingStatus.bind(this)),this._audioFix=new Zr(e),e}_connectSignaling(e,t){return st(this,null,(function*(){return this._signaling.setEndpoint(t.endpoint),this.subscribe(this._signaling,Bt.NOTIFICATION,this._onSignalingNotification.bind(this)),this.subscribe(this._signaling,Bt.FAILED,this._onSignalingFailed.bind(this)),this.subscribe(this._signaling,Bt.RECONNECT,this._onSignalingReconnect.bind(this)),this._signaling.connect(e,t)}))}_processConnection(e){return st(this,null,(function*(){yield this._registerConnectionParticipants(e),this._processConnectionData(e)}))}_prepareParticipants(e){return st(this,null,(function*(){let t=e.map((e=>e.id));t.length&&(yield this._api.prepareUserIds(t))}))}_onConversationParticipantListChunk(e){let t=e.participants;t&&Ur.onConversationParticipantListChunk(this._participantListChunkToExternalChunk(this._createParticipantListChunk(t)))}_createParticipantListChunk(e){return nt(nt({},{participants:[],countBefore:0,countAfter:0,markerFound:!1}),e)}_participantListChunkToExternalChunk(e){let t=Ui.mapSharedParticipants(e.participants.map((e=>{let t=Ui.composeId(e);return this._participants[t]})));return at(nt({},e),{participants:t})}_registerConnectionParticipants(e){return st(this,null,(function*(){var t,i;yield this._registerParticipants(e.conversation.participants),(null==(t=e.participants)?void 0:t.participants)&&(yield this._registerParticipants(null==(i=e.participants)?void 0:i.participants))}))}_registerParticipants(e){return st(this,null,(function*(){if(this._conversation)for(let t of e){let e=Ui.composeId(t);e!==this._conversation.compositeUserId?t.state!==Lt.HUNGUP&&t.state!==Lt.REJECTED?(this._registerParticipantInCache(yield this._createParticipant({id:e,externalId:t.externalId&&Vr.fromSignaling(t.externalId,t.deviceIdx||0),mediaSettings:Ti(t.mediaSettings),participantState:Ui.mapParticipantState(t),state:t.state,roles:t.roles||[],status:Ar.batchParticipantsOnStart?Dr.WAITING:null,muteStates:t.muteStates||{},unmuteOptions:t.unmuteOptions||[],observedIds:t.observedIds||[],markers:this._denormalizeMarkers(e,t.markers),movieShareInfos:t.movieShareInfos})),t.roles&&t.roles.length&&(Fr.debug(`Roles for participant [${e}] changed: ${t.roles}`),Ur.onRolesChanged(this._participants[e].externalId,t.roles))):this._participants[t.id]&&this._removeParticipant(this._participants[t.id],bt.HUNGUP):(this._conversation.roles=t.roles||[],this._conversation.roles.length&&(Fr.debug(`Local roles changed: ${t.roles}`),Ur.onLocalRolesChanged(this._conversation.roles)),yield this._registerParticipantLocalMuteState(t))}}))}_registerParticipantLocalMuteState(e){return st(this,null,(function*(){if(!e.muteStates)return Promise.resolve();let t=Qr(e.muteStates,Nt.MUTE),i=Qr(e.muteStates,Nt.MUTE_PERMANENT);for(let r of[t,i])!r.length||(yield this._onMuteParticipant({muteStates:e.muteStates,unmuteOptions:e.unmuteOptions,mediaOptions:r,stateUpdated:!0}))}))}_getClientType(){return Ar.clientType}_getStatusByTransportState(e){let t;return e===Pn.CONNECTED?t=Dr.CONNECTED:e===Pn.CONNECTING||e===Pn.OPENED?t=Dr.CONNECTING:e===Pn.RECONNECTING&&(t=Dr.RECONNECT),t}_registerParticipantInCache(e){return this._participants[e.id]=e}_getExistedParticipantByIdOrCreate(e){return st(this,null,(function*(){return this._participants[e]||this._createParticipant({id:e})}))}_getExternalIdByParticipantId(e){return st(this,null,(function*(){var t;return Ar.useParticipantListChunk?(yield this._getExistedParticipantByIdOrCreate(e)).externalId:null==(t=this._participants[e])?void 0:t.externalId}))}_registerParticipantAndSetMarkersIfChunkEnabled(e,t){return st(this,null,(function*(){if(Ar.useParticipantListChunk){let i=this._registerParticipantInCache(yield this._getExistedParticipantByIdOrCreate(e));return this._setParticipantMarkers(i,t),i}return this._participants[e]}))}_warnParticipantNotInConversation(e){Fr.warn(`Participant [${e}] isn't in conversation`)}_setParticipantMarkers(e,t){return e.markers=this._denormalizeMarkers(e.id,t),e}_denormalizeMarkers(e,t){if(!t)return null;let i=Object.values(t).find((e=>"ts"in e&&"rank"in e));return Object.entries(t).reduce(((t,[r,n])=>(t[r]=at(nt(nt({},i),n),{id:e}),t)),{})}_processConnectionData(e){return st(this,null,(function*(){Ui.isEmptyObject(this._conversation.muteStates)&&e.conversation.muteStates&&this._onMuteParticipant({muteStates:e.conversation.muteStates,unmuteOptions:e.unmuteOptions,mediaOptions:Object.keys(e.conversation.muteStates),muteAll:!0,stateUpdated:!0}),e.conversation.pinnedParticipantId&&(yield this._onPinParticipant(e.conversation.pinnedParticipantId)),this._onRecordInfo(e.conversation.recordInfo),this._onOptionsChanged(e.conversation.options),e.chatRoom&&e.chatRoom.totalCount&&this._onChatRoomUpdated(mt.ATTENDEE,e.chatRoom.totalCount,e.chatRoom.firstParticipants)}))}_allocateTransport(){if(!this._conversation||!this._mediaSource)return;this._transport=new On(this._conversation.topology,this._signaling,this._mediaSource,this._serverSettings),this._debugInfo=new en,this.subscribe(this._transport,An.STATE_CHANGED,this._onTransportStateChanged.bind(this)),this.subscribe(this._transport,An.LOCAL_STATE_CHANGED,this._onTransportLocalStateChanged.bind(this)),this.subscribe(this._transport,An.REMOTE_TRACK_ADDED,this._onRemoteTrackAdded.bind(this)),this.subscribe(this._transport,An.REMOTE_TRACK_REMOVED,this._onRemoteTrackRemoved.bind(this)),this.subscribe(this._transport,An.REMOTE_ALL_STALL,this._onRemoteAllStall.bind(this)),this.subscribe(this._transport,An.REMOTE_DATA_STATS,this._onRemoteDataStats.bind(this)),this.subscribe(this._transport,An.SIGNALLED_STALLED_PARTICIPANTS,this._onRemoteSignalledStall.bind(this)),this.subscribe(this._transport,An.TOPOLOGY_CHANGED,this._onTopologyChanged.bind(this)),this.subscribe(this._transport,An.NETWORK_STATUS,this._onNetworkStatus.bind(this)),this.subscribe(this._transport,An.REMOTE_STREAM_SECOND,this._onRemoteStreamSecond.bind(this)),this.subscribe(this._transport,An.PEER_CONNECTION_CLOSED,this._onPeerConnectionClosed.bind(this));let e=this._conversation.direction===pt.OUTGOING&&!this._conversation.concurrent;for(let t of Object.values(this._participants))(t.state===Lt.ACCEPTED||t.state===Lt.CALLED)&&this._transport.allocate(t.id,e)}_createSpeakerDetector(){this._transport&&(this._volumesDetector=new wn(this._transport),this.subscribe(this._volumesDetector,Dn.VOLUMES_DETECTED,this._onVolumesDetected.bind(this)),this._speakerDetector=new kn(this._volumesDetector,this._transport,this._conversation.topology),this.subscribe(this._speakerDetector,Nn.SPEAKER_CHANGED,this._onSpeakerChanged.bind(this)),this._localVolumeDetector=new rn(this._mediaSource))}_createSpecListener(){this._transport&&this._volumesDetector&&(this._specListener=new Ln(this._transport,this._volumesDetector,this._participants))}_logDevices(){let e=dr.getCameras().length,t=dr.getMicrophones().length;Fr.debug("Cameras: "+e+(dr.hasCameraPermission()?"✔":"✖")+", Microphones: "+t+(dr.hasMicrophonePermission()?"✔":"✖")),fi.log(Ht.DEVICES,`${e}_${t}`)}_logWithMediaSettings(e,t){fi.log(e,[(null==t?void 0:t.isAudioEnabled)&&"audio",(null==t?void 0:t.isVideoEnabled)&&"video"].filter(Boolean).join("_"))}_removeParticipant(e,t){var i;e.state===Lt.CALLED||e.state===Lt.ACCEPTED||"CLOSE"===this._state||(e.id===this._lastSignalledActiveSpeakerId&&(this._lastSignalledActiveSpeakerId=null),this._participants[e.id]&&(t===bt.HUNGUP?this._setParticipantsStatus([e],Dr.HANGUP):this._setParticipantsStatus([e],Dr.ERROR,t),null==(i=e.mediaSource)||i.disconnect(),this._conversation&&this._conversation.pinnedParticipantId===e.id&&(this._conversation.pinnedParticipantId=null),this.updateDisplayLayout([{uid:e.externalId,mediaType:$r.CAMERA,stopStream:!0}]),delete this._participants[e.id],Ur.onRemoteRemoved(e.externalId,e.markers)))}_cleanupListeners(){this.unsubscribe(),window.removeEventListener("unload",this._onUnload)}_cleanupMediaSource(){this._mediaSource&&(this._mediaSource.destroy(),this._mediaSource=null)}_cleanupParticipants(){Object.values(this._participants).forEach((e=>{var t,i,r;null==(t=e.remoteStream)||t.getTracks().forEach((e=>e.stop())),null==(i=e.secondStream)||i.getTracks().forEach((e=>e.stop())),null==(r=e.mediaSource)||r.disconnect()})),this._participants={},this._audioOutput&&this._audioOutput.destroy()}_cleanupParticipantAgnosticStreams(){Fr.debug("cleaning up participant-agnostic streams"),this._streamByStreamId.forEach((e=>{e.getTracks().forEach((e=>{e.stop()}))})),this._streamByStreamId=new Map,this._streamWaitTimerByStreamDescription.forEach((e=>{window.clearTimeout(e)})),this._streamWaitTimerByStreamDescription=new Map,this._streamIdByStreamDescription=new Map,this._sequenceNumberByStreamDescription=new Map,this._cooldownTimestampByStreamDescription=new Map}_cleanupTransport(){this._transport&&(this._transport.destroy(),this._transport=null),this._debugInfo&&(this._debugInfo=null)}_cleanupSpeakerDetector(){this._speakerDetector&&(this._speakerDetector.destroy(),this._speakerDetector=null),this._volumesDetector&&(this._volumesDetector.destroy(),this._volumesDetector=null),this._localVolumeDetector&&(this._localVolumeDetector.destroy(),this._localVolumeDetector=null)}_cleanupSpecListener(){this._specListener&&(this._specListener.destroy(),this._specListener=null)}_cleanupSignaling(){this._signaling.close(),this._signaling.cleanup()}_onAddParticipant(e,t,i){return st(this,null,(function*(){Fr.debug(`Add new participant [${e}]`);let r=this._participants[e];!r||r.state!==Lt.ACCEPTED&&r.state!==Lt.CALLED?(r||(r=this._registerParticipantInCache(yield this._createParticipant({id:e,externalId:t.externalId&&Vr.fromSignaling(t.externalId,t.deviceIdx||0),mediaSettings:Ti(t.mediaSettings),state:t.state,roles:t.roles||[],muteStates:t.muteStates||{},unmuteOptions:t.unmuteOptions||[],observedIds:t.observedIds||[]}))),this._setParticipantsStatus([r],Dr.WAITING),i?(r.state=Lt.HUNGUP,this._removeParticipant(r,i)):this._transport&&(r.state=Lt.CALLED,this._transport.allocate(r.id,!0),fi.log(Ht.ADD_PARTICIPANT),this._invokeRolesChangedCallbackIfNeeded(r))):Fr.warn(`Participant [${r.id}:${r.state}] is already in conversation`)}))}_onRemoveParticipant(e){Fr.debug(`Remove participant [${e}]`);let t=[];for(let i=0;i<=15;i++){let r=Ui.compose(e,i),n=this._participants[r];n&&t.push(n)}if(t.length){if(this._transport)for(let e of t)this._transport.close(e.id);fi.log(Ht.REMOVE_PARTICIPANT)}else this._warnParticipantNotInConversation(e)}changeDevice(e){return st(this,null,(function*(){return"audiooutput"===e?this._audioOutput.changeOutput():this._mediaSource?("audioinput"===e&&(this._audioFix=new Zr(this._mediaSource)),this._mediaSource.changeDevice(e)):Promise.reject(At.UNKNOWN)}))}toggleScreenCapturing(e){return st(this,null,(function*(){return this._mediaSource?this._mediaSource.toggleScreenCapturing(e):Promise.reject(At.UNKNOWN)}))}setVideoStream(e,t=!1){return st(this,null,(function*(){if(this._mediaSource)return this._mediaSource.setVideoStream(e,t)}))}setAudioStream(e){return st(this,null,(function*(){if(this._mediaSource)return this._mediaSource.setAudioStream(e)}))}toggleLocalVideo(e){return st(this,null,(function*(){if(this._mediaSource)return fi.log(Ht.MEDIA_STATUS,e?"video_1":"video_0"),this._mediaSource.toggleVideo(e)}))}toggleLocalAudio(e){return st(this,null,(function*(){if(this._mediaSource)return fi.log(Ht.MEDIA_STATUS,e?"audio_1":"audio_0"),this._mediaSource.toggleAudio(e)}))}changePriorities(e){return st(this,null,(function*(){if(e.length<2||!this._signaling.ready)return;let t={},i={};for(let t of e){let e="object"==typeof t.uid?t.uid:Vr.fromId(t.uid);i[Vr.toString(e)]=t.priority}for(let e of Object.values(this._participants)){let r=Vr.toString(e.externalId);i.hasOwnProperty(r)&&(t[e.id]=i[r])}yield this._signaling.changePriorities(t)}))}changeParticipantState(e){return st(this,null,(function*(){for(let[t,i]of Object.entries(e))if(t.length>5||i.length>5)throw new Error("key/value max length is 5 chars, mappings with empty values (null or empty string) are discarded");yield this._signaling.changeParticipantState(e)}))}requestKeyFrame(e){return st(this,null,(function*(){let t={};return t[Kr(e)]={keyFrameRequested:!0},this._signaling.updateDisplayLayout(t)}))}requestTestMode(e,t){return st(this,null,(function*(){return this._signaling.requestTestMode(e,t)}))}updateDisplayLayout(e){return st(this,null,(function*(){if(e.length<1||!this._signaling.ready)return;Fr.log(`Update display layout [${this._signaling.getNextCommandSequenceNumber()}]`,e);let t={};for(let i of e){let e="object"==typeof i.uid?i.uid:Vr.fromId(i.uid),r=this._api.getCachedOkIdByExternalId(e);if(!r){let t=Vr.toString(e);Fr.log(`Unknown participant external ID ${t}`);continue}let n=Ui.compose(r,e.deviceIdx),a=Kr({participantId:n,mediaType:i.mediaType,streamName:i.streamName}),s=this._participants[n];s&&(s.lastRequestedLayouts[a]=i),Hr(i)?this._streamIdByStreamDescription.has(a)&&!this._cooldownTimestampByStreamDescription.has(a)&&this._cooldownTimestampByStreamDescription.set(a,Date.now()):(this._cooldownTimestampByStreamDescription.delete(a),!this._streamIdByStreamDescription.has(a)&&Ar.videoTracksCount>0&&this._streamIdByStreamDescription.set(a,null),t[a]=i)}let i=this._cooldownTimestampByStreamDescription.keys();for(;this._streamIdByStreamDescription.size>Ar.videoTracksCount;){let e=i.next();if(e.done){Fr.error("Cannot accommodate all streaming requests: tracks available "+Ar.videoTracksCount+"; requested streams: "+Array.from(this._streamIdByStreamDescription.keys()));break}this._stopStreaming(e.value),t[e.value]={stopStream:!0}}yield this._sendUpdateDisplayLayout(t)}))}_stopStreaming(e){if(this._cooldownTimestampByStreamDescription.delete(e),this._sequenceNumberByStreamDescription.set(e,this._signaling.getNextCommandSequenceNumber()),this._streamWaitTimerByStreamDescription.has(e)&&(Fr.log("Client asked to stop streaming before stream became available",e),window.clearTimeout(this._streamWaitTimerByStreamDescription.get(e)),this._streamWaitTimerByStreamDescription.delete(e)),this._streamIdByStreamDescription.get(e)){let t=qr(e),i=this._participants[t.participantId],{compositeUserId:r,externalId:n}=this._conversation,a=r===t.participantId;if(!i&&!a)return void Fr.log(`Cannot find participant to stop streaming: ${t.participantId}`);if(!t.streamName||t.mediaType!==$r.STREAM&&t.mediaType!==$r.MOVIE)a||Ur.onRemoteStream(i.externalId,null);else{let e={stream:null,streamName:t.streamName,mediaType:t.mediaType};a?Ur.onLocalLive(n,e):Ur.onRemoteLive(i.externalId,e)}fi.log(Ht.PAT_DEALLOCATED)}this._streamIdByStreamDescription.delete(e)}_sendUpdateDisplayLayout(e){return st(this,null,(function*(){if(0===Object.keys(e).length)return;let t=yield this._signaling.updateDisplayLayout(e);if(!t)return;let i=[];for(let[e,r]of Object.entries(t.errorCodeByParticipantId||{})){let t=qr(e),n=this._participants[t.participantId];if(n){let e;"number"!=typeof r?(Fr.warn(`Unexpected error code ${r} received for participant ${t.participantId}`),e=Kt.UNKNOWN_ERROR):e=1===r?"no-available-tracks":"unknown-error",i.push({externalId:n.externalId,errorReason:e})}}if(i&&i.length)throw new Bn("Could not allocate one or more participants",i)}))}_cleanupCooldownQueue(){let e={},t=this._cooldownTimestampByStreamDescription.entries();for(;;){let i=t.next();if(i.done)break;let r=i.value;if(r[1]+1e4>Date.now())break;let n=r[0];this._stopStreaming(n),e[n]={stopStream:!0}}this._sendUpdateDisplayLayout(e)}_onParticipantSourcesUpdate(e){if(this._conversation){Fr.log("Received participant sources update notification",e);for(let t of e)this._waitForStreamIfNeeded(t)}}_onParticipantPromoted(e){return st(this,null,(function*(){Fr.log("Promoted in waiting hall",!e.demote),e.demote?(Fr.log("Kicked from waiting hall"),this._close(new Ai(bt.REMOVED))):(this._updateConversation(e),yield this._onJoinPart2(e))}))}_onChatRoomUpdated(e){return st(this,arguments,(function*(e,t=0,i=[]){Fr.log(`Chat room updated: ${e}`);let r=[],n=[];i.length&&(i.forEach((e=>{if(e.externalId){let t=Br.fromSignaling(e.externalId);r.push(t),this._api.cacheExternalId(e.id.id,t)}else n.push(Ui.decomposeId(e.id.id).id)})),n.length&&!r.length&&(r=yield this._api.getExternalIdsByOkIds(n))),Ur.onChatRoomUpdated(e,t,r)}))}_onSharedMovieUpdate(e){return st(this,null,(function*(){Fr.log(`Shared movie updated: ${e.notification}`);let{compositeUserId:t,externalId:i}=this._conversation,{data:r}=e;for(let e of r)if(e.participantId===t)Ur.onLocalLiveUpdate(i,e);else{let t=yield this._getExternalIdByParticipantId(e.participantId);t&&Ur.onRemoteLiveUpdate(t,e)}}))}_onSharedMovieInfoStarted(e){return st(this,null,(function*(){var t;Fr.log(`Shared movie started data received: ${e.notification}`);let{compositeUserId:i,externalId:r}=this._conversation,{movieShareInfo:n}=e;if(n.initiatorId===i)Ur.onLocalSharedMovieInfo(r,n);else{let e=yield this._getExternalIdByParticipantId(n.initiatorId);e&&Ur.onRemoteSharedMovieInfo(e,n)}!Object.keys(this._participants).length&&n&&this._transport.getTopology()===bn.SERVER&&this._participantState!==Lt.CALLED&&this._transport.open(this._transport.allocated(),null,!!(null==(t=this._conversation)?void 0:t.observer),!0)}))}_onSharedMovieInfoStopped(e){return st(this,null,(function*(){Fr.log(`Shared movie stopped data received: ${e.notification}`);let{compositeUserId:t,externalId:i}=this._conversation,{initiatorId:r,movieId:n,source:a}=e,s={initiatorId:r,movieId:n,source:a};if(r===t)Ur.onLocalSharedMovieStoppedInfo(i,s);else{let e=yield this._getExternalIdByParticipantId(r);e&&Ur.onRemoteSharedMovieStoppedInfo(e,s)}}))}_waitForStreamIfNeeded(e){var t,i;let r=this._matchStreamDescription(e.participantStreamDescription);if(!r||Ar.producerScreenDataChannel&&r.mediaType===$r.SCREEN)return;let n=Kr(r),a=this._sequenceNumberByStreamDescription.get(n);if(a&&a>e.sequenceNumber)return Fr.warn(`Participant ${r.participantId} received outdated PAT response: sequence number ${e.sequenceNumber}; last sent sequence number for given participant is ${a}`),void fi.log(Ht.PAT_OUTDATED_RESPONSE);let s=e.streamId,o=e.rtpTimestamp?this._getWaitingTime(s,e.rtpTimestamp):0;if(o<=0){this._streamWaitTimerByStreamDescription.delete(n);let a=r.participantId,o=this._participants[a],{compositeUserId:c,externalId:d}=this._conversation,l=c===a;if(!o&&!l)return fi.log(Ht.PAT_ERROR,"participantMissing"),void Fr.error(`Could not find participant by ID: ${a}`);let u=l?d:o.externalId,p=this._streamByStreamId.get(s);if(!p)return fi.log(Ht.PAT_ERROR,"streamNotFound"),void Fr.error(`Could not find stream by ID: ${s}`);fi.log(Ht.PAT_ALLOCATED),this._streamIdByStreamDescription.set(n,s);let h=null==(t=e.participantStreamDescription)?void 0:t.mediaType;if(h===$r.STREAM||h===$r.MOVIE){if(null==(i=e.participantStreamDescription)?void 0:i.streamName){let t={streamName:e.participantStreamDescription.streamName,stream:p,mediaType:h};l?Ur.onLocalLive(u,t):Ur.onRemoteLive(u,t)}}else if(Ar.producerScreenTrack&&h===$r.SCREEN)Ur.onRemoteScreenStream(o.externalId,p);else if(!l){let e=(Ar.producerScreenTrack?null:o.secondStream)||p;Ur.onRemoteStream(o.externalId,e)}}else{Fr.debug(`Waiting for ${o} until stream ${s} for ${n} is switched`);let t=window.setTimeout(this._waitForStreamIfNeeded.bind(this,e),o);this._streamWaitTimerByStreamDescription.set(n,t)}}_matchStreamDescription(e){if(!e)return null;if(this._streamIdByStreamDescription.has(Kr(e)))return e;let t=e.participantId;if(e.mediaType){let e={participantId:t,mediaType:null};if(this._streamIdByStreamDescription.has(Kr(e)))return e}else{let e={participantId:t,mediaType:$r.CAMERA};if(this._streamIdByStreamDescription.has(Kr(e)))return e;let i={participantId:t,mediaType:$r.SCREEN};if(this._streamIdByStreamDescription.has(Kr(i)))return i}return Fr.error("Received unrequested allocation",e),null}_getWaitingTime(e,t){if(this._transport)return this._transport.getStreamWaitingTimeMs(e,t);throw new Error("transport is not initialized")}_isCallAdmin(){return!!this._conversation&&Ui.includesOneOf(this._conversation.roles,[zt.ADMIN,zt.CREATOR])}_checkAdminRole(){if(this._conversation&&!Ui.includesOneOf(this._conversation.roles,[zt.ADMIN,zt.CREATOR]))throw new Error("You don't have the required permission")}grantRoles(e,t,i){return st(this,null,(function*(){this._checkAdminRole(),yield this._signaling.grantRoles(e,t,i)}))}muteParticipant(){return st(this,arguments,(function*(e=null,t,i=[]){this._checkAdminRole(),yield this._signaling.muteParticipant(e,t,i)}))}pinParticipant(e,t){return st(this,null,(function*(){this._checkAdminRole(),yield this._signaling.pinParticipant(e,t)}))}updateMediaModifiers(e){return st(this,null,(function*(){this._signaling.ready&&this._conversation&&(this._conversation.mediaModifiers=e,yield this._signaling.updateMediaModifiers(e))}))}changeOptions(e){return st(this,null,(function*(){if(this._signaling.ready&&this._conversation){this._checkAdminRole(),yield this._signaling.changeOptions(e);let t=function(e,t){let i=new Set(e);for(let[e,r]of Object.entries(t))r?i.add(e):i.delete(e);return Array.from(i)}(this._conversation.options,e);this._onOptionsChanged(t)}}))}getWaitingHall(e,t,i){return st(this,null,(function*(){if(!this._signaling)return Promise.reject();let r=null;e&&(r=function(e){try{return JSON.parse(atob(e))}catch(t){Fr.warn("WaitingParticipant: failed convert from string",e,t)}return null}(e));let n=yield this._signaling.getWaitingHall(r,t,i);if(n.error)return Promise.reject(n.message);let a=n.participants||[],s=[],o=[],c=null;return a.length&&(a.forEach((e=>{if(e.externalId){let t=Br.fromSignaling(e.externalId);s.push(t),this._api.cacheExternalId(e.id.id,t)}else o.push(Ui.decomposeId(e.id.id).id)})),o.length&&!s.length&&(s=yield this._api.getExternalIdsByOkIds(o)),n.hasMore&&(c=function(e){try{return btoa(JSON.stringify(e))}catch(t){Fr.warn("WaitingParticipant: failed convert to string",e,t)}return null}(a[a.length-1].id))),{participants:s,pageMarker:c,totalCount:n.totalCount||0}}))}promoteParticipant(e,t){return st(this,null,(function*(){this._signaling&&(yield this._signaling.promoteParticipant(e,t))}))}chatMessage(e,t=null){return st(this,null,(function*(){this._signaling.ready&&(yield this._signaling.chatMessage(e,t))}))}chatHistory(e){return st(this,null,(function*(){if(this._signaling.ready){let t=yield this._signaling.chatHistory(e);for(let e=t.messages.length-1;e>=0;e--){let i=t.messages[e];yield this._onChatMessage(i)}}}))}customData(e,t=null){return st(this,null,(function*(){this._signaling.ready&&(yield this._signaling.customData(e,t))}))}createJoinLink(){return st(this,null,(function*(){if(this._conversation){let e=(yield this._api.createJoinLink(this._conversation.id)).join_link;if(e)return this._conversation.joinLink=e,e}return Promise.reject()}))}removeJoinLink(){return st(this,null,(function*(){if(!this._conversation||!(yield this._api.removeJoinLink(this._conversation.id)).success)return Promise.reject();delete this._conversation.joinLink}))}addMovie(e){return st(this,arguments,(function*({movieId:e,gain:t,metadata:i}){let r={movieId:e};(t||0===t)&&(r.gain=t),i&&(r.metadata=i);let n=yield this._signaling.addMovie(r);if(n.error)throw new Error(n.error);return{movieId:n.movieId,streamType:n.streamType}}))}updateMovie(e,t,i,r){return st(this,null,(function*(){let n={movieId:e};(t||0===t)&&(n.gain=t),(i||0===i)&&(n.offset=i),void 0!==typeof r&&(n.pause=r);let a=yield this._signaling.updateMovie(n);if(a.error)throw new Error(a.error)}))}removeMovie(e){return st(this,null,(function*(){let t={movieId:e},i=yield this._signaling.removeMovie(t);if(i.error)throw new Error(i.error)}))}startStream(e=!1,t=null,i=null,r="DIRECT_LINK",n=null){return st(this,null,(function*(){let a={movieId:i,name:t,privacy:r,groupId:n,streamMovie:!e},s=yield this._signaling.startStream(a);return s.error?Promise.reject(s.message):s}))}stopStream(){return st(this,null,(function*(){let e=yield this._signaling.stopStream();return e.error?Promise.reject():e}))}recordSetRole(e,t){return st(this,null,(function*(){let i=yield this._signaling.recordSetRole(e,t);if(i.error)throw new Error(i.error)}))}getStreamInfo(){return st(this,null,(function*(){let e=yield this._signaling.getRecordStatus();return{movieId:e.recordMovieId,preview:e.recordMoviePreviewUrl}}))}setLocalResolution(e,t,i){return st(this,null,(function*(){var r;if(e<Ar.videoMinWidth||t<Ar.videoMinHeight)throw new Error("Sizes received are less than the `videoMinWidth` or `videoMinHeight`");if(null==i?void 0:i.effect){if(i.effect.width<Ar.videoMinWidth||i.effect.height<Ar.videoMinHeight)throw new Error("Sizes of effect received are less than the `videoMinWidth` or `videoMinHeight`");Ar.videoEffectMaxHeight=i.effect.height,Ar.videoEffectMaxWidth=i.effect.width}return Ar.videoMaxWidth=e,Ar.videoMaxHeight=t,null==(r=this._mediaSource)?void 0:r.setResolution(e,t)}))}videoEffect(e){return st(this,null,(function*(){var t;return null==(t=this._mediaSource)?void 0:t.videoEffect(e)}))}getParticipants(e){return st(this,null,(function*(){let t=e.externalIds.map((e=>({id:e.id,type:this._getClientType()}))),i=yield this._signaling.getParticipants(t);if(i.error)throw new Error(i.error);let r=i.participants,n=this._transport.getState();return Promise.all(r.map((e=>st(this,null,(function*(){var t;let i=Ui.composeId(e);return this._createParticipant({id:i,externalId:e.externalId&&Vr.fromSignaling(e.externalId,e.deviceIdx||0),mediaSettings:Ti(e.mediaSettings),participantState:Ui.mapParticipantState(e),state:e.state,roles:e.roles||[],status:null!=(t=this._getStatusByTransportState(n))?t:Dr.WAITING,muteStates:e.muteStates||{},unmuteOptions:e.unmuteOptions||[],observedIds:e.observedIds||[],markers:this._denormalizeMarkers(i,e.markers)})}))))).then(Ui.mapSharedParticipants)}))}getParticipantListChunk(e){return st(this,null,(function*(){var t;Fr.log("Request participant list chunk",e);let i=yield this._signaling.getParticipantListChunk(e);if(i.error)throw new Error(i.error);let r=this._createParticipantListChunk(i.chunk),n=r.participants.filter((e=>{let t=Ui.composeId(e);return!this._participants[t]}));yield this._registerParticipants(n);let a=null==(t=this._transport)?void 0:t.getState();return r.participants.forEach((e=>{var t;let i=Ui.composeId(e),r=this._participants[i];r.status=null!=(t=this._getStatusByTransportState(a))?t:Dr.WAITING,Object.assign(r.muteStates,e.muteStates),Object.assign(r.unmuteOptions,e.unmuteOptions)})),this._participantListChunkToExternalChunk(r)}))}_getInitialParticiapntListChunk(){return st(this,null,(function*(){let e=Ar.participantListChunkInitIndex,t=Ar.participantListChunkInitCount;return(yield this._signaling.getParticipantListChunk({listType:"GRID",fromIdx:e,count:t})).chunk}))}_onLocalMediaStreamChanged(e){return st(this,null,(function*(){var t,i;!this._conversation||(Fr.debug("Local media stream changed",e.mediaSettings),Ur.onLocalStreamUpdate(e.mediaSettings,e.kind),this._signaling.ready&&!(null==(t=this._conversation)?void 0:t.waitingHall)&&!(null==(i=this._conversation)?void 0:i.observer)&&(yield this._signaling.changeMediaSettings(e.mediaSettings)))}))}_onScreenSharingStatus(e){return st(this,null,(function*(){var t,i;if(Fr.log("Screen sharing changed",e.track,e.mediaSettings),Ar.consumerScreenTrack){let r=e.track?new MediaStream([e.track]):null;Ur.onScreenStream(r,e.mediaSettings),this._signaling.ready&&!(null==(t=this._conversation)?void 0:t.waitingHall)&&!(null==(i=this._conversation)?void 0:i.observer)&&(yield this._signaling.changeMediaSettings(e.mediaSettings))}}))}_changeRemoteMediaSettings(e,t){Fr.debug(`Remote media settings changed [${e}]`,t);let{compositeUserId:i,externalId:r}=this._conversation;if(e===i)return void Ur.onLocalMediaSettings(r,t);let n=this._participants[e];n?(n.mediaSettings=t,"ACTIVE"===this._state&&Ur.onRemoteMediaSettings(n.externalId,t,n.markers),this._specListener&&this._specListener.onChangeRemoteMediaSettings(e,t)):this._warnParticipantNotInConversation(e)}_changeRemoteParticipantState(e,t){Fr.debug(`Remote participant state changed [${e}]`,t);let i=this._participants[e];i?(i.participantState=t||{},"ACTIVE"===this._state&&Ur.onRemoteParticipantState(i.externalId,i.participantState,i.markers)):this._warnParticipantNotInConversation(e)}_invokeRolesChangedCallbackIfNeeded(e){"ACTIVE"===this._state&&e.roles&&e.roles.length&&(Fr.debug(`Roles for participant [${e.id}] changed: ${e.roles}`),Ur.onRolesChanged(e.externalId,e.roles))}_onSignalingNotification(e){switch(e.notification){case Ft.ACCEPTED_CALL:return this._onAcceptedCall(e);case Ft.HUNGUP:return this._onHungup(e);case Ft.PARTICIPANT_ADDED:return this._onAddedParticipant(e);case Ft.PARTICIPANT_JOINED:return this._onJoinedParticipant(e);case Ft.CLOSED_CONVERSATION:return this._onClosedConversation(e);case Ft.MEDIA_SETTINGS_CHANGED:return this._onMediaSettingsChanged(e);case Ft.PARTICIPANT_STATE_CHANGED:return this._onParticipantStateChanged(e);case Ft.RATE_CALL_DATA:return this._onNeedRate();case Ft.FEATURE_SET_CHANGED:return this._onFeatureSetChanged(e);case Ft.MULTIPARTY_CHAT_CREATED:return this._onMultipartyChatCreated(e);case Ft.FORCE_MEDIA_SETTINGS_CHANGE:return this._onForceMediaSettingsChange(e);case Ft.SETTINGS_UPDATE:return this._onSettingsUpdate(e);case Ft.VIDEO_QUALITY_UPDATE:return this._onVideoQualityUpdate(e);case Ft.REGISTERED_PEER:return this._onPeerRegistered(e);case Ft.SWITCH_MICRO:return this._onMicSwitched(e);case Ft.CHAT_MESSAGE:return this._onChatMessage(e);case Ft.CUSTOM_DATA:return this._onCustomData(e);case Ft.RECORD_STARTED:return this._onRecordInfo(e.recordInfo);case Ft.RECORD_STOPPED:return this._onRecordInfo(null);case Ft.ROLES_CHANGED:return this._onRolesChanged(e.participantId,e.roles||[]);case Ft.MUTE_PARTICIPANT:return this._onMuteParticipant(e);case Ft.PIN_PARTICIPANT:return this._onPinParticipant(e.participantId,e.unpin,e.markers);case Ft.OPTIONS_CHANGED:return this._onOptionsChanged(e.options||[]);case Ft.PARTICIPANT_SOURCES_UPDATE:return this._onParticipantSourcesUpdate(e.participantUpdateInfos);case Ft.PROMOTE_PARTICIPANT:return this._onParticipantPromoted(e);case Ft.CHAT_ROOM_UPDATED:return this._onChatRoomUpdated(e.eventType,e.totalCount,e.firstParticipants);case Ft.JOIN_LINK_CHANGED:return this._onJoinLinkChanged(e);case Ft.MOVIE_UPDATE_NOTIFICATION:return this._onSharedMovieUpdate(e);case Ft.MOVIE_SHARE_STARTED:return this._onSharedMovieInfoStarted(e);case Ft.MOVIE_SHARE_STOPPED:return this._onSharedMovieInfoStopped(e)}}_onSignalingReconnect(e){return st(this,null,(function*(){if(!this._conversation)return;e.conversation.acceptTime&&(this._conversation.acceptTime=e.conversation.acceptTime),e.conversation.participantsLimit&&(this._conversation.participantsLimit=e.conversation.participantsLimit),e.conversation.features&&(this._conversation.features=e.conversation.features,this._changeFeatureSet()),e.conversation.pinnedParticipantId!==this._conversation.pinnedParticipantId&&(e.conversation.pinnedParticipantId?yield this._onPinParticipant(e.conversation.pinnedParticipantId,!1):this._conversation.pinnedParticipantId&&(yield this._onPinParticipant(this._conversation.pinnedParticipantId,!0))),e.conversation.state;let t=null;if(e.conversation.participants){let i=Object.keys(this._participants),r=[];for(let i of e.conversation.participants){let e=Ui.composeId(i),n=i.roles||[];if(e===this._conversation.compositeUserId){t=Ti(i.mediaSettings),Yt(this._conversation.roles,n)||this._onRolesChanged(e,n);continue}r.push(e);let a=this._participants[e];if(a){let t=Ti(i.mediaSettings);yi(t,a.mediaSettings)||this._changeRemoteMediaSettings(e,t);let r=Ui.mapParticipantState(i),s=a.participantState;Ui.isEqualParticipantState(r,s)||this._changeRemoteParticipantState(e,r),Yt(n,a.roles)||this._onRolesChanged(a.id,n)}else yield this._onJoinedParticipant({participantId:i.id,participant:i,mediaSettings:i.mediaSettings})}for(let e of i)r.indexOf(e)<0&&this._removeParticipant(this._participants[e],bt.HUNGUP)}this._onMuteParticipant({muteStates:e.conversation.muteStates,unmuteOptions:e.unmuteOptions,mediaOptions:[]},t),this._onRecordInfo(e.conversation.recordInfo),this._onOptionsChanged(e.conversation.options)}))}_onSignalingFailed(e){Fr.error("Signaling failed",e),this._close(e)}_onAcceptedCall(e){return st(this,null,(function*(){let t=Ui.composeMessageId(e),i=Ui.getPeerIdString(e.peerId);if(Fr.debug(`Participant accepted call [${t}]`),this._conversation&&t===this._conversation.compositeUserId)return void this._close(new Ai(bt.MISSED),"Call accepted on other device");let r=this._participants[t];r||(r=this._registerParticipantInCache(yield this._createParticipant({id:t,mediaSettings:Ti(e.mediaSettings)}))),r.state=Lt.ACCEPTED,r.mediaSettings=Ti(e.mediaSettings),this._logWithMediaSettings(Ht.ACCEPTED_OUTGOING,r.mediaSettings),this._conversation&&this._conversation.direction===pt.OUTGOING&&("IDLE"===this._state||"PROCESSING"===this._state)&&(this._state="ACTIVE",this._changeFeatureSet()),"ACTIVE"===this._state&&this._transport&&this._transport.open([r.id],i),this._changeRemoteMediaSettings(t,r.mediaSettings),this._changeRemoteParticipantState(t)}))}_onHungup(e){return st(this,null,(function*(){Fr.debug(`Participant hungup [${e.participantId}]`,{reason:e.reason});let t=Ui.composeMessageId(e);if(this._conversation&&this._conversation.compositeUserId===t)return void this._close(new Ai(e.reason,{remote:!0}));yield this._registerParticipantAndSetMarkersIfChunkEnabled(t,e.markers);let i=this._participants[t];i?(this._transport&&this._transport.close(t),i.state=e.reason===bt.REJECTED?Lt.REJECTED:Lt.HUNGUP,"CLOSE"!==this._state&&this._removeParticipant(i,bt.HUNGUP)):this._warnParticipantNotInConversation(t)}))}_onAddedParticipant(e){return st(this,null,(function*(){var t,i;Fr.debug(`Participant added [${e.participantId}]`);let r=Ui.composeMessageId(e),n=this._participants[r];n&&n.state!==Lt.HUNGUP&&n.state!==Lt.REJECTED?Fr.debug(`Participant [${r}] is already in conversation and is active`):(n||(n=this._registerParticipantInCache(yield this._createParticipant({id:r,externalId:e.participant.externalId&&Vr.fromSignaling(e.participant.externalId,e.participant.deviceIdx||0),mediaSettings:Ti(e.participant.mediaSettings),state:e.participant.state,participantState:Ui.mapParticipantState(e.participant),roles:e.participant.roles||[],muteStates:e.participant.muteStates||{},unmuteOptions:e.participant.unmuteOptions||[],observedIds:e.participant.observedIds||[]}))),n.state=Lt.CALLED,n.mediaSettings=Ti(null==(t=e.participant)?void 0:t.mediaSettings),n.participantState=Ui.mapParticipantState(e.participant),n.roles=(null==(i=e.participant)?void 0:i.roles)||[],this._setParticipantsStatus([n],Dr.WAITING),"ACTIVE"===this._state&&this._transport&&this._transport.allocate(n.id,!0),Ur.onParticipantAdded(n.externalId,n.markers),this._changeRemoteMediaSettings(r,n.mediaSettings),this._changeRemoteParticipantState(r,n.participantState),this._invokeRolesChangedCallbackIfNeeded(n))}))}_onJoinedParticipant(e){return st(this,null,(function*(){var t,i;Fr.debug(`Participant joined [${e.participantId}]`);let r=Ui.composeMessageId(e),n=this._participants[r];n&&n.state===Lt.ACCEPTED?Fr.warn(`Participant [${r}] is already in conversation and is active`):(n||(n=this._registerParticipantInCache(yield this._createParticipant({id:r,externalId:e.participant.externalId&&Vr.fromSignaling(e.participant.externalId,e.participant.deviceIdx||0),mediaSettings:Ti(e.participant.mediaSettings),state:e.participant.state,participantState:Ui.mapParticipantState(e.participant),roles:e.participant.roles||[],muteStates:e.participant.muteStates||{},unmuteOptions:e.participant.unmuteOptions||[],observedIds:e.participant.observedIds||[],markers:this._denormalizeMarkers(r,e.participant.markers)}))),this._conversation&&this._conversation.direction===pt.OUTGOING&&("IDLE"===this._state||"PROCESSING"===this._state)&&(this._state="ACTIVE",this._changeFeatureSet()),n.state=Lt.ACCEPTED,n.mediaSettings=Ti(e.mediaSettings),n.participantState=Ui.mapParticipantState(e.participant),n.roles=e.participant.roles||[],(null==(t=this._transport)?void 0:t.isAllocated(n.id))?this._setParticipantsStatus([n],Dr.CONNECTED):this._setParticipantsStatus([n],Dr.WAITING),"ACTIVE"===this._state&&this._transport&&(this._transport.isAllocated(n.id)||this._transport.allocate(n.id,!0),this._transport.open([n.id],null,!!(null==(i=this._conversation)?void 0:i.observer))),Ur.onParticipantJoined(n.externalId,n.markers),this._changeRemoteMediaSettings(r,n.mediaSettings),this._changeRemoteParticipantState(r,n.participantState),this._invokeRolesChangedCallbackIfNeeded(n),Ur.onMuteStates(n.muteStates,n.unmuteOptions,Object.keys(n.muteStates),!1,!1,n.externalId,void 0,!0))}))}_onClosedConversation(e){this._toggleJoinAvailability(),this._close(new Ai(e.reason,{remote:!0}))}_onMediaSettingsChanged(e){return st(this,null,(function*(){let t=Ui.composeMessageId(e);yield this._registerParticipantAndSetMarkersIfChunkEnabled(t,e.markers),this._changeRemoteMediaSettings(t,Ti(e.mediaSettings))}))}_onParticipantStateChanged(e){return st(this,null,(function*(){let t=Ui.composeMessageId(e);yield this._registerParticipantAndSetMarkersIfChunkEnabled(t,e.markers),this._changeRemoteParticipantState(t,Ui.mapParticipantState(e))}))}_onNeedRate(){this._conversation&&(this._conversation.needRate=!0,this._changeNeedRate())}_onFeatureSetChanged(e){this._conversation&&(this._conversation.features=e.features,this._changeFeatureSet())}_onMultipartyChatCreated(e){this._conversation&&(this._conversation.chatId=e.chatId,this._toggleJoinAvailability(),Ur.onMultipartyChatCreated(this._conversation))}_onForceMediaSettingsChange(e){return st(this,null,(function*(){if(!this._mediaSource)return;let t=this._mediaSource.getMediaSettings(),i=Ti(e.mediaSettings);t.isAudioEnabled!==i.isAudioEnabled&&(yield this._mediaSource.toggleAudio(i.isAudioEnabled)),t.isVideoEnabled!==i.isVideoEnabled&&(yield this._mediaSource.toggleVideo(i.isVideoEnabled)),Ar.consumerScreenTrack&&t.isScreenSharingEnabled!==i.isScreenSharingEnabled&&(yield this._mediaSource.toggleScreenCapturing(i.isScreenSharingEnabled))}))}_onSettingsUpdate(e){Fr.debug("Got settings update notification",e);let t={camera:e.camera,screenSharing:e.screenSharing};this._serverSettings=Xr(this._serverSettings,t),this._transport&&this._transport.updateSettings(this._serverSettings)}_onVideoQualityUpdate(e){Fr.debug("Got video quality update notification",e);let t=Math.round(e.quality.maxBitrate/1024),i=e.quality.maxDimension,r={camera:Object.assign({},this._serverSettings.camera,{maxBitrateK:t,maxDimension:i}),screenSharing:null};this._serverSettings=Xr(this._serverSettings,r),this._transport&&this._transport.updateSettings(this._serverSettings)}_onPeerRegistered(e){let t=Ui.composeMessageId(e);this._participants[t]&&(this._participants[t].clientType=e.clientType,this._participants[t].platform=e.platform)}_onMicSwitched(e){return st(this,null,(function*(){Ur.onDeviceSwitched(Dt.AUDIO,!e.mute),yield this.toggleLocalAudio(!e.mute)}))}_onChatMessage(e){return st(this,null,(function*(){let t,i=Ui.composeMessageId(e);t=this._participants[i]?this._participants[i].externalId:yield this._getParticipantId(i),Ur.onChatMessage(e.message,t,e.direct)}))}_onCustomData(e){return st(this,null,(function*(){if(e.data.hasOwnProperty("sdk"))return;let t,i=Ui.composeMessageId(e);t=this._participants[i]?this._participants[i].externalId:yield this._getParticipantId(i),Ur.onCustomData(e.data,t,e.direct)}))}_onRecordInfo(e){return st(this,null,(function*(){var t;if(!this._conversation)return;let i=!1;if(!this._conversation.recordInfo!=!e?i=!0:this._conversation.recordInfo&&e&&(i=this._conversation.recordInfo.recordMovieId!==e.recordMovieId),i)if(e){let t=yield this._getParticipantId(e.initiator);Ur.onRecordStarted(t,e.recordMovieId,e.recordStartTime,e.recordType,e.recordExternalMovieId,e.recordExternalOwnerId)}else Ur.onRecordStopped();this._conversation.recordInfo=e,e&&this._transport.getTopology()===bn.SERVER&&this._participantState!==Lt.CALLED&&this._transport.open(this._transport.allocated(),null,!!(null==(t=this._conversation)?void 0:t.observer),!0)}))}_onRolesChanged(e,t){if(this._conversation&&e===this._conversation.compositeUserId&&!Yt(this._conversation.roles,t))return Fr.debug(`Local roles changed: ${t}`),this._conversation.roles=t,Ur.onLocalRolesChanged(t),void this._processMuteState({mediaOptions:Qr(this._conversation.muteStates,Nt.MUTE_PERMANENT),stateUpdated:!0});let i=this._participants[e];i&&!Yt(i.roles,t)&&(Fr.debug(`Roles for participant [${e}] changed: ${t}`),i.roles=t,Ur.onRolesChanged(i.externalId,t))}_onMuteParticipant(e,t=null){return st(this,null,(function*(){if(!this._conversation)return;let i=e.muteStates||{},r=e.unmuteOptions||[],n=e.mediaOptions||[],a=e.adminId?this._participants[e.adminId]:null;if(e.participantId&&e.participantId!==this._conversation.compositeUserId){if(!this._isCallAdmin())return void Fr.warn(`Not admin got mute states for participant [${e.participantId}]`);let t=this._participants[e.participantId];t&&(Fr.debug(`Mute states for participant [${e.participantId}] changed`,i),Ur.onMuteStates(i,r,n,e.muteAll,e.unmute,t.externalId,null==a?void 0:a.externalId,e.stateUpdated,e.requestedMedia))}else if(!Ui.isObjectsEquals(this._conversation.muteStates,i)||!Ui.isArraysEquals(this._conversation.unmuteOptions,r)||n.length){if(this._conversation.muteStates=i,this._conversation.unmuteOptions=r,e.adminId===this._conversation.compositeUserId)return void(e.muteAll&&Ur.onMuteStates(i,r,n,e.muteAll,e.unmute,null,this._conversation.externalId,e.stateUpdated,e.requestedMedia));yield this._processMuteState({mediaOptions:n,muteAll:e.muteAll,unmute:e.unmute,serverSettings:t,admin:a,stateUpdated:e.stateUpdated,requestedMedia:e.requestedMedia})}}))}_processMuteState(e){return st(this,arguments,(function*({mediaOptions:e=[],muteAll:t=!1,unmute:i=!1,serverSettings:r=null,admin:n=null,stateUpdated:a,requestedMedia:s}){if(!this._conversation||!this._mediaSource||this._participantState!==Lt.ACCEPTED)return;let o=Object.assign({},this._conversation.muteStates),c=this._conversation.unmuteOptions,d=this._mediaSource.getMediaSettings(),l=Object.entries(o);for(let[n,a]of l)if((a===Nt.MUTE||a===Nt.MUTE_PERMANENT)&&(this._isCallAdmin()&&a===Nt.MUTE_PERMANENT&&!t&&(o[n]=Nt.MUTE),e.includes(n)&&!i))switch(n){case Dt.VIDEO:d.isVideoEnabled&&!(null==r?void 0:r.isVideoEnabled)&&(Ur.onDeviceSwitched(Dt.VIDEO,!1),yield this.toggleLocalVideo(!1));break;case Dt.AUDIO:d.isAudioEnabled&&!(null==r?void 0:r.isAudioEnabled)&&(Ur.onDeviceSwitched(Dt.AUDIO,!1),yield this.toggleLocalAudio(!1));break;case Dt.SCREEN_SHARING:d.isScreenSharingEnabled&&!(null==r?void 0:r.isScreenSharingEnabled)&&(Ur.onDeviceSwitched(Dt.SCREEN_SHARING,!1),yield this.toggleScreenCapturing(!1))}Ur.onMuteStates(o,c,e,t,i,null,null==n?void 0:n.externalId,a,s)}))}_onPinParticipant(e,t=!1,i){return st(this,null,(function*(){if(!this._conversation)return;let r=this._conversation.pinnedParticipantId;if(r&&r!==e)if(this._conversation.compositeUserId===r)Ur.onLocalPin(!0);else{let t=yield this._getExternalIdByParticipantId(r);t&&Ur.onPinnedParticipant(t,!0,this._denormalizeMarkers(e,i))}if(this._conversation.compositeUserId===e)Ur.onLocalPin(t);else{let r=yield this._getExternalIdByParticipantId(e);r&&Ur.onPinnedParticipant(r,t,this._denormalizeMarkers(e,i))}this._conversation.pinnedParticipantId=t?null:e}))}_onOptionsChanged(e){this._conversation&&!function(e,t){if(e.length!==t.length)return!1;for(let i of e)if(!t.includes(i))return!1;return!0}(this._conversation.options,e)&&(this._conversation.options=e,Ur.onOptionsChanged(e))}_onNetworkStatus(e){if(this._conversation){let t=[];for(let[i,r]of Object.entries(e)){let e;if(i===this._conversation.compositeUserId||""===i)e=this._conversation.networkRating;else{if(!this._participants[i])continue;e=this._participants[i].networkRating}if(e!==r)if(i===this._conversation.compositeUserId||""===i)this._conversation.networkRating=r,Ur.onLocalNetworkStatusChanged(r);else{let e=this._participants[i];e.networkRating=r,t.push({uid:e.externalId,rating:r})}}if(0===t.length)return;Fr.log("Received network status update: ",e),Ur.onNetworkStatusChanged(t)}}_onRemoteStreamSecond(e,t){let i=this._participants[e];if(i){if(Ar.producerScreenTrack)return void Ur.onRemoteScreenStream(i.externalId,t);if(i.secondStream=t,Ar.videoTracksCount>0){let t=e;if(!this._streamIdByStreamDescription.has(t))return void Fr.error("Received remote stream notification for a participant that has no track associated with it",t);let r=this._streamIdByStreamDescription.get(t);if(!r||this._streamWaitTimerByStreamDescription.has(t))return void Fr.log("Delaying secondary stream start/stop until main stream becomes available",t);let n=this._streamByStreamId.get(r);if(!n)return fi.log(Ht.PAT_ERROR,"streamNotFound"),void Fr.error(`Could not find stream by ID: ${r}`);Ur.onRemoteStream(i.externalId,i.secondStream||n)}else{let e=t||i.remoteStream;e&&Ur.onRemoteStream(i.externalId,e)}}}_onPeerConnectionClosed(e){e===bn.SERVER&&this._cleanupParticipantAgnosticStreams()}_changeFeatureSet(){if(this._conversation){let e="ACTIVE"===this._state,t=this._conversation.features.includes(vt.ADD_PARTICIPANT);Ur.onCallState(e,t,this._conversation)}}_changeNeedRate(){this._conversation&&this._conversation.needRate&&Ur.onRateNeeded()}_onVolumesDetected(e){let t=[];for(let[i,r]of Object.entries(e)){let e=this._participants[i];e&&e.externalId&&t.push({uid:e.externalId,volume:r.real})}Ur.onVolumesDetected(t)}_onSpeakerChanged(e){this._activeSpeakerId=e,this._participants[e]&&this._lastSignalledActiveSpeakerId!==e&&(Ur.onSpeakerChanged(this._participants[e].externalId),this._lastSignalledActiveSpeakerId=e)}_onTransportStateChanged(e,t){return st(this,null,(function*(){Fr.debug(`Transport state has changed: ${t}`,e);let i=this._getStatusByTransportState(t);if(!i)return;let r=e.reduce(((e,i)=>{if(i in this._participants){let r=this._participants[i];e.push(r),t===Pn.CONNECTED&&(r.remoteStream||(r.mediaSettings&&this._changeRemoteMediaSettings(i,r.mediaSettings),this._changeRemoteParticipantState(i,r.participantState)),this._updateDisplayLayoutFromCache(i))}else this._warnParticipantNotInConversation(i);return e}),[]);!r.length||this._setParticipantsStatus(r,i)}))}_onTransportLocalStateChanged(e){return st(this,null,(function*(){Fr.debug(`Local transport state has changed: ${e}`),e===Pn.CONNECTED&&Ur.onLocalStatus(Dr.CONNECTED),e===Pn.CONNECTING&&Ur.onLocalStatus(Dr.CONNECTING),e===Pn.RECONNECTING&&Ur.onLocalStatus(Dr.RECONNECT),e===Pn.FAILED&&this._transport&&0===this._transport.allocated().length&&(this._signaling.ready&&(yield this._signaling.hangup(bt.FAILED)),this._close(new Ai(bt.FAILED),"Transport failed"))}))}_onRemoteTrackAdded(e,t,i){return st(this,null,(function*(){if(e.endsWith(Wt.AUDIO_MIX))Fr.debug("Remote audio mix track added"),this._audioOutput.add(i),Ur.onRemoteMixedAudioStream(t);else if(e.startsWith(Wt.PARTICIPANT_AGNOSTIC_TRACK_PREFIX))Fr.debug(`Participant-agnostic track added: ${e}`),this._streamByStreamId.set(e,t);else{Fr.debug(`Remote track added on the participant [${e}]`,{kind:i.kind});let r=this._participants[e];if(r||(Fr.warn(`Conversation: track added before participant [${e}]`),r=this._registerParticipantInCache(yield this._createParticipant({id:e})),this._setParticipantsStatus([r],Dr.WAITING),this._activeSpeakerId===e&&this._lastSignalledActiveSpeakerId!==e&&(Ur.onSpeakerChanged(r.externalId),this._lastSignalledActiveSpeakerId=e)),this._transport&&!this._transport.isAllocated(r.id)&&this._transport.allocate(r.id,!1),i.kind===bi.audio&&(this._audioOutput.add(i),Ar.preserveAudioTracks||t.removeTrack(i)),r.remoteStream!==t){if(r.remoteStream=t,r.secondStream)return;Ur.onRemoteStream(r.externalId,t)}r.mediaSettings&&this._changeRemoteMediaSettings(e,r.mediaSettings),Ar.batchParticipantsOnStart||this._changeRemoteParticipantState(e,r.participantState)}}))}_onRemoteTrackRemoved(e,t,i){switch(Fr.debug(`[${e}] remote track (removed)`,{track:i}),i.kind){case bi.audio:this._removeAudioTrack(e,t,i);break;case bi.video:case bi.screen:this._removeVideoTrack(e,t,i)}}_removeAudioTrack(e,t,i){if(e!==Wt.AUDIO_MIX){let i=this._participants[e];if(!i||i.remoteStream&&i.remoteStream!==t)return}this._audioOutput.remove(i)}_removeVideoTrack(e,t,i){}_onTopologyChanged(e){e===bn.DIRECT&&(this._onRemoteSignalledStall([]),this._onRemoteAllStall(!1)),this._conversation&&(this._conversation.topology=e,this._changeFeatureSet())}_onRemoteAllStall(e){if(this._remoteAllStalled===e)return;this._remoteAllStalled=e;let t=[],i=[];for(let r in this._participants)if(this._participants.hasOwnProperty(r)){let n=this._participants[r];e||this._lastStalled[r]?t.push(n):i.push(n)}t.length&&this._setParticipantsStatus(t,Dr.RECONNECT),i.length&&this._setParticipantsStatus(i,Dr.CONNECTED)}_onRemoteSignalledStall(e){let t={},i=[],r=[];e.forEach((e=>{if(t[e]=!0,!this._lastStalled[e]){let t=this._participants[e];t&&!this._remoteAllStalled&&i.push(t)}delete this._lastStalled[e]})),Object.keys(this._lastStalled).forEach((e=>{let t=this._participants[e];t&&!this._remoteAllStalled&&r.push(t)})),i.length&&this._setParticipantsStatus(i,Dr.RECONNECT),r.length&&this._setParticipantsStatus(r,Dr.CONNECTED),this._lastStalled=t}_onRemoteDataStats(e){this._debugInfo&&this._debugInfo.onRemoteDataStats(e,this._participants),this._fixAudioDevice(e.outbound.rtps)}_fixAudioDevice(e){var t;!dr.hasMicrophone()||!this._audioFix||!(null==(t=this._mediaSource)?void 0:t.getMediaSettings().isAudioEnabled)||this._audioFix.fix(e)}_toggleJoinAvailability(){let e=this._conversation&&this._conversation.chatId,t=e&&"CLOSE"!==this._state||!1;e&&(Fr.debug("Toggle join availability",{available:t,chatId:e}),Ur.onJoinStatus(t,e))}_updateDisplayLayoutFromCache(e){return st(this,null,(function*(){var t;if((null==(t=this._transport)?void 0:t.getTopology())!==bn.SERVER)return;let i=this._participants[e];i&&i.lastRequestedLayouts&&Object.keys(i.lastRequestedLayouts).length&&(yield this.updateDisplayLayout(Object.values(i.lastRequestedLayouts)))}))}_setParticipantsStatus(e,t,i=null){if(!e.length)return;let r=e.reduce(((e,r)=>(r.status!==t&&(r.status=t,Ar.batchParticipantsOnStart?e.push(r.externalId):Ur.onParticipantStatus(r.externalId,t,i)),e)),[]);!r.length||Ar.batchParticipantsOnStart&&Ur.onRemoteStatus(r,t,i)}_onJoinLinkChanged(e){Ur.onJoinLinkChanged(e.joinLink)}},Un=Mn;Un._delayedHangup=!1;var xn,Bn=class extends Error{constructor(e,t){super(e),Object.setPrototypeOf(this,Bn.prototype),this.participantErrors=t}},Vn=null;function Fn(){return xn?Promise.resolve(xn):Vn||(Vn=function(){return st(this,null,(function*(){var e;if("AUTO"!==Ar.apiEnv)return Ar.apiEndpoint;try{let t=atob("aHR0cHM6Ly9kbnMuZ29vZ2xlL3Jlc29sdmU/bmFtZT12aWRlby5fZW5kcG9pbnQub2sucnUmdHlwZT1UWFQ="),i=yield(yield fetch(t,{method:"GET",mode:"cors",cache:"no-cache"})).json(),r=null==(e=null==i?void 0:i.Answer[0])?void 0:e.data;if(!r)throw new Error("Wrong DNS response");return Fr.debug("Resolved API endpoint",r),r}catch(e){return Fr.warn("Failed to resolve API endpoint using DNS, default is used",e),Ar.apiEndpoint}}))}().then((e=>xn=e)).finally((()=>Vn=null)))}function Gn(e){return st(this,arguments,(function*(e,t={},i=!1){if(!window.Blob||!window.navigator.sendBeacon)return;yield Fn();let r=jn(e,t,i),n=new window.Blob([r],{type:"application/x-www-form-urlencoded"});window.navigator.sendBeacon(`${xn}/fb.do`,n)}))}function Hn(e){return st(this,null,(function*(){return new Promise(((t,i)=>{let r=new XMLHttpRequest;r.open("POST",`${xn}/fb.do`,!0),r.setRequestHeader("Content-type","application/x-www-form-urlencoded"),r.onreadystatechange=()=>{if(r.readyState!==XMLHttpRequest.DONE)return;let e;try{e=JSON.parse(r.responseText)}catch(t){e={result:r.responseText}}200!==r.status||e.hasOwnProperty("error_msg")?i(e):t(e)},r.send(e)}))}))}function jn(e,t={},i=!1){t.method=e,t.format="JSON",t.application_key||(t.application_key=Ar.apiKey),i||(Rr.sessionKey?t.session_key=Rr.sessionKey:Rr.accessToken&&(t.access_token=Rr.accessToken));for(let[e,i]of Object.entries(t))"object"==typeof i&&(t[e]=JSON.stringify(i));let r="";for(let[e,i]of Object.entries(t))r&&(r+="&"),r+=`${e}=${encodeURIComponent(i)}`;return r}var Wn,$n=class extends ot{constructor(){super(...arguments),this._userId=null,this._externalUidsCache={}}_callUnsafe(e){return st(this,arguments,(function*(e,t={},i=!1){let r=n=>st(this,null,(function*(){try{return yield function(e){return st(this,arguments,(function*(e,t={},i=!1){return yield Fn(),Hn(jn(e,t,i))}))}(e,t,i)}catch(t){if(!t.hasOwnProperty("error_msg")&&(n++,Fr.debug(`${e} network error, attempt ${n}...`),n<10))return yield Ui.delay(Math.min(700*n,3e3)),r(n);throw Fr.warn(e,"error",t),t}}));return r(0)}))}_call(e){return st(this,arguments,(function*(e,t={},i=!1){try{return yield this._callUnsafe(e,t,i)}catch(r){Fr.warn("Api call error",r);let n=At.API;switch(r.error_code){case 102:case 103:case 104:return yield this.authorize(),this._callUnsafe(e,t,i);case 1101:n=bt.SERVICE_DISABLED;break;case 1102:n=bt.CALLEE_IS_OFFLINE;break;case 1103:n=bt.NOT_FRIENDS;break;case 1104:case 1106:n=bt.EXTERNAL_API_ERROR;break;case 1113:n=bt.CALLER_IS_REJECTED}throw new Ai(n,{message:r.error_msg,code:r.error_code})}}))}userId(e){return st(this,null,(function*(){let t=Ui.decomposeId(e).id;return Rr.isEmpty()?Br.fromId(String(t)):(this._externalUidsCache.hasOwnProperty(t)||Object.assign(this._externalUidsCache,yield this._getExternalIdsByOkIds([t])),Br.fromString(this._externalUidsCache[t]))}))}prepareUserIds(e){return st(this,null,(function*(){Rr.isEmpty()||Object.assign(this._externalUidsCache,yield this._getExternalIdsByOkIds(e))}))}authorize(){return st(this,null,(function*(){if(!this._uuid){let e=Ei.get("uuid");e||(e=Ui.uuid(),Ei.set("uuid",e)),this._uuid=String(e)}let e={session_data:{version:2,device_id:this._uuid,client_version:Ar.appVersion,client_type:"SDK_JS"}};return Ar.authToken&&(e.session_data.auth_token=Ar.authToken,e.session_data.version=3),this._callUnsafe("auth.anonymLogin",e,!0).then((e=>{e.uid&&(this._userId=Number(e.uid)),Rr.sessionKey=e.session_key,Rr.sessionSecretKey=e.session_secret_key})).catch((e=>{throw 401===e.error_code&&Ur.onTokenExpired(),new Ai(At.AUTH,{message:e.error_msg,code:e.error_code})}))}))}log(e){Gn("log.externalLog",{collector:"ok.mobile.apps.video",data:JSON.stringify({application:`${Ar.appName}:${Ar.sdkVersion}`,platform:Ar.platform,items:e})})}init(){!function(){if(!Ar.apiKey)throw new Ai(At.API,{message:"Required argument apiAppKey not passed"})}()}joinConversation(e,t=!1,i){return st(this,null,(function*(){let r={conversationId:e,isVideo:t,protocolVersion:Ar.protocolVersion};return i&&(r.chatId=i),this._call("vchat.joinConversation",r)}))}createConversation(e,t="",i=!1){return st(this,null,(function*(){let r=this._preareStartConversationData({conversationId:e,isVideo:!1,joiningAllowed:!0,payload:t,requireAuthToJoin:i});return this._startConversation(r)}))}startConversation(e,t,i,r=!1,n="",a=!1,s=!1){return st(this,null,(function*(){let o=this._preareStartConversationData({conversationId:e,isVideo:r,joiningAllowed:a,payload:n,requireAuthToJoin:s});if(t&&t.length)switch(i){case _t.USER:o.uids=t.join(",");break;case _t.GROUP:o.gid=t[0];break;case _t.CHAT:o.chatId=t[0]}return this._startConversation(o)}))}_preareStartConversationData({conversationId:e,isVideo:t,payload:i="",joiningAllowed:r=!1,requireAuthToJoin:n=!1}){let a={conversationId:e,isVideo:t,protocolVersion:Ar.protocolVersion};return r&&(a.createJoinLink=!0),i&&(a.payload=i),Ar.domain&&(a.domainId=Ar.domain),Ar.externalDomain&&(a.externalDomain=Ar.externalDomain),n&&(a.requireAuthToJoin=!0),a}_startConversation(e){return st(this,null,(function*(){return this._call("vchat.startConversation",e)}))}createJoinLink(e){return st(this,null,(function*(){return this._call("vchat.createJoinLink",{conversationId:e})}))}removeJoinLink(e){return st(this,null,(function*(){return this._call("vchat.removeJoinLink",{conversationId:e})}))}getAnonymTokenByLink(e,t){return st(this,null,(function*(){let i={joinLink:e};t&&(i.anonymName=t);let r=yield this._call("vchat.getAnonymTokenByLink",i);return this._userId=Number(r.uid),r.token}))}joinConversationByLink(e,t=!1,i){return st(this,null,(function*(){let r={joinLink:e,isVideo:t,protocolVersion:Ar.protocolVersion};return(null==i?void 0:i.length)&&(r.observedIds=i.join(",")),Ar.anonymToken&&(r.anonymToken=Ar.anonymToken),this._call("vchat.joinConversationByLink",r)}))}getOkIdsByExternalIds(e){return st(this,null,(function*(){let t=Br.fromIds(e),i=[],r={methods:[]},n=[],a=Object.keys(this._externalUidsCache),s=Object.values(this._externalUidsCache);for(let e of t){let t=Br.toString(e),o=s.indexOf(t);o>-1?i.push(Number(a[o])):(n.push(t),r.methods.push({"vchat.getOkIdByExternalId":{params:{externalId:e.id,anonym:e.type===Gr.ANONYM},onError:"SKIP"}}))}return r.methods.length&&(yield this._call("batch.executeV2",r)).forEach(((e,t)=>{if(e.ok){let r=Number(e.ok.ok_id);this._externalUidsCache[r]=n[t],i.push(r)}})),i}))}getExternalIdsByOkIds(e){return st(this,null,(function*(){let t=[],i=[];for(let r of e)this._externalUidsCache.hasOwnProperty(r)?t.push(Br.fromString(this._externalUidsCache[r])):i.push(r);if(!i.length)return t;let r=yield this._getExternalIdsByOkIds(i);Object.assign(this._externalUidsCache,r);for(let e of i)r.hasOwnProperty(e)&&t.push(Br.fromString(r[e]));return t}))}getCachedOkIdByExternalId(e){let t=Object.keys(this._externalUidsCache),i=Object.values(this._externalUidsCache),r=Br.toString(e),n=i.indexOf(r);return n>-1?Ui.composeUserId(t[n],Xt.USER):null}cacheExternalId(e,t){let i=Ui.decomposeId(e).id;this._externalUidsCache[i]=Br.toString(t)}getConversationParams(e){return st(this,null,(function*(){let t={};return Ar.anonymToken&&(t.anonymToken=Ar.anonymToken),e&&(t.conversationId=e),this._call("vchat.getConversationParams",t)}))}getUserId(){return this._userId}setUserId(e){this._userId=e}hangupConversation(e){let t={conversationId:e,reason:bt.HUNGUP};Ar.anonymToken&&(t.anonymToken=Ar.anonymToken),Gn("vchat.hangupConversation",t)}removeHistoryRecords(e){return st(this,null,(function*(){yield this._call("vchat.removeHistoryRecords",{recordIds:e.join(",")})}))}cleanup(){}_getExternalIdsByOkIds(e){return st(this,null,(function*(){let t={};try{let i=yield this._call("vchat.getExternalIdsByOkIds",{uids:e.join(",")});if(i.external_ids)for(let[e,r]of Object.entries(i.external_ids))t[e]=Br.fromIdToString(r,Gr.USER);if(i.anonym_ids)for(let[e,r]of Object.entries(i.anonym_ids))t[e]=Br.fromIdToString(r,Gr.ANONYM);return t}catch(e){return t}}))}},Kn=((Wn=Kn||{}).RECOVER="recover",Wn.ACCEPT_CALL="accept-call",Wn.ADD_PARTICIPANT="add-participant",Wn.REMOVE_PARTICIPANT="remove-participant",Wn.HANGUP="hangup",Wn.TRANSMIT_DATA="transmit-data",Wn.ACCEPT_PRODUCER="accept-producer",Wn.ALLOCATE_CONSUMER="allocate-consumer",Wn.CHANGE_MEDIA_SETTINGS="change-media-settings",Wn.CHANGE_PARTICIPANT_STATE="change-participant-state",Wn.CHANGE_STREAM_PRIORITIES="change-streams-priorities",Wn.UPDATE_DISPLAY_LAYOUT="update-display-layout",Wn.REPORT_PERF_STAT="report-perf-stat",Wn.RECORD_START="record-start",Wn.RECORD_STOP="record-stop",Wn.RECORD_SET_ROLE="record-set-role",Wn.RECORD_GET_STATUS="record-get-status",Wn.SWITCH_MICRO="switch-micro",Wn.SWITCH_TOPOLOGY="switch-topology",Wn.REQUEST_REALLOC="request-realloc",Wn.CHAT_MESSAGE="chat-message",Wn.CHAT_HISTORY="chat-history",Wn.CUSTOM_DATA="custom-data",Wn.GRANT_ROLES="grant-roles",Wn.MUTE_PARTICIPANT="mute-participant",Wn.PIN_PARTICIPANT="pin-participant",Wn.UPDATE_MEDIA_MODIFIERS="update-media-modifiers",Wn.CHANGE_OPTIONS="change-options",Wn.GET_WAITING_HALL="get-waiting-hall",Wn.GET_PARTICIPANT_LIST_CHUNK="get-participant-list-chunk",Wn.GET_PARTICIPANTS="get-participants",Wn.PROMOTE_PARTICIPANT="promote-participant",Wn.REQUEST_TEST_MODE="request-test-mode",Wn.ADD_MOVIE="add-movie",Wn.UPDATE_MOVIE="update-movie",Wn.REMOVE_MOVIE="remove-movie",Wn),qn=Kn;function zn(){let e=new DataView(new ArrayBuffer(64)),t=0;function i(i){if(t+i>e.byteLength){let r=new Uint8Array(Math.max(t+i,e.byteLength+64));r.set(new Uint8Array(e.buffer.slice(0,t))),e=new DataView(r.buffer)}}return{put(r){if(i(r.byteLength),function(e){return void 0!==e.buffer}(r)){let i=r.buffer;new Uint8Array(e.buffer).set(new Uint8Array(i),t)}else new Uint8Array(e.buffer).set(new Uint8Array(r),t);t+=r.byteLength},putI8(r){i(1),e.setInt8(t,r),++t},putI16(r){i(2),e.setInt16(t,r),t+=2},putI32(r){i(4),e.setInt32(t,r),t+=4},putI64(r){i(8);let n=r<0;n&&(r=-r);let a=r/4294967296|0,s=r%4294967296|0;n&&(s=1+~s|0,a=0===s?1+~a|0:~a),e.setUint32(t,a),e.setUint32(t+4,s),t+=8},putUi8(r){i(1),e.setUint8(t,r),++t},putUi16(r){i(2),e.setUint16(t,r),t+=2},putUi32(r){i(4),e.setUint32(t,r),t+=4},putUi64(r){i(8),e.setUint32(t,r/4294967296|0),e.setUint32(t+4,r%4294967296),t+=8},putF(r){i(8),e.setFloat64(t,r),t+=8},ui8array:()=>new Uint8Array(e.buffer.slice(0,t))}}function Yn(e){let t=ArrayBuffer.isView(e)?new DataView(e.buffer,e.byteOffset,e.byteLength):new DataView(e),i=0;return{peek:()=>t.getUint8(i),get(e){i+=e;let r=t.byteOffset;return t.buffer.slice(r+i-e,r+i)},getI8:()=>t.getInt8(i++),getI16:()=>(i+=2,t.getInt16(i-2)),getI32:()=>(i+=4,t.getInt32(i-4)),getI64:()=>(i+=8,4294967296*t.getInt32(i-8)+t.getUint32(i-4)),getUi8:()=>t.getUint8(i++),getUi16:()=>(i+=2,t.getUint16(i-2)),getUi32:()=>(i+=4,t.getUint32(i-4)),getUi64:()=>(i+=8,4294967296*t.getUint32(i-8)+t.getUint32(i-4)),getF32:()=>(i+=4,t.getFloat32(i-4)),getF64:()=>(i+=8,t.getFloat64(i-8))}}var Jn="open",Xn=[()=>Ar.producerScreenTrack,()=>Ar.videoTracksCount>0,()=>!0,()=>Ar.filteredMessages,()=>Ar.consumerScreenTrack,()=>!0,()=>Ar.movieShare,()=>Ar.useParticipantListChunk],Qn=class extends lt{constructor(){super(...arguments),this.socket=null,this.sequence=1,this.lastStamp=0,this.websocketCommandsQueue=[],this.datachannelCommandsQueue=[],this.incomingCache=[],this.responseHandlers={},this.reconnectCount=0,this.conversationResolve=null,this.conversationReject=null,this.connected=!1,this.listenersReady=!1,this.postfix="&platform="+Ar.platform+"&appVersion="+Ar.appVersion+"&version="+Ar.protocolVersion+"&device="+Ar.device+"&capabilities="+Qn._getCapabilityFlags(),this.peerId=null,this.conversationId=null,this.reconnectTimer=0,this.connectionMessageWaitTimer=0,this.doctorTimer=0,this.participantIdRegistry=null,this.producerNotificationDataChannel=null,this.producerCommandDataChannel=null,this.producerCommandDataChannelEnabled=!1,this.producerCommandSerializationService=new class{constructor(){this.participantIdRegistry=null}setParticipantIdRegistry(e){this.participantIdRegistry=e}serializeUpdateDisplayLayout(e,t){let i=zn();xe.enc(i,0),xe.enc(i,0),xe.enc(i,e),Me.enc(i,null);let r=[];for(let e in t)t.hasOwnProperty(e)&&this.writeLayout(t,e,r);return je.enc(i,r),Me.enc(i,null),i.ui8array()}writeLayout(e,t,i){let r=e[t],n=zn();if(this.writeStreamDesc(t,n),Hr(r))xe.enc(n,1);else if(jr(r))xe.enc(n,2);else if(xe.enc(n,0),void 0!==r.priority?xe.enc(n,r.priority):Me.enc(n,null),void 0!==r.width&&void 0!==r.height?(xe.enc(n,Math.round(r.width)),xe.enc(n,Math.round(r.height))):(Me.enc(n,null),Me.enc(n,null)),void 0!==r.fit)switch(r.fit){case"cv":xe.enc(n,0);break;case"cn":xe.enc(n,1);break;default:Me.enc(n,null)}else Me.enc(n,null);i.push(n.ui8array())}writeStreamDesc(e,t){if(this.participantIdRegistry){let i=this.participantIdRegistry.getCompactId(e);if(void 0!==i)return void xe.enc(t,i)}Ge.enc(t,e)}serializePerfStatReport(e,t){let i=zn();return xe.enc(i,1),xe.enc(i,0),xe.enc(i,e),xe.enc(i,t.framesDecoded),xe.enc(i,t.framesReceived),i.ui8array()}deserializeCommandResponse(e){return st(this,null,(function*(){let t;t=e instanceof Blob?Yn(yield e.arrayBuffer()):Yn(e);let i=xe.dec(t),r=xe.dec(t);if(0===r)if(0===xe.dec(t))switch(i){case 0:return this.deserializeUpdateDisplayLayoutResponse(t);case 1:return this.deserializeReportPerfStatResponse(t);default:return Fr.warn("unsupported command response commandType: "+i),null}else Fr.warn("Error code: "+i+"received for command type: "+i+", version "+r);else Fr.warn("Unsupported version for command type: "+i+", version "+r)}))}deserializeUpdateDisplayLayoutResponse(e){let t=xe.dec(e),i=je.dec(e),r={};return i.forEach((e=>{let t=Yn(e),i=Le.dec(t);if("string"==typeof i)r[i]=xe.dec(t);else{let e=i,n=Kr(this.participantIdRegistry.getStreamDescription(e));r[n]=xe.dec(t)}})),{type:"response",sequence:t,response:qn.UPDATE_DISPLAY_LAYOUT.toString(),errorCodeByParticipantId:r}}deserializeReportPerfStatResponse(e){let t=xe.dec(e),i=xe.dec(e);return{type:"response",sequence:t,response:qn.REPORT_PERF_STAT.toString(),estimatedPerformanceIndex:i}}}}static _getCapabilityFlags(){let e=0;for(let t=0;t<Xn.length;t++)Xn[t]()&&(e|=1<<t);return e.toString(16).toUpperCase()}get ready(){return null!==this.socket}setEndpoint(e){this.endpoint=e}setConversationId(e){this.conversationId=e}setParticipantIdRegistry(e){this.participantIdRegistry=e,this.producerCommandSerializationService.setParticipantIdRegistry(e)}setProducerNotificationDataChannel(e){this.producerNotificationDataChannel=e,this.producerNotificationDataChannel.onmessage=e=>{var t;let i=null==(t=this.participantIdRegistry)?void 0:t.handleMessage(e.data);i&&this._handleMessage(i)}}setProducerCommandDataChannel(e){this.producerCommandDataChannel=e,this.producerCommandDataChannel.onmessage=e=>{this.producerCommandSerializationService.deserializeCommandResponse(e.data).then((e=>{e&&this._handleMessage(e)})).catch((e=>{Fr.warn("Cannot parse message at producerCommandDataChannel",e)}))},this._handleCommandsQueue(this.datachannelCommandsQueue)}useCommandDataChannel(e){this.producerCommandDataChannelEnabled=e}cleanup(){this.datachannelCommandsQueue=[]}connect(e){return st(this,null,(function*(){return this.postfix+=`&clientType=${Ar.clientType}`,new Promise(((t,i)=>{if(this.socket&&this.socket.readyState<WebSocket.CLOSING)return fi.log(Ht.SOCKET_ACTION,"already_opened"),void i(Error("Socket already opened"));this.conversationResolve=e=>{t(e),this.conversationResolve=null,this.conversationReject=null},this.conversationReject=e=>{i(e),this.conversationResolve=null,this.conversationReject=null},this._connect(e)}))}))}_send(e){return st(this,arguments,(function*(e,t={},i=0){if(t.participantId){let e=Ui.decomposeParticipantId(t.participantId),i=Ui.decomposeId(e.compositeUserId);t=Object.assign({},t,{participantId:i.id,participantType:i.type}),e.deviceIdx&&(t.deviceIdx=e.deviceIdx)}return this._sendRaw(e,t,i)}))}_sendRaw(e){return st(this,arguments,(function*(e,t={},i=0){let r=t=>{var i;if(this._isDataChannelCommand(e))this.datachannelCommandsQueue.push(t),(null==(i=this.producerCommandDataChannel)?void 0:i.readyState)===Jn&&this._handleCommandsQueue(this.datachannelCommandsQueue);else{if(!this.socket)return fi.log(Ht.SOCKET_ACTION,"not_opened"),Fr.warn("Socket not opened"),void t.reject(new Error(`Socket not opened [${e}]`),!0);this.socket.readyState>WebSocket.OPEN&&(fi.log(Ht.SOCKET_ACTION,"invalid_state"),Fr.warn(`Socket is not opened, state ${this.socket.readyState}`)),this.websocketCommandsQueue.push(t),this.socket&&this.socket.readyState===WebSocket.OPEN&&this._handleCommandsQueue(this.websocketCommandsQueue)}};return new Promise(((n,a)=>{let s={sequence:this.sequence++,name:e,params:t,responseTimer:0,resolve:n,reject:(t,n=!1)=>{!i||n?a(t):(Fr.debug("Resending a signaling message",e,s.sequence),i--,r(s))}};r(s)}))}))}_isDataChannelCommand(e){return!!this.producerCommandDataChannelEnabled&&(e===qn.UPDATE_DISPLAY_LAYOUT||e===qn.REPORT_PERF_STAT)}static _isDataChannelResponseRequired(e){return e===qn.UPDATE_DISPLAY_LAYOUT||e===qn.REPORT_PERF_STAT}getNextCommandSequenceNumber(){return this.sequence}hangup(e){return st(this,null,(function*(){return this._send(qn.HANGUP,{reason:e}).catch((()=>{}))}))}sendCandidate(e,t){return st(this,null,(function*(){return this._send(qn.TRANSMIT_DATA,{participantId:e,data:{candidate:t}})}))}requestTestMode(e,t){return st(this,null,(function*(){return this._send(qn.REQUEST_TEST_MODE,{consumer:e,producer:t})}))}sendSdp(e,t){return st(this,null,(function*(){return this._send(qn.TRANSMIT_DATA,{participantId:e,data:{sdp:t}})}))}acceptCall(e){return st(this,null,(function*(){return this._send(qn.ACCEPT_CALL,{mediaSettings:e})}))}changeMediaSettings(e){return st(this,null,(function*(){return this._send(qn.CHANGE_MEDIA_SETTINGS,{mediaSettings:e},10)}))}changeParticipantState(e){return st(this,null,(function*(){return this._send(qn.CHANGE_PARTICIPANT_STATE,{participantState:{state:e}})}))}addParticipant(e,t){return st(this,null,(function*(){return this._send(qn.ADD_PARTICIPANT,nt({participantId:e},t))}))}removeParticipant(e,t=!1){return st(this,null,(function*(){return this._send(qn.REMOVE_PARTICIPANT,{participantId:e,ban:t})}))}allocateConsumer(e,t){return st(this,null,(function*(){let i={capabilities:t};return e&&(i.description=e.sdp),this._send(qn.ALLOCATE_CONSUMER,i)}))}acceptProducer(e,t){return st(this,null,(function*(){let i={description:e.sdp};return t&&(i.ssrcs=t),this._send(qn.ACCEPT_PRODUCER,i)}))}changePriorities(e){return st(this,null,(function*(){return this._send(qn.CHANGE_STREAM_PRIORITIES,{typedPriorities:e}).catch((()=>{}))}))}updateDisplayLayout(e){return st(this,null,(function*(){return this._send(qn.UPDATE_DISPLAY_LAYOUT,e)}))}addMovie(e){return st(this,null,(function*(){return this._send(qn.ADD_MOVIE,e)}))}updateMovie(e){return st(this,null,(function*(){return this._send(qn.UPDATE_MOVIE,e)}))}removeMovie(e){return st(this,null,(function*(){return this._send(qn.REMOVE_MOVIE,e)}))}startStream(e){return st(this,null,(function*(){return this._send(qn.RECORD_START,e)}))}stopStream(){return st(this,null,(function*(){return this._send(qn.RECORD_STOP)}))}recordSetRole(e,t){return st(this,null,(function*(){return this._send(qn.RECORD_SET_ROLE,{participantId:e,role:t})}))}getRecordStatus(){return st(this,null,(function*(){return this._send(qn.RECORD_GET_STATUS)}))}switchTopology(e,t=!1){return st(this,null,(function*(){return this._send(qn.SWITCH_TOPOLOGY,{topology:e,force:t})}))}requestRealloc(){return st(this,null,(function*(){return this._send(qn.REQUEST_REALLOC)}))}reportPerfStat(e){return st(this,null,(function*(){return this._send(qn.REPORT_PERF_STAT,e)}))}chatMessage(e,t=null){return st(this,null,(function*(){return this._send(qn.CHAT_MESSAGE,{message:e,participantId:t})}))}chatHistory(e){return st(this,null,(function*(){return this._send(qn.CHAT_HISTORY,{count:e})}))}customData(e,t){return st(this,null,(function*(){return this._send(qn.CUSTOM_DATA,{data:e,participantId:t})}))}grantRoles(e,t,i){return st(this,null,(function*(){let r={participantId:e,roles:t};return i&&(r.revoke=!0),this._sendRaw(qn.GRANT_ROLES,r)}))}muteParticipant(e,t,i){return st(this,null,(function*(){return this._sendRaw(qn.MUTE_PARTICIPANT,{participantId:e,muteStates:t,requestedMedia:i})}))}pinParticipant(e,t){return st(this,null,(function*(){let i={participantId:e};return t&&(i.unpin=!0),this._sendRaw(qn.PIN_PARTICIPANT,i)}))}updateMediaModifiers(e){return st(this,null,(function*(){return this._send(qn.UPDATE_MEDIA_MODIFIERS,{mediaModifiers:e})}))}changeOptions(e){return st(this,null,(function*(){return this._send(qn.CHANGE_OPTIONS,{options:e})}))}getWaitingHall(e=null,t,i=!1){return st(this,null,(function*(){let r={};return e&&(r.fromId=e),t&&(r.count=t),i&&(r.backward=i),this._send(qn.GET_WAITING_HALL,r)}))}promoteParticipant(e,t=!1){return st(this,null,(function*(){let i={participantId:e};return t&&(i.demote=t),this._sendRaw(qn.PROMOTE_PARTICIPANT,i)}))}close(){this.socket&&this.socket.readyState<WebSocket.CLOSING&&this._closeSocket(),this._stopWaitConnectionMessage(),this._stopDoctor(),clearTimeout(this.reconnectTimer)}readyToSend(){this.listenersReady=!0,this._handleCachedMessages()}getParticipantListChunk(e){return st(this,null,(function*(){return this._send(qn.GET_PARTICIPANT_LIST_CHUNK,e)}))}getParticipants(e){return st(this,null,(function*(){return this._send(qn.GET_PARTICIPANTS,{externalIds:e})}))}_connect(e){if(this.socket&&this.socket.readyState<WebSocket.CLOSING)return;let t="";e&&(t+=`&tgt=${e}`),e===Ut.RETRY&&this.lastStamp&&(t+=`&recoverTs=${this.lastStamp}`),t=function(e){if(!Ar.useParticipantListChunk)return e;e+=`&partIdx=${Ar.participantListChunkInitIndex}`;let t=Ar.participantListChunkInitCount;return null!==t&&(e+=`&partCount=${t}`),e}(t),Fr.debug("Connecting to "+this.endpoint+this.postfix+t),this.socket=new WebSocket(this.endpoint+this.postfix+t),this.socket.onopen=this._onOpen.bind(this),this.socket.onmessage=this._onMessage.bind(this),this.socket.onerror=this._onError.bind(this),this.socket.onclose=this._onClose.bind(this),this._startDoctor()}_disconnect(){this.socket&&this.socket.readyState<WebSocket.CLOSING&&(this.socket.onopen=null,this.socket.onmessage=null,this.socket.onerror=null,this.socket.onclose=null,this.socket.close(),this.socket=null),this._stopWaitConnectionMessage(),this._stopDoctor(),clearTimeout(this.reconnectTimer)}_onOpen(){Fr.debug("Socket opened"),fi.log(Ht.SOCKET_ACTION,"opened"),this._waitConnectionMessage(),this._startDoctor()}_onMessage(e){if(this._startDoctor(),"ping"!==e.data)try{this._handleMessage(JSON.parse(e.data))}catch(t){fi.log(Ht.SOCKET_ACTION,"parse_error"),Fr.error("Unable to parse message",t,e.data)}else this.socket&&this.socket.readyState===WebSocket.OPEN&&this.socket.send("pong")}_handleMessage(e){var t;"notification"===e.type?"connection"===e.notification?(Fr.debug("Signaling connected",e),this.connected=!0,this.reconnectCount=0,this.endpoint=e.endpoint,e.peerId&&this.peerId!==e.peerId.id&&(this.postfix+=`&peerId=${e.peerId.id}`,this.peerId=e.peerId.id),this._stopWaitConnectionMessage(),this.conversationResolve?this.conversationResolve(e):(this._triggerEvent(Bt.RECONNECT,e),e.conversation.topology&&this._triggerEvent(Bt.NOTIFICATION,{type:"notification",notification:Ft.TOPOLOGY_CHANGED,topology:e.conversation.topology})),this.lastStamp&&this._handleCachedMessages(),null==(t=e.recoverMessages)||t.forEach((e=>this._handleMessage(e))),this._handleCommandsQueue(this.websocketCommandsQueue)):this.connected&&this.listenersReady?this._triggerEvent(Bt.NOTIFICATION,e):this.incomingCache.push(e):"response"===e.type&&this.responseHandlers[e.sequence]?this._handleCommandResponse(!0,e):"error"===e.type&&this.responseHandlers[e.sequence]?(fi.log(Ht.SOCKET_ACTION,`error-${e.error}`),this._handleCommandResponse(!1,e)):"error"===e.type?(fi.log(Ht.SOCKET_ACTION,`error-${e.error}`),"service-unavailable"===e.error?this._reconnect():"conversation-ended"===e.error?this.conversationReject?this.conversationReject(new Ai(bt.SOCKET_CLOSED,{message:`Unable to connect to the signaling: ${e.error}`})):this._triggerEvent(Bt.NOTIFICATION,{notification:Ft.CLOSED_CONVERSATION,reason:e.reason}):this.connected||"invalid-token"===e.error?this._throwError(new Error(`Signaling error: ${e.error}`)):e.sequence||(this.conversationReject&&this.conversationReject(new Ai(At.SIGNALING_FAILED,{message:`Unable to connect to the signaling: ${e.error}`})),this._closeSocket())):(fi.log(Ht.SOCKET_ACTION,"unknown_message"),Fr.warn("Unhandled message",e)),this.lastStamp=e.stamp||this.lastStamp}_handleCachedMessages(){let e=[...this.incomingCache];for(this.incomingCache=[];e.length>0;){let t=e.shift();this._handleMessage(t)}}_throwError(e){this._triggerEvent(Bt.FAILED,e)}_onError(e){fi.log(Ht.SOCKET_ACTION,"error"),Fr.error("Signaling error",e)}_onClose(e){fi.log(Ht.SOCKET_ACTION,"closed"),Fr.debug("Connection closed",{code:e.code,reason:e.reason}),this.connected=!1,this._stopDoctor(),this.socket&&this.reconnectCount++<Qn.RECONNECT_MAX_COUNT?this._reconnect():this.socket&&this._closeSocket(new Error("Connection closed"))}_closeSocket(e=null){!this.socket||(this._disconnect(),Object.values(this.responseHandlers).forEach((t=>{window.clearTimeout(t.responseTimer),e&&t.reject(new Error("Connection closed"),!0)})),this.websocketCommandsQueue=[],this.responseHandlers={},this.lastStamp=0,e&&this._throwError(new Error("Connection closed")))}_reconnect(){let e=Math.min(Qn.RECONNECT_MAX_DELAY,Qn.RECONNECT_DELAY*Math.pow(2,this.reconnectCount-1));Fr.log(`Reconnect websocket after ${e}ms (${this.reconnectCount})`),fi.log(Ht.SOCKET_ACTION,"reconnect"),this.reconnectTimer=window.setTimeout(this._connect.bind(this,Ut.RETRY),e)}_handleCommandResponse(e,t){var i;if(!this.responseHandlers.hasOwnProperty(t.sequence))return;let r=this.responseHandlers[t.sequence];window.clearTimeout(r.responseTimer),e?(delete this.responseHandlers[t.sequence],r.resolve(t)):(null==(i=this.socket)?void 0:i.readyState)===WebSocket.OPEN?(delete this.responseHandlers[t.sequence],fi.log(Ht.SOCKET_ACTION,"response-timeout"),r.reject(new Error(t.error||`Response timeout [${r.name}]`))):r.responseTimer=window.setTimeout((()=>this._handleCommandResponse(!1,t)),Qn.WAIT_RESPONSE_DELAY)}_handleCommandsQueue(e){for(var t,i;e.length>0;){let r=e.shift();if(this._isDataChannelCommand(r.name)){if((null==(t=this.producerCommandDataChannel)?void 0:t.readyState)!==Jn)return void r.reject(new Error(`Invalid data channel state: ${null==(i=this.producerCommandDataChannel)?void 0:i.readyState}`));Qn._isDataChannelResponseRequired(r.name)&&(r.responseTimer=window.setTimeout((()=>this._handleCommandResponse(!1,{command:r.name,sequence:r.sequence})),Qn.WAIT_RESPONSE_DELAY),this.responseHandlers[r.sequence]=r);let e=this._serializeBinary(r);null!==e&&this.producerCommandDataChannel.send(e)}else{if(!this.socket||this.socket.readyState!==WebSocket.OPEN){r.reject(new Error("Invalid state or socket already closed"));continue}r.responseTimer=window.setTimeout((()=>this._handleCommandResponse(!1,{command:r.name,sequence:r.sequence})),Qn.WAIT_RESPONSE_DELAY),this.responseHandlers[r.sequence]=r,this.socket.send(this._serializeJson(r))}}}_serializeBinary(e){switch(e.name){case qn.UPDATE_DISPLAY_LAYOUT:return this.producerCommandSerializationService.serializeUpdateDisplayLayout(e.sequence,e.params);case qn.REPORT_PERF_STAT:return this.producerCommandSerializationService.serializePerfStatReport(e.sequence,e.params)}return Fr.warn("cannot get binary data for data channel command: "+e.name),null}_serializeJson(e){let t;t=e.name===qn.UPDATE_DISPLAY_LAYOUT?this._convertDisplayLayout(e.params):e.params;let i=Object.assign({command:e.name,sequence:e.sequence},t);return JSON.stringify(i)}_convertDisplayLayout(e){let t=e,i={};for(let e in t)t.hasOwnProperty(e)&&(i[e]=Wr(t[e]));return{layouts:i}}_waitConnectionMessage(){this.connectionMessageWaitTimer=window.setTimeout((()=>{this.conversationReject&&this.conversationReject(new Ai(At.SIGNALING_FAILED,{message:"Unable to connect to the signaling: connection timeout"}))}),Qn.WAIT_CONNECTION_DELAY)}_stopWaitConnectionMessage(){window.clearTimeout(this.connectionMessageWaitTimer),this.connectionMessageWaitTimer=0}_startDoctor(){this._stopDoctor(),this.doctorTimer=window.setTimeout((()=>{Fr.warn("Socket is dead, trying to reconnect"),this._disconnect(),this._connect(Ut.RETRY)}),Qn.WAIT_MESSAGE_DELAY)}_stopDoctor(){window.clearTimeout(this.doctorTimer),this.doctorTimer=0}},Zn=Qn;Zn.RECONNECT_DELAY=Ar.signalingReconnectDelay,Zn.RECONNECT_MAX_DELAY=Ar.signalingReconnectMaxDelay,Zn.RECONNECT_MAX_COUNT=Ar.signalingReconnectMaxCount,Zn.WAIT_CONNECTION_DELAY=Ar.waitConnectionDelay,Zn.WAIT_RESPONSE_DELAY=Ar.waitResponseDelay,Zn.WAIT_MESSAGE_DELAY=Ar.waitMessageDelay;var ea,ta,ia=(e=>(e.KING="KING",e.PAWN="PAWN",e))(ia||{}),ra=ia,na=null,aa={getCameras:dr.getCameras,getMicrophones:dr.getMicrophones,getOutput:dr.getOutput,hasCamera:dr.hasCamera,hasMicrophone:dr.hasMicrophone,getSavedCamera:dr.getSavedCamera,getSavedMicrophone:dr.getSavedMicrophone,getSavedOutput:dr.getSavedOutput,hasCameraPermission:dr.hasCameraPermission,hasMicrophonePermission:dr.hasMicrophonePermission,hasPermissions:dr.hasPermissions,getUserMedia:dr.getUserMedia,getUserVideo:dr.getUserVideo,getUserAudio:dr.getUserAudio,saveDeviceId:dr.saveDeviceId,isBrowserSupported:dr.isBrowserSupported,isScreenCapturingSupported:dr.isScreenCapturingSupported,os:dr.os,isMobile:dr.isMobile,browserName:dr.browserName,browserVersion:dr.browserVersion,baseChromeVersion:dr.baseChromeVersion,getAudioContext:dr.getAudioContext};function sa(e){ta=e}function oa(e){ea=e}function ca(e){na=e}function da(e){Ar.videoEffects=e}function la(e){return st(this,null,(function*(){if(Ar.set(e),"Sferum"===dr.browserName()&&(Ar.platform=`SFERUM:${dr.browserVersion()}`),ta||sa(new $n),ea||oa((()=>new Zn)),Ar.debug&&(_e.disableLog(!1),Fr.toggle(!0)),Fr.log(`Calls SDK ${Ar.sdkVersion}`,e),yield dr.init(),!dr.isBrowserSupported())throw new Ai(At.UNSUPPORTED);ta.init()}))}function ua(e){return st(this,arguments,(function*(e,t=[Dt.AUDIO],i="",r=!1,n=!1){let a=[],s=[];if(Array.isArray(e)?a=e.length?e:[]:e&&(a=[e]),a.length&&(s=yield ta.getOkIdsByExternalIds(a),!s.length))throw new Ai(bt.CALLEE_IS_OFFLINE);return pa(s,_t.USER,t,i,r,n)}))}function pa(e){return st(this,arguments,(function*(e,t=_t.USER,i,r="",n=!1,a=!1){if(Un.current())throw Fr.error("There is already active call"),new Ai(bt.FAILED);return new Un(ta,ea(),na).onStart(e,t,i,r,n,a)}))}function ha(e){return st(this,null,(function*(){return _a(e)}))}function _a(e){return st(this,arguments,(function*(e,t=Xt.USER,i){if(e===Un.id())throw new Error("Push has already been processed");return new Un(ta,ea(),na).onPush(e,t,i)}))}function fa(e){return st(this,null,(function*(){return e&&(Ar.authToken=e),ta.authorize()}))}function ma(){return st(this,arguments,(function*(e=[Dt.AUDIO]){return ms().accept(e)}))}function ga(){return st(this,null,(function*(){let e=Un.current();if(e)return e.decline()}))}function va(e){return st(this,arguments,(function*(e,t=[Dt.AUDIO]){return Sa(e,t)}))}function Sa(e,t,i){return st(this,null,(function*(){if(Un.current())throw Fr.error("There is already active call"),new Ai(bt.FAILED);return new Un(ta,ea(),na).onJoin({conversationId:e,mediaOptions:t,chatId:i})}))}function Ea(e){return st(this,arguments,(function*(e,t=[Dt.AUDIO],i,r){if(Un.current())throw Fr.error("There is already active call"),new Ai(bt.FAILED);return i&&(Ar.anonymToken=i),new Un(ta,ea(),na).onJoin({joinLink:e,mediaOptions:t,observedIds:r})}))}function ya(){return st(this,null,(function*(){let e=Un.current();if(e)return e.hangup();Un.hangupAfterInit()}))}function Ta(e,t){return st(this,null,(function*(){let i=yield ta.getOkIdsByExternalIds([e]);if(!i.length)throw new Error("User not found");return Ca(i[0],t)}))}function Ca(e,t){return st(this,null,(function*(){let i=Un.current();i&&(yield i.addParticipant(Ui.composeUserId(e,Xt.USER),t))}))}function Ra(e,t=!1){return st(this,null,(function*(){return Ia((yield ta.getOkIdsByExternalIds([e]))[0],t)}))}function Ia(e,t=!1){return st(this,null,(function*(){let i=Un.current();i&&(yield i.removeParticipant(Ui.composeUserId(e,Xt.USER),t))}))}function Aa(e,t){return st(this,null,(function*(){let i=yield dr.saveDeviceId(e,t),r=Un.current();return i&&r?r.changeDevice(e):Promise.reject()}))}function Pa(e){return st(this,null,(function*(){let t=Un.current();return t?t.toggleScreenCapturing(e):Promise.reject()}))}function ba(e,t=!1){return st(this,null,(function*(){let i=Un.current();i&&(yield i.setVideoStream(e,t))}))}function Oa(e){return st(this,null,(function*(){let t=Un.current();t&&(yield t.toggleLocalVideo(e))}))}function Da(e){return st(this,null,(function*(){let t=Un.current();t&&(yield t.toggleLocalAudio(e))}))}function wa(e,t,i){return st(this,null,(function*(){let r=Un.current();if(r)return r.setLocalResolution(e,t,i)}))}function Na(e){return st(this,null,(function*(){let t=Un.current();t&&(yield t.changePriorities(e))}))}function ka(e){return st(this,null,(function*(){let t=Un.current();t&&(yield t.changeParticipantState(e))}))}function La(e){return st(this,null,(function*(){let t=Un.current();t&&(yield t.updateDisplayLayout(e))}))}function Ma(e,t,i=!1){return st(this,null,(function*(){return Ua((yield ta.getOkIdsByExternalIds([e]))[0],t,i)}))}function Ua(e,t,i=!1){return st(this,null,(function*(){let r=Un.current();r&&(yield r.grantRoles(Ui.composeUserId(e,Xt.USER),t,i))}))}function xa(){return st(this,arguments,(function*(e=null,t,i=[]){let r=null;return e&&(r=(yield ta.getOkIdsByExternalIds([e]))[0]),Ba(r,t,i,Vr.getDeviceIdx(e))}))}function Ba(){return st(this,arguments,(function*(e=null,t,i=[],r=0){let n=Un.current();if(n){let a=e?Ui.composeParticipantId(e,Xt.USER,r):null;yield n.muteParticipant(a,t,i)}}))}function Va(e,t=!1){return st(this,null,(function*(){return Fa((yield ta.getOkIdsByExternalIds([e]))[0],t,Vr.getDeviceIdx(e))}))}function Fa(e,t=!1,i=0){return st(this,null,(function*(){let r=Un.current();r&&(yield r.pinParticipant(Ui.composeParticipantId(e,Xt.USER,i),t))}))}function Ga(e){return st(this,null,(function*(){let t=Un.current();t&&(yield t.updateMediaModifiers(e))}))}function Ha(e){return st(this,null,(function*(){let t=Un.current();t&&(yield t.changeOptions(e))}))}function ja(e,t=null){return st(this,null,(function*(){let i=null;return t&&(i=(yield ta.getOkIdsByExternalIds([t]))[0]),Wa(e,i)}))}function Wa(e,t=null){return st(this,null,(function*(){let i=Un.current();if(i){let r=t?Ui.composeUserId(t,Xt.USER):null;yield i.chatMessage(e,r)}}))}function $a(e=10){return st(this,null,(function*(){let t=Un.current();if(t)return t.chatHistory(e)}))}function Ka(e,t=null){return st(this,null,(function*(){let i=null;return t&&(i=(yield ta.getOkIdsByExternalIds([t]))[0]),qa(e,i,Vr.getDeviceIdx(t))}))}function qa(e,t=null,i=0){return st(this,null,(function*(){let r=Un.current();if(r){let n=t?Ui.composeParticipantId(t,Xt.USER,i):null;yield r.customData(e,n)}}))}function za(e="",t=!1){return st(this,null,(function*(){return(yield ta.createConversation(Ui.uuid(),e,t)).join_link}))}function Ya(){return st(this,null,(function*(){let e=Un.current();return e?e.createJoinLink():Promise.reject()}))}function Ja(){return st(this,null,(function*(){let e=Un.current();return e?e.removeJoinLink():Promise.reject()}))}function Xa(e,t){return st(this,null,(function*(){return ta.getAnonymTokenByLink(e,t)}))}function Qa(e){let t=Un.current();t&&t.setVolume(e)}function Za(e){Ar.forceRelayPolicy=e}function es(e=!1,t=null,i=null,r="DIRECT_LINK",n=null){return st(this,null,(function*(){let a=Un.current();return a?a.startStream(e,t,i,r,n):Promise.reject()}))}function ts(){return st(this,null,(function*(){let e=Un.current();return e?e.stopStream():Promise.reject()}))}function is(e,t){return st(this,null,(function*(){let i=Un.current();if(i){let r=yield ta.getOkIdsByExternalIds([e]),n=Vr.getDeviceIdx(e);return i.recordSetRole(Ui.composeParticipantId(r[0],Xt.USER,n),t)}return Promise.reject()}))}function rs(){return st(this,null,(function*(){let e=Un.current();return e?e.getStreamInfo():Promise.reject()}))}function ns(e){return st(this,null,(function*(){let t=Un.current();return t?t.addMovie(e):Promise.reject()}))}function as(e,t,i,r){return st(this,null,(function*(){let n=Un.current();return n?n.updateMovie(e,t,i,r):Promise.reject()}))}function ss(e){return st(this,null,(function*(){let t=Un.current();return t?t.removeMovie(e):Promise.reject()}))}function os(e){Ar.statisticsInterval=e;let t=Un.current();if(t)return t.updateStatisticsInterval()}function cs(e){_e.disableLog(!e),Fr.toggle(e)}function ds(e,...t){!Ar.debugLog||Fr.send(e,"[external]",...t)}function ls(e){return st(this,null,(function*(){let t=Un.current();if(t)return t.videoEffect(e)}))}function us(e){return st(this,null,(function*(){let t=Un.current();t&&(yield t.setAudioStream(e))}))}function ps(e=null,t,i=!1){return st(this,null,(function*(){return ms().getWaitingHall(e,t,i)}))}function hs(e,t=!1){return st(this,null,(function*(){let i=ms(),r=yield ta.getOkIdsByExternalIds([e]);return i.promoteParticipant(Ui.composeUserId(r[0],Xt.USER),t)}))}function _s(e){return st(this,null,(function*(){return ms().getParticipantListChunk(e)}))}function fs(e){return st(this,null,(function*(){return ms().getParticipants(e)}))}function ms(){let e=Un.current();if(!e)throw new Error("Conversation not found");return e}function gs(e){return st(this,null,(function*(){yield ta.removeHistoryRecords(e)}))}function vs(){return Ar.sdkVersion}},6257:e=>{var t=function(){"undefined"!=typeof document&&document.currentScript&&document.currentScript.src;return function(e){var t,i,r=void 0!==(e=e||{})?e:{};r.ready=new Promise((function(e,r){t=e,i=r}));var n,a={};for(n in r)r.hasOwnProperty(n)&&(a[n]=r[n]);var s,o=[],c="";"undefined"!=typeof document&&document.currentScript&&(c=document.currentScript.src),c=0!==c.indexOf("blob:")?c.substr(0,c.lastIndexOf("/")+1):"";var d=r.print||console.log.bind(console),l=r.printErr||console.warn.bind(console);for(n in a)a.hasOwnProperty(n)&&(r[n]=a[n]);a=null,r.arguments&&(o=r.arguments),r.thisProgram&&r.thisProgram,r.quit&&r.quit;var u,p=0;r.wasmBinary&&(u=r.wasmBinary);var h;r.noExitRuntime;"object"!=typeof WebAssembly&&H("no native wasm support detected");var _=!1;var f="undefined"!=typeof TextDecoder?new TextDecoder("utf8"):void 0;function m(e,t,i){for(var r=t+i,n=t;e[n]&&!(n>=r);)++n;if(n-t>16&&e.subarray&&f)return f.decode(e.subarray(t,n));for(var a="";t<n;){var s=e[t++];if(128&s){var o=63&e[t++];if(192!=(224&s)){var c=63&e[t++];if((s=224==(240&s)?(15&s)<<12|o<<6|c:(7&s)<<18|o<<12|c<<6|63&e[t++])<65536)a+=String.fromCharCode(s);else{var d=s-65536;a+=String.fromCharCode(55296|d>>10,56320|1023&d)}}else a+=String.fromCharCode((31&s)<<6|o)}else a+=String.fromCharCode(s)}return a}function g(e,t){return e?m(E,e,t):""}var v,S,E,y,T,C,R,I,A,P="undefined"!=typeof TextDecoder?new TextDecoder("utf-16le"):void 0;function b(e,t){for(var i=e,r=i>>1,n=r+t/2;!(r>=n)&&T[r];)++r;if((i=r<<1)-e>32&&P)return P.decode(E.subarray(e,i));for(var a="",s=0;!(s>=t/2);++s){var o=y[e+2*s>>1];if(0==o)break;a+=String.fromCharCode(o)}return a}function O(e,t,i){if(void 0===i&&(i=2147483647),i<2)return 0;for(var r=t,n=(i-=2)<2*e.length?i/2:e.length,a=0;a<n;++a){var s=e.charCodeAt(a);y[t>>1]=s,t+=2}return y[t>>1]=0,t-r}function D(e){return 2*e.length}function w(e,t){for(var i=0,r="";!(i>=t/4);){var n=C[e+4*i>>2];if(0==n)break;if(++i,n>=65536){var a=n-65536;r+=String.fromCharCode(55296|a>>10,56320|1023&a)}else r+=String.fromCharCode(n)}return r}function N(e,t,i){if(void 0===i&&(i=2147483647),i<4)return 0;for(var r=t,n=r+i-4,a=0;a<e.length;++a){var s=e.charCodeAt(a);if(s>=55296&&s<=57343)s=65536+((1023&s)<<10)|1023&e.charCodeAt(++a);if(C[t>>2]=s,(t+=4)+4>n)break}return C[t>>2]=0,t-r}function k(e){for(var t=0,i=0;i<e.length;++i){var r=e.charCodeAt(i);r>=55296&&r<=57343&&++i,t+=4}return t}function L(e){v=e,r.HEAP8=S=new Int8Array(e),r.HEAP16=y=new Int16Array(e),r.HEAP32=C=new Int32Array(e),r.HEAPU8=E=new Uint8Array(e),r.HEAPU16=T=new Uint16Array(e),r.HEAPU32=R=new Uint32Array(e),r.HEAPF32=I=new Float32Array(e),r.HEAPF64=A=new Float64Array(e)}r.INITIAL_MEMORY;var M,U=[],x=[],B=[];var V=0,F=null,G=null;function H(e){r.onAbort&&r.onAbort(e),l(e+=""),_=!0,1,e="abort("+e+"). Build with -s ASSERTIONS=1 for more info.";var t=new WebAssembly.RuntimeError(e);throw i(t),t}r.preloadedImages={},r.preloadedAudios={};var j,W;function $(e){return e.startsWith("data:application/octet-stream;base64,")}function K(e){try{if(e==j&&u)return new Uint8Array(u);if(s)return s(e);throw"both async and sync fetching of the wasm failed"}catch(e){H(e)}}function q(e){for(;e.length>0;){var t=e.shift();if("function"!=typeof t){var i=t.func;"number"==typeof i?void 0===t.arg?M.get(i)():M.get(i)(t.arg):i(void 0===t.arg?null:t.arg)}else t(r)}}function z(e){switch(e){case 1:return 0;case 2:return 1;case 4:return 2;case 8:return 3;default:throw new TypeError("Unknown type size: "+e)}}$(j="libvpx.wasm")||(W=j,j=r.locateFile?r.locateFile(W,c):c+W);var Y=void 0;function J(e){for(var t="",i=e;E[i];)t+=Y[E[i++]];return t}var X={},Q={},Z={};function ee(e){if(void 0===e)return"_unknown";var t=(e=e.replace(/[^a-zA-Z0-9_]/g,"$")).charCodeAt(0);return t>=48&&t<=57?"_"+e:e}function te(e,t){return e=ee(e),function(){return t.apply(this,arguments)}}function ie(e,t){var i=te(t,(function(e){this.name=t,this.message=e;var i=new Error(e).stack;void 0!==i&&(this.stack=this.toString()+"\n"+i.replace(/^Error(:[^\n]*)?\n/,""))}));return i.prototype=Object.create(e.prototype),i.prototype.constructor=i,i.prototype.toString=function(){return void 0===this.message?this.name:this.name+": "+this.message},i}var re=void 0;function ne(e){throw new re(e)}var ae=void 0;function se(e){throw new ae(e)}function oe(e,t,i){function r(t){var r=i(t);r.length!==e.length&&se("Mismatched type converter count");for(var n=0;n<e.length;++n)ce(e[n],r[n])}e.forEach((function(e){Z[e]=t}));var n=new Array(t.length),a=[],s=0;t.forEach((function(e,t){Q.hasOwnProperty(e)?n[t]=Q[e]:(a.push(e),X.hasOwnProperty(e)||(X[e]=[]),X[e].push((function(){n[t]=Q[e],++s===a.length&&r(n)})))})),0===a.length&&r(n)}function ce(e,t,i){if(i=i||{},!("argPackAdvance"in t))throw new TypeError("registerType registeredInstance requires argPackAdvance");var r=t.name;if(e||ne('type "'+r+'" must have a positive integer typeid pointer'),Q.hasOwnProperty(e)){if(i.ignoreDuplicateRegistrations)return;ne("Cannot register type '"+r+"' twice")}if(Q[e]=t,delete Z[e],X.hasOwnProperty(e)){var n=X[e];delete X[e],n.forEach((function(e){e()}))}}function de(e){if(!(this instanceof Te))return!1;if(!(e instanceof Te))return!1;for(var t=this.$$.ptrType.registeredClass,i=this.$$.ptr,r=e.$$.ptrType.registeredClass,n=e.$$.ptr;t.baseClass;)i=t.upcast(i),t=t.baseClass;for(;r.baseClass;)n=r.upcast(n),r=r.baseClass;return t===r&&i===n}function le(e){ne(e.$$.ptrType.registeredClass.name+" instance already deleted")}var ue=!1;function pe(e){}function he(e){e.count.value-=1,0===e.count.value&&function(e){e.smartPtr?e.smartPtrType.rawDestructor(e.smartPtr):e.ptrType.registeredClass.rawDestructor(e.ptr)}(e)}function _e(e){return"undefined"==typeof FinalizationGroup?(_e=function(e){return e},e):(ue=new FinalizationGroup((function(e){for(var t=e.next();!t.done;t=e.next()){var i=t.value;i.ptr?he(i):console.warn("object already deleted: "+i.ptr)}})),_e=function(e){return ue.register(e,e.$$,e.$$),e},pe=function(e){ue.unregister(e.$$)},_e(e))}function fe(){if(this.$$.ptr||le(this),this.$$.preservePointerOnDelete)return this.$$.count.value+=1,this;var e,t=_e(Object.create(Object.getPrototypeOf(this),{$$:{value:(e=this.$$,{count:e.count,deleteScheduled:e.deleteScheduled,preservePointerOnDelete:e.preservePointerOnDelete,ptr:e.ptr,ptrType:e.ptrType,smartPtr:e.smartPtr,smartPtrType:e.smartPtrType})}}));return t.$$.count.value+=1,t.$$.deleteScheduled=!1,t}function me(){this.$$.ptr||le(this),this.$$.deleteScheduled&&!this.$$.preservePointerOnDelete&&ne("Object already scheduled for deletion"),pe(this),he(this.$$),this.$$.preservePointerOnDelete||(this.$$.smartPtr=void 0,this.$$.ptr=void 0)}function ge(){return!this.$$.ptr}var ve=void 0,Se=[];function Ee(){for(;Se.length;){var e=Se.pop();e.$$.deleteScheduled=!1,e.delete()}}function ye(){return this.$$.ptr||le(this),this.$$.deleteScheduled&&!this.$$.preservePointerOnDelete&&ne("Object already scheduled for deletion"),Se.push(this),1===Se.length&&ve&&ve(Ee),this.$$.deleteScheduled=!0,this}function Te(){}var Ce={};function Re(e,t,i){if(void 0===e[t].overloadTable){var r=e[t];e[t]=function(){return e[t].overloadTable.hasOwnProperty(arguments.length)||ne("Function '"+i+"' called with an invalid number of arguments ("+arguments.length+") - expects one of ("+e[t].overloadTable+")!"),e[t].overloadTable[arguments.length].apply(this,arguments)},e[t].overloadTable=[],e[t].overloadTable[r.argCount]=r}}function Ie(e,t,i){r.hasOwnProperty(e)?((void 0===i||void 0!==r[e].overloadTable&&void 0!==r[e].overloadTable[i])&&ne("Cannot register public name '"+e+"' twice"),Re(r,e,e),r.hasOwnProperty(i)&&ne("Cannot register multiple overloads of a function with the same number of arguments ("+i+")!"),r[e].overloadTable[i]=t):(r[e]=t,void 0!==i&&(r[e].numArguments=i))}function Ae(e,t,i,r,n,a,s,o){this.name=e,this.constructor=t,this.instancePrototype=i,this.rawDestructor=r,this.baseClass=n,this.getActualType=a,this.upcast=s,this.downcast=o,this.pureVirtualFunctions=[]}function Pe(e,t,i){for(;t!==i;)t.upcast||ne("Expected null or instance of "+i.name+", got an instance of "+t.name),e=t.upcast(e),t=t.baseClass;return e}function be(e,t){if(null===t)return this.isReference&&ne("null is not a valid "+this.name),0;t.$$||ne('Cannot pass "'+st(t)+'" as a '+this.name),t.$$.ptr||ne("Cannot pass deleted object as a pointer of type "+this.name);var i=t.$$.ptrType.registeredClass;return Pe(t.$$.ptr,i,this.registeredClass)}function Oe(e,t){var i;if(null===t)return this.isReference&&ne("null is not a valid "+this.name),this.isSmartPointer?(i=this.rawConstructor(),null!==e&&e.push(this.rawDestructor,i),i):0;t.$$||ne('Cannot pass "'+st(t)+'" as a '+this.name),t.$$.ptr||ne("Cannot pass deleted object as a pointer of type "+this.name),!this.isConst&&t.$$.ptrType.isConst&&ne("Cannot convert argument of type "+(t.$$.smartPtrType?t.$$.smartPtrType.name:t.$$.ptrType.name)+" to parameter type "+this.name);var r=t.$$.ptrType.registeredClass;if(i=Pe(t.$$.ptr,r,this.registeredClass),this.isSmartPointer)switch(void 0===t.$$.smartPtr&&ne("Passing raw pointer to smart pointer is illegal"),this.sharingPolicy){case 0:t.$$.smartPtrType===this?i=t.$$.smartPtr:ne("Cannot convert argument of type "+(t.$$.smartPtrType?t.$$.smartPtrType.name:t.$$.ptrType.name)+" to parameter type "+this.name);break;case 1:i=t.$$.smartPtr;break;case 2:if(t.$$.smartPtrType===this)i=t.$$.smartPtr;else{var n=t.clone();i=this.rawShare(i,rt((function(){n.delete()}))),null!==e&&e.push(this.rawDestructor,i)}break;default:ne("Unsupporting sharing policy")}return i}function De(e,t){if(null===t)return this.isReference&&ne("null is not a valid "+this.name),0;t.$$||ne('Cannot pass "'+st(t)+'" as a '+this.name),t.$$.ptr||ne("Cannot pass deleted object as a pointer of type "+this.name),t.$$.ptrType.isConst&&ne("Cannot convert argument of type "+t.$$.ptrType.name+" to parameter type "+this.name);var i=t.$$.ptrType.registeredClass;return Pe(t.$$.ptr,i,this.registeredClass)}function we(e){return this.fromWireType(R[e>>2])}function Ne(e){return this.rawGetPointee&&(e=this.rawGetPointee(e)),e}function ke(e){this.rawDestructor&&this.rawDestructor(e)}function Le(e){null!==e&&e.delete()}function Me(e,t,i){if(t===i)return e;if(void 0===i.baseClass)return null;var r=Me(e,t,i.baseClass);return null===r?null:i.downcast(r)}function Ue(){return Object.keys(Ve).length}function xe(){var e=[];for(var t in Ve)Ve.hasOwnProperty(t)&&e.push(Ve[t]);return e}function Be(e){ve=e,Se.length&&ve&&ve(Ee)}var Ve={};function Fe(e,t){return t=function(e,t){for(void 0===t&&ne("ptr should not be undefined");e.baseClass;)t=e.upcast(t),e=e.baseClass;return t}(e,t),Ve[t]}function Ge(e,t){return t.ptrType&&t.ptr||se("makeClassHandle requires ptr and ptrType"),!!t.smartPtrType!==!!t.smartPtr&&se("Both smartPtrType and smartPtr must be specified"),t.count={value:1},_e(Object.create(e,{$$:{value:t}}))}function He(e){var t=this.getPointee(e);if(!t)return this.destructor(e),null;var i=Fe(this.registeredClass,t);if(void 0!==i){if(0===i.$$.count.value)return i.$$.ptr=t,i.$$.smartPtr=e,i.clone();var r=i.clone();return this.destructor(e),r}function n(){return this.isSmartPointer?Ge(this.registeredClass.instancePrototype,{ptrType:this.pointeeType,ptr:t,smartPtrType:this,smartPtr:e}):Ge(this.registeredClass.instancePrototype,{ptrType:this,ptr:e})}var a,s=this.registeredClass.getActualType(t),o=Ce[s];if(!o)return n.call(this);a=this.isConst?o.constPointerType:o.pointerType;var c=Me(t,this.registeredClass,a.registeredClass);return null===c?n.call(this):this.isSmartPointer?Ge(a.registeredClass.instancePrototype,{ptrType:a,ptr:c,smartPtrType:this,smartPtr:e}):Ge(a.registeredClass.instancePrototype,{ptrType:a,ptr:c})}function je(e,t,i,r,n,a,s,o,c,d,l){this.name=e,this.registeredClass=t,this.isReference=i,this.isConst=r,this.isSmartPointer=n,this.pointeeType=a,this.sharingPolicy=s,this.rawGetPointee=o,this.rawConstructor=c,this.rawShare=d,this.rawDestructor=l,n||void 0!==t.baseClass?this.toWireType=Oe:r?(this.toWireType=be,this.destructorFunction=null):(this.toWireType=De,this.destructorFunction=null)}function We(e,t,i){return e.includes("j")?function(e,t,i){var n=r["dynCall_"+e];return i&&i.length?n.apply(null,[t].concat(i)):n.call(null,t)}(e,t,i):M.get(t).apply(null,i)}function $e(e,t){var i,r,n,a=(e=J(e)).includes("j")?(i=e,r=t,n=[],function(){n.length=arguments.length;for(var e=0;e<arguments.length;e++)n[e]=arguments[e];return We(i,r,n)}):M.get(t);return"function"!=typeof a&&ne("unknown function pointer with signature "+e+": "+t),a}var Ke=void 0;function qe(e){var t=ft(e),i=J(t);return ht(t),i}function ze(e,t){var i=[],r={};throw t.forEach((function e(t){r[t]||Q[t]||(Z[t]?Z[t].forEach(e):(i.push(t),r[t]=!0))})),new Ke(e+": "+i.map(qe).join([", "]))}function Ye(e,t){for(var i=[],r=0;r<e;r++)i.push(C[(t>>2)+r]);return i}function Je(e){for(;e.length;){var t=e.pop();e.pop()(t)}}function Xe(e,t,i,r,n){var a=t.length;a<2&&ne("argTypes array size mismatch! Must at least get return value and 'this' types!");for(var s=null!==t[1]&&null!==i,o=!1,c=1;c<t.length;++c)if(null!==t[c]&&void 0===t[c].destructorFunction){o=!0;break}var d="void"!==t[0].name,l=a-2,u=new Array(l),p=[],h=[];return function(){var i;arguments.length!==l&&ne("function "+e+" called with "+arguments.length+" arguments, expected "+l+" args!"),h.length=0,p.length=s?2:1,p[0]=n,s&&(i=t[1].toWireType(h,this),p[1]=i);for(var a=0;a<l;++a)u[a]=t[a+2].toWireType(h,arguments[a]),p.push(u[a]);var c=r.apply(null,p);function _(e){if(o)Je(h);else for(var r=s?1:2;r<t.length;r++){var n=1===r?i:u[r-2];null!==t[r].destructorFunction&&t[r].destructorFunction(n)}if(d)return t[0].fromWireType(e)}return _(c)}}var Qe=[],Ze=[{},{value:void 0},{value:null},{value:!0},{value:!1}];function et(e){e>4&&0==--Ze[e].refcount&&(Ze[e]=void 0,Qe.push(e))}function tt(){for(var e=0,t=5;t<Ze.length;++t)void 0!==Ze[t]&&++e;return e}function it(){for(var e=5;e<Ze.length;++e)if(void 0!==Ze[e])return Ze[e];return null}function rt(e){switch(e){case void 0:return 1;case null:return 2;case!0:return 3;case!1:return 4;default:var t=Qe.length?Qe.pop():Ze.length;return Ze[t]={refcount:1,value:e},t}}function nt(e,t,i){switch(t){case 0:return function(e){var t=i?S:E;return this.fromWireType(t[e])};case 1:return function(e){var t=i?y:T;return this.fromWireType(t[e>>1])};case 2:return function(e){var t=i?C:R;return this.fromWireType(t[e>>2])};default:throw new TypeError("Unknown integer type: "+e)}}function at(e,t){var i=Q[e];return void 0===i&&ne(t+" has unknown type "+qe(e)),i}function st(e){if(null===e)return"null";var t=typeof e;return"object"===t||"array"===t||"function"===t?e.toString():""+e}function ot(e,t){switch(t){case 2:return function(e){return this.fromWireType(I[e>>2])};case 3:return function(e){return this.fromWireType(A[e>>3])};default:throw new TypeError("Unknown float type: "+e)}}function ct(e,t,i){switch(t){case 0:return i?function(e){return S[e]}:function(e){return E[e]};case 1:return i?function(e){return y[e>>1]}:function(e){return T[e>>1]};case 2:return i?function(e){return C[e>>2]}:function(e){return R[e>>2]};default:throw new TypeError("Unknown integer type: "+e)}}function dt(e){try{return h.grow(e-v.byteLength+65535>>>16),L(h.buffer),1}catch(e){}}var lt={mappings:{},buffers:[null,[],[]],printChar:function(e,t){var i=lt.buffers[e];0===t||10===t?((1===e?d:l)(m(i,0)),i.length=0):i.push(t)},varargs:void 0,get:function(){return lt.varargs+=4,C[lt.varargs-4>>2]},getStr:function(e){return g(e)},get64:function(e,t){return e}};!function(){for(var e=new Array(256),t=0;t<256;++t)e[t]=String.fromCharCode(t);Y=e}(),re=r.BindingError=ie(Error,"BindingError"),ae=r.InternalError=ie(Error,"InternalError"),Te.prototype.isAliasOf=de,Te.prototype.clone=fe,Te.prototype.delete=me,Te.prototype.isDeleted=ge,Te.prototype.deleteLater=ye,je.prototype.getPointee=Ne,je.prototype.destructor=ke,je.prototype.argPackAdvance=8,je.prototype.readValueFromPointer=we,je.prototype.deleteObject=Le,je.prototype.fromWireType=He,r.getInheritedInstanceCount=Ue,r.getLiveInheritedInstances=xe,r.flushPendingDeletes=Ee,r.setDelayFunction=Be,Ke=r.UnboundTypeError=ie(Error,"UnboundTypeError"),r.count_emval_handles=tt,r.get_first_emval=it;var ut,pt={y:function(e,t,i,r,n){},H:function(e,t,i,r,n){var a=z(i);ce(e,{name:t=J(t),fromWireType:function(e){return!!e},toWireType:function(e,t){return t?r:n},argPackAdvance:8,readValueFromPointer:function(e){var r;if(1===i)r=S;else if(2===i)r=y;else{if(4!==i)throw new TypeError("Unknown boolean type size: "+t);r=C}return this.fromWireType(r[e>>a])},destructorFunction:null})},t:function(e,t,i,n,a,s,o,c,d,l,u,p,h){u=J(u),s=$e(a,s),c&&(c=$e(o,c)),l&&(l=$e(d,l)),h=$e(p,h);var _=ee(u);Ie(_,(function(){ze("Cannot construct "+u+" due to unbound types",[n])})),oe([e,t,i],n?[n]:[],(function(t){var i,a;t=t[0],a=n?(i=t.registeredClass).instancePrototype:Te.prototype;var o=te(_,(function(){if(Object.getPrototypeOf(this)!==d)throw new re("Use 'new' to construct "+u);if(void 0===p.constructor_body)throw new re(u+" has no accessible constructor");var e=p.constructor_body[arguments.length];if(void 0===e)throw new re("Tried to invoke ctor of "+u+" with invalid number of parameters ("+arguments.length+") - expected ("+Object.keys(p.constructor_body).toString()+") parameters instead!");return e.apply(this,arguments)})),d=Object.create(a,{constructor:{value:o}});o.prototype=d;var p=new Ae(u,o,d,h,i,s,c,l),f=new je(u,p,!0,!1,!1),m=new je(u+"*",p,!1,!1,!1),g=new je(u+" const*",p,!1,!0,!1);return Ce[e]={pointerType:m,constPointerType:g},function(e,t,i){r.hasOwnProperty(e)||se("Replacing nonexistant public symbol"),void 0!==r[e].overloadTable&&void 0!==i?r[e].overloadTable[i]=t:(r[e]=t,r[e].argCount=i)}(_,o),[f,m,g]}))},p:function(e,t,i,r,n,a){var s;t>0||H("Assertion failed: "+s);var o=Ye(t,i);n=$e(r,n),oe([],[e],(function(e){var i="constructor "+(e=e[0]).name;if(void 0===e.registeredClass.constructor_body&&(e.registeredClass.constructor_body=[]),void 0!==e.registeredClass.constructor_body[t-1])throw new re("Cannot register multiple constructors with identical number of parameters ("+(t-1)+") for class '"+e.name+"'! Overload resolution is currently only performed using the parameter count, not actual type info!");return e.registeredClass.constructor_body[t-1]=function(){ze("Cannot construct "+e.name+" due to unbound types",o)},oe([],o,(function(r){return r.splice(1,0,null),e.registeredClass.constructor_body[t-1]=Xe(i,r,null,n,a),[]})),[]}))},e:function(e,t,i,r,n,a,s,o){var c=Ye(i,r);t=J(t),a=$e(n,a),oe([],[e],(function(e){var r=(e=e[0]).name+"."+t;function n(){ze("Cannot call "+r+" due to unbound types",c)}t.startsWith("@@")&&(t=Symbol[t.substring(2)]),o&&e.registeredClass.pureVirtualFunctions.push(t);var d=e.registeredClass.instancePrototype,l=d[t];return void 0===l||void 0===l.overloadTable&&l.className!==e.name&&l.argCount===i-2?(n.argCount=i-2,n.className=e.name,d[t]=n):(Re(d,t,r),d[t].overloadTable[i-2]=n),oe([],c,(function(n){var o=Xe(r,n,e,a,s);return void 0===d[t].overloadTable?(o.argCount=i-2,d[t]=o):d[t].overloadTable[i-2]=o,[]})),[]}))},G:function(e,t){ce(e,{name:t=J(t),fromWireType:function(e){var t=Ze[e].value;return et(e),t},toWireType:function(e,t){return rt(t)},argPackAdvance:8,readValueFromPointer:we,destructorFunction:null})},L:function(e,t,i,r){var n=z(i);function a(){}t=J(t),a.values={},ce(e,{name:t,constructor:a,fromWireType:function(e){return this.constructor.values[e]},toWireType:function(e,t){return t.value},argPackAdvance:8,readValueFromPointer:nt(t,n,r),destructorFunction:null}),Ie(t,a)},x:function(e,t,i){var r=at(e,"enum");t=J(t);var n=r.constructor,a=Object.create(r.constructor.prototype,{value:{value:i},constructor:{value:te(r.name+"_"+t,(function(){}))}});n.values[i]=a,n[t]=a},r:function(e,t,i){var r=z(i);ce(e,{name:t=J(t),fromWireType:function(e){return e},toWireType:function(e,t){if("number"!=typeof t&&"boolean"!=typeof t)throw new TypeError('Cannot convert "'+st(t)+'" to '+this.name);return t},argPackAdvance:8,readValueFromPointer:ot(t,r),destructorFunction:null})},h:function(e,t,i,r,n){t=J(t),-1===n&&(n=4294967295);var a=z(i),s=function(e){return e};if(0===r){var o=32-8*i;s=function(e){return e<<o>>>o}}var c=t.includes("unsigned");ce(e,{name:t,fromWireType:s,toWireType:function(e,i){if("number"!=typeof i&&"boolean"!=typeof i)throw new TypeError('Cannot convert "'+st(i)+'" to '+this.name);if(i<r||i>n)throw new TypeError('Passing a number "'+st(i)+'" from JS side to C/C++ side to an argument of type "'+t+'", which is outside the valid range ['+r+", "+n+"]!");return c?i>>>0:0|i},argPackAdvance:8,readValueFromPointer:ct(t,a,0!==r),destructorFunction:null})},g:function(e,t,i){var r=[Int8Array,Uint8Array,Int16Array,Uint16Array,Int32Array,Uint32Array,Float32Array,Float64Array][t];function n(e){var t=R,i=t[e>>=2],n=t[e+1];return new r(v,n,i)}ce(e,{name:i=J(i),fromWireType:n,argPackAdvance:8,readValueFromPointer:n},{ignoreDuplicateRegistrations:!0})},s:function(e,t){var i="std::string"===(t=J(t));ce(e,{name:t,fromWireType:function(e){var t,r=R[e>>2];if(i)for(var n=e+4,a=0;a<=r;++a){var s=e+4+a;if(a==r||0==E[s]){var o=g(n,s-n);void 0===t?t=o:(t+=String.fromCharCode(0),t+=o),n=s+1}}else{var c=new Array(r);for(a=0;a<r;++a)c[a]=String.fromCharCode(E[e+4+a]);t=c.join("")}return ht(e),t},toWireType:function(e,t){var r;t instanceof ArrayBuffer&&(t=new Uint8Array(t));var n="string"==typeof t;n||t instanceof Uint8Array||t instanceof Uint8ClampedArray||t instanceof Int8Array||ne("Cannot pass non-string to std::string"),r=i&&n?function(){return function(e){for(var t=0,i=0;i<e.length;++i){var r=e.charCodeAt(i);r>=55296&&r<=57343&&(r=65536+((1023&r)<<10)|1023&e.charCodeAt(++i)),r<=127?++t:t+=r<=2047?2:r<=65535?3:4}return t}(t)}:function(){return t.length};var a=r(),s=_t(4+a+1);if(R[s>>2]=a,i&&n)(function(e,t,i,r){if(!(r>0))return 0;for(var n=i,a=i+r-1,s=0;s<e.length;++s){var o=e.charCodeAt(s);if(o>=55296&&o<=57343&&(o=65536+((1023&o)<<10)|1023&e.charCodeAt(++s)),o<=127){if(i>=a)break;t[i++]=o}else if(o<=2047){if(i+1>=a)break;t[i++]=192|o>>6,t[i++]=128|63&o}else if(o<=65535){if(i+2>=a)break;t[i++]=224|o>>12,t[i++]=128|o>>6&63,t[i++]=128|63&o}else{if(i+3>=a)break;t[i++]=240|o>>18,t[i++]=128|o>>12&63,t[i++]=128|o>>6&63,t[i++]=128|63&o}}t[i]=0})(t,E,s+4,a+1);else if(n)for(var o=0;o<a;++o){var c=t.charCodeAt(o);c>255&&(ht(s),ne("String has UTF-16 code units that do not fit in 8 bits")),E[s+4+o]=c}else for(o=0;o<a;++o)E[s+4+o]=t[o];return null!==e&&e.push(ht,s),s},argPackAdvance:8,readValueFromPointer:we,destructorFunction:function(e){ht(e)}})},m:function(e,t,i){var r,n,a,s,o;i=J(i),2===t?(r=b,n=O,s=D,a=function(){return T},o=1):4===t&&(r=w,n=N,s=k,a=function(){return R},o=2),ce(e,{name:i,fromWireType:function(e){for(var i,n=R[e>>2],s=a(),c=e+4,d=0;d<=n;++d){var l=e+4+d*t;if(d==n||0==s[l>>o]){var u=r(c,l-c);void 0===i?i=u:(i+=String.fromCharCode(0),i+=u),c=l+t}}return ht(e),i},toWireType:function(e,r){"string"!=typeof r&&ne("Cannot pass non-string to C++ string type "+i);var a=s(r),c=_t(4+a+t);return R[c>>2]=a>>o,n(r,c+4,a+t),null!==e&&e.push(ht,c),c},argPackAdvance:8,readValueFromPointer:we,destructorFunction:function(e){ht(e)}})},I:function(e,t){ce(e,{isVoid:!0,name:t=J(t),argPackAdvance:0,fromWireType:function(){},toWireType:function(e,t){}})},F:function(){throw"longjmp"},k:et,l:function(e){e>4&&(Ze[e].refcount+=1)},j:function(e,t){return rt((e=at(e,"_emval_take_value")).readValueFromPointer(t))},E:function(){H()},C:function(e,t,i){E.copyWithin(e,t,t+i)},D:function(e){var t,i,r=E.length,n=2147483648;if((e>>>=0)>n)return!1;for(var a=1;a<=4;a*=2){var s=r*(1+.2/a);if(s=Math.min(s,e+100663296),dt(Math.min(n,((t=Math.max(e,s))%(i=65536)>0&&(t+=i-t%i),t))))return!0}return!1},q:function(e,t,i,r){for(var n=0,a=0;a<i;a++){for(var s=C[t+8*a>>2],o=C[t+(8*a+4)>>2],c=0;c<o;c++)lt.printChar(e,E[s+c]);n+=o}return C[r>>2]=n,0},a:function(){return p},f:function(e){var t=Date.now();return C[e>>2]=t/1e3|0,C[e+4>>2]=t%1e3*1e3|0,0},d:function(e,t,i){var r=mt();try{return M.get(e)(t,i)}catch(e){if(gt(r),e!==e+0&&"longjmp"!==e)throw e;vt(1,0)}},n:function(e,t,i,r){var n=mt();try{return M.get(e)(t,i,r)}catch(e){if(gt(n),e!==e+0&&"longjmp"!==e)throw e;vt(1,0)}},o:function(e,t,i,r,n){var a=mt();try{return M.get(e)(t,i,r,n)}catch(e){if(gt(a),e!==e+0&&"longjmp"!==e)throw e;vt(1,0)}},u:function(e,t,i,r,n,a){var s=mt();try{return M.get(e)(t,i,r,n,a)}catch(e){if(gt(s),e!==e+0&&"longjmp"!==e)throw e;vt(1,0)}},K:function(e,t,i,r,n,a,s,o,c){var d=mt();try{return M.get(e)(t,i,r,n,a,s,o,c)}catch(e){if(gt(d),e!==e+0&&"longjmp"!==e)throw e;vt(1,0)}},B:function(e,t,i,r,n,a,s,o){var c=mt();try{return St(e,t,i,r,n,a,s,o)}catch(e){if(gt(c),e!==e+0&&"longjmp"!==e)throw e;vt(1,0)}},z:function(e,t,i,r){var n=mt();try{return yt(e,t,i,r)}catch(e){if(gt(n),e!==e+0&&"longjmp"!==e)throw e;vt(1,0)}},i:function(e,t){var i=mt();try{M.get(e)(t)}catch(e){if(gt(i),e!==e+0&&"longjmp"!==e)throw e;vt(1,0)}},w:function(e,t,i){var r=mt();try{M.get(e)(t,i)}catch(e){if(gt(r),e!==e+0&&"longjmp"!==e)throw e;vt(1,0)}},c:function(e,t,i,r,n){var a=mt();try{M.get(e)(t,i,r,n)}catch(e){if(gt(a),e!==e+0&&"longjmp"!==e)throw e;vt(1,0)}},J:function(e,t,i,r,n,a,s){var o=mt();try{M.get(e)(t,i,r,n,a,s)}catch(e){if(gt(o),e!==e+0&&"longjmp"!==e)throw e;vt(1,0)}},v:function(e,t,i,r,n,a,s,o,c){var d=mt();try{M.get(e)(t,i,r,n,a,s,o,c)}catch(e){if(gt(d),e!==e+0&&"longjmp"!==e)throw e;vt(1,0)}},A:function(e,t,i,r,n,a,s,o,c,d){var l=mt();try{Et(e,t,i,r,n,a,s,o,c,d)}catch(e){if(gt(l),e!==e+0&&"longjmp"!==e)throw e;vt(1,0)}},b:function(e){p=e}},ht=(function(){var e={a:pt};function t(e,t){var i,n=e.exports;r.asm=n,L((h=r.asm.M).buffer),M=r.asm.Q,i=r.asm.N,x.unshift(i),function(e){if(V--,r.monitorRunDependencies&&r.monitorRunDependencies(V),0==V&&(null!==F&&(clearInterval(F),F=null),G)){var t=G;G=null,t()}}()}function n(e){t(e.instance)}function a(t){return(u||"function"!=typeof fetch?Promise.resolve().then((function(){return K(j)})):fetch(j,{credentials:"same-origin"}).then((function(e){if(!e.ok)throw"failed to load wasm binary file at '"+j+"'";return e.arrayBuffer()})).catch((function(){return K(j)}))).then((function(t){return WebAssembly.instantiate(t,e)})).then(t,(function(e){l("failed to asynchronously prepare wasm: "+e),H(e)}))}if(V++,r.monitorRunDependencies&&r.monitorRunDependencies(V),r.instantiateWasm)try{return r.instantiateWasm(e,t)}catch(e){return l("Module.instantiateWasm callback failed with error: "+e),!1}(u||"function"!=typeof WebAssembly.instantiateStreaming||$(j)||"function"!=typeof fetch?a(n):fetch(j,{credentials:"same-origin"}).then((function(t){return WebAssembly.instantiateStreaming(t,e).then(n,(function(e){return l("wasm streaming compile failed: "+e),l("falling back to ArrayBuffer instantiation"),a(n)}))}))).catch(i)}(),r.___wasm_call_ctors=function(){return(r.___wasm_call_ctors=r.asm.N).apply(null,arguments)},r._free=function(){return(ht=r._free=r.asm.O).apply(null,arguments)}),_t=r._malloc=function(){return(_t=r._malloc=r.asm.P).apply(null,arguments)},ft=r.___getTypeName=function(){return(ft=r.___getTypeName=r.asm.R).apply(null,arguments)},mt=(r.___embind_register_native_and_builtin_types=function(){return(r.___embind_register_native_and_builtin_types=r.asm.S).apply(null,arguments)},r.stackSave=function(){return(mt=r.stackSave=r.asm.T).apply(null,arguments)}),gt=r.stackRestore=function(){return(gt=r.stackRestore=r.asm.U).apply(null,arguments)},vt=r._setThrew=function(){return(vt=r._setThrew=r.asm.V).apply(null,arguments)},St=r.dynCall_iiiijj=function(){return(St=r.dynCall_iiiijj=r.asm.W).apply(null,arguments)},Et=(r.dynCall_iiijiii=function(){return(r.dynCall_iiijiii=r.asm.X).apply(null,arguments)},r.dynCall_vijjjid=function(){return(Et=r.dynCall_vijjjid=r.asm.Y).apply(null,arguments)}),yt=r.dynCall_iij=function(){return(yt=r.dynCall_iij=r.asm.Z).apply(null,arguments)};r.dynCall_jiji=function(){return(r.dynCall_jiji=r.asm._).apply(null,arguments)};function Tt(e){function i(){ut||(ut=!0,r.calledRun=!0,_||(!0,q(x),t(r),r.onRuntimeInitialized&&r.onRuntimeInitialized(),function(){if(r.postRun)for("function"==typeof r.postRun&&(r.postRun=[r.postRun]);r.postRun.length;)e=r.postRun.shift(),B.unshift(e);var e;q(B)}()))}e=e||o,V>0||(!function(){if(r.preRun)for("function"==typeof r.preRun&&(r.preRun=[r.preRun]);r.preRun.length;)e=r.preRun.shift(),U.unshift(e);var e;q(U)}(),V>0||(r.setStatus?(r.setStatus("Running..."),setTimeout((function(){setTimeout((function(){r.setStatus("")}),1),i()}),1)):i()))}if(G=function e(){ut||Tt(),ut||(G=e)},r.run=Tt,r.preInit)for("function"==typeof r.preInit&&(r.preInit=[r.preInit]);r.preInit.length>0;)r.preInit.pop()();return Tt(),e.ready}}();e.exports=t,t.getUrl=function(e){return"https://st.mycdn.me/static/libvpx/2-0-9/"+e}},89588:(e,t,i)=>{"use strict";t.isIPadOS=t.isIPad=void 0;var r=i(79405);function n(e){e||(e=r.canUseDOM?navigator.userAgent.toLowerCase():"");var t=f(e),i=t||-1!==e.indexOf("ipad"),n=!i&&-1!==e.search(/iphone|ipod/),a=n||i,s=a&&e.match(/OS ([\d_]+) like Mac OS X/i),o=0,c=0;t?(o=13,c=0):s&&(o=+(s=s[1].split("_"))[0],c=+s[1]),s=null;var d=o<13&&!(11===o&&c<3),l=a&&function(e){if(!r.canUseDOM)return!1;var t=window.webkit;if(t&&t.messageHandlers)return!0;var i=/constructor/i.test(String(window.HTMLElement)),n=!!window.indexedDB;if(-1===e.indexOf("safari")||-1===e.indexOf("version")||navigator.standalone){if(!n&&i||!window.statusbar||!window.statusbar.visible);else if(!i||n)return!0}else;return!1}(e),u=!1;return r.canUseDOM&&(u=a&&375===screen.width&&812===screen.height&&3===window.devicePixelRatio),{isIPad:i,isIPhone:n,isIOS:a,isIPadOS:t,iosMajor:o,iosMinor:c,isWKWebView:l,isScrollBasedViewport:d,isIPhoneX:u,isIOSChrome:-1!==e.search(/crios/i)}}var a=n(),s=a.isIPad,o=a.isIPhone,c=a.isIOS,d=a.isIPadOS,l=a.iosMajor,u=a.iosMinor,p=a.isWKWebView,h=a.isScrollBasedViewport,_=a.isIPhoneX;function f(e){if(!r.canUseDOM)return!1;var t=!/ipad|iphone|ipod/.test(e);return!(!/mac os/.test(e)||!t||"boolean"!=typeof navigator.standalone)}a.isIOSChrome,t.isIPadOS=d,t.isIPad=s},79405:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.canUseEventListeners=t.canUseDOM=void 0,t.onDOMLoaded=function(e){"loading"!==document.readyState?e():document.addEventListener("DOMContentLoaded",e)};var i=!("undefined"==typeof window||!window.document||!window.document.createElement);t.canUseDOM=i;var r=i&&!!window.addEventListener;t.canUseEventListeners=r},38797:function(e,t,i){var r;!function(n){var a=function(e,t,i){if(!(e instanceof ArrayBuffer||"undefined"!=typeof Buffer&&e instanceof Buffer))throw new Error("Must specify a valid ArrayBuffer or Buffer.");t=t||0,i=i||e.byteLength||e.length,this._view=new Uint8Array(e.buffer||e,t,i),this.bigEndian=!1};a._scratch=new DataView(new ArrayBuffer(8)),Object.defineProperty(a.prototype,"buffer",{get:function(){return"undefined"!=typeof Buffer?Buffer.from(this._view.buffer):this._view.buffer},enumerable:!0,configurable:!1}),Object.defineProperty(a.prototype,"byteLength",{get:function(){return this._view.length},enumerable:!0,configurable:!1}),a.prototype._setBit=function(e,t){t?this._view[e>>3]|=1<<(7&e):this._view[e>>3]&=~(1<<(7&e))},a.prototype.getBits=function(e,t,i){var r=8*this._view.length-e;if(t>r)throw new Error("Cannot get "+t+" bit(s) from offset "+e+", "+r+" available");for(var n=0,a=0;a<t;){var s=t-a,o=7&e,c=this._view[e>>3],d=Math.min(s,8-o);this.bigEndian?(n<<=d,n|=c>>8-d-o&~(255<<d)):n|=(c>>o&~(255<<d))<<a,e+=d,a+=d}return i?(32!==t&&n&1<<t-1&&(n|=-1^(1<<t)-1),n):n>>>0},a.prototype.setBits=function(e,t,i){var r=8*this._view.length-e;if(i>r)throw new Error("Cannot set "+i+" bit(s) from offset "+e+", "+r+" available");for(var n=0;n<i;){var a,s,o,c=i-n,d=7&e,l=e>>3,u=Math.min(c,8-d);if(this.bigEndian){s=t>>i-n-u&(a=~(-1<<u));var p=8-d-u;o=~(a<<p),this._view[l]=this._view[l]&o|s<<p}else s=t&(a=~(255<<u)),t>>=u,o=~(a<<d),this._view[l]=this._view[l]&o|s<<d;e+=u,n+=u}},a.prototype.getBoolean=function(e){return 0!==this.getBits(e,1,!1)},a.prototype.getInt8=function(e){return this.getBits(e,8,!0)},a.prototype.getUint8=function(e){return this.getBits(e,8,!1)},a.prototype.getInt16=function(e){return this.getBits(e,16,!0)},a.prototype.getUint16=function(e){return this.getBits(e,16,!1)},a.prototype.getInt32=function(e){return this.getBits(e,32,!0)},a.prototype.getUint32=function(e){return this.getBits(e,32,!1)},a.prototype.getFloat32=function(e){return a._scratch.setUint32(0,this.getUint32(e)),a._scratch.getFloat32(0)},a.prototype.getFloat64=function(e){return a._scratch.setUint32(0,this.getUint32(e)),a._scratch.setUint32(4,this.getUint32(e+32)),a._scratch.getFloat64(0)},a.prototype.setBoolean=function(e,t){this.setBits(e,t?1:0,1)},a.prototype.setInt8=a.prototype.setUint8=function(e,t){this.setBits(e,t,8)},a.prototype.setInt16=a.prototype.setUint16=function(e,t){this.setBits(e,t,16)},a.prototype.setInt32=a.prototype.setUint32=function(e,t){this.setBits(e,t,32)},a.prototype.setFloat32=function(e,t){a._scratch.setFloat32(0,t),this.setBits(e,a._scratch.getUint32(0),32)},a.prototype.setFloat64=function(e,t){a._scratch.setFloat64(0,t),this.setBits(e,a._scratch.getUint32(0),32),this.setBits(e+32,a._scratch.getUint32(4),32)},a.prototype.getArrayBuffer=function(e,t){for(var i=new Uint8Array(t),r=0;r<t;r++)i[r]=this.getUint8(e+8*r);return i};var s=function(e,t){return function(){if(this._index+t>this._length)throw new Error("Trying to read past the end of the stream");var i=this._view[e](this._index);return this._index+=t,i}},o=function(e,t){return function(i){this._view[e](this._index,i),this._index+=t}};function c(e,t,i){if(0===t)return"";var r=0,n=[],a=!0,s=!!t;for(t||(t=Math.floor((e._length-e._index)/8));r<t;){var o=e.readUint8();if(0===o&&(a=!1,!s))break;a&&n.push(o),r++}var c=String.fromCharCode.apply(null,n);if(!i)return c;try{return decodeURIComponent(escape(c))}catch(e){return c}}var d=function(e,t,i){var r=e instanceof ArrayBuffer||"undefined"!=typeof Buffer&&e instanceof Buffer;if(!(e instanceof a||r))throw new Error("Must specify a valid BitView, ArrayBuffer or Buffer");this._view=r?new a(e,t,i):e,this._index=0,this._startIndex=0,this._length=8*this._view.byteLength};Object.defineProperty(d.prototype,"index",{get:function(){return this._index-this._startIndex},set:function(e){this._index=e+this._startIndex},enumerable:!0,configurable:!0}),Object.defineProperty(d.prototype,"length",{get:function(){return this._length-this._startIndex},set:function(e){this._length=e+this._startIndex},enumerable:!0,configurable:!0}),Object.defineProperty(d.prototype,"bitsLeft",{get:function(){return this._length-this._index},enumerable:!0,configurable:!0}),Object.defineProperty(d.prototype,"byteIndex",{get:function(){return Math.ceil(this._index/8)},set:function(e){this._index=8*e},enumerable:!0,configurable:!0}),Object.defineProperty(d.prototype,"buffer",{get:function(){return this._view.buffer},enumerable:!0,configurable:!1}),Object.defineProperty(d.prototype,"view",{get:function(){return this._view},enumerable:!0,configurable:!1}),Object.defineProperty(d.prototype,"bigEndian",{get:function(){return this._view.bigEndian},set:function(e){this._view.bigEndian=e},enumerable:!0,configurable:!1}),d.prototype.readBits=function(e,t){var i=this._view.getBits(this._index,e,t);return this._index+=e,i},d.prototype.writeBits=function(e,t){this._view.setBits(this._index,e,t),this._index+=t},d.prototype.readBoolean=s("getBoolean",1),d.prototype.readInt8=s("getInt8",8),d.prototype.readUint8=s("getUint8",8),d.prototype.readInt16=s("getInt16",16),d.prototype.readUint16=s("getUint16",16),d.prototype.readInt32=s("getInt32",32),d.prototype.readUint32=s("getUint32",32),d.prototype.readFloat32=s("getFloat32",32),d.prototype.readFloat64=s("getFloat64",64),d.prototype.writeBoolean=o("setBoolean",1),d.prototype.writeInt8=o("setInt8",8),d.prototype.writeUint8=o("setUint8",8),d.prototype.writeInt16=o("setInt16",16),d.prototype.writeUint16=o("setUint16",16),d.prototype.writeInt32=o("setInt32",32),d.prototype.writeUint32=o("setUint32",32),d.prototype.writeFloat32=o("setFloat32",32),d.prototype.writeFloat64=o("setFloat64",64),d.prototype.readASCIIString=function(e){return function(e,t){return c(e,t,!1)}(this,e)},d.prototype.readUTF8String=function(e){return function(e,t){return c(e,t,!0)}(this,e)},d.prototype.writeASCIIString=function(e,t){!function(e,t,i){for(var r=i||t.length+1,n=0;n<r;n++)e.writeUint8(n<t.length?t.charCodeAt(n):0)}(this,e,t)},d.prototype.writeUTF8String=function(e,t){!function(e,t,i){for(var r=function(e){var t,i,r=[];for(t=0;t<e.length;t++)(i=e.charCodeAt(t))<=127?r.push(i):i<=2047?(r.push(i>>6|192),r.push(63&i|128)):i<=65535?(r.push(i>>12|224),r.push(i>>6&63|128),r.push(63&i|128)):(r.push(i>>18|240),r.push(i>>12&63|128),r.push(i>>6&63|128),r.push(63&i|128));return r}(t),n=i||r.length+1,a=0;a<n;a++)e.writeUint8(a<r.length?r[a]:0)}(this,e,t)},d.prototype.readBitStream=function(e){var t=new d(this._view);return t._startIndex=this._index,t._index=this._index,t.length=e,this._index+=e,t},d.prototype.writeBitStream=function(e,t){var i;for(t||(t=e.bitsLeft);t>0;)i=Math.min(t,32),this.writeBits(e.readBits(i),i),t-=i},d.prototype.readArrayBuffer=function(e){var t=this._view.getArrayBuffer(this._index,e);return this._index+=8*e,t},d.prototype.writeArrayBuffer=function(e,t){this.writeBitStream(new d(e),8*t)},void 0===(r=function(){return{BitView:a,BitStream:d}}.call(t,i,t,e))||(e.exports=r)}()},20773:(e,t,i)=>{var r="__lodash_hash_undefined__",n="[object Function]",a="[object GeneratorFunction]",s=/^\[object .+?Constructor\]$/,o="object"==typeof i.g&&i.g&&i.g.Object===Object&&i.g,c="object"==typeof self&&self&&self.Object===Object&&self,d=o||c||Function("return this")();var l,u=Array.prototype,p=Function.prototype,h=Object.prototype,_=d["__core-js_shared__"],f=(l=/[^.]+$/.exec(_&&_.keys&&_.keys.IE_PROTO||""))?"Symbol(src)_1."+l:"",m=p.toString,g=h.hasOwnProperty,v=h.toString,S=RegExp("^"+m.call(g).replace(/[\\^$.*+?()[\]{}|]/g,"\\$&").replace(/hasOwnProperty|(function).*?(?=\\\()| for .+?(?=\\\])/g,"$1.*?")+"$"),E=u.splice,y=O(d,"Map"),T=O(Object,"create");function C(e){var t=-1,i=e?e.length:0;for(this.clear();++t<i;){var r=e[t];this.set(r[0],r[1])}}function R(e){var t=-1,i=e?e.length:0;for(this.clear();++t<i;){var r=e[t];this.set(r[0],r[1])}}function I(e){var t=-1,i=e?e.length:0;for(this.clear();++t<i;){var r=e[t];this.set(r[0],r[1])}}function A(e,t){for(var i,r,n=e.length;n--;)if((i=e[n][0])===(r=t)||i!=i&&r!=r)return n;return-1}function P(e){if(!w(e)||(t=e,f&&f in t))return!1;var t,i=function(e){var t=w(e)?v.call(e):"";return t==n||t==a}(e)||function(e){var t=!1;if(null!=e&&"function"!=typeof e.toString)try{t=!!(e+"")}catch(e){}return t}(e)?S:s;return i.test(function(e){if(null!=e){try{return m.call(e)}catch(e){}try{return e+""}catch(e){}}return""}(e))}function b(e,t){var i,r,n=e.__data__;return("string"==(r=typeof(i=t))||"number"==r||"symbol"==r||"boolean"==r?"__proto__"!==i:null===i)?n["string"==typeof t?"string":"hash"]:n.map}function O(e,t){var i=function(e,t){return null==e?void 0:e[t]}(e,t);return P(i)?i:void 0}function D(e,t){if("function"!=typeof e||t&&"function"!=typeof t)throw new TypeError("Expected a function");var i=function(){var r=arguments,n=t?t.apply(this,r):r[0],a=i.cache;if(a.has(n))return a.get(n);var s=e.apply(this,r);return i.cache=a.set(n,s),s};return i.cache=new(D.Cache||I),i}function w(e){var t=typeof e;return!!e&&("object"==t||"function"==t)}C.prototype.clear=function(){this.__data__=T?T(null):{}},C.prototype.delete=function(e){return this.has(e)&&delete this.__data__[e]},C.prototype.get=function(e){var t=this.__data__;if(T){var i=t[e];return i===r?void 0:i}return g.call(t,e)?t[e]:void 0},C.prototype.has=function(e){var t=this.__data__;return T?void 0!==t[e]:g.call(t,e)},C.prototype.set=function(e,t){return this.__data__[e]=T&&void 0===t?r:t,this},R.prototype.clear=function(){this.__data__=[]},R.prototype.delete=function(e){var t=this.__data__,i=A(t,e);return!(i<0)&&(i==t.length-1?t.pop():E.call(t,i,1),!0)},R.prototype.get=function(e){var t=this.__data__,i=A(t,e);return i<0?void 0:t[i][1]},R.prototype.has=function(e){return A(this.__data__,e)>-1},R.prototype.set=function(e,t){var i=this.__data__,r=A(i,e);return r<0?i.push([e,t]):i[r][1]=t,this},I.prototype.clear=function(){this.__data__={hash:new C,map:new(y||R),string:new C}},I.prototype.delete=function(e){return b(this,e).delete(e)},I.prototype.get=function(e){return b(this,e).get(e)},I.prototype.has=function(e){return b(this,e).has(e)},I.prototype.set=function(e,t){return b(this,e).set(e,t),this},D.Cache=I,e.exports=D},62539:(e,t,i)=>{"use strict";var r=i(57539);function n(e,t,i,n,a){var s=r.writeRtpDescription(e.kind,t);if(s+=r.writeIceParameters(e.iceGatherer.getLocalParameters()),s+=r.writeDtlsParameters(e.dtlsTransport.getLocalParameters(),"offer"===i?"actpass":a||"active"),s+="a=mid:"+e.mid+"\r\n",e.rtpSender&&e.rtpReceiver?s+="a=sendrecv\r\n":e.rtpSender?s+="a=sendonly\r\n":e.rtpReceiver?s+="a=recvonly\r\n":s+="a=inactive\r\n",e.rtpSender){var o=e.rtpSender._initialTrackId||e.rtpSender.track.id;e.rtpSender._initialTrackId=o;var c="msid:"+(n?n.id:"-")+" "+o+"\r\n";s+="a="+c,s+="a=ssrc:"+e.sendEncodingParameters[0].ssrc+" "+c,e.sendEncodingParameters[0].rtx&&(s+="a=ssrc:"+e.sendEncodingParameters[0].rtx.ssrc+" "+c,s+="a=ssrc-group:FID "+e.sendEncodingParameters[0].ssrc+" "+e.sendEncodingParameters[0].rtx.ssrc+"\r\n")}return s+="a=ssrc:"+e.sendEncodingParameters[0].ssrc+" cname:"+r.localCName+"\r\n",e.rtpSender&&e.sendEncodingParameters[0].rtx&&(s+="a=ssrc:"+e.sendEncodingParameters[0].rtx.ssrc+" cname:"+r.localCName+"\r\n"),s}function a(e,t){var i={codecs:[],headerExtensions:[],fecMechanisms:[]},r=function(e,t){e=parseInt(e,10);for(var i=0;i<t.length;i++)if(t[i].payloadType===e||t[i].preferredPayloadType===e)return t[i]},n=function(e,t,i,n){var a=r(e.parameters.apt,i),s=r(t.parameters.apt,n);return a&&s&&a.name.toLowerCase()===s.name.toLowerCase()};return e.codecs.forEach((function(r){for(var a=0;a<t.codecs.length;a++){var s=t.codecs[a];if(r.name.toLowerCase()===s.name.toLowerCase()&&r.clockRate===s.clockRate){if("rtx"===r.name.toLowerCase()&&r.parameters&&s.parameters.apt&&!n(r,s,e.codecs,t.codecs))continue;(s=JSON.parse(JSON.stringify(s))).numChannels=Math.min(r.numChannels,s.numChannels),i.codecs.push(s),s.rtcpFeedback=s.rtcpFeedback.filter((function(e){for(var t=0;t<r.rtcpFeedback.length;t++)if(r.rtcpFeedback[t].type===e.type&&r.rtcpFeedback[t].parameter===e.parameter)return!0;return!1}));break}}})),e.headerExtensions.forEach((function(e){for(var r=0;r<t.headerExtensions.length;r++){var n=t.headerExtensions[r];if(e.uri===n.uri){i.headerExtensions.push(n);break}}})),i}function s(e,t,i){return-1!=={offer:{setLocalDescription:["stable","have-local-offer"],setRemoteDescription:["stable","have-remote-offer"]},answer:{setLocalDescription:["have-remote-offer","have-local-pranswer"],setRemoteDescription:["have-local-offer","have-remote-pranswer"]}}[t][e].indexOf(i)}function o(e,t){var i=e.getRemoteCandidates().find((function(e){return t.foundation===e.foundation&&t.ip===e.ip&&t.port===e.port&&t.priority===e.priority&&t.protocol===e.protocol&&t.type===e.type}));return i||e.addRemoteCandidate(t),!i}function c(e,t){var i=new Error(t);return i.name=e,i.code={NotSupportedError:9,InvalidStateError:11,InvalidAccessError:15,TypeError:void 0,OperationError:void 0}[e],i}e.exports=function(e,t){function i(t,i){i.addTrack(t),i.dispatchEvent(new e.MediaStreamTrackEvent("addtrack",{track:t}))}function d(t,i,r,n){var a=new Event("track");a.track=i,a.receiver=r,a.transceiver={receiver:r},a.streams=n,e.setTimeout((function(){t._dispatchEvent("track",a)}))}var l=function(i){var n=this,a=document.createDocumentFragment();if(["addEventListener","removeEventListener","dispatchEvent"].forEach((function(e){n[e]=a[e].bind(a)})),this.canTrickleIceCandidates=null,this.needNegotiation=!1,this.localStreams=[],this.remoteStreams=[],this._localDescription=null,this._remoteDescription=null,this.signalingState="stable",this.iceConnectionState="new",this.connectionState="new",this.iceGatheringState="new",i=JSON.parse(JSON.stringify(i||{})),this.usingBundle="max-bundle"===i.bundlePolicy,"negotiate"===i.rtcpMuxPolicy)throw c("NotSupportedError","rtcpMuxPolicy 'negotiate' is not supported");switch(i.rtcpMuxPolicy||(i.rtcpMuxPolicy="require"),i.iceTransportPolicy){case"all":case"relay":break;default:i.iceTransportPolicy="all"}switch(i.bundlePolicy){case"balanced":case"max-compat":case"max-bundle":break;default:i.bundlePolicy="balanced"}if(i.iceServers=function(e,t){var i=!1;return(e=JSON.parse(JSON.stringify(e))).filter((function(e){if(e&&(e.urls||e.url)){var r=e.urls||e.url;e.url&&!e.urls&&console.warn("RTCIceServer.url is deprecated! Use urls instead.");var n="string"==typeof r;return n&&(r=[r]),r=r.filter((function(e){return 0!==e.indexOf("turn:")||-1===e.indexOf("transport=udp")||-1!==e.indexOf("turn:[")||i?0===e.indexOf("stun:")&&t>=14393&&-1===e.indexOf("?transport=udp"):(i=!0,!0)})),delete e.url,e.urls=n?r[0]:r,!!r.length}}))}(i.iceServers||[],t),this._iceGatherers=[],i.iceCandidatePoolSize)for(var s=i.iceCandidatePoolSize;s>0;s--)this._iceGatherers.push(new e.RTCIceGatherer({iceServers:i.iceServers,gatherPolicy:i.iceTransportPolicy}));else i.iceCandidatePoolSize=0;this._config=i,this.transceivers=[],this._sdpSessionId=r.generateSessionId(),this._sdpSessionVersion=0,this._dtlsRole=void 0,this._isClosed=!1};Object.defineProperty(l.prototype,"localDescription",{configurable:!0,get:function(){return this._localDescription}}),Object.defineProperty(l.prototype,"remoteDescription",{configurable:!0,get:function(){return this._remoteDescription}}),l.prototype.onicecandidate=null,l.prototype.onaddstream=null,l.prototype.ontrack=null,l.prototype.onremovestream=null,l.prototype.onsignalingstatechange=null,l.prototype.oniceconnectionstatechange=null,l.prototype.onconnectionstatechange=null,l.prototype.onicegatheringstatechange=null,l.prototype.onnegotiationneeded=null,l.prototype.ondatachannel=null,l.prototype._dispatchEvent=function(e,t){this._isClosed||(this.dispatchEvent(t),"function"==typeof this["on"+e]&&this["on"+e](t))},l.prototype._emitGatheringStateChange=function(){var e=new Event("icegatheringstatechange");this._dispatchEvent("icegatheringstatechange",e)},l.prototype.getConfiguration=function(){return this._config},l.prototype.getLocalStreams=function(){return this.localStreams},l.prototype.getRemoteStreams=function(){return this.remoteStreams},l.prototype._createTransceiver=function(e,t){var i=this.transceivers.length>0,r={track:null,iceGatherer:null,iceTransport:null,dtlsTransport:null,localCapabilities:null,remoteCapabilities:null,rtpSender:null,rtpReceiver:null,kind:e,mid:null,sendEncodingParameters:null,recvEncodingParameters:null,stream:null,associatedRemoteMediaStreams:[],wantReceive:!0};if(this.usingBundle&&i)r.iceTransport=this.transceivers[0].iceTransport,r.dtlsTransport=this.transceivers[0].dtlsTransport;else{var n=this._createIceAndDtlsTransports();r.iceTransport=n.iceTransport,r.dtlsTransport=n.dtlsTransport}return t||this.transceivers.push(r),r},l.prototype.addTrack=function(t,i){if(this._isClosed)throw c("InvalidStateError","Attempted to call addTrack on a closed peerconnection.");var r;if(this.transceivers.find((function(e){return e.track===t})))throw c("InvalidAccessError","Track already exists.");for(var n=0;n<this.transceivers.length;n++)this.transceivers[n].track||this.transceivers[n].kind!==t.kind||(r=this.transceivers[n]);return r||(r=this._createTransceiver(t.kind)),this._maybeFireNegotiationNeeded(),-1===this.localStreams.indexOf(i)&&this.localStreams.push(i),r.track=t,r.stream=i,r.rtpSender=new e.RTCRtpSender(t,r.dtlsTransport),r.rtpSender},l.prototype.addStream=function(e){var i=this;if(t>=15025)e.getTracks().forEach((function(t){i.addTrack(t,e)}));else{var r=e.clone();e.getTracks().forEach((function(e,t){var i=r.getTracks()[t];e.addEventListener("enabled",(function(e){i.enabled=e.enabled}))})),r.getTracks().forEach((function(e){i.addTrack(e,r)}))}},l.prototype.removeTrack=function(t){if(this._isClosed)throw c("InvalidStateError","Attempted to call removeTrack on a closed peerconnection.");if(!(t instanceof e.RTCRtpSender))throw new TypeError("Argument 1 of RTCPeerConnection.removeTrack does not implement interface RTCRtpSender.");var i=this.transceivers.find((function(e){return e.rtpSender===t}));if(!i)throw c("InvalidAccessError","Sender was not created by this connection.");var r=i.stream;i.rtpSender.stop(),i.rtpSender=null,i.track=null,i.stream=null,-1===this.transceivers.map((function(e){return e.stream})).indexOf(r)&&this.localStreams.indexOf(r)>-1&&this.localStreams.splice(this.localStreams.indexOf(r),1),this._maybeFireNegotiationNeeded()},l.prototype.removeStream=function(e){var t=this;e.getTracks().forEach((function(e){var i=t.getSenders().find((function(t){return t.track===e}));i&&t.removeTrack(i)}))},l.prototype.getSenders=function(){return this.transceivers.filter((function(e){return!!e.rtpSender})).map((function(e){return e.rtpSender}))},l.prototype.getReceivers=function(){return this.transceivers.filter((function(e){return!!e.rtpReceiver})).map((function(e){return e.rtpReceiver}))},l.prototype._createIceGatherer=function(t,i){var r=this;if(i&&t>0)return this.transceivers[0].iceGatherer;if(this._iceGatherers.length)return this._iceGatherers.shift();var n=new e.RTCIceGatherer({iceServers:this._config.iceServers,gatherPolicy:this._config.iceTransportPolicy});return Object.defineProperty(n,"state",{value:"new",writable:!0}),this.transceivers[t].bufferedCandidateEvents=[],this.transceivers[t].bufferCandidates=function(e){var i=!e.candidate||0===Object.keys(e.candidate).length;n.state=i?"completed":"gathering",null!==r.transceivers[t].bufferedCandidateEvents&&r.transceivers[t].bufferedCandidateEvents.push(e)},n.addEventListener("localcandidate",this.transceivers[t].bufferCandidates),n},l.prototype._gather=function(t,i){var n=this,a=this.transceivers[i].iceGatherer;if(!a.onlocalcandidate){var s=this.transceivers[i].bufferedCandidateEvents;this.transceivers[i].bufferedCandidateEvents=null,a.removeEventListener("localcandidate",this.transceivers[i].bufferCandidates),a.onlocalcandidate=function(e){if(!(n.usingBundle&&i>0)){var s=new Event("icecandidate");s.candidate={sdpMid:t,sdpMLineIndex:i};var o=e.candidate,c=!o||0===Object.keys(o).length;if(c)"new"!==a.state&&"gathering"!==a.state||(a.state="completed");else{"new"===a.state&&(a.state="gathering"),o.component=1,o.ufrag=a.getLocalParameters().usernameFragment;var d=r.writeCandidate(o);s.candidate=Object.assign(s.candidate,r.parseCandidate(d)),s.candidate.candidate=d,s.candidate.toJSON=function(){return{candidate:s.candidate.candidate,sdpMid:s.candidate.sdpMid,sdpMLineIndex:s.candidate.sdpMLineIndex,usernameFragment:s.candidate.usernameFragment}}}var l=r.getMediaSections(n._localDescription.sdp);l[s.candidate.sdpMLineIndex]+=c?"a=end-of-candidates\r\n":"a="+s.candidate.candidate+"\r\n",n._localDescription.sdp=r.getDescription(n._localDescription.sdp)+l.join("");var u=n.transceivers.every((function(e){return e.iceGatherer&&"completed"===e.iceGatherer.state}));"gathering"!==n.iceGatheringState&&(n.iceGatheringState="gathering",n._emitGatheringStateChange()),c||n._dispatchEvent("icecandidate",s),u&&(n._dispatchEvent("icecandidate",new Event("icecandidate")),n.iceGatheringState="complete",n._emitGatheringStateChange())}},e.setTimeout((function(){s.forEach((function(e){a.onlocalcandidate(e)}))}),0)}},l.prototype._createIceAndDtlsTransports=function(){var t=this,i=new e.RTCIceTransport(null);i.onicestatechange=function(){t._updateIceConnectionState(),t._updateConnectionState()};var r=new e.RTCDtlsTransport(i);return r.ondtlsstatechange=function(){t._updateConnectionState()},r.onerror=function(){Object.defineProperty(r,"state",{value:"failed",writable:!0}),t._updateConnectionState()},{iceTransport:i,dtlsTransport:r}},l.prototype._disposeIceAndDtlsTransports=function(e){var t=this.transceivers[e].iceGatherer;t&&(delete t.onlocalcandidate,delete this.transceivers[e].iceGatherer);var i=this.transceivers[e].iceTransport;i&&(delete i.onicestatechange,delete this.transceivers[e].iceTransport);var r=this.transceivers[e].dtlsTransport;r&&(delete r.ondtlsstatechange,delete r.onerror,delete this.transceivers[e].dtlsTransport)},l.prototype._transceive=function(e,i,n){var s=a(e.localCapabilities,e.remoteCapabilities);i&&e.rtpSender&&(s.encodings=e.sendEncodingParameters,s.rtcp={cname:r.localCName,compound:e.rtcpParameters.compound},e.recvEncodingParameters.length&&(s.rtcp.ssrc=e.recvEncodingParameters[0].ssrc),e.rtpSender.send(s)),n&&e.rtpReceiver&&s.codecs.length>0&&("video"===e.kind&&e.recvEncodingParameters&&t<15019&&e.recvEncodingParameters.forEach((function(e){delete e.rtx})),e.recvEncodingParameters.length?s.encodings=e.recvEncodingParameters:s.encodings=[{}],s.rtcp={compound:e.rtcpParameters.compound},e.rtcpParameters.cname&&(s.rtcp.cname=e.rtcpParameters.cname),e.sendEncodingParameters.length&&(s.rtcp.ssrc=e.sendEncodingParameters[0].ssrc),e.rtpReceiver.receive(s))},l.prototype.setLocalDescription=function(e){var t,i,n=this;if(-1===["offer","answer"].indexOf(e.type))return Promise.reject(c("TypeError",'Unsupported type "'+e.type+'"'));if(!s("setLocalDescription",e.type,n.signalingState)||n._isClosed)return Promise.reject(c("InvalidStateError","Can not set local "+e.type+" in state "+n.signalingState));if("offer"===e.type)t=r.splitSections(e.sdp),i=t.shift(),t.forEach((function(e,t){var i=r.parseRtpParameters(e);n.transceivers[t].localCapabilities=i})),n.transceivers.forEach((function(e,t){n._gather(e.mid,t)}));else if("answer"===e.type){t=r.splitSections(n._remoteDescription.sdp),i=t.shift();var o=r.matchPrefix(i,"a=ice-lite").length>0;t.forEach((function(e,t){var s=n.transceivers[t],c=s.iceGatherer,d=s.iceTransport,l=s.dtlsTransport,u=s.localCapabilities,p=s.remoteCapabilities;if(!(r.isRejected(e)&&0===r.matchPrefix(e,"a=bundle-only").length)&&!s.rejected){var h=r.getIceParameters(e,i),_=r.getDtlsParameters(e,i);o&&(_.role="server"),n.usingBundle&&0!==t||(n._gather(s.mid,t),"new"===d.state&&d.start(c,h,o?"controlling":"controlled"),"new"===l.state&&l.start(_));var f=a(u,p);n._transceive(s,f.codecs.length>0,!1)}}))}return n._localDescription={type:e.type,sdp:e.sdp},"offer"===e.type?n._updateSignalingState("have-local-offer"):n._updateSignalingState("stable"),Promise.resolve()},l.prototype.setRemoteDescription=function(n){var l=this;if(-1===["offer","answer"].indexOf(n.type))return Promise.reject(c("TypeError",'Unsupported type "'+n.type+'"'));if(!s("setRemoteDescription",n.type,l.signalingState)||l._isClosed)return Promise.reject(c("InvalidStateError","Can not set remote "+n.type+" in state "+l.signalingState));var u={};l.remoteStreams.forEach((function(e){u[e.id]=e}));var p=[],h=r.splitSections(n.sdp),_=h.shift(),f=r.matchPrefix(_,"a=ice-lite").length>0,m=r.matchPrefix(_,"a=group:BUNDLE ").length>0;l.usingBundle=m;var g=r.matchPrefix(_,"a=ice-options:")[0];return l.canTrickleIceCandidates=!!g&&g.substr(14).split(" ").indexOf("trickle")>=0,h.forEach((function(s,c){var d=r.splitLines(s),h=r.getKind(s),g=r.isRejected(s)&&0===r.matchPrefix(s,"a=bundle-only").length,v=d[0].substr(2).split(" ")[2],S=r.getDirection(s,_),E=r.parseMsid(s),y=r.getMid(s)||r.generateIdentifier();if(g||"application"===h&&("DTLS/SCTP"===v||"UDP/DTLS/SCTP"===v))l.transceivers[c]={mid:y,kind:h,protocol:v,rejected:!0};else{var T,C,R,I,A,P,b,O,D;!g&&l.transceivers[c]&&l.transceivers[c].rejected&&(l.transceivers[c]=l._createTransceiver(h,!0));var w,N,k=r.parseRtpParameters(s);g||(w=r.getIceParameters(s,_),(N=r.getDtlsParameters(s,_)).role="client"),b=r.parseRtpEncodingParameters(s);var L=r.parseRtcpParameters(s),M=r.matchPrefix(s,"a=end-of-candidates",_).length>0,U=r.matchPrefix(s,"a=candidate:").map((function(e){return r.parseCandidate(e)})).filter((function(e){return 1===e.component}));if(("offer"===n.type||"answer"===n.type)&&!g&&m&&c>0&&l.transceivers[c]&&(l._disposeIceAndDtlsTransports(c),l.transceivers[c].iceGatherer=l.transceivers[0].iceGatherer,l.transceivers[c].iceTransport=l.transceivers[0].iceTransport,l.transceivers[c].dtlsTransport=l.transceivers[0].dtlsTransport,l.transceivers[c].rtpSender&&l.transceivers[c].rtpSender.setTransport(l.transceivers[0].dtlsTransport),l.transceivers[c].rtpReceiver&&l.transceivers[c].rtpReceiver.setTransport(l.transceivers[0].dtlsTransport)),"offer"!==n.type||g){if("answer"===n.type&&!g){C=(T=l.transceivers[c]).iceGatherer,R=T.iceTransport,I=T.dtlsTransport,A=T.rtpReceiver,P=T.sendEncodingParameters,O=T.localCapabilities,l.transceivers[c].recvEncodingParameters=b,l.transceivers[c].remoteCapabilities=k,l.transceivers[c].rtcpParameters=L,U.length&&"new"===R.state&&(!f&&!M||m&&0!==c?U.forEach((function(e){o(T.iceTransport,e)})):R.setRemoteCandidates(U)),m&&0!==c||("new"===R.state&&R.start(C,w,"controlling"),"new"===I.state&&I.start(N)),!a(T.localCapabilities,T.remoteCapabilities).codecs.filter((function(e){return"rtx"===e.name.toLowerCase()})).length&&T.sendEncodingParameters[0].rtx&&delete T.sendEncodingParameters[0].rtx,l._transceive(T,"sendrecv"===S||"recvonly"===S,"sendrecv"===S||"sendonly"===S),!A||"sendrecv"!==S&&"sendonly"!==S?delete T.rtpReceiver:(D=A.track,E?(u[E.stream]||(u[E.stream]=new e.MediaStream),i(D,u[E.stream]),p.push([D,A,u[E.stream]])):(u.default||(u.default=new e.MediaStream),i(D,u.default),p.push([D,A,u.default])))}}else{(T=l.transceivers[c]||l._createTransceiver(h)).mid=y,T.iceGatherer||(T.iceGatherer=l._createIceGatherer(c,m)),U.length&&"new"===T.iceTransport.state&&(!M||m&&0!==c?U.forEach((function(e){o(T.iceTransport,e)})):T.iceTransport.setRemoteCandidates(U)),O=e.RTCRtpReceiver.getCapabilities(h),t<15019&&(O.codecs=O.codecs.filter((function(e){return"rtx"!==e.name}))),P=T.sendEncodingParameters||[{ssrc:1001*(2*c+2)}];var x,B=!1;if("sendrecv"===S||"sendonly"===S){if(B=!T.rtpReceiver,A=T.rtpReceiver||new e.RTCRtpReceiver(T.dtlsTransport,h),B)D=A.track,E&&"-"===E.stream||(E?(u[E.stream]||(u[E.stream]=new e.MediaStream,Object.defineProperty(u[E.stream],"id",{get:function(){return E.stream}})),Object.defineProperty(D,"id",{get:function(){return E.track}}),x=u[E.stream]):(u.default||(u.default=new e.MediaStream),x=u.default)),x&&(i(D,x),T.associatedRemoteMediaStreams.push(x)),p.push([D,A,x])}else T.rtpReceiver&&T.rtpReceiver.track&&(T.associatedRemoteMediaStreams.forEach((function(t){var i=t.getTracks().find((function(e){return e.id===T.rtpReceiver.track.id}));i&&function(t,i){i.removeTrack(t),i.dispatchEvent(new e.MediaStreamTrackEvent("removetrack",{track:t}))}(i,t)})),T.associatedRemoteMediaStreams=[]);T.localCapabilities=O,T.remoteCapabilities=k,T.rtpReceiver=A,T.rtcpParameters=L,T.sendEncodingParameters=P,T.recvEncodingParameters=b,l._transceive(l.transceivers[c],!1,B)}}})),void 0===l._dtlsRole&&(l._dtlsRole="offer"===n.type?"active":"passive"),l._remoteDescription={type:n.type,sdp:n.sdp},"offer"===n.type?l._updateSignalingState("have-remote-offer"):l._updateSignalingState("stable"),Object.keys(u).forEach((function(t){var i=u[t];if(i.getTracks().length){if(-1===l.remoteStreams.indexOf(i)){l.remoteStreams.push(i);var r=new Event("addstream");r.stream=i,e.setTimeout((function(){l._dispatchEvent("addstream",r)}))}p.forEach((function(e){var t=e[0],r=e[1];i.id===e[2].id&&d(l,t,r,[i])}))}})),p.forEach((function(e){e[2]||d(l,e[0],e[1],[])})),e.setTimeout((function(){l&&l.transceivers&&l.transceivers.forEach((function(e){e.iceTransport&&"new"===e.iceTransport.state&&e.iceTransport.getRemoteCandidates().length>0&&(console.warn("Timeout for addRemoteCandidate. Consider sending an end-of-candidates notification"),e.iceTransport.addRemoteCandidate({}))}))}),4e3),Promise.resolve()},l.prototype.close=function(){this.transceivers.forEach((function(e){e.iceTransport&&e.iceTransport.stop(),e.dtlsTransport&&e.dtlsTransport.stop(),e.rtpSender&&e.rtpSender.stop(),e.rtpReceiver&&e.rtpReceiver.stop()})),this._isClosed=!0,this._updateSignalingState("closed")},l.prototype._updateSignalingState=function(e){this.signalingState=e;var t=new Event("signalingstatechange");this._dispatchEvent("signalingstatechange",t)},l.prototype._maybeFireNegotiationNeeded=function(){var t=this;"stable"===this.signalingState&&!0!==this.needNegotiation&&(this.needNegotiation=!0,e.setTimeout((function(){if(t.needNegotiation){t.needNegotiation=!1;var e=new Event("negotiationneeded");t._dispatchEvent("negotiationneeded",e)}}),0))},l.prototype._updateIceConnectionState=function(){var e,t={new:0,closed:0,checking:0,connected:0,completed:0,disconnected:0,failed:0};if(this.transceivers.forEach((function(e){e.iceTransport&&!e.rejected&&t[e.iceTransport.state]++})),e="new",t.failed>0?e="failed":t.checking>0?e="checking":t.disconnected>0?e="disconnected":t.new>0?e="new":t.connected>0?e="connected":t.completed>0&&(e="completed"),e!==this.iceConnectionState){this.iceConnectionState=e;var i=new Event("iceconnectionstatechange");this._dispatchEvent("iceconnectionstatechange",i)}},l.prototype._updateConnectionState=function(){var e,t={new:0,closed:0,connecting:0,connected:0,completed:0,disconnected:0,failed:0};if(this.transceivers.forEach((function(e){e.iceTransport&&e.dtlsTransport&&!e.rejected&&(t[e.iceTransport.state]++,t[e.dtlsTransport.state]++)})),t.connected+=t.completed,e="new",t.failed>0?e="failed":t.connecting>0?e="connecting":t.disconnected>0?e="disconnected":t.new>0?e="new":t.connected>0&&(e="connected"),e!==this.connectionState){this.connectionState=e;var i=new Event("connectionstatechange");this._dispatchEvent("connectionstatechange",i)}},l.prototype.createOffer=function(){var i=this;if(i._isClosed)return Promise.reject(c("InvalidStateError","Can not call createOffer after close"));var a=i.transceivers.filter((function(e){return"audio"===e.kind})).length,s=i.transceivers.filter((function(e){return"video"===e.kind})).length,o=arguments[0];if(o){if(o.mandatory||o.optional)throw new TypeError("Legacy mandatory/optional constraints not supported.");void 0!==o.offerToReceiveAudio&&(a=!0===o.offerToReceiveAudio?1:!1===o.offerToReceiveAudio?0:o.offerToReceiveAudio),void 0!==o.offerToReceiveVideo&&(s=!0===o.offerToReceiveVideo?1:!1===o.offerToReceiveVideo?0:o.offerToReceiveVideo)}for(i.transceivers.forEach((function(e){"audio"===e.kind?--a<0&&(e.wantReceive=!1):"video"===e.kind&&--s<0&&(e.wantReceive=!1)}));a>0||s>0;)a>0&&(i._createTransceiver("audio"),a--),s>0&&(i._createTransceiver("video"),s--);var d=r.writeSessionBoilerplate(i._sdpSessionId,i._sdpSessionVersion++);i.transceivers.forEach((function(n,a){var s=n.track,o=n.kind,c=n.mid||r.generateIdentifier();n.mid=c,n.iceGatherer||(n.iceGatherer=i._createIceGatherer(a,i.usingBundle));var d=e.RTCRtpSender.getCapabilities(o);t<15019&&(d.codecs=d.codecs.filter((function(e){return"rtx"!==e.name}))),d.codecs.forEach((function(e){"H264"===e.name&&void 0===e.parameters["level-asymmetry-allowed"]&&(e.parameters["level-asymmetry-allowed"]="1"),n.remoteCapabilities&&n.remoteCapabilities.codecs&&n.remoteCapabilities.codecs.forEach((function(t){e.name.toLowerCase()===t.name.toLowerCase()&&e.clockRate===t.clockRate&&(e.preferredPayloadType=t.payloadType)}))})),d.headerExtensions.forEach((function(e){(n.remoteCapabilities&&n.remoteCapabilities.headerExtensions||[]).forEach((function(t){e.uri===t.uri&&(e.id=t.id)}))}));var l=n.sendEncodingParameters||[{ssrc:1001*(2*a+1)}];s&&t>=15019&&"video"===o&&!l[0].rtx&&(l[0].rtx={ssrc:l[0].ssrc+1}),n.wantReceive&&(n.rtpReceiver=new e.RTCRtpReceiver(n.dtlsTransport,o)),n.localCapabilities=d,n.sendEncodingParameters=l})),"max-compat"!==i._config.bundlePolicy&&(d+="a=group:BUNDLE "+i.transceivers.map((function(e){return e.mid})).join(" ")+"\r\n"),d+="a=ice-options:trickle\r\n",i.transceivers.forEach((function(e,t){d+=n(e,e.localCapabilities,"offer",e.stream,i._dtlsRole),d+="a=rtcp-rsize\r\n",!e.iceGatherer||"new"===i.iceGatheringState||0!==t&&i.usingBundle||(e.iceGatherer.getLocalCandidates().forEach((function(e){e.component=1,d+="a="+r.writeCandidate(e)+"\r\n"})),"completed"===e.iceGatherer.state&&(d+="a=end-of-candidates\r\n"))}));var l=new e.RTCSessionDescription({type:"offer",sdp:d});return Promise.resolve(l)},l.prototype.createAnswer=function(){var i=this;if(i._isClosed)return Promise.reject(c("InvalidStateError","Can not call createAnswer after close"));if("have-remote-offer"!==i.signalingState&&"have-local-pranswer"!==i.signalingState)return Promise.reject(c("InvalidStateError","Can not call createAnswer in signalingState "+i.signalingState));var s=r.writeSessionBoilerplate(i._sdpSessionId,i._sdpSessionVersion++);i.usingBundle&&(s+="a=group:BUNDLE "+i.transceivers.map((function(e){return e.mid})).join(" ")+"\r\n"),s+="a=ice-options:trickle\r\n";var o=r.getMediaSections(i._remoteDescription.sdp).length;i.transceivers.forEach((function(e,r){if(!(r+1>o)){if(e.rejected)return"application"===e.kind?"DTLS/SCTP"===e.protocol?s+="m=application 0 DTLS/SCTP 5000\r\n":s+="m=application 0 "+e.protocol+" webrtc-datachannel\r\n":"audio"===e.kind?s+="m=audio 0 UDP/TLS/RTP/SAVPF 0\r\na=rtpmap:0 PCMU/8000\r\n":"video"===e.kind&&(s+="m=video 0 UDP/TLS/RTP/SAVPF 120\r\na=rtpmap:120 VP8/90000\r\n"),void(s+="c=IN IP4 0.0.0.0\r\na=inactive\r\na=mid:"+e.mid+"\r\n");var c;if(e.stream)"audio"===e.kind?c=e.stream.getAudioTracks()[0]:"video"===e.kind&&(c=e.stream.getVideoTracks()[0]),c&&t>=15019&&"video"===e.kind&&!e.sendEncodingParameters[0].rtx&&(e.sendEncodingParameters[0].rtx={ssrc:e.sendEncodingParameters[0].ssrc+1});var d=a(e.localCapabilities,e.remoteCapabilities);!d.codecs.filter((function(e){return"rtx"===e.name.toLowerCase()})).length&&e.sendEncodingParameters[0].rtx&&delete e.sendEncodingParameters[0].rtx,s+=n(e,d,"answer",e.stream,i._dtlsRole),e.rtcpParameters&&e.rtcpParameters.reducedSize&&(s+="a=rtcp-rsize\r\n")}}));var d=new e.RTCSessionDescription({type:"answer",sdp:s});return Promise.resolve(d)},l.prototype.addIceCandidate=function(e){var t,i=this;return e&&void 0===e.sdpMLineIndex&&!e.sdpMid?Promise.reject(new TypeError("sdpMLineIndex or sdpMid required")):new Promise((function(n,a){if(!i._remoteDescription)return a(c("InvalidStateError","Can not add ICE candidate without a remote description"));if(e&&""!==e.candidate){var s=e.sdpMLineIndex;if(e.sdpMid)for(var d=0;d<i.transceivers.length;d++)if(i.transceivers[d].mid===e.sdpMid){s=d;break}var l=i.transceivers[s];if(!l)return a(c("OperationError","Can not add ICE candidate"));if(l.rejected)return n();var u=Object.keys(e.candidate).length>0?r.parseCandidate(e.candidate):{};if("tcp"===u.protocol&&(0===u.port||9===u.port))return n();if(u.component&&1!==u.component)return n();if((0===s||s>0&&l.iceTransport!==i.transceivers[0].iceTransport)&&!o(l.iceTransport,u))return a(c("OperationError","Can not add ICE candidate"));var p=e.candidate.trim();0===p.indexOf("a=")&&(p=p.substr(2)),(t=r.getMediaSections(i._remoteDescription.sdp))[s]+="a="+(u.type?p:"end-of-candidates")+"\r\n",i._remoteDescription.sdp=r.getDescription(i._remoteDescription.sdp)+t.join("")}else for(var h=0;h<i.transceivers.length&&(i.transceivers[h].rejected||(i.transceivers[h].iceTransport.addRemoteCandidate({}),(t=r.getMediaSections(i._remoteDescription.sdp))[h]+="a=end-of-candidates\r\n",i._remoteDescription.sdp=r.getDescription(i._remoteDescription.sdp)+t.join(""),!i.usingBundle));h++);n()}))},l.prototype.getStats=function(t){if(t&&t instanceof e.MediaStreamTrack){var i=null;if(this.transceivers.forEach((function(e){e.rtpSender&&e.rtpSender.track===t?i=e.rtpSender:e.rtpReceiver&&e.rtpReceiver.track===t&&(i=e.rtpReceiver)})),!i)throw c("InvalidAccessError","Invalid selector.");return i.getStats()}var r=[];return this.transceivers.forEach((function(e){["rtpSender","rtpReceiver","iceGatherer","iceTransport","dtlsTransport"].forEach((function(t){e[t]&&r.push(e[t].getStats())}))})),Promise.all(r).then((function(e){var t=new Map;return e.forEach((function(e){e.forEach((function(e){t.set(e.id,e)}))})),t}))};["RTCRtpSender","RTCRtpReceiver","RTCIceGatherer","RTCIceTransport","RTCDtlsTransport"].forEach((function(t){var i=e[t];if(i&&i.prototype&&i.prototype.getStats){var r=i.prototype.getStats;i.prototype.getStats=function(){return r.apply(this).then((function(e){var t=new Map;return Object.keys(e).forEach((function(i){var r;e[i].type={inboundrtp:"inbound-rtp",outboundrtp:"outbound-rtp",candidatepair:"candidate-pair",localcandidate:"local-candidate",remotecandidate:"remote-candidate"}[(r=e[i]).type]||r.type,t.set(i,e[i])})),t}))}}}));var u=["createOffer","createAnswer"];return u.forEach((function(e){var t=l.prototype[e];l.prototype[e]=function(){var e=arguments;return"function"==typeof e[0]||"function"==typeof e[1]?t.apply(this,[arguments[2]]).then((function(t){"function"==typeof e[0]&&e[0].apply(null,[t])}),(function(t){"function"==typeof e[1]&&e[1].apply(null,[t])})):t.apply(this,arguments)}})),(u=["setLocalDescription","setRemoteDescription","addIceCandidate"]).forEach((function(e){var t=l.prototype[e];l.prototype[e]=function(){var e=arguments;return"function"==typeof e[1]||"function"==typeof e[2]?t.apply(this,arguments).then((function(){"function"==typeof e[1]&&e[1].apply(null)}),(function(t){"function"==typeof e[2]&&e[2].apply(null,[t])})):t.apply(this,arguments)}})),["getStats"].forEach((function(e){var t=l.prototype[e];l.prototype[e]=function(){var e=arguments;return"function"==typeof e[1]?t.apply(this,arguments).then((function(){"function"==typeof e[1]&&e[1].apply(null)})):t.apply(this,arguments)}})),l}},57539:e=>{"use strict";var t={generateIdentifier:function(){return Math.random().toString(36).substr(2,10)}};t.localCName=t.generateIdentifier(),t.splitLines=function(e){return e.trim().split("\n").map((function(e){return e.trim()}))},t.splitSections=function(e){return e.split("\nm=").map((function(e,t){return(t>0?"m="+e:e).trim()+"\r\n"}))},t.getDescription=function(e){var i=t.splitSections(e);return i&&i[0]},t.getMediaSections=function(e){var i=t.splitSections(e);return i.shift(),i},t.matchPrefix=function(e,i){return t.splitLines(e).filter((function(e){return 0===e.indexOf(i)}))},t.parseCandidate=function(e){for(var t,i={foundation:(t=0===e.indexOf("a=candidate:")?e.substring(12).split(" "):e.substring(10).split(" "))[0],component:parseInt(t[1],10),protocol:t[2].toLowerCase(),priority:parseInt(t[3],10),ip:t[4],address:t[4],port:parseInt(t[5],10),type:t[7]},r=8;r<t.length;r+=2)switch(t[r]){case"raddr":i.relatedAddress=t[r+1];break;case"rport":i.relatedPort=parseInt(t[r+1],10);break;case"tcptype":i.tcpType=t[r+1];break;case"ufrag":i.ufrag=t[r+1],i.usernameFragment=t[r+1];break;default:i[t[r]]=t[r+1]}return i},t.writeCandidate=function(e){var t=[];t.push(e.foundation),t.push(e.component),t.push(e.protocol.toUpperCase()),t.push(e.priority),t.push(e.address||e.ip),t.push(e.port);var i=e.type;return t.push("typ"),t.push(i),"host"!==i&&e.relatedAddress&&e.relatedPort&&(t.push("raddr"),t.push(e.relatedAddress),t.push("rport"),t.push(e.relatedPort)),e.tcpType&&"tcp"===e.protocol.toLowerCase()&&(t.push("tcptype"),t.push(e.tcpType)),(e.usernameFragment||e.ufrag)&&(t.push("ufrag"),t.push(e.usernameFragment||e.ufrag)),"candidate:"+t.join(" ")},t.parseIceOptions=function(e){return e.substr(14).split(" ")},t.parseRtpMap=function(e){var t=e.substr(9).split(" "),i={payloadType:parseInt(t.shift(),10)};return t=t[0].split("/"),i.name=t[0],i.clockRate=parseInt(t[1],10),i.channels=3===t.length?parseInt(t[2],10):1,i.numChannels=i.channels,i},t.writeRtpMap=function(e){var t=e.payloadType;void 0!==e.preferredPayloadType&&(t=e.preferredPayloadType);var i=e.channels||e.numChannels||1;return"a=rtpmap:"+t+" "+e.name+"/"+e.clockRate+(1!==i?"/"+i:"")+"\r\n"},t.parseExtmap=function(e){var t=e.substr(9).split(" ");return{id:parseInt(t[0],10),direction:t[0].indexOf("/")>0?t[0].split("/")[1]:"sendrecv",uri:t[1]}},t.writeExtmap=function(e){return"a=extmap:"+(e.id||e.preferredId)+(e.direction&&"sendrecv"!==e.direction?"/"+e.direction:"")+" "+e.uri+"\r\n"},t.parseFmtp=function(e){for(var t,i={},r=e.substr(e.indexOf(" ")+1).split(";"),n=0;n<r.length;n++)i[(t=r[n].trim().split("="))[0].trim()]=t[1];return i},t.writeFmtp=function(e){var t="",i=e.payloadType;if(void 0!==e.preferredPayloadType&&(i=e.preferredPayloadType),e.parameters&&Object.keys(e.parameters).length){var r=[];Object.keys(e.parameters).forEach((function(t){e.parameters[t]?r.push(t+"="+e.parameters[t]):r.push(t)})),t+="a=fmtp:"+i+" "+r.join(";")+"\r\n"}return t},t.parseRtcpFb=function(e){var t=e.substr(e.indexOf(" ")+1).split(" ");return{type:t.shift(),parameter:t.join(" ")}},t.writeRtcpFb=function(e){var t="",i=e.payloadType;return void 0!==e.preferredPayloadType&&(i=e.preferredPayloadType),e.rtcpFeedback&&e.rtcpFeedback.length&&e.rtcpFeedback.forEach((function(e){t+="a=rtcp-fb:"+i+" "+e.type+(e.parameter&&e.parameter.length?" "+e.parameter:"")+"\r\n"})),t},t.parseSsrcMedia=function(e){var t=e.indexOf(" "),i={ssrc:parseInt(e.substr(7,t-7),10)},r=e.indexOf(":",t);return r>-1?(i.attribute=e.substr(t+1,r-t-1),i.value=e.substr(r+1)):i.attribute=e.substr(t+1),i},t.parseSsrcGroup=function(e){var t=e.substr(13).split(" ");return{semantics:t.shift(),ssrcs:t.map((function(e){return parseInt(e,10)}))}},t.getMid=function(e){var i=t.matchPrefix(e,"a=mid:")[0];if(i)return i.substr(6)},t.parseFingerprint=function(e){var t=e.substr(14).split(" ");return{algorithm:t[0].toLowerCase(),value:t[1]}},t.getDtlsParameters=function(e,i){return{role:"auto",fingerprints:t.matchPrefix(e+i,"a=fingerprint:").map(t.parseFingerprint)}},t.writeDtlsParameters=function(e,t){var i="a=setup:"+t+"\r\n";return e.fingerprints.forEach((function(e){i+="a=fingerprint:"+e.algorithm+" "+e.value+"\r\n"})),i},t.parseCryptoLine=function(e){var t=e.substr(9).split(" ");return{tag:parseInt(t[0],10),cryptoSuite:t[1],keyParams:t[2],sessionParams:t.slice(3)}},t.writeCryptoLine=function(e){return"a=crypto:"+e.tag+" "+e.cryptoSuite+" "+("object"==typeof e.keyParams?t.writeCryptoKeyParams(e.keyParams):e.keyParams)+(e.sessionParams?" "+e.sessionParams.join(" "):"")+"\r\n"},t.parseCryptoKeyParams=function(e){if(0!==e.indexOf("inline:"))return null;var t=e.substr(7).split("|");return{keyMethod:"inline",keySalt:t[0],lifeTime:t[1],mkiValue:t[2]?t[2].split(":")[0]:void 0,mkiLength:t[2]?t[2].split(":")[1]:void 0}},t.writeCryptoKeyParams=function(e){return e.keyMethod+":"+e.keySalt+(e.lifeTime?"|"+e.lifeTime:"")+(e.mkiValue&&e.mkiLength?"|"+e.mkiValue+":"+e.mkiLength:"")},t.getCryptoParameters=function(e,i){return t.matchPrefix(e+i,"a=crypto:").map(t.parseCryptoLine)},t.getIceParameters=function(e,i){var r=t.matchPrefix(e+i,"a=ice-ufrag:")[0],n=t.matchPrefix(e+i,"a=ice-pwd:")[0];return r&&n?{usernameFragment:r.substr(12),password:n.substr(10)}:null},t.writeIceParameters=function(e){return"a=ice-ufrag:"+e.usernameFragment+"\r\na=ice-pwd:"+e.password+"\r\n"},t.parseRtpParameters=function(e){for(var i={codecs:[],headerExtensions:[],fecMechanisms:[],rtcp:[]},r=t.splitLines(e)[0].split(" "),n=3;n<r.length;n++){var a=r[n],s=t.matchPrefix(e,"a=rtpmap:"+a+" ")[0];if(s){var o=t.parseRtpMap(s),c=t.matchPrefix(e,"a=fmtp:"+a+" ");switch(o.parameters=c.length?t.parseFmtp(c[0]):{},o.rtcpFeedback=t.matchPrefix(e,"a=rtcp-fb:"+a+" ").map(t.parseRtcpFb),i.codecs.push(o),o.name.toUpperCase()){case"RED":case"ULPFEC":i.fecMechanisms.push(o.name.toUpperCase())}}}return t.matchPrefix(e,"a=extmap:").forEach((function(e){i.headerExtensions.push(t.parseExtmap(e))})),i},t.writeRtpDescription=function(e,i){var r="";r+="m="+e+" ",r+=i.codecs.length>0?"9":"0",r+=" UDP/TLS/RTP/SAVPF ",r+=i.codecs.map((function(e){return void 0!==e.preferredPayloadType?e.preferredPayloadType:e.payloadType})).join(" ")+"\r\n",r+="c=IN IP4 0.0.0.0\r\n",r+="a=rtcp:9 IN IP4 0.0.0.0\r\n",i.codecs.forEach((function(e){r+=t.writeRtpMap(e),r+=t.writeFmtp(e),r+=t.writeRtcpFb(e)}));var n=0;return i.codecs.forEach((function(e){e.maxptime>n&&(n=e.maxptime)})),n>0&&(r+="a=maxptime:"+n+"\r\n"),r+="a=rtcp-mux\r\n",i.headerExtensions&&i.headerExtensions.forEach((function(e){r+=t.writeExtmap(e)})),r},t.parseRtpEncodingParameters=function(e){var i,r=[],n=t.parseRtpParameters(e),a=-1!==n.fecMechanisms.indexOf("RED"),s=-1!==n.fecMechanisms.indexOf("ULPFEC"),o=t.matchPrefix(e,"a=ssrc:").map((function(e){return t.parseSsrcMedia(e)})).filter((function(e){return"cname"===e.attribute})),c=o.length>0&&o[0].ssrc,d=t.matchPrefix(e,"a=ssrc-group:FID").map((function(e){return e.substr(17).split(" ").map((function(e){return parseInt(e,10)}))}));d.length>0&&d[0].length>1&&d[0][0]===c&&(i=d[0][1]),n.codecs.forEach((function(e){if("RTX"===e.name.toUpperCase()&&e.parameters.apt){var t={ssrc:c,codecPayloadType:parseInt(e.parameters.apt,10)};c&&i&&(t.rtx={ssrc:i}),r.push(t),a&&((t=JSON.parse(JSON.stringify(t))).fec={ssrc:c,mechanism:s?"red+ulpfec":"red"},r.push(t))}})),0===r.length&&c&&r.push({ssrc:c});var l=t.matchPrefix(e,"b=");return l.length&&(l=0===l[0].indexOf("b=TIAS:")?parseInt(l[0].substr(7),10):0===l[0].indexOf("b=AS:")?1e3*parseInt(l[0].substr(5),10)*.95-16e3:void 0,r.forEach((function(e){e.maxBitrate=l}))),r},t.parseRtcpParameters=function(e){var i={},r=t.matchPrefix(e,"a=ssrc:").map((function(e){return t.parseSsrcMedia(e)})).filter((function(e){return"cname"===e.attribute}))[0];r&&(i.cname=r.value,i.ssrc=r.ssrc);var n=t.matchPrefix(e,"a=rtcp-rsize");i.reducedSize=n.length>0,i.compound=0===n.length;var a=t.matchPrefix(e,"a=rtcp-mux");return i.mux=a.length>0,i},t.parseMsid=function(e){var i,r=t.matchPrefix(e,"a=msid:");if(1===r.length)return{stream:(i=r[0].substr(7).split(" "))[0],track:i[1]};var n=t.matchPrefix(e,"a=ssrc:").map((function(e){return t.parseSsrcMedia(e)})).filter((function(e){return"msid"===e.attribute}));return n.length>0?{stream:(i=n[0].value.split(" "))[0],track:i[1]}:void 0},t.parseSctpDescription=function(e){var i,r=t.parseMLine(e),n=t.matchPrefix(e,"a=max-message-size:");n.length>0&&(i=parseInt(n[0].substr(19),10)),isNaN(i)&&(i=65536);var a=t.matchPrefix(e,"a=sctp-port:");if(a.length>0)return{port:parseInt(a[0].substr(12),10),protocol:r.fmt,maxMessageSize:i};if(t.matchPrefix(e,"a=sctpmap:").length>0){var s=t.matchPrefix(e,"a=sctpmap:")[0].substr(10).split(" ");return{port:parseInt(s[0],10),protocol:s[1],maxMessageSize:i}}},t.writeSctpDescription=function(e,t){var i=[];return i="DTLS/SCTP"!==e.protocol?["m="+e.kind+" 9 "+e.protocol+" "+t.protocol+"\r\n","c=IN IP4 0.0.0.0\r\n","a=sctp-port:"+t.port+"\r\n"]:["m="+e.kind+" 9 "+e.protocol+" "+t.port+"\r\n","c=IN IP4 0.0.0.0\r\n","a=sctpmap:"+t.port+" "+t.protocol+" 65535\r\n"],void 0!==t.maxMessageSize&&i.push("a=max-message-size:"+t.maxMessageSize+"\r\n"),i.join("")},t.generateSessionId=function(){return Math.random().toString().substr(2,21)},t.writeSessionBoilerplate=function(e,i,r){var n=void 0!==i?i:2;return"v=0\r\no="+(r||"thisisadapterortc")+" "+(e||t.generateSessionId())+" "+n+" IN IP4 127.0.0.1\r\ns=-\r\nt=0 0\r\n"},t.writeMediaSection=function(e,i,r,n){var a=t.writeRtpDescription(e.kind,i);if(a+=t.writeIceParameters(e.iceGatherer.getLocalParameters()),a+=t.writeDtlsParameters(e.dtlsTransport.getLocalParameters(),"offer"===r?"actpass":"active"),a+="a=mid:"+e.mid+"\r\n",e.direction?a+="a="+e.direction+"\r\n":e.rtpSender&&e.rtpReceiver?a+="a=sendrecv\r\n":e.rtpSender?a+="a=sendonly\r\n":e.rtpReceiver?a+="a=recvonly\r\n":a+="a=inactive\r\n",e.rtpSender){var s="msid:"+n.id+" "+e.rtpSender.track.id+"\r\n";a+="a="+s,a+="a=ssrc:"+e.sendEncodingParameters[0].ssrc+" "+s,e.sendEncodingParameters[0].rtx&&(a+="a=ssrc:"+e.sendEncodingParameters[0].rtx.ssrc+" "+s,a+="a=ssrc-group:FID "+e.sendEncodingParameters[0].ssrc+" "+e.sendEncodingParameters[0].rtx.ssrc+"\r\n")}return a+="a=ssrc:"+e.sendEncodingParameters[0].ssrc+" cname:"+t.localCName+"\r\n",e.rtpSender&&e.sendEncodingParameters[0].rtx&&(a+="a=ssrc:"+e.sendEncodingParameters[0].rtx.ssrc+" cname:"+t.localCName+"\r\n"),a},t.getDirection=function(e,i){for(var r=t.splitLines(e),n=0;n<r.length;n++)switch(r[n]){case"a=sendrecv":case"a=sendonly":case"a=recvonly":case"a=inactive":return r[n].substr(2)}return i?t.getDirection(i):"sendrecv"},t.getKind=function(e){return t.splitLines(e)[0].split(" ")[0].substr(2)},t.isRejected=function(e){return"0"===e.split(" ",2)[1]},t.parseMLine=function(e){var i=t.splitLines(e)[0].substr(2).split(" ");return{kind:i[0],port:parseInt(i[1],10),protocol:i[2],fmt:i.slice(3).join(" ")}},t.parseOLine=function(e){var i=t.matchPrefix(e,"o=")[0].substr(2).split(" ");return{username:i[0],sessionId:i[1],sessionVersion:parseInt(i[2],10),netType:i[3],addressType:i[4],address:i[5]}},t.isValidSDP=function(e){if("string"!=typeof e||0===e.length)return!1;for(var i=t.splitLines(e),r=0;r<i.length;r++)if(i[r].length<2||"="!==i[r].charAt(1))return!1;return!0},e.exports=t},90255:(e,t,i)=>{"use strict";var r=i(20773),n=i(25278),a=function(){function e(e){this.bytes=e}return e.prototype.write=function(e,t){return e.set(this.bytes,t),t+this.bytes.length},e.prototype.countSize=function(){return this.bytes.length},e}();t.Value=a;var s=function(){function e(e,i,r){this.id=e,this.children=i;var a=this.children.reduce((function(e,t){return e+t.countSize()}),0);this.sizeMetaData=r?t.UNKNOWN_SIZE:t.vintEncode(n.numberToByteArray(a,t.getEBMLByteLength(a))),this.size=this.id.length+this.sizeMetaData.length+a}return e.prototype.write=function(e,t){return e.set(this.id,t),e.set(this.sizeMetaData,t+this.id.length),this.children.reduce((function(t,i){return i.write(e,t)}),t+this.id.length+this.sizeMetaData.length)},e.prototype.countSize=function(){return this.size},e}();t.Element=s,t.bytes=r((function(e){return new a(e)})),t.number=r((function(e){return t.bytes(n.numberToByteArray(e))})),t.vintEncodedNumber=r((function(e){return t.bytes(t.vintEncode(n.numberToByteArray(e,t.getEBMLByteLength(e))))})),t.string=r((function(e){return t.bytes(n.stringToByteArray(e))})),t.element=function(e,t){return new s(e,Array.isArray(t)?t:[t],!1)},t.unknownSizeElement=function(e,t){return new s(e,Array.isArray(t)?t:[t],!0)},t.build=function(e){var t=new Uint8Array(e.countSize());return e.write(t,0),t},t.getEBMLByteLength=function(e){if(e<127)return 1;if(e<16383)return 2;if(e<2097151)return 3;if(e<268435455)return 4;if(e<34359738367)return 5;if(e<4398046511103)return 6;if(e<562949953421311)return 7;if(e<9007199254740992)return 8;throw e<72057594037927940?new Error("EBMLgetEBMLByteLength: number exceeds Number.MAX_SAFE_INTEGER"):new Error("EBMLgetEBMLByteLength: data size must be less than or equal to "+(Math.pow(2,56)-2))},t.UNKNOWN_SIZE=new Uint8Array([1,255,255,255,255,255,255,255]),t.vintEncode=function(e){return e[0]=t.getSizeMask(e.length)|e[0],e},t.getSizeMask=function(e){return 128>>e-1}},94943:(e,t)=>{"use strict";t.ID={EBML:Uint8Array.of(26,69,223,163),EBMLVersion:Uint8Array.of(66,134),EBMLReadVersion:Uint8Array.of(66,247),EBMLMaxIDLength:Uint8Array.of(66,242),EBMLMaxSizeLength:Uint8Array.of(66,243),DocType:Uint8Array.of(66,130),DocTypeVersion:Uint8Array.of(66,135),DocTypeReadVersion:Uint8Array.of(66,133),Void:Uint8Array.of(236),CRC32:Uint8Array.of(191),Segment:Uint8Array.of(24,83,128,103),SeekHead:Uint8Array.of(17,77,155,116),Seek:Uint8Array.of(77,187),SeekID:Uint8Array.of(83,171),SeekPosition:Uint8Array.of(83,172),Info:Uint8Array.of(21,73,169,102),SegmentUID:Uint8Array.of(115,164),SegmentFilename:Uint8Array.of(115,132),PrevUID:Uint8Array.of(60,185,35),PrevFilename:Uint8Array.of(60,131,171),NextUID:Uint8Array.of(62,185,35),NextFilename:Uint8Array.of(62,131,187),SegmentFamily:Uint8Array.of(68,68),ChapterTranslate:Uint8Array.of(105,36),ChapterTranslateEditionUID:Uint8Array.of(105,252),ChapterTranslateCodec:Uint8Array.of(105,191),ChapterTranslateID:Uint8Array.of(105,165),TimecodeScale:Uint8Array.of(42,215,177),Duration:Uint8Array.of(68,137),DateUTC:Uint8Array.of(68,97),Title:Uint8Array.of(123,169),MuxingApp:Uint8Array.of(77,128),WritingApp:Uint8Array.of(87,65),Cluster:Uint8Array.of(31,67,182,117),Timecode:Uint8Array.of(231),SilentTracks:Uint8Array.of(88,84),SilentTrackNumber:Uint8Array.of(88,215),Position:Uint8Array.of(167),PrevSize:Uint8Array.of(171),SimpleBlock:Uint8Array.of(163),BlockGroup:Uint8Array.of(160),Block:Uint8Array.of(161),BlockAdditions:Uint8Array.of(117,161),BlockMore:Uint8Array.of(166),BlockAddID:Uint8Array.of(238),BlockAdditional:Uint8Array.of(165),BlockDuration:Uint8Array.of(155),ReferencePriority:Uint8Array.of(250),ReferenceBlock:Uint8Array.of(251),CodecState:Uint8Array.of(164),DiscardPadding:Uint8Array.of(117,162),Slices:Uint8Array.of(142),TimeSlice:Uint8Array.of(232),LaceNumber:Uint8Array.of(204),Tracks:Uint8Array.of(22,84,174,107),TrackEntry:Uint8Array.of(174),TrackNumber:Uint8Array.of(215),TrackUID:Uint8Array.of(115,197),TrackType:Uint8Array.of(131),FlagEnabled:Uint8Array.of(185),FlagDefault:Uint8Array.of(136),FlagForced:Uint8Array.of(85,170),FlagLacing:Uint8Array.of(156),MinCache:Uint8Array.of(109,231),MaxCache:Uint8Array.of(109,248),DefaultDuration:Uint8Array.of(35,227,131),DefaultDecodedFieldDuration:Uint8Array.of(35,78,122),MaxBlockAdditionID:Uint8Array.of(85,238),Name:Uint8Array.of(83,110),Language:Uint8Array.of(34,181,156),CodecID:Uint8Array.of(134),CodecPrivate:Uint8Array.of(99,162),CodecName:Uint8Array.of(37,134,136),AttachmentLink:Uint8Array.of(116,70),CodecDecodeAll:Uint8Array.of(170),TrackOverlay:Uint8Array.of(111,171),CodecDelay:Uint8Array.of(86,170),SeekPreRoll:Uint8Array.of(86,187),TrackTranslate:Uint8Array.of(102,36),TrackTranslateEditionUID:Uint8Array.of(102,252),TrackTranslateCodec:Uint8Array.of(102,191),TrackTranslateTrackID:Uint8Array.of(102,165),Video:Uint8Array.of(224),FlagInterlaced:Uint8Array.of(154),FieldOrder:Uint8Array.of(157),StereoMode:Uint8Array.of(83,184),AlphaMode:Uint8Array.of(83,192),PixelWidth:Uint8Array.of(176),PixelHeight:Uint8Array.of(186),PixelCropBottom:Uint8Array.of(84,170),PixelCropTop:Uint8Array.of(84,187),PixelCropLeft:Uint8Array.of(84,204),PixelCropRight:Uint8Array.of(84,221),DisplayWidth:Uint8Array.of(84,176),DisplayHeight:Uint8Array.of(84,186),DisplayUnit:Uint8Array.of(84,178),AspectRatioType:Uint8Array.of(84,179),ColourSpace:Uint8Array.of(46,181,36),Colour:Uint8Array.of(85,176),MatrixCoefficients:Uint8Array.of(85,177),BitsPerChannel:Uint8Array.of(85,178),ChromaSubsamplingHorz:Uint8Array.of(85,179),ChromaSubsamplingVert:Uint8Array.of(85,180),CbSubsamplingHorz:Uint8Array.of(85,181),CbSubsamplingVert:Uint8Array.of(85,182),ChromaSitingHorz:Uint8Array.of(85,183),ChromaSitingVert:Uint8Array.of(85,184),Range:Uint8Array.of(85,185),TransferCharacteristics:Uint8Array.of(85,186),Primaries:Uint8Array.of(85,187),MaxCLL:Uint8Array.of(85,188),MaxFALL:Uint8Array.of(85,189),MasteringMetadata:Uint8Array.of(85,208),PrimaryRChromaticityX:Uint8Array.of(85,209),PrimaryRChromaticityY:Uint8Array.of(85,210),PrimaryGChromaticityX:Uint8Array.of(85,211),PrimaryGChromaticityY:Uint8Array.of(85,212),PrimaryBChromaticityX:Uint8Array.of(85,213),PrimaryBChromaticityY:Uint8Array.of(85,214),WhitePointChromaticityX:Uint8Array.of(85,215),WhitePointChromaticityY:Uint8Array.of(85,216),LuminanceMax:Uint8Array.of(85,217),LuminanceMin:Uint8Array.of(85,218),Audio:Uint8Array.of(225),SamplingFrequency:Uint8Array.of(181),OutputSamplingFrequency:Uint8Array.of(120,181),Channels:Uint8Array.of(159),BitDepth:Uint8Array.of(98,100),TrackOperation:Uint8Array.of(226),TrackCombinePlanes:Uint8Array.of(227),TrackPlane:Uint8Array.of(228),TrackPlaneUID:Uint8Array.of(229),TrackPlaneType:Uint8Array.of(230),TrackJoinBlocks:Uint8Array.of(233),TrackJoinUID:Uint8Array.of(237),ContentEncodings:Uint8Array.of(109,128),ContentEncoding:Uint8Array.of(98,64),ContentEncodingOrder:Uint8Array.of(80,49),ContentEncodingScope:Uint8Array.of(80,50),ContentEncodingType:Uint8Array.of(80,51),ContentCompression:Uint8Array.of(80,52),ContentCompAlgo:Uint8Array.of(66,84),ContentCompSettings:Uint8Array.of(66,85),ContentEncryption:Uint8Array.of(80,53),ContentEncAlgo:Uint8Array.of(71,225),ContentEncKeyID:Uint8Array.of(71,226),ContentSignature:Uint8Array.of(71,227),ContentSigKeyID:Uint8Array.of(71,228),ContentSigAlgo:Uint8Array.of(71,229),ContentSigHashAlgo:Uint8Array.of(71,230),Cues:Uint8Array.of(28,83,187,107),CuePoint:Uint8Array.of(187),CueTime:Uint8Array.of(179),CueTrackPositions:Uint8Array.of(183),CueTrack:Uint8Array.of(247),CueClusterPosition:Uint8Array.of(241),CueRelativePosition:Uint8Array.of(240),CueDuration:Uint8Array.of(178),CueBlockNumber:Uint8Array.of(83,120),CueCodecState:Uint8Array.of(234),CueReference:Uint8Array.of(219),CueRefTime:Uint8Array.of(150),Attachments:Uint8Array.of(25,65,164,105),AttachedFile:Uint8Array.of(97,167),FileDescription:Uint8Array.of(70,126),FileName:Uint8Array.of(70,110),FileMimeType:Uint8Array.of(70,96),FileData:Uint8Array.of(70,92),FileUID:Uint8Array.of(70,174),Chapters:Uint8Array.of(16,67,167,112),EditionEntry:Uint8Array.of(69,185),EditionUID:Uint8Array.of(69,188),EditionFlagHidden:Uint8Array.of(69,189),EditionFlagDefault:Uint8Array.of(69,219),EditionFlagOrdered:Uint8Array.of(69,221),ChapterAtom:Uint8Array.of(182),ChapterUID:Uint8Array.of(115,196),ChapterStringUID:Uint8Array.of(86,84),ChapterTimeStart:Uint8Array.of(145),ChapterTimeEnd:Uint8Array.of(146),ChapterFlagHidden:Uint8Array.of(152),ChapterFlagEnabled:Uint8Array.of(69,152),ChapterSegmentUID:Uint8Array.of(110,103),ChapterSegmentEditionUID:Uint8Array.of(110,188),ChapterPhysicalEquiv:Uint8Array.of(99,195),ChapterTrack:Uint8Array.of(143),ChapterTrackNumber:Uint8Array.of(137),ChapterDisplay:Uint8Array.of(128),ChapString:Uint8Array.of(133),ChapLanguage:Uint8Array.of(67,124),ChapCountry:Uint8Array.of(67,126),ChapProcess:Uint8Array.of(105,68),ChapProcessCodecID:Uint8Array.of(105,85),ChapProcessPrivate:Uint8Array.of(69,13),ChapProcessCommand:Uint8Array.of(105,17),ChapProcessTime:Uint8Array.of(105,34),ChapProcessData:Uint8Array.of(105,51),Tags:Uint8Array.of(18,84,195,103),Tag:Uint8Array.of(115,115),Targets:Uint8Array.of(99,192),TargetTypeValue:Uint8Array.of(104,202),TargetType:Uint8Array.of(99,202),TagTrackUID:Uint8Array.of(99,197),TagEditionUID:Uint8Array.of(99,201),TagChapterUID:Uint8Array.of(99,196),TagAttachmentUID:Uint8Array.of(99,198),SimpleTag:Uint8Array.of(103,200),TagName:Uint8Array.of(69,163),TagLanguage:Uint8Array.of(68,122),TagDefault:Uint8Array.of(68,132),TagString:Uint8Array.of(68,135),TagBinary:Uint8Array.of(68,133)}},36090:(e,t,i)=>{"use strict";function r(e){for(var i in e)t.hasOwnProperty(i)||(t[i]=e[i])}r(i(90255)),r(i(94943)),r(i(25278))},25278:(e,t,i)=>{"use strict";var r=i(20773);function n(e){if(e<0)throw new Error("EBML.typedArrayUtils.getNumberByteLength: negative number not implemented");if(e<256)return 1;if(e<65536)return 2;if(e<16777216)return 3;if(e<4294967296)return 4;if(e<1099511627776)return 5;if(e<281474976710656)return 6;if(e<9007199254740992)return 7;throw new Error("EBML.typedArrayUtils.getNumberByteLength: number exceeds Number.MAX_SAFE_INTEGER")}t.numberToByteArray=function(e,t){var i;if(void 0===t&&(t=n(e)),1===t)(i=new DataView(new ArrayBuffer(1))).setUint8(0,e);else if(2===t)(i=new DataView(new ArrayBuffer(2))).setUint16(0,e);else if(3===t)(i=new DataView(new ArrayBuffer(3))).setUint8(0,e>>16),i.setUint16(1,65535&e);else if(4===t)(i=new DataView(new ArrayBuffer(4))).setUint32(0,e);else if(e<4294967295)(i=new DataView(new ArrayBuffer(5))).setUint32(1,e);else if(5===t)(i=new DataView(new ArrayBuffer(5))).setUint8(0,e/4294967296|0),i.setUint32(1,e%4294967296);else if(6===t)(i=new DataView(new ArrayBuffer(6))).setUint16(0,e/4294967296|0),i.setUint32(2,e%4294967296);else if(7===t)(i=new DataView(new ArrayBuffer(7))).setUint8(0,e/281474976710656|0),i.setUint16(1,e/4294967296&65535),i.setUint32(3,e%4294967296);else{if(8!==t)throw new Error("EBML.typedArrayUtils.numberToByteArray: byte length must be less than or equal to 8");(i=new DataView(new ArrayBuffer(8))).setUint32(0,e/4294967296|0),i.setUint32(4,e%4294967296)}return new Uint8Array(i.buffer)},t.stringToByteArray=r((function(e){return Uint8Array.from(Array.from(e).map((function(e){return e.codePointAt(0)})))})),t.getNumberByteLength=n,t.int16Bit=r((function(e){var t=new ArrayBuffer(2);return new DataView(t).setInt16(0,e),new Uint8Array(t)})),t.float32bit=r((function(e){var t=new ArrayBuffer(4);return new DataView(t).setFloat32(0,e),new Uint8Array(t)})),t.dumpBytes=function(e){return Array.from(new Uint8Array(e)).map((function(e){return"0x"+e.toString(16)})).join(", ")}},73674:(e,t,i)=>{"use strict";i.d(t,{CallStatReachedType:()=>S.CallStatReachedType,CallStatResult:()=>S.CallStatResult,CallStatFailReason:()=>S.CallStatFailReason,CallStatSource:()=>S.CallStatSource,CallActionEventType:()=>S.CallActionEventType,VIDEO_SLOTS_COUNT:()=>E,NoiseCancellationTypes:()=>f,VideoResolutionTypes:()=>m,VIDEO_RESOLUTION_STORAGE_KEY:()=>x,LOCALSTORAGE_IS_CALLS_APP_DOWNLOADED:()=>F,DESKTOP_CALLS_SCHEME:()=>G,DESKTOP_CALLS_HOST:()=>H,DESKTOP_CALLS_DOWNLOAD_PAGE:()=>j,DESKTOP_CALLS_DOWNLOAD:()=>W,CALLS_DESKTOP_APP_NOTIFICATION:()=>$,DESKTOP_CALLS_FILENAME:()=>K,VideoHeight:()=>y,VideoWidth:()=>T,ParticipantsManagementMode:()=>C,ErrorHandleType:()=>I,CallErrorType:()=>A,MediaError:()=>P,FatalError:()=>b,SearchResultType:()=>O,Mode:()=>D,E_ACTION:()=>w,CallType:()=>N,UIMode:()=>k,NotificationType:()=>L,SdkHandType:()=>M,SdkErrorType:()=>U,defaultNotificationLifeSpan:()=>z,VOLUME_LEVEL_DETECTION:()=>Y,DEFAULT_AVATAR:()=>J,DEFAULT_GROUP_CALL_PHOTO:()=>X,HANGUP_DELAY:()=>Q,CLIENT_ERROR_UNKNOWN:()=>Z,SERVER_ERROR_UNKNOWN:()=>ee,SERVER_ERROR_INVALID_REQUEST:()=>te,SERVER_ERROR_FLOOD_CONTROL:()=>ie,SERVER_ERROR_INTERNAL:()=>re,SERVER_ERROR_OLD_RECEIVER_APP:()=>ne,SERVER_ERROR_PRIVACY:()=>ae,SERVER_ERROR_BUSY:()=>se,SERVER_ERROR_REQUIRE_AUTH:()=>oe,SERVER_ERROR_MESSAGES_CALL_JOIN_NOT_ALLOWED:()=>ce,SERVER_ERROR_MESSAGES_CALL_NOT_FOUND:()=>de,SERVER_ERROR_MESSAGES_CALL_INVALID_JOIN_LINK:()=>le,SDK_ERROR_AUTH:()=>ue,POPUP_SETTINGS:()=>pe,POPUP_TRANSLATION:()=>he,POPUP_RECORD:()=>_e,POPUP_TRANSLATION_START_COUNTDOWN:()=>fe,POPUP_TRANSLATION_STOP:()=>me,POPUP_TRANSLATION_SHARE:()=>ge,POPUP_EXIT:()=>ve,POPUP_UNMUTE_REQUEST:()=>Se,POPUP_UNMUTE_AUDIO_REQUEST:()=>Ee,POPUP_UNMUTE_VIDEO_REQUEST:()=>ye,POPUP_ADMIN_PIN_UNMUTE_REQUEST:()=>Te,POPUP_TRANSFER_ADMIN_RIGHTS:()=>Ce,POPUP_VIRUTAL_BACKGROUND:()=>Re,POPUP_UPLOAD_BACKGROUND_PHOTO:()=>Ie,POPUP_UPLOAD_BACKGROUND_ERROR:()=>Ae,POPUP_ON_CALL_HANGUP_BUSY:()=>Pe,POPUP_ON_CALL_HANGUP_KILLED:()=>be,POPUP_ON_CALL_HANGUP_KILLED_WITHOUT_DELETE:()=>Oe,POPUP_ON_CALL_HANGUP_REMOVED:()=>De,POPUP_ON_CALL_HANGUP_BANNED:()=>we,POPUP_ON_CALL_SEND_LINK:()=>Ne,POPUP_SHARE_PLANNED_CALL:()=>ke,POPUP_PLAN_CALENDAR_EVENT:()=>Le,POPUP_MOVIE_CHOOSE:()=>Me,HANGUP_TYPE_BUSY:()=>Ue,HANGUP_TYPE_CALLEE_IS_OFFLINE:()=>xe,HANGUP_TYPE_CALLER_IS_BLOCKED:()=>Be,HANGUP_TYPE_CANCELED:()=>Ve,HANGUP_TYPE_EXTERNAL_API_ERROR:()=>Fe,HANGUP_TYPE_FAILED:()=>Ge,HANGUP_TYPE_HUNGUP:()=>He,HANGUP_TYPE_MISSED:()=>je,HANGUP_TYPE_NOT_FRIENDS:()=>We,HANGUP_TYPE_OLD_VERSION:()=>$e,HANGUP_TYPE_REJECTED:()=>Ke,HANGUP_TYPE_REMOVED:()=>qe,HANGUP_TYPE_SERVICE_DISABLED:()=>ze,HANGUP_TYPE_UNKNOWN_ERROR:()=>Ye,HANGUP_TYPE_UNSUPPORTED:()=>Je,FLAG_OUTBOUND:()=>Xe,FLAG_DELETED:()=>Qe,FLAG_SPAM:()=>Ze,INCOMING_CALL:()=>et,ADD_MESSAGE:()=>tt,CONVERSATION_UPDATED:()=>it,MAIL_CHAT_UPDATE_TYPE_CALL_IN_PROGRESS_CHANGED:()=>rt,READ_INBOUND:()=>nt,SET_FLAGS:()=>at,EDIT_MESSAGE:()=>st,REPLACE_MESSAGE:()=>ot,DELETE_DIALOG:()=>ct,COUNT_OF_GROUP_MEMBERS_TO_LOAD:()=>dt,KickParticipantType:()=>q,CHAT_PEER_ID_OFFSET:()=>pt,EVideoEffectType:()=>lt,EVideoOptionType:()=>ut,LS_KEYS:()=>ht,LS_SFERUM_KEYS:()=>_t,VIRTUAL_BACKGROUND_BLUR_ID:()=>ft,CALL_HANGUP_MODAP_MAP:()=>mt,GRID_SCROLL_NUMBER_OF_VISIBLE:()=>gt,SFERUM_APP_URL:()=>St,SFERUM_DESKTOP_CALLS_FILENAME:()=>Et});var r,n,a,s,o,c,d,l,u,p,h,_,f,m,g=i(53996),v=i(61108),S=i(63035),E=30;!function(e){e.NEURAL="NEURAL",e.SIMPLE="SIMPLE",e.NONE="NONE"}(f||(f={})),function(e){e.SD="SD",e.HD="HD",e.FHD="FHD"}(m||(m={}));var y,T,C,R,I,A,P,b,O,D,w,N,k,L,M,U,x="calls_video_resolution",B="vk.com",V="https://vk.com",F="vkcalls:calls_app_downloaded",G="vkcalls://",H=B,j=V+"/video-calls",W=((r={})[v.OS.WINDOWS]="https://vkcalls-native-ac.vk-apps.com/latest/vk-calls.exe",r[v.OS.MAC]="https://vkcalls-native-ac.vk-apps.com/latest/vk-calls.dmg",r[v.OS.LINUX]={deb:(n={},n[v.ARCH.X64]="https://vkcalls-native-ac.vk-apps.com/latest/vk-calls-amd64.deb",n[v.ARCH.X86]="https://vkcalls-native-ac.vk-apps.com/latest/vk-calls-i386.deb",n),rpm:(a={},a[v.ARCH.X64]="https://vkcalls-native-ac.vk-apps.com/latest/vk-calls-x86_64.rpm",a[v.ARCH.X86]="https://vkcalls-native-ac.vk-apps.com/latest/vk-calls-i686.rpm",a)},r),$="calls_desktop_app_notification",K=((s={})[v.OS.WINDOWS]="vk-calls.exe",s[v.OS.MAC]="vk-calls.dmg",s[v.OS.LINUX]={deb:(o={},o[v.ARCH.X64]="vk-calls-amd64.deb",o)},s);!function(e){e[e.SD=360]="SD",e[e.HD=720]="HD",e[e.FHD=1080]="FHD"}(y||(y={})),function(e){e[e.SD=640]="SD",e[e.HD=1280]="HD",e[e.FHD=1920]="FHD"}(T||(T={})),function(e){e[e.SINGLE=0]="SINGLE",e[e.ALL=1]="ALL",e[e.SINGLE_AUDIO=2]="SINGLE_AUDIO",e[e.SINGLE_VIDEO=3]="SINGLE_VIDEO",e[e.ALL_AUDIO=4]="ALL_AUDIO",e[e.ALL_VIDEO=5]="ALL_VIDEO"}(C||(C={})),function(e){e[e.DENY=0]="DENY",e[e.ONCE=1]="ONCE",e[e.ALLOW=1/0]="ALLOW"}(R||(R={})),function(e){e[e.DECLINE=0]="DECLINE",e[e.PROCESS=1]="PROCESS",e[e.FATAL=2]="FATAL"}(I||(I={})),function(e){e.ALREADY_IN_CALL="already_in_call",e.CANT_REACH_API="cant_reach_api"}(A||(A={})),function(e){e.MIC_CAMERA_PERMISSION="mic_camera",e.CAMERA_PERMISSION="camera",e.MIC_PERMISSION="mic",e.CAMERA_ACCESS="cameralock",e.MIC_ACCESS="miclock",e.MIC_NOT_FOUND="nomic",e.SCREEN_PERMISSION="screenpermission",e.SCREEN_ACCESS="screenlock"}(P||(P={})),function(e){e.AUTH="auth"}(b||(b={})),function(e){e[e.HEADER=0]="HEADER",e[e.CALL_ALL_IN_CHAT=1]="CALL_ALL_IN_CHAT",e[e.MEMBERS_MORE=2]="MEMBERS_MORE",e[e.FRIENDS_MORE=3]="FRIENDS_MORE",e[e.GROUP_MEMBERS_MORE=4]="GROUP_MEMBERS_MORE"}(O||(O={})),function(e){e[e.READY=0]="READY",e[e.CALL=1]="CALL",e[e.INCOMING=2]="INCOMING",e[e.JOIN=3]="JOIN",e[e.ERROR=4]="ERROR",e[e.FEEDBACK=5]="FEEDBACK",e[e.START=6]="START",e[e.CALL_BY=7]="CALL_BY",e[e.CREATE_CALL=8]="CREATE_CALL",e[e.BLOCK=9]="BLOCK"}(D||(D={})),function(e){e.LOAD_PEERS="load_peer",e.CHANGE_MODE="change_mode",e.CALL_STATE="call_state",e.REMOVE_USER="remove_user",e.TIME_START="time_start",e.LOCAL_TIME_START="local_time_start",e.HANGUP="hangup",e.SET_CHAT_INFO="set_chat_info",e.GROUP_CALL_SETUP="group_call_setup",e.TOGGLE_POPUP="toggle_popup",e.UPDATE_HASH="update_hash",e.CHANGE_UI_MODE="change_ui_mode",e.SET_ORATOR="set_orator",e.TOGGLE_ORATOR_MODE="toggle_orator_mode",e.TOGGLE_PARTICIPANTS_ASIDE="toggle_participants_aside",e.SET_PINNED_PARTICIPANT="set_pinned_participant",e.SET_ADMIN_PINNED_PARTICIPANT="set_admin_pinned_participant",e.SET_SCREEN_SHARING_PINNED_PARTICIPANT="set_screen_sharing_pinned_participant",e.SET_MOVIE_SHARING_PINNED_PARTICIPANT="set_movie_sharing_pinned_participant",e.MANAGEMENT="management",e.CALL_NOTIFICATION="call_notification",e.JOIN="join",e.CALL_BY_NAME="call_by_name",e.CREATE_CALL_BY_LINK="create_call_by_link",e.ERROR="error",e.CHANGE_PARTICIPANT_ROLES="change_participant_roles",e.SET_SCREEN_SHARER="set_screen_sharer",e.SET_FRIENDS="set_friends",e.SET_GROUP_MEMBERS="set_group_members",e.SET_FOUNDED_GROUP_MEMBERS="set_group_members",e.SET_SPEAKERS="set_speakers",e.UPDATE_PARTICIPANTS_BATCH="update_participants_batch",e.REMOVE_DEVICE_FROM_CACHE="remove_device_from_cache",e.SET_UNREAD_COUNT="set_unread_count",e.SHOW_CAUTION_BOX="show_caution_box",e.SHOW_LOADER="show_loader",e.SET_TOOLTIP="set_tooltip",e.SET_ENTRYPOINT="set_entrypoint",e.MANUAL_ADD_PARTICIPANTS="manual_add_participants",e.SET_TRANSLATION="set_translation",e.UPDATE_ANON_SECRET="update_anon_token",e.TOGGLE_PARTICIPANTS_MANAGEMENT="toggle_participants_management",e.TOGGLE_PARTICIPANTS_KICK="toggle_participants_kick",e.TOGGLE_ADMIN_ASSIGNMENT="toggle_admin_assignment",e.SET_NOISE_CANCELLATION="set_noise_cancellation",e.CHANGE_LOCAL_VIDEO_RESOLUTION="change_local_video_resolution",e.SET_CONVERSATION_OPTIONS="set_conversation_options",e.SET_PRIVACY_SETTINGS="set_privacy_settings",e.UNBAN_PARTICIPANTS="unban_participants",e.SET_GROUP="set_group",e.SET_WAITING_HALL="set_waiting_hall",e.SET_PUSH_TO_TALK_ENABLE="set_push_to_talk_enable",e.SET_GRID_SCROLL_POSITION="set_grid_scroll_position",e.SET_ORATOR_SCROLL_POSITION="set_orator_scroll_position",e.SET_SHOW_DESKTOP_NOTIFICATION="set_show_desktop_notification",e.SET_SHOW_WARNING_DESKTOP_NOTIFICATION="set_show_warning_desktop_notification",e.SET_SHOW_RECORD_ENDED_DESKTOP_NOTIFICATION="set_show_record_ended_desktop_notification",e.SET_START_OPTIONS="set_start_params",e.VB_SET_USER_PHOTOS="vb_set_user_photos",e.VB_ADD_USER_PHOTO="vb_add_user_photo",e.VB_REMOVE_USER_PHOTO="vb_remove_user_photo",e.VB_SET_VIDEO_OPTIONS="vb_set_video_options",e.SET_CALL_PERMISSIONS="set_call_permissions",e.SET_PARTICIPANTS_CHUNK="set_participants_chunk",e.SET_PARTICIPANT_HAND_STATE="set_participant_hand_state",e.CLEAN_LAST_CALL_DATA="clean_last_call_data",e.SET_LAST_CALL_DATA="set_last_call_data",e.SET_LOCAL_DEVICE="set_local_device",e.SET_PLANNED_CALENDAR_EVENT="set_planned_calendar_event",e.TOGGLE_POPUP_CALENDAR_PLANNING="toggle_popup_calendar_planning",e.SET_PLANNED_CALENDAR_EVENT_OWNER_OPTIONS="set_planned_calendar_event_owner_options",e.UPDATE_SHARED_MOVIE_STATE="update_shared_movie_state",e.SHARED_MOVIE_STATE_SET_UPDATING="shared_movie_state_set_updating",e.SET_COMMON_SHARED_MOVIE_INFO="set_common_shared_movie_info",e.SET_SHARED_MOVIE_OWNER="set_shared_movie_owner"}(w||(w={})),function(e){e.AUDIO="audio",e.VIDEO="video"}(N||(N={})),function(e){e.DEFAULT="default",e.COLLAPSED="collapsed",e.FULLSCREEN="fullscreen"}(k||(k={})),function(e){e.SPEAKING_ON_MUTE="SPEAKING_ON_MUTE",e.RAISED_HAND="RAISED_HAND",e.SCREEN_SHARING_STARTED="SCREEN_SHARING_STARTED",e.BAD_NETWORK_CONNECTION="BAD_NETWORK_CONNECTION",e.BAD_NETWORK_CONNECTION_DISABLE_CAMERA="BAD_NETWORK_CONNECTION_DISABLE_CAMERA",e.ADMIN_ROLE_GRANTED="ADMIN_ROLE_GRANTED",e.USER_GRANTED_WITH_ADMIN_ROLE="USER_GRANTED_WITH_ADMIN_ROLE",e.PINNED_BY_ADMIN="PINNED_BY_ADMIN",e.USER_PINNED_BY_ADMIN="USER_PINNED_BY_ADMIN",e.PUSH_TO_TALK="PUSH_TO_TALK",e.CONNECTING="CONNECTING",e.LINK_COPIED_TO_CLIPBOARD="LINK_COPIED_TO_CLIPBOARD",e.ADMIN_MUTE="ADMIN_MUTE",e.ADMIN_MUTE_AUDIO="ADMIN_MUTE_AUDIO",e.ADMIN_MUTE_VIDEO="ADMIN_MUTE_VIDEO",e.ADMIN_MUTE_PERMANENT="ADMIN_MUTE_PERMANENT",e.ADMIN_MUTE_PERMANENT_AUDIO="ADMIN_MUTE_PERMANENT_AUDIO",e.ADMIN_MUTE_PERMANENT_VIDEO="ADMIN_MUTE_PERMANENT_VIDEO",e.ADMIN_UNMUTE_PERMANENT="ADMIN_UNMUTE_PERMANENT",e.ADMIN_UNMUTE_PERMANENT_AUDIO="ADMIN_UNMUTE_PERMANENT_AUDIO",e.ADMIN_UNMUTE_PERMANENT_VIDEO="ADMIN_UNMUTE_PERMANENT_VIDEO"}(L||(L={})),function(e){e.LOWERED="0",e.RAISED="1"}(M||(M={})),function(e){e.NETWORK="network_error",e.API="api_error"}(U||(U={}));var q,z=5e3,Y=.25,J=V+"/images/camera_400.png",X=V+"/images/call_convo_stub.png",Q=2,Z=-2,ee=1,te=8,ie=9,re=10,ne=923,ae=928,se=948,oe=960,ce=963,de=951,le=954,ue=401,pe="settings",he="translation",_e="record",fe="translation_start_countdown",me="translation_stop",ge="translation_stop_share",ve="exit",Se="unmute_request",Ee="unmute_audio_request",ye="unmute_video_request",Te="admin_pin_unmute_request",Ce="transfer_admin_rights",Re="virtual_background",Ie="virtual_upload_background_photo",Ae="virtual_upload_background_error",Pe="on_call_hangup_busy",be="on_call_hangup_killed",Oe="on_call_hangup_killed_without_delete",De="on_call_hangup_removed",we="on_call_hangup_banned",Ne="on_call_send_link",ke="share_planned_call",Le="popup_plan_calendar_event",Me="popup_movie_choose",Ue=g.HangupType.BUSY,xe=g.HangupType.CALLEE_IS_OFFLINE,Be=g.HangupType.CALLER_IS_BLOCKED,Ve=g.HangupType.CANCELED,Fe=g.HangupType.EXTERNAL_API_ERROR,Ge=g.HangupType.FAILED,He=g.HangupType.HUNGUP,je=g.HangupType.MISSED,We=g.HangupType.NOT_FRIENDS,$e=g.HangupType.OLD_VERSION,Ke=g.HangupType.REJECTED,qe=g.HangupType.REMOVED,ze=g.HangupType.SERVICE_DISABLED,Ye=g.HangupType.UNKNOWN_ERROR,Je=g.HangupType.UNSUPPORTED,Xe=2,Qe=128,Ze=64,et="incoming_call",tt="event_add_message",it="event_chat_updated",rt=19,nt="event_read_inbound",at="event_set_flags",st="event_edit_message",ot="event_replace_message",ct="event_delete_dialog",dt=500;!function(e){e[e.CALL=0]="CALL",e[e.WAITING_HALL=1]="WAITING_HALL"}(q||(q={}));var lt,ut,pt=2e9;!function(e){e.BACKGROUND="calls_background",e.BLUR="calls_blur",e.NONE="calls_none",e.ADD="calls_add"}(lt||(lt={})),function(e){e.IS_VIDEO_MIRRORED="calls_is_video_mirrored"}(ut||(ut={}));var ht={VIRTUAL_BACKGROUND_EFFECT:"calls_virtual_background_effect",VIRTUAL_BACKGROUND_EFFECT_SELECTED_TS:"calls_virtual_background_effect_selected_ts",VIDEO_OPTIONS:"calls_video_options"},_t={VIRTUAL_BACKGROUND_EFFECT:"sferum_virtual_background_effect",VIRTUAL_BACKGROUND_EFFECT_SELECTED_TS:"sferum_virtual_background_effect_selected_ts",VIDEO_OPTIONS:"sferum_video_options"},ft=-16,mt=((c={})[g.HangupType.BUSY]=Pe,c[g.HangupType.KILLED]=be,c[g.HangupType.KILLED_WITHOUT_DELETE]=Oe,c[g.HangupType.BANNED]=we,c[g.HangupType.REMOVED]=De,c),gt=30,vt="https://st.mycdn.me/static/sferum/latest/sferum.exe",St=((d={})[v.OS.WINDOWS]=vt,d[v.OS.MAC]="https://st.mycdn.me/static/sferum/latest/sferum.pkg",d[v.OS.LINUX]={deb:(l={},l[v.ARCH.X64]="https://st.mycdn.me/static/sferum/latest/sferum-amd64.deb",l[v.ARCH.X86]="https://st.mycdn.me/static/sferum/latest/sferum-i386.deb",l),rpm:(u={},u[v.ARCH.X64]="https://st.mycdn.me/static/sferum/latest/sferum-x86_64.rpm",u[v.ARCH.X86]="https://st.mycdn.me/static/sferum/latest/sferum-i686.rpm",u)},d[v.OS.UNKNOWN]=vt,d),Et=((p={})[v.OS.WINDOWS]="sferum.exe",p[v.OS.MAC]="sferum.pkg",p[v.OS.LINUX]={deb:(h={},h[v.ARCH.X64]="sferum-amd64.deb",h[v.ARCH.X86]="sferum-i386.deb",h),rpm:(_={},_[v.ARCH.X64]="sferum-x86_64.rpm",_[v.ARCH.X86]="sferum-i686.rpm",_)},p)},61108:(e,t,i)=>{"use strict";i.d(t,{OS:()=>n,ARCH:()=>a,BROWSER:()=>s,Platform:()=>h,getBrowserInfo:()=>_});var r,n,a,s,o=i(70655),c=i(89588);!function(e){e.WINDOWS="windows",e.MAC="mac",e.ANDROID="android",e.IOS="ios",e.LINUX="linux",e.UNKNOWN="unknown"}(n||(n={})),function(e){e.X86="x86",e.X64="x64",e.ARM="arm"}(a||(a={})),function(e){e.CHROME="chrome",e.FIREFOX="firefox",e.SAFARI="safari",e.OPERA="opera",e.YANDEX="yandex",e.IE="ie",e.EDGE="edge"}(s||(s={}));var d=((r={})[n.ANDROID]=/Android/i,r[n.IOS]=/(iPhone|iPad|iPod)/i,r[n.WINDOWS]=/Win/i,r[n.IOS]=/(iPhone|iPad|iPod)/i,r[n.ANDROID]=/Android/i,r[n.MAC]=/(MacPPC|MacIntel|Mac_PowerPC|Macintosh|Mac OS X)/i,r[n.LINUX]=/(Linux|X11(?!.*CrOS))/i,r),l=/(x86_64|x86-64|win64|x64;|amd64|wow64|x64_64)/i,u=/Mobile|mini|Fennec|Android|iP(ad|od|hone)|opera (mini|mobi)/i,p=new Map,h={get OS(){var e,t;if(p.has("os"))return p.get("os");var i=window.navigator.userAgent;try{for(var r=(0,o.__values)(Object.entries(d)),a=r.next();!a.done;a=r.next()){var s=(0,o.__read)(a.value,2),c=s[0],l=s[1];if(l&&l.test(i))return p.set("os",c),c}}catch(t){e={error:t}}finally{try{a&&!a.done&&(t=r.return)&&t.call(r)}finally{if(e)throw e.error}}return p.set("os",n.UNKNOWN),n.UNKNOWN},get ARCH(){if(p.has("arch"))return p.get("arch");var e=window.navigator,t=e.userAgent,i=e.platform;return l.test(t)||"MacIntel"===i||"Linux x86_64"===i?(p.set("arch",a.X64),a.X64):/arm/i.test(t)?(p.set("arch",a.ARM),a.ARM):(p.set("arch",a.X86),a.X86)},get BROWSER(){return _().name.toLowerCase()},get isChromeBased(){return _().chromeBased},get isMobile(){if(p.has("isMobile"))return p.get("isMobile");var e=window.navigator.appVersion,t=u.test(e);return p.set("isMobile",t),t},get isIPad(){return c.isIPad||c.isIPadOS}};function _(){if(p.has("browserInfo"))return p.get("browserInfo");var e=function(){var e,t=!1,i=0,r=window.navigator,n=r.userAgent,a=r.appName,o=r.appVersion,c=n.match(/(opera|chrome|safari|firefox|msie|trident(?=\/))\/?\s*(\d+)([\d.]+)/i)||[];if(/trident/i.test(c[1]))return e=/\brv[ :]+(\d+)([\d.]+)/g.exec(n),{name:s.IE,version:e&&e[1]||"Unknown",fullVersion:e&&e[1]?""+e[1]+(e[2]||""):"Unknown",chromeBased:t,chromeVersion:i};if("Safari"===c[1]){if(e=n.match(/\bEdge\/(\d+)([\d.])+/))return{name:s.EDGE,version:e[1]||"Unknown",fullVersion:e[1]?""+e[1]+(e[2]||""):"Unknown",chromeBased:t,chromeVersion:i};if(e=n.match(/\bCriOS\/(\d+)([\d.]+)/))return{name:s.CHROME,version:e[1],fullVersion:""+e[1]+e[2],chromeBased:!0,chromeVersion:e[1]};if(e=n.match(/\bFxiOS\/(\d+)([\d.]+)/))return{name:s.FIREFOX,version:e[1],fullVersion:""+e[1]+e[2],chromeBased:t,chromeVersion:i};if(e=n.match(/\bYaBrowser\/(\d+)([\d.]+)/))return{name:s.YANDEX,version:e[1],fullVersion:""+e[1]+e[2],chromeBased:t,chromeVersion:i};if(e=n.match(/\bOPT\/(\d+)([\d.]+)/))return{name:s.OPERA,version:e[1],fullVersion:""+e[1]+e[2],chromeBased:t,chromeVersion:i}}if("Chrome"===c[1]){if(i=Number(c[2]),t=!0,e=n.match(/\bOPR\/(\d+)([\d.]+)/))return{name:s.CHROME,version:e[1]||"Unknown",fullVersion:e[1]?""+e[1]+(e[2]||""):"Unknown",chromeBased:t,chromeVersion:i};if(e=n.match(/\bYaBrowser\/(\d+)([\d.]+)/))return{name:s.YANDEX,version:e[1]||"Unknown",fullVersion:e[1]?""+e[1]+(e[2]||""):"Unknown",chromeBased:t,chromeVersion:i};if(e=n.match(/\bEdge?\/(\d+)([\d.]+)/))return{name:s.EDGE,version:e[1]||"Unknown",fullVersion:e[1]?""+e[1]+(e[2]||""):"Unknown",chromeBased:t,chromeVersion:i};if(void 0!==window.opr&&/^(.+\.)?ok.ru$/.test(window.location.host))return{name:s.OPERA,version:"Hidden",fullVersion:"Hidden",chromeBased:t,chromeVersion:i}}return e=n.match(/version\/(\d+)([\d.]+)/i),{name:c[2]?c[1]:a,version:e&&e[1]||c[2]||o,fullVersion:e&&e[1]?""+e[1]+(e[2]||""):c[2]?""+c[2]+(c[3]||""):o,chromeBased:t,chromeVersion:i}}();return p.set("browserInfo",e),e}}}]);try{stManager.done("dist/66ca193dea2abc977b93ba525d084995.cedc2deaa6dda2a04ba7.js")}catch(e){}